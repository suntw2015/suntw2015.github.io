<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"suntw2015.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.3.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="redis集群是由多个节点实例组成的网状拓扑结构，每一个节点有两个对外服务的端口，一个是面向普通客户端的正常服务(默认端口是6379)，另一个则是用于集群内节点交流的服务(默认端口是6379+10000)，主要包括增加节点、删除节点、分配哈希槽点、迁移槽点、故障修复等功能。集群的实现和哨兵的实现有相同的地方，也有不一样的地方。相同点是二者都支持主从模式，并且在master挂掉之后，能够自动发现并修">
<meta property="og:type" content="article">
<meta property="og:title" content="redis集群">
<meta property="og:url" content="http://suntw2015.github.io/2020/04/07/redis-cluster/index.html">
<meta property="og:site_name" content="MadeLife">
<meta property="og:description" content="redis集群是由多个节点实例组成的网状拓扑结构，每一个节点有两个对外服务的端口，一个是面向普通客户端的正常服务(默认端口是6379)，另一个则是用于集群内节点交流的服务(默认端口是6379+10000)，主要包括增加节点、删除节点、分配哈希槽点、迁移槽点、故障修复等功能。集群的实现和哨兵的实现有相同的地方，也有不一样的地方。相同点是二者都支持主从模式，并且在master挂掉之后，能够自动发现并修">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://suntw2015.github.io/images/redis-cluster-nodes.png">
<meta property="og:image" content="http://suntw2015.github.io/images/redis-cluster-handshake.png">
<meta property="article:published_time" content="2020-04-07T15:55:26.000Z">
<meta property="article:modified_time" content="2021-04-06T04:02:09.188Z">
<meta property="article:author" content="孙天文">
<meta property="article:tag" content="redis">
<meta property="article:tag" content="cluster">
<meta property="article:tag" content="集群">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://suntw2015.github.io/images/redis-cluster-nodes.png">


<link rel="canonical" href="http://suntw2015.github.io/2020/04/07/redis-cluster/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>redis集群 | MadeLife</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">MadeLife</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%BB%84%E6%88%90"><span class="nav-number">1.</span> <span class="nav-text">集群组成</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8A%82%E7%82%B9"><span class="nav-number">1.1.</span> <span class="nav-text">节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="nav-number">1.2.</span> <span class="nav-text">创建集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%A1%E6%89%8B%E8%BF%87%E7%A8%8B"><span class="nav-number">1.3.</span> <span class="nav-text">握手过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A7%BD%E7%82%B9-%E5%93%88%E5%B8%8C%E6%A7%BD"><span class="nav-number">2.</span> <span class="nav-text">槽点(哈希槽)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A7%BD%E7%82%B9%E5%93%88%E5%B8%8C"><span class="nav-number">2.1.</span> <span class="nav-text">槽点哈希</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A7%BD%E7%82%B9%E8%BF%81%E7%A7%BB"><span class="nav-number">2.2.</span> <span class="nav-text">槽点迁移</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E4%BF%AE%E5%A4%8D"><span class="nav-number">3.</span> <span class="nav-text">故障修复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.</span> <span class="nav-text">客户端查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">5.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">5.1.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">5.2.</span> <span class="nav-text">初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterLoadConfig"><span class="nav-number">5.2.1.</span> <span class="nav-text">clusterLoadConfig</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSaveConfig"><span class="nav-number">5.2.2.</span> <span class="nav-text">clusterSaveConfig</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSaveConfigOrDie"><span class="nav-number">5.2.3.</span> <span class="nav-text">clusterSaveConfigOrDie</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterLockConfig"><span class="nav-number">5.2.4.</span> <span class="nav-text">clusterLockConfig</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterUpdateMyselfFlags"><span class="nav-number">5.2.5.</span> <span class="nav-text">clusterUpdateMyselfFlags</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterInit"><span class="nav-number">5.2.6.</span> <span class="nav-text">clusterInit</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterReset"><span class="nav-number">5.2.7.</span> <span class="nav-text">clusterReset</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E4%BA%A4%E6%B5%81%E8%BF%9E%E6%8E%A5"><span class="nav-number">5.3.</span> <span class="nav-text">节点交流连接</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#createClusterLink"><span class="nav-number">5.3.1.</span> <span class="nav-text">createClusterLink</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#freeClusterLink"><span class="nav-number">5.3.2.</span> <span class="nav-text">freeClusterLink</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterAcceptHandler"><span class="nav-number">5.3.3.</span> <span class="nav-text">clusterAcceptHandler</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%94%AE%E5%80%BC%E5%93%88%E5%B8%8C%E5%A4%84%E7%90%86"><span class="nav-number">5.4.</span> <span class="nav-text">键值哈希处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#keyHashSlot"><span class="nav-number">5.4.1.</span> <span class="nav-text">keyHashSlot</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E7%9B%B8%E5%85%B3"><span class="nav-number">5.5.</span> <span class="nav-text">节点相关</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#createClusterNode"><span class="nav-number">5.5.1.</span> <span class="nav-text">createClusterNode</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterNodeAddFailureReport"><span class="nav-number">5.5.2.</span> <span class="nav-text">clusterNodeAddFailureReport</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterNodeCleanupFailureReports"><span class="nav-number">5.5.3.</span> <span class="nav-text">clusterNodeCleanupFailureReports</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterNodeDelFailureReport"><span class="nav-number">5.5.4.</span> <span class="nav-text">clusterNodeDelFailureReport</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterNodeFailureReportsCount"><span class="nav-number">5.5.5.</span> <span class="nav-text">clusterNodeFailureReportsCount</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterNodeRemoveSlave"><span class="nav-number">5.5.6.</span> <span class="nav-text">clusterNodeRemoveSlave</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterNodeAddSlave"><span class="nav-number">5.5.7.</span> <span class="nav-text">clusterNodeAddSlave</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterCountNonFailingSlaves"><span class="nav-number">5.5.8.</span> <span class="nav-text">clusterCountNonFailingSlaves</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#freeClusterNode"><span class="nav-number">5.5.9.</span> <span class="nav-text">freeClusterNode</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterAddNode"><span class="nav-number">5.5.10.</span> <span class="nav-text">clusterAddNode</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterDelNode"><span class="nav-number">5.5.11.</span> <span class="nav-text">clusterDelNode</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterLookupNode"><span class="nav-number">5.5.12.</span> <span class="nav-text">clusterLookupNode</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterRenameNode"><span class="nav-number">5.5.13.</span> <span class="nav-text">clusterRenameNode</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%BA%AA%E5%85%83"><span class="nav-number">5.6.</span> <span class="nav-text">配置纪元</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterGetMaxEpoch"><span class="nav-number">5.6.1.</span> <span class="nav-text">clusterGetMaxEpoch</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterBumpConfigEpochWithoutConsensus"><span class="nav-number">5.6.2.</span> <span class="nav-text">clusterBumpConfigEpochWithoutConsensus</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterHandleConfigEpochCollision"><span class="nav-number">5.6.3.</span> <span class="nav-text">clusterHandleConfigEpochCollision</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8E%E5%A4%87%E5%88%97%E8%A1%A8"><span class="nav-number">5.7.</span> <span class="nav-text">后备列表</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterBlacklistCleanup"><span class="nav-number">5.7.1.</span> <span class="nav-text">clusterBlacklistCleanup</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterBlacklistAddNode"><span class="nav-number">5.7.2.</span> <span class="nav-text">clusterBlacklistAddNode</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterBlacklistExists"><span class="nav-number">5.7.3.</span> <span class="nav-text">clusterBlacklistExists</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%B6%88%E6%81%AF"><span class="nav-number">5.8.</span> <span class="nav-text">集群消息</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#markNodeAsFailingIfNeeded"><span class="nav-number">5.8.1.</span> <span class="nav-text">markNodeAsFailingIfNeeded</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clearNodeFailureIfNeeded"><span class="nav-number">5.8.2.</span> <span class="nav-text">clearNodeFailureIfNeeded</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterHandshakeInProgress"><span class="nav-number">5.8.3.</span> <span class="nav-text">clusterHandshakeInProgress</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterStartHandshake"><span class="nav-number">5.8.4.</span> <span class="nav-text">clusterStartHandshake</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterProcessGossipSection"><span class="nav-number">5.8.5.</span> <span class="nav-text">clusterProcessGossipSection</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#nodeIp2String"><span class="nav-number">5.8.6.</span> <span class="nav-text">nodeIp2String</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#nodeUpdateAddressIfNeeded"><span class="nav-number">5.8.7.</span> <span class="nav-text">nodeUpdateAddressIfNeeded</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSetNodeAsMaster"><span class="nav-number">5.8.8.</span> <span class="nav-text">clusterSetNodeAsMaster</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterUpdateSlotsConfigWith"><span class="nav-number">5.8.9.</span> <span class="nav-text">clusterUpdateSlotsConfigWith</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterProcessPacket"><span class="nav-number">5.8.10.</span> <span class="nav-text">clusterProcessPacket</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#handleLinkIOError"><span class="nav-number">5.8.11.</span> <span class="nav-text">handleLinkIOError</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterWriteHandler"><span class="nav-number">5.8.12.</span> <span class="nav-text">clusterWriteHandler</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterReadHandler"><span class="nav-number">5.8.13.</span> <span class="nav-text">clusterReadHandler</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSendMessage"><span class="nav-number">5.8.14.</span> <span class="nav-text">clusterSendMessage</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterBroadcastMessage"><span class="nav-number">5.8.15.</span> <span class="nav-text">clusterBroadcastMessage</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterBuildMessageHdr"><span class="nav-number">5.8.16.</span> <span class="nav-text">clusterBuildMessageHdr</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterNodeIsInGossipSection"><span class="nav-number">5.8.17.</span> <span class="nav-text">clusterNodeIsInGossipSection</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSetGossipEntry"><span class="nav-number">5.8.18.</span> <span class="nav-text">clusterSetGossipEntry</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSendPing"><span class="nav-number">5.8.19.</span> <span class="nav-text">clusterSendPing</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterBroadcastPong"><span class="nav-number">5.8.20.</span> <span class="nav-text">clusterBroadcastPong</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSendPublish"><span class="nav-number">5.8.21.</span> <span class="nav-text">clusterSendPublish</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSendFail"><span class="nav-number">5.8.22.</span> <span class="nav-text">clusterSendFail</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSendUpdate"><span class="nav-number">5.8.23.</span> <span class="nav-text">clusterSendUpdate</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSendModule"><span class="nav-number">5.8.24.</span> <span class="nav-text">clusterSendModule</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSendModuleMessageToTarget"><span class="nav-number">5.8.25.</span> <span class="nav-text">clusterSendModuleMessageToTarget</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterPropagatePublish"><span class="nav-number">5.8.26.</span> <span class="nav-text">clusterPropagatePublish</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#slave%E8%8A%82%E7%82%B9%E7%9B%B8%E5%85%B3"><span class="nav-number">5.9.</span> <span class="nav-text">slave节点相关</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterRequestFailoverAuth"><span class="nav-number">5.9.1.</span> <span class="nav-text">clusterRequestFailoverAuth</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSendFailoverAuth"><span class="nav-number">5.9.2.</span> <span class="nav-text">clusterSendFailoverAuth</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSendMFStart"><span class="nav-number">5.9.3.</span> <span class="nav-text">clusterSendMFStart</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSendFailoverAuthIfNeeded"><span class="nav-number">5.9.4.</span> <span class="nav-text">clusterSendFailoverAuthIfNeeded</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterGetSlaveRank"><span class="nav-number">5.9.5.</span> <span class="nav-text">clusterGetSlaveRank</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterLogCantFailover"><span class="nav-number">5.9.6.</span> <span class="nav-text">clusterLogCantFailover</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterFailoverReplaceYourMaster"><span class="nav-number">5.9.7.</span> <span class="nav-text">clusterFailoverReplaceYourMaster</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterHandleSlaveFailover"><span class="nav-number">5.9.8.</span> <span class="nav-text">clusterHandleSlaveFailover</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#slave%E8%BF%81%E7%A7%BB"><span class="nav-number">5.10.</span> <span class="nav-text">slave迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterHandleSlaveMigration"><span class="nav-number">5.10.1.</span> <span class="nav-text">clusterHandleSlaveMigration</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%8B%E5%8A%A8%E4%BF%AE%E5%A4%8D"><span class="nav-number">5.11.</span> <span class="nav-text">手动修复</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#resetManualFailover"><span class="nav-number">5.11.1.</span> <span class="nav-text">resetManualFailover</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#manualFailoverCheckTimeout"><span class="nav-number">5.11.2.</span> <span class="nav-text">manualFailoverCheckTimeout</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterHandleManualFailover"><span class="nav-number">5.11.3.</span> <span class="nav-text">clusterHandleManualFailover</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="nav-number">5.12.</span> <span class="nav-text">集群定时任务</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterCron"><span class="nav-number">5.12.1.</span> <span class="nav-text">clusterCron</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterBeforeSleep"><span class="nav-number">5.12.2.</span> <span class="nav-text">clusterBeforeSleep</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterDoBeforeSleep"><span class="nav-number">5.12.3.</span> <span class="nav-text">clusterDoBeforeSleep</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A7%BD%E7%82%B9"><span class="nav-number">5.13.</span> <span class="nav-text">槽点</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#bitmapTestBit"><span class="nav-number">5.13.1.</span> <span class="nav-text">bitmapTestBit</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#bitmapSetBit"><span class="nav-number">5.13.2.</span> <span class="nav-text">bitmapSetBit</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#bitmapClearBit"><span class="nav-number">5.13.3.</span> <span class="nav-text">bitmapClearBit</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterMastersHaveSlaves"><span class="nav-number">5.13.4.</span> <span class="nav-text">clusterMastersHaveSlaves</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterNodeSetSlotBit"><span class="nav-number">5.13.5.</span> <span class="nav-text">clusterNodeSetSlotBit</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterNodeClearSlotBit"><span class="nav-number">5.13.6.</span> <span class="nav-text">clusterNodeClearSlotBit</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterNodeGetSlotBit"><span class="nav-number">5.13.7.</span> <span class="nav-text">clusterNodeGetSlotBit</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterAddSlot"><span class="nav-number">5.13.8.</span> <span class="nav-text">clusterAddSlot</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterDelSlot"><span class="nav-number">5.13.9.</span> <span class="nav-text">clusterDelSlot</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterDelNodeSlots"><span class="nav-number">5.13.10.</span> <span class="nav-text">clusterDelNodeSlots</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterCloseAllSlots"><span class="nav-number">5.13.11.</span> <span class="nav-text">clusterCloseAllSlots</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="nav-number">5.14.</span> <span class="nav-text">集群状态</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterUpdateState"><span class="nav-number">5.14.1.</span> <span class="nav-text">clusterUpdateState</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#verifyClusterConfigWithData"><span class="nav-number">5.14.2.</span> <span class="nav-text">verifyClusterConfigWithData</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#salve%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C"><span class="nav-number">5.15.</span> <span class="nav-text">salve节点操作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterSetMaster"><span class="nav-number">5.15.1.</span> <span class="nav-text">clusterSetMaster</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E5%88%B0%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E8%BD%AC%E6%8D%A2"><span class="nav-number">5.16.</span> <span class="nav-text">节点到字符串的转换</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#redisNodeFlags"><span class="nav-number">5.16.1.</span> <span class="nav-text">redisNodeFlags</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#representClusterNodeFlags"><span class="nav-number">5.16.2.</span> <span class="nav-text">representClusterNodeFlags</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterGenNodeDescription"><span class="nav-number">5.16.3.</span> <span class="nav-text">clusterGenNodeDescription</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterGenNodesDescription"><span class="nav-number">5.16.4.</span> <span class="nav-text">clusterGenNodesDescription</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%91%BD%E4%BB%A4"><span class="nav-number">5.17.</span> <span class="nav-text">集群命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterGetMessageTypeString"><span class="nav-number">5.17.1.</span> <span class="nav-text">clusterGetMessageTypeString</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getSlotOrReply"><span class="nav-number">5.17.2.</span> <span class="nav-text">getSlotOrReply</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterReplyMultiBulkSlots"><span class="nav-number">5.17.3.</span> <span class="nav-text">clusterReplyMultiBulkSlots</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterCommand"><span class="nav-number">5.17.4.</span> <span class="nav-text">clusterCommand</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#createDumpPayload"><span class="nav-number">5.17.5.</span> <span class="nav-text">createDumpPayload</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#restoreCommand"><span class="nav-number">5.17.6.</span> <span class="nav-text">restoreCommand</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#key%E8%BF%81%E7%A7%BB%E6%93%8D%E4%BD%9C"><span class="nav-number">5.18.</span> <span class="nav-text">key迁移操作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#migrateGetSocket"><span class="nav-number">5.18.1.</span> <span class="nav-text">migrateGetSocket</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#migrateCloseSocket"><span class="nav-number">5.18.2.</span> <span class="nav-text">migrateCloseSocket</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#migrateCloseTimedoutSockets"><span class="nav-number">5.18.3.</span> <span class="nav-text">migrateCloseTimedoutSockets</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#migrateCommand"><span class="nav-number">5.18.4.</span> <span class="nav-text">migrateCommand</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#askingCommand"><span class="nav-number">5.18.5.</span> <span class="nav-text">askingCommand</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#readonlyCommand"><span class="nav-number">5.18.6.</span> <span class="nav-text">readonlyCommand</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#readwriteCommand"><span class="nav-number">5.18.7.</span> <span class="nav-text">readwriteCommand</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getNodeByQuery"><span class="nav-number">5.18.8.</span> <span class="nav-text">getNodeByQuery</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#clusterRedirectBlockedClientIfNeeded"><span class="nav-number">5.18.9.</span> <span class="nav-text">clusterRedirectBlockedClientIfNeeded</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">孙天文</p>
  <div class="site-description" itemprop="description">记录一些随笔</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/suntw2015" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;suntw2015" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://suntw2015.github.io/2020/04/07/redis-cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="孙天文">
      <meta itemprop="description" content="记录一些随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MadeLife">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          redis集群
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-07 23:55:26" itemprop="dateCreated datePublished" datetime="2020-04-07T23:55:26+08:00">2020-04-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-04-06 12:02:09" itemprop="dateModified" datetime="2021-04-06T12:02:09+08:00">2021-04-06</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>redis集群是由多个节点实例组成的网状拓扑结构，每一个节点有两个对外服务的端口，一个是面向普通客户端的正常服务(默认端口是6379)，另一个则是用于集群内节点交流的服务(默认端口是6379+10000)，主要包括增加节点、删除节点、分配哈希槽点、迁移槽点、故障修复等功能。集群的实现和哨兵的实现有相同的地方，也有不一样的地方。相同点是二者都支持主从模式，并且在master挂掉之后，能够自动发现并修复。不一样的地方是哨兵模式下的故障修复是从哨兵中选出一个leader，参与投票的也是哨兵节点，然后由leader哨兵主导完成整个修复过程。在集群模式下，则不存在哨兵这样的领导层角色节点，故障修复过程则是由挂掉master下的slave节点发起，其余master参与投票来选出一个slave来主导修复过程。</p>
<p>redis集群的实现引入了哈希槽的概念，将整个集群分为16384个槽点，集群中每个节点负责其中的一部分。通过对命令中key进行运算，结果对总的槽点取余来决定应该访问哪个槽点。当集群稳定后，集群中每个槽点都会有一份完整的槽点路由表，记录每个槽点应该去哪个节点。</p>
<span id="more"></span>

<h3 id="集群组成"><a href="#集群组成" class="headerlink" title="集群组成"></a>集群组成</h3><h4 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h4><p>一个节点有以下信息，是其他节点都知道的：</p>
<ol>
<li>IP、端口、集群端口</li>
<li>标识位，比如是master、是slave、客观下线、主观下线、握手中</li>
<li>节点使用的槽点情况</li>
<li>最近一次发送ping的时间</li>
<li>最近一次收到ping的时间</li>
<li>slave节点的数量</li>
<li>主节点的信息</li>
</ol>
<p>在使用<code>redis-cli</code>创建集群的时候，会选取第一个master节点作为标杆，其余的master节点向第一个节点发送<code>MEET</code>消息，消息内会带上自身的信息，ip、端口、名称等信息。节点接收到<code>MEET</code>信息后，会把该节点作为集群中的一部分记录下来，然后在定时任务中，对自己已知的节点发送<code>PING</code>命令来进行心跳检测和交流，收到<code>PING</code>命令的节点则会回复<code>PONG</code>命令。在<code>MEET</code>、<code>PING</code>、<code>PONG</code>命令中，都会附带当前节点的部分已知节点信息，收到命令的一方，则会把该节点添加到自己的已知节点中。在经过多次交流后，每两个节点都会知道彼此的全部已知节点信息。</p>
<p>集群是由多个master主节点组成，为了提升集群的高可用性，解决某个master挂掉之后，部分槽点变得不可用的情况，通常会为每个master配置一个或多个slave从节点。当master挂掉之后，从其slave节点中提取一个成为新的master。<br>集群中节点都是直接连接的，不存在向哨兵那样的管理节点。在由N个节点组成的集群中，每个节点都有N-1个连接，从结构上来看，像是一个图结构。节点之间交流的的时候，会带上自身的信息和自己的槽点路由表。因此在构建集群的时候，我们只需要把所有节点连接成一个树就好了，在经过一段时间的交流后，最终形成一个完整的图。比如A知道B，B知道C,B跟A交流的时候，会告诉A自己知道C，然后A知道了C，同样的B跟C交流的时候，C也会知道A。下图所示的就是我们在构建集群开始的拓扑，和集群稳定后的拓扑。</p>
<p><img src="/images/redis-cluster-nodes.png"></p>
<blockquote>
<p>master节点的数量最低为3，因为当master挂掉之后，一个slave节点能够成为新的master，是需要获得一半以上master票数的支持的。一个或两个master节点组成的集群，其一半以上的数量就是总的master节点数量，在某个master挂掉后，是永远都不满足的这个条件的。而三个节点的话，一半以上的数量最低是2个，是能够满足的。</p>
</blockquote>
<h4 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h4><p>创建集群分为两步，第一步是节点通过<code>MEET</code>命令构建成一个连通图，第二步是节点通过gossip协议交流，完善各自的拓扑结构。在第一步中，是需要一个额外的工具来完成的，可以是纯手工操作、<code>redis-cli cluster命令</code>或者<code>redis-trib.rb</code>脚本。</p>
<h4 id="握手过程"><a href="#握手过程" class="headerlink" title="握手过程"></a>握手过程</h4><ol>
<li>脚本向节点A发送<code>MEET</code>命令，要求节点A去会见节点B，此时A创建一个node,填充上ip、port、cport，标记<code>CLUSTER_NODE_HANDSHAKE &amp; CLUSTER_NODE_MEET</code>node-&gt;link为空，node-&gt;name是随机生成</li>
<li>节点A在定时任务里，发现此node-&gt;link为空，创建根据node-&gt;ip,node-&gt;cport创建连接，指定连接的读响应处理为<code>clusterReadHandler</code>，此时<code>link-&gt;node=node;node-&gt;link=link;</code>，link和node完成关联</li>
<li>节点B<code>clusterAcceptHandler</code>收到链接请求，创建一个link，link-&gt;node为空，指定连接的读响应处理同样为<code>clusterReadHandler</code></li>
<li>节点A发送<code>MEET</code>消息，消息里有节点A的名字</li>
<li>节点B接受到完整信息后，调用<code>clusterProcessPacket</code>处理<code>MEET</code>消息。创建一个node填充ip、port、cport，并标记<code>CLUSTER_NODE_HANDSHAKE</code>，处理gossip信息并回复<code>PONG</code></li>
<li>节点A收到<code>PONG</code>回复，因为node还在握手阶段，所以会根据<code>PONG</code>回复里的节点B名字来更新node-&gt;name。node结束握手阶段，给node打上master或者slave标签</li>
<li>节点B在定时任务中，发现node-&gt;link为空，创建跟节点A的link，此时<code>link-&gt;node=node;node-&gt;link=link;</code>，link和node完成关联连接后续处理为<code>clusterReadHandler</code>，发送<code>PING</code>消息给A</li>
<li>节点A回复<code>PONG</code></li>
<li>节点B收到完成消息，调用<code>clusterProcessPacket</code>处理<code>PONG</code>消息，更新node-&gt;name。节点B的node握手结束，打上master或者slave标签</li>
</ol>
<p>整个过程如下图所示<br><img src="/images/redis-cluster-handshake.png"></p>
<p>最终的，节点A跟节点B各有两个link，一个是主动发起的link，和node互相绑定；一个是被动连接的link，根据消息里的sender查找本地对应的node。这两个连接也有特殊的用途，当一个节点的ip、port、cport发生变化时，我们可以通过主动的link来告知其他节点，我们的连接信息发生变化了。比如节点A和B互相建立的连接，节点A在某一刻ip发生变化了，在后续发给节点B的<code>PING</code>消息中，会带上自己的最新ip。节点B在收到消息后，发现消息中节点A自报的ip和自己已知nodeA中的ip信息不一致，这时就会删除nodeA中的link，也就是主动的link，并更新nodeA的ip。在下一次定时任务时，会使用更新后的信息，建立跟节点A的连接。</p>
<p>因此在<code>clusterProcessPacket</code>中看到<code>if (link-&gt;node)</code>，表示是我们发起的主动连接，<code>if (sender)</code>则表示消息里的name对应的节点是我们已知的节点。</p>
<h3 id="槽点-哈希槽"><a href="#槽点-哈希槽" class="headerlink" title="槽点(哈希槽)"></a>槽点(哈希槽)</h3><p>redis集群的实现没有使用一致性哈希，而是采用了槽点的概念。整个集群共有<code>16384</code>个槽点，每个master节点分别负责其中的一部分，每个节点都有一份完整的槽点路由表，记录着每个槽点对应的节点的信息。这样客户端只需要连接集群中任意一个节点，该节点就能正确告知客户端应该去哪个真正的节点进行操作。</p>
<h4 id="槽点哈希"><a href="#槽点哈希" class="headerlink" title="槽点哈希"></a>槽点哈希</h4><p>当我们在集群中执行命令的时候，服务端会把键值进行<code>CRC16</code>计算，然后对总槽点数进行取余，来决定该命令应该落到哪个槽点，然后根据槽点路由表，找到集群中对应的节点来处理命令。</p>
<p>针对键值的计算，有以下规则：</p>
<ol>
<li>如果键值里包含”{}”, 且第一对”{}”中间的内容不为空，那么只有第一个”{}”之间的内容会参与<code>CRC16</code>计算。eg: key = <code>&#123;user&#125;100&#123;qaq&#125;</code>, 参与计算的数据为 <code>user</code></li>
<li>如果键值里包含”{}”, 且第一对”{}”中间的内容为空，整个键值都会参与计算。eg: key = <code>&#123;&#125;user100</code>，参与计算的数据为<code>&#123;&#125;user100</code></li>
<li>如果键值里不包含”{}”,整个键值都会参与计算。eg : key = <code>user100</code>，参与计算的数据为<code>user100</code></li>
</ol>
<p>总的来说就是，当且仅当键值中第一对”{}”中间不为空时，才会使用第一对”{}”之间的内容进行计算，否则会使用整个键值的内容。</p>
<blockquote>
<p>如果命令涉及到多个key，当且仅当所有key都分布在同一个槽点才能正常响应。比如<code>mget</code>，当key分布在不同槽点的话，会返回一个错误<code>(error) CROSSSLOT Keys in request don&#39;t hash to the same slot</code>。我们可以利用上面的规则使用”{}”规则，强制把多个key分布在同一个节点上，这样就能正常响应多key请求了。</p>
</blockquote>
<h4 id="槽点迁移"><a href="#槽点迁移" class="headerlink" title="槽点迁移"></a>槽点迁移</h4><p>由于某些原因(人为故意的、碎片整理)，我们需要对槽点进行节点间的迁移。槽点在迁移的过程中有两个状态<code>MIGRATING</code>和<code>IMPORTING</code>，比如我们要把槽点1从节点A迁移到节点B上。需要执行以下两步：</p>
<ol>
<li>向目标节点B发送命令 ：<code>CLUSTER SETSLOT 1 IMPORTING A</code> ,表示从A节点迁移槽点1</li>
<li>向源节点A发送命令 ：<code>CLUSTER SETSLOT 1 MIGRATING B</code> ， 表示把槽点1迁移到B</li>
</ol>
<h3 id="故障修复"><a href="#故障修复" class="headerlink" title="故障修复"></a>故障修复</h3><p>在一个良好的redis集群拓扑中，至少有3个master节点组成，每个master至少有一个salve节点。在某个master挂掉之后，其下面的salve节点检测到master不可用，会将该master标记成<code>PFAIL</code>主观下线状态。在后续跟其他节点交流的过程中，统计其他节点是否也检测到该master不可用。当标记master不可用的节点数量达到集群中总节点数量一半以上时，slave将其标记成<code>FAIL</code>客观下线。然后会发起一个投票，希望自己能够成为故障修复的执行者，请求其他master投自己一票。当一段时间内，有超过一半以上的master同意了，那么就可以成功当选，否则会在下一次再尝试发起。</p>
<p>成功选举后，slave会进行以下操作：</p>
<ol>
<li>把自己变成master，去掉salve标记，打上master标记，把自己从之前master节点下的salve列表中删除，更新自己的纪元</li>
<li>删除掉主从同步中master标记，断开跟master以及自己下面所有salve的连接</li>
<li>把之前master负责的槽点划分到自己下面</li>
<li>广播告知其他节点，更新拓扑结构</li>
<li>其余节点在收到slave的后续交流消息时，发现旧的master负责的槽点，现在被新的master宣布说他负责，则更新自己的拓扑结构。如果是旧master下的slave节点收到消息的话，则会更改自己的master，成为新master的slave</li>
</ol>
<blockquote>
<p>这个过程也可以手动执行，当我们想强制提升一个slave为master的时候</p>
</blockquote>
<h3 id="客户端查询"><a href="#客户端查询" class="headerlink" title="客户端查询"></a>客户端查询</h3><p>连接单点的实例时，我们通常用<code>redis-cli -h xxxx -p xxxx</code>去连接，针对于集群的话，我们需要加上<code>-c</code>参数，在该命令下，如果服务端返回<code>ASK</code>,<code>MOVED</code>命令的话，能够自动切换到对应的节点进行查询，否则的话，会看到一个异常报错。</p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_SLOTS 16384 <span class="comment">//槽点的个数</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_OK 0          <span class="comment">//集群节点状态正常</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_FAIL 1        <span class="comment">//集群节点状态不正常</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_NAMELEN 40    <span class="comment">//集群节点名称长度</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_PORT_INCR 10000 <span class="comment">//集群服务端口偏移量，默认是正常端口加上该偏移量</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//时间相关</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_DEFAULT_NODE_TIMEOUT 15000 <span class="comment">//出现故障时，修复的超时时间</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_DEFAULT_SLAVE_VALIDITY 10 <span class="comment">//从节点和主节点最大数据差因子，当从节点和主节点数据相差很大时，该从节点是不能提升为新的主节点，</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_DEFAULT_REQUIRE_FULL_COVERAGE 1 <span class="comment">//计算集群状态时，是否需要考虑所有槽点是否正常</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_DEFAULT_SLAVE_NO_FAILOVER 0 <span class="comment">//故障修复默认状态，正常</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_FAIL_REPORT_VALIDITY_MULT 2 <span class="comment">//节点汇报失败消息的有效性因子，如果距离节点上一次汇报失败是 CLUSTER_DEFAULT_NODE_TIMEOUT*CLUSTER_FAIL_REPORT_VALIDITY_MULT以上,那么认为该消息是无效的</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_FAIL_UNDO_TIME_MULT 2 <span class="comment">//有效master节点挂掉失效时间因子，如果master挂掉的时间距离现在有CLUSTER_FAIL_UNDO_TIME_MULT*CLUSTER_DEFAULT_NODE_TIMEOUT,那么清除挂掉的标记</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_FAIL_UNDO_TIME_ADD 10 <span class="comment">//没有用到</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_FAILOVER_DELAY 5 <span class="comment">//开始故障修复的延迟时间，现在没有用到</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_DEFAULT_MIGRATION_BARRIER 1 <span class="comment">//master故障时，进行修复所需要最低良好状态的slave节点数量</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_MF_TIMEOUT 5000 <span class="comment">//手动故障转义超时时间</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_MF_PAUSE_MULT 2 <span class="comment">//没有用到</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_SLAVE_MIGRATION_DELAY 5000 <span class="comment">//故障迁移开始的延迟时间</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//命令参数映射到槽点的错误</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_REDIR_NONE 0          <span class="comment">//可以正常服务</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_REDIR_CROSS_SLOT 1    <span class="comment">//命令涉及到跨槽点</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_REDIR_UNSTABLE 2      <span class="comment">//涉及到的槽点正在处于迁入/迁出状态，稍后再试</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_REDIR_ASK 3           <span class="comment">//槽点已经开始迁移</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_REDIR_MOVED 4         <span class="comment">//槽点不属于当前节点</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_REDIR_DOWN_STATE 5    <span class="comment">//节点状态不正常，全方面</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_REDIR_DOWN_UNBOUND 6  <span class="comment">//节点状态不正常，没有负责任何槽点</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">clusterNode</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//节点间交流的连接</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clusterLink</span> &#123;</span></span><br><span class="line">    <span class="keyword">mstime_t</span> ctime;             <span class="comment">//连接创建时间</span></span><br><span class="line">    <span class="keyword">int</span> fd;                     <span class="comment">//socket fd</span></span><br><span class="line">    sds sndbuf;                 <span class="comment">//发送的内容</span></span><br><span class="line">    sds rcvbuf;                 <span class="comment">//收到的内容</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clusterNode</span> *<span class="title">node</span>;</span>   <span class="comment">//相关的节点</span></span><br><span class="line">&#125; clusterLink;</span><br><span class="line"></span><br><span class="line"><span class="comment">//节点标识</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_NODE_MASTER 1     <span class="comment">//master</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_NODE_SLAVE 2      <span class="comment">//slave</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_NODE_PFAIL 4      <span class="comment">//主观下线，自己认为节点下线, possible fail</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_NODE_FAIL 8       <span class="comment">//客观下线，大多数其他master也认为下线了</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_NODE_MYSELF 16    <span class="comment">//自己</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_NODE_HANDSHAKE 32 <span class="comment">//握手中，第一次连接交流</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_NODE_NOADDR   64  <span class="comment">//不知道ip</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_NODE_MEET 128     <span class="comment">//发送meet消息</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_NODE_MIGRATE_TO 256 <span class="comment">//</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_NODE_NOFAILOVER 512 <span class="comment">//slave不会发起故障修复</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_NODE_NULL_NAME <span class="meta-string">&quot;\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000\000&quot;</span> <span class="comment">//节点空名字填充</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> nodeIsMaster(n) ((n)-&gt;flags &amp; CLUSTER_NODE_MASTER) <span class="comment">//节点是否是master</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> nodeIsSlave(n) ((n)-&gt;flags &amp; CLUSTER_NODE_SLAVE) <span class="comment">//节点是否是slave</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> nodeInHandshake(n) ((n)-&gt;flags &amp; CLUSTER_NODE_HANDSHAKE) <span class="comment">//节点是否在握手中</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> nodeHasAddr(n) (!((n)-&gt;flags &amp; CLUSTER_NODE_NOADDR)) <span class="comment">//节点有地址</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> nodeWithoutAddr(n) ((n)-&gt;flags &amp; CLUSTER_NODE_NOADDR) <span class="comment">//节点没地址</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> nodeTimedOut(n) ((n)-&gt;flags &amp; CLUSTER_NODE_PFAIL) <span class="comment">//节点超时</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> nodeFailed(n) ((n)-&gt;flags &amp; CLUSTER_NODE_FAIL) <span class="comment">//节点下线</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> nodeCantFailover(n) ((n)-&gt;flags &amp; CLUSTER_NODE_NOFAILOVER) <span class="comment">//节点能否发起故障修复</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//slave节点不能发起故障修复的原因</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_CANT_FAILOVER_NONE 0 <span class="comment">//没有原因</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_CANT_FAILOVER_DATA_AGE 1 <span class="comment">//跟master的数据量相差太大</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_CANT_FAILOVER_WAITING_DELAY 2 <span class="comment">//还没有到延迟时间</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_CANT_FAILOVER_EXPIRED 3 <span class="comment">//尝试发起，然后过期了</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_CANT_FAILOVER_WAITING_VOTES 4 <span class="comment">//等待其余master投票</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_CANT_FAILOVER_RELOG_PERIOD (60*5) <span class="comment">//相同错误原因记录的间隔，在此期间只记录一条</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//事件循环前要做的事情标识</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_TODO_HANDLE_FAILOVER (1&lt;&lt;0) <span class="comment">//发起故障修复</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_TODO_UPDATE_STATE (1&lt;&lt;1) <span class="comment">//更新自己总的状态ok/fail</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_TODO_SAVE_CONFIG (1&lt;&lt;2) <span class="comment">//保存集群配置</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_TODO_FSYNC_CONFIG (1&lt;&lt;3) <span class="comment">//flush配置到磁盘</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//节点间消息类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_TYPE_PING 0          <span class="comment">//ping</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_TYPE_PONG 1          <span class="comment">//pong,对ping的回复</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_TYPE_MEET 2          <span class="comment">//meet,和ping一样，不一样的是，接收方会把发送方当做集群中的节点保存下来</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_TYPE_FAIL 3          <span class="comment">//标记某个节点fail</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_TYPE_PUBLISH 4       <span class="comment">//发布</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST 5 <span class="comment">//slave节点询问自己能否主导故障修复</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK 6     <span class="comment">//master节点回复slave可以的</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_TYPE_UPDATE 7        <span class="comment">//节点配置有更新</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_TYPE_MFSTART 8       <span class="comment">//暂停手动故障修复</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_TYPE_MODULE 9        <span class="comment">//模块消息</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_TYPE_COUNT 10        <span class="comment">//消息类型的总数量</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//模块的标识</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_MODULE_FLAG_NONE 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_MODULE_FLAG_NO_FAILOVER (1&lt;&lt;1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_MODULE_FLAG_NO_REDIRECTION (1&lt;&lt;2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//汇报节点下线消息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clusterNodeFailReport</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clusterNode</span> *<span class="title">node</span>;</span>  <span class="comment">//下线状态的节点</span></span><br><span class="line">    <span class="keyword">mstime_t</span> time;             <span class="comment">//上一次汇报的时间</span></span><br><span class="line">&#125; clusterNodeFailReport;</span><br><span class="line"></span><br><span class="line"><span class="comment">//节点</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clusterNode</span> &#123;</span></span><br><span class="line">    <span class="keyword">mstime_t</span> ctime; <span class="comment">//创建时间</span></span><br><span class="line">    <span class="keyword">char</span> name[CLUSTER_NAMELEN]; <span class="comment">//节点名称</span></span><br><span class="line">    <span class="keyword">int</span> flags;      <span class="comment">//节点标志，参见CLUSTER_NODE_*</span></span><br><span class="line">    <span class="keyword">uint64_t</span> configEpoch; <span class="comment">//配置纪元</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> slots[CLUSTER_SLOTS/<span class="number">8</span>]; <span class="comment">//节点负责的槽点bitmap</span></span><br><span class="line">    <span class="keyword">int</span> numslots;   <span class="comment">//负责槽点数量</span></span><br><span class="line">    <span class="keyword">int</span> numslaves;  <span class="comment">//从节点个数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clusterNode</span> **<span class="title">slaves</span>;</span> <span class="comment">//当前是主节点的话，对应从节点列表</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">clusterNode</span> *<span class="title">slaveof</span>;</span> <span class="comment">//当前是从节点的话，对应的主节点</span></span><br><span class="line">    <span class="keyword">mstime_t</span> ping_sent;      <span class="comment">//最近发送ping的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> pong_received;  <span class="comment">//最近收到pong的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> fail_time;      <span class="comment">//标记下线的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> voted_time;     <span class="comment">//当前是master, 上一次对其slave投票时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> repl_offset_time;  <span class="comment">//最近收到同步的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> orphaned_time;     <span class="comment">//对于masterl来说，所有slave都挂掉的时间,</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> repl_offset;      <span class="comment">//最近的同步便宜量</span></span><br><span class="line">    <span class="keyword">char</span> ip[NET_IP_STR_LEN];  <span class="comment">//ip</span></span><br><span class="line">    <span class="keyword">int</span> port;                   <span class="comment">//正常端口</span></span><br><span class="line">    <span class="keyword">int</span> cport;                  <span class="comment">//集群端口</span></span><br><span class="line">    clusterLink *link;          <span class="comment">//交流连接</span></span><br><span class="line">    <span class="built_in">list</span> *fail_reports;         <span class="comment">//汇报当前节点挂掉的报告</span></span><br><span class="line">&#125; clusterNode;</span><br><span class="line"></span><br><span class="line"><span class="comment">//集群状态</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">clusterState</span> &#123;</span></span><br><span class="line">    clusterNode *myself;  <span class="comment">//自己</span></span><br><span class="line">    <span class="keyword">uint64_t</span> currentEpoch; <span class="comment">//当前纪元</span></span><br><span class="line">    <span class="keyword">int</span> state;            <span class="comment">//状态，ok/fail</span></span><br><span class="line">    <span class="keyword">int</span> size;             <span class="comment">//至少有一个槽点的master数量</span></span><br><span class="line">    dict *nodes;          <span class="comment">//所有节点 name-&gt;node</span></span><br><span class="line">    dict *nodes_black_list; <span class="comment">//不会重新加入到nodes的节点</span></span><br><span class="line">    clusterNode *migrating_slots_to[CLUSTER_SLOTS]; <span class="comment">//迁出的槽点映射</span></span><br><span class="line">    clusterNode *importing_slots_from[CLUSTER_SLOTS]; <span class="comment">//迁入的槽点映射</span></span><br><span class="line">    clusterNode *slots[CLUSTER_SLOTS]; <span class="comment">//所有槽点路由表</span></span><br><span class="line">    <span class="keyword">uint64_t</span> slots_keys_count[CLUSTER_SLOTS]; <span class="comment">//每个槽点的key数量</span></span><br><span class="line">    rax *slots_to_keys;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//slave选举用到的</span></span><br><span class="line">    <span class="keyword">mstime_t</span> failover_auth_time; <span class="comment">//发起选举的时间</span></span><br><span class="line">    <span class="keyword">int</span> failover_auth_count;    <span class="comment">//同意自己选举的数量</span></span><br><span class="line">    <span class="keyword">int</span> failover_auth_sent;     <span class="comment">//是否已经发送选举自己请求</span></span><br><span class="line">    <span class="keyword">int</span> failover_auth_rank;     <span class="comment">//选举排名</span></span><br><span class="line">    <span class="keyword">uint64_t</span> failover_auth_epoch; <span class="comment">//选举的纪元</span></span><br><span class="line">    <span class="keyword">int</span> cant_failover_reason;   <span class="comment">//不能发起故障修复的原因</span></span><br><span class="line">    <span class="keyword">mstime_t</span> mf_end;            <span class="comment">//手动发起修复的结束时间，0标识没有</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//master</span></span><br><span class="line">    clusterNode *mf_slave;      <span class="comment">//主导故障修复的slave</span></span><br><span class="line">    <span class="comment">//slave</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> mf_master_offset; <span class="comment">//手动修复同步开始的偏移量</span></span><br><span class="line">    <span class="keyword">int</span> mf_can_start;           <span class="comment">//是否可以手动修复</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//master记录自己投票情况</span></span><br><span class="line">    <span class="keyword">uint64_t</span> lastVoteEpoch;     <span class="comment">//最近一次投票纪元</span></span><br><span class="line">    <span class="keyword">int</span> todo_before_sleep; <span class="comment">//clusterBeforeSleep要做的事情标记</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//统计信息</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> stats_bus_messages_sent[CLUSTERMSG_TYPE_COUNT]; <span class="comment">//发送的各种类型消息数量</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> stats_bus_messages_received[CLUSTERMSG_TYPE_COUNT]; <span class="comment">//接收的各种类型消息数量</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> stats_pfail_nodes;    <span class="comment">//被标记成下线的节点数量，包括没有地址的</span></span><br><span class="line">&#125; clusterState;</span><br><span class="line"></span><br><span class="line"><span class="comment">//节点通信gossip消息，字段参照clusterNode</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> nodename[CLUSTER_NAMELEN];</span><br><span class="line">    <span class="keyword">uint32_t</span> ping_sent;</span><br><span class="line">    <span class="keyword">uint32_t</span> pong_received;</span><br><span class="line">    <span class="keyword">char</span> ip[NET_IP_STR_LEN];</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint16_t</span> cport;</span><br><span class="line">    <span class="keyword">uint16_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> notused1;</span><br><span class="line">&#125; clusterMsgDataGossip;</span><br><span class="line"></span><br><span class="line"><span class="comment">//节点挂掉消息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> nodename[CLUSTER_NAMELEN];</span><br><span class="line">&#125; clusterMsgDataFail;</span><br><span class="line"></span><br><span class="line"><span class="comment">//发布消息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> channel_len;</span><br><span class="line">    <span class="keyword">uint32_t</span> message_len;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> bulk_data[<span class="number">8</span>];</span><br><span class="line">&#125; clusterMsgDataPublish;</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新配置消息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> configEpoch; <span class="comment">//配置纪元</span></span><br><span class="line">    <span class="keyword">char</span> nodename[CLUSTER_NAMELEN];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> slots[CLUSTER_SLOTS/<span class="number">8</span>];</span><br><span class="line">&#125; clusterMsgDataUpdate;</span><br><span class="line"></span><br><span class="line"><span class="comment">//模块消息</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> module_id;</span><br><span class="line">    <span class="keyword">uint32_t</span> len;</span><br><span class="line">    <span class="keyword">uint8_t</span> type;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> bulk_data[<span class="number">3</span>];</span><br><span class="line">&#125; clusterMsgModule;</span><br><span class="line"></span><br><span class="line"><span class="comment">//消息内容</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">clusterMsgData</span> &#123;</span></span><br><span class="line">    <span class="comment">//ping,pong,meet三个都是一样的</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        clusterMsgDataGossip gossip[<span class="number">1</span>];</span><br><span class="line">    &#125; ping;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//挂掉</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        clusterMsgDataFail about;</span><br><span class="line">    &#125; fail;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发布</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        clusterMsgDataPublish msg;</span><br><span class="line">    &#125; publish;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新配置</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        clusterMsgDataUpdate nodecfg;</span><br><span class="line">    &#125; update;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//模块</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        clusterMsgModule msg;</span><br><span class="line">    &#125; <span class="keyword">module</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_PROTO_VER 1 <span class="comment">//消息协议版本</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//完整的消息体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> sig[<span class="number">4</span>];        <span class="comment">//固定的&quot;RCmb&quot; (Redis Cluster message bus)</span></span><br><span class="line">    <span class="keyword">uint32_t</span> totlen;    <span class="comment">//消息总长度</span></span><br><span class="line">    <span class="keyword">uint16_t</span> ver;       <span class="comment">//协议版本</span></span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint16_t</span> type;      <span class="comment">//消息类型</span></span><br><span class="line">    <span class="keyword">uint16_t</span> count;     <span class="comment">//消息具体内容的数量，只针对部分消息</span></span><br><span class="line">    <span class="keyword">uint64_t</span> currentEpoch;  <span class="comment">//发送方的纪元</span></span><br><span class="line">    <span class="keyword">uint64_t</span> configEpoch;   <span class="comment">//配置纪元</span></span><br><span class="line">    <span class="keyword">uint64_t</span> offset;    <span class="comment">//同步偏移量</span></span><br><span class="line">    <span class="keyword">char</span> sender[CLUSTER_NAMELEN];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> myslots[CLUSTER_SLOTS/<span class="number">8</span>]; <span class="comment">//发送方负责的槽点</span></span><br><span class="line">    <span class="keyword">char</span> slaveof[CLUSTER_NAMELEN];</span><br><span class="line">    <span class="keyword">char</span> myip[NET_IP_STR_LEN]; <span class="comment">//发送方ip</span></span><br><span class="line">    <span class="keyword">char</span> notused1[<span class="number">34</span>];  <span class="comment">//未使用</span></span><br><span class="line">    <span class="keyword">uint16_t</span> cport;      <span class="comment">//集群端口</span></span><br><span class="line">    <span class="keyword">uint16_t</span> flags;      <span class="comment">//发送方标志</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> state;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> mflags[<span class="number">3</span>];</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">clusterMsgData</span> <span class="title">data</span>;</span> <span class="comment">//具体消息</span></span><br><span class="line">&#125; clusterMsg;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_MIN_LEN (sizeof(clusterMsg)-sizeof(union clusterMsgData)) <span class="comment">//消息最低长度</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_FLAG0_PAUSED (1&lt;&lt;0) <span class="comment">//master暂停，由于手动修复</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTERMSG_FLAG0_FORCEACK (1&lt;&lt;1) <span class="comment">//master正常的话，强制回复</span></span></span><br></pre></td></tr></table></figure>

<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><h5 id="clusterLoadConfig"><a href="#clusterLoadConfig" class="headerlink" title="clusterLoadConfig"></a>clusterLoadConfig</h5><p>从文件中加载集群配置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterLoadConfig</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123;</span><br><span class="line">    FILE *fp = fopen(filename,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">sb</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *line;</span><br><span class="line">    <span class="keyword">int</span> maxline, j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == ENOENT) &#123;</span><br><span class="line">            <span class="keyword">return</span> C_ERR;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">&quot;Loading the cluster node config from %s: %s&quot;</span>,</span><br><span class="line">                filename, strerror(errno));</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查0长度文件</span></span><br><span class="line">    <span class="keyword">if</span> (fstat(fileno(fp),&amp;sb) != <span class="number">-1</span> &amp;&amp; sb.st_size == <span class="number">0</span>) &#123;</span><br><span class="line">        fclose(fp);</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    maxline = <span class="number">1024</span>+CLUSTER_SLOTS*<span class="number">128</span>;</span><br><span class="line">    line = zmalloc(maxline);</span><br><span class="line">    <span class="keyword">while</span>(fgets(line,maxline,fp) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> argc;</span><br><span class="line">        sds *argv;</span><br><span class="line">        clusterNode *n, *master;</span><br><span class="line">        <span class="keyword">char</span> *p, *s;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//跳过无效行</span></span><br><span class="line">        <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;\n&#x27;</span> || line[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        argv = sdssplitargs(line,&amp;argc);</span><br><span class="line">        <span class="keyword">if</span> (argv == <span class="literal">NULL</span>) <span class="keyword">goto</span> fmterr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//处理变量</span></span><br><span class="line">        <span class="keyword">if</span> (strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;vars&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; argc; j += <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (strcasecmp(argv[j],<span class="string">&quot;currentEpoch&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    server.cluster-&gt;currentEpoch =</span><br><span class="line">                            strtoull(argv[j+<span class="number">1</span>],<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcasecmp(argv[j],<span class="string">&quot;lastVoteEpoch&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    server.cluster-&gt;lastVoteEpoch =</span><br><span class="line">                            strtoull(argv[j+<span class="number">1</span>],<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    serverLog(LL_WARNING,</span><br><span class="line">                        <span class="string">&quot;Skipping unknown cluster config variable &#x27;%s&#x27;&quot;</span>,</span><br><span class="line">                        argv[j]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sdsfreesplitres(argv,argc);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//最小长度</span></span><br><span class="line">        <span class="keyword">if</span> (argc &lt; <span class="number">8</span>) <span class="keyword">goto</span> fmterr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建节点</span></span><br><span class="line">        n = clusterLookupNode(argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!n) &#123;</span><br><span class="line">            n = createClusterNode(argv[<span class="number">0</span>],<span class="number">0</span>);</span><br><span class="line">            clusterAddNode(n);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ip&amp;port</span></span><br><span class="line">        <span class="keyword">if</span> ((p = <span class="built_in">strrchr</span>(argv[<span class="number">1</span>],<span class="string">&#x27;:&#x27;</span>)) == <span class="literal">NULL</span>) <span class="keyword">goto</span> fmterr;</span><br><span class="line">        *p = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(n-&gt;ip,argv[<span class="number">1</span>],<span class="built_in">strlen</span>(argv[<span class="number">1</span>])+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">char</span> *port = p+<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">char</span> *busp = <span class="built_in">strchr</span>(port,<span class="string">&#x27;@&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (busp) &#123;</span><br><span class="line">            *busp = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            busp++;</span><br><span class="line">        &#125;</span><br><span class="line">        n-&gt;port = atoi(port);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//集群端口</span></span><br><span class="line">        n-&gt;cport = busp ? atoi(busp) : n-&gt;port + CLUSTER_PORT_INCR;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//标志位</span></span><br><span class="line">        p = s = argv[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">while</span>(p) &#123;</span><br><span class="line">            p = <span class="built_in">strchr</span>(s,<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (p) *p = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span> (!strcasecmp(s,<span class="string">&quot;myself&quot;</span>)) &#123;</span><br><span class="line">                serverAssert(server.cluster-&gt;myself == <span class="literal">NULL</span>);</span><br><span class="line">                myself = server.cluster-&gt;myself = n;</span><br><span class="line">                n-&gt;flags |= CLUSTER_NODE_MYSELF;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(s,<span class="string">&quot;master&quot;</span>)) &#123;</span><br><span class="line">                n-&gt;flags |= CLUSTER_NODE_MASTER;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(s,<span class="string">&quot;slave&quot;</span>)) &#123;</span><br><span class="line">                n-&gt;flags |= CLUSTER_NODE_SLAVE;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(s,<span class="string">&quot;fail?&quot;</span>)) &#123;</span><br><span class="line">                n-&gt;flags |= CLUSTER_NODE_PFAIL;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(s,<span class="string">&quot;fail&quot;</span>)) &#123;</span><br><span class="line">                n-&gt;flags |= CLUSTER_NODE_FAIL;</span><br><span class="line">                n-&gt;fail_time = mstime();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(s,<span class="string">&quot;handshake&quot;</span>)) &#123;</span><br><span class="line">                n-&gt;flags |= CLUSTER_NODE_HANDSHAKE;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(s,<span class="string">&quot;noaddr&quot;</span>)) &#123;</span><br><span class="line">                n-&gt;flags |= CLUSTER_NODE_NOADDR;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(s,<span class="string">&quot;nofailover&quot;</span>)) &#123;</span><br><span class="line">                n-&gt;flags |= CLUSTER_NODE_NOFAILOVER;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(s,<span class="string">&quot;noflags&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">/* nothing to do */</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                serverPanic(<span class="string">&quot;Unknown flag in redis cluster config file&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (p) s = p+<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置slave对应master</span></span><br><span class="line">        <span class="keyword">if</span> (argv[<span class="number">3</span>][<span class="number">0</span>] != <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">            master = clusterLookupNode(argv[<span class="number">3</span>]);</span><br><span class="line">            <span class="keyword">if</span> (!master) &#123;</span><br><span class="line">                master = createClusterNode(argv[<span class="number">3</span>],<span class="number">0</span>);</span><br><span class="line">                clusterAddNode(master);</span><br><span class="line">            &#125;</span><br><span class="line">            n-&gt;slaveof = master;</span><br><span class="line">            clusterNodeAddSlave(master,n);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ping/pong time</span></span><br><span class="line">        <span class="keyword">if</span> (atoi(argv[<span class="number">4</span>])) n-&gt;ping_sent = mstime();</span><br><span class="line">        <span class="keyword">if</span> (atoi(argv[<span class="number">5</span>])) n-&gt;pong_received = mstime();</span><br><span class="line"></span><br><span class="line">        n-&gt;configEpoch = strtoull(argv[<span class="number">6</span>],<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//负责的哈希槽</span></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">8</span>; j &lt; argc; j++) &#123;</span><br><span class="line">            <span class="keyword">int</span> start, stop;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (argv[j][<span class="number">0</span>] == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">/* Here we handle migrating / importing slots */</span></span><br><span class="line">                <span class="keyword">int</span> slot;</span><br><span class="line">                <span class="keyword">char</span> direction;</span><br><span class="line">                clusterNode *cn;</span><br><span class="line"></span><br><span class="line">                p = <span class="built_in">strchr</span>(argv[j],<span class="string">&#x27;-&#x27;</span>);</span><br><span class="line">                serverAssert(p != <span class="literal">NULL</span>);</span><br><span class="line">                *p = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                direction = p[<span class="number">1</span>]; <span class="comment">/* Either &#x27;&gt;&#x27; or &#x27;&lt;&#x27; */</span></span><br><span class="line">                slot = atoi(argv[j]+<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (slot &lt; <span class="number">0</span> || slot &gt;= CLUSTER_SLOTS) <span class="keyword">goto</span> fmterr;</span><br><span class="line">                p += <span class="number">3</span>;</span><br><span class="line">                cn = clusterLookupNode(p);</span><br><span class="line">                <span class="keyword">if</span> (!cn) &#123;</span><br><span class="line">                    cn = createClusterNode(p,<span class="number">0</span>);</span><br><span class="line">                    clusterAddNode(cn);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (direction == <span class="string">&#x27;&gt;&#x27;</span>) &#123;</span><br><span class="line">                    server.cluster-&gt;migrating_slots_to[slot] = cn;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    server.cluster-&gt;importing_slots_from[slot] = cn;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((p = <span class="built_in">strchr</span>(argv[j],<span class="string">&#x27;-&#x27;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                *p = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                start = atoi(argv[j]);</span><br><span class="line">                stop = atoi(p+<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                start = stop = atoi(argv[j]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (start &lt; <span class="number">0</span> || start &gt;= CLUSTER_SLOTS) <span class="keyword">goto</span> fmterr;</span><br><span class="line">            <span class="keyword">if</span> (stop &lt; <span class="number">0</span> || stop &gt;= CLUSTER_SLOTS) <span class="keyword">goto</span> fmterr;</span><br><span class="line">            <span class="keyword">while</span>(start &lt;= stop) clusterAddSlot(n, start++);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sdsfreesplitres(argv,argc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;myself == <span class="literal">NULL</span>) <span class="keyword">goto</span> fmterr;</span><br><span class="line"></span><br><span class="line">    zfree(line);</span><br><span class="line">    fclose(fp);</span><br><span class="line"></span><br><span class="line">    serverLog(LL_NOTICE,<span class="string">&quot;Node configuration loaded, I&#x27;m %.40s&quot;</span>, myself-&gt;name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clusterGetMaxEpoch() &gt; server.cluster-&gt;currentEpoch) &#123;</span><br><span class="line">        server.cluster-&gt;currentEpoch = clusterGetMaxEpoch();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line"></span><br><span class="line">fmterr:</span><br><span class="line">    serverLog(LL_WARNING,</span><br><span class="line">        <span class="string">&quot;Unrecoverable error: corrupted cluster config file.&quot;</span>);</span><br><span class="line">    zfree(line);</span><br><span class="line">    <span class="keyword">if</span> (fp) fclose(fp);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterSaveConfig"><a href="#clusterSaveConfig" class="headerlink" title="clusterSaveConfig"></a>clusterSaveConfig</h5><p>保存集群配置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterSaveConfig</span><span class="params">(<span class="keyword">int</span> do_fsync)</span> </span>&#123;</span><br><span class="line">    sds ci;</span><br><span class="line">    <span class="keyword">size_t</span> content_size;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">sb</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">    server.cluster-&gt;todo_before_sleep &amp;= ~CLUSTER_TODO_SAVE_CONFIG;</span><br><span class="line"></span><br><span class="line">    ci = clusterGenNodesDescription(CLUSTER_NODE_HANDSHAKE);</span><br><span class="line">    ci = sdscatprintf(ci,<span class="string">&quot;vars currentEpoch %llu lastVoteEpoch %llu\n&quot;</span>,</span><br><span class="line">        (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) server.cluster-&gt;currentEpoch,</span><br><span class="line">        (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) server.cluster-&gt;lastVoteEpoch);</span><br><span class="line">    content_size = sdslen(ci);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fd = open(server.cluster_configfile,O_WRONLY|O_CREAT,<span class="number">0644</span>))</span><br><span class="line">        == <span class="number">-1</span>) <span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fstat(fd,&amp;sb) != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sb.st_size &gt; (<span class="keyword">off_t</span>)content_size) &#123;</span><br><span class="line">            ci = sdsgrowzero(ci,sb.st_size);</span><br><span class="line">            <span class="built_in">memset</span>(ci+content_size,<span class="string">&#x27;\n&#x27;</span>,sb.st_size-content_size);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (write(fd,ci,sdslen(ci)) != (<span class="keyword">ssize_t</span>)sdslen(ci)) <span class="keyword">goto</span> err;</span><br><span class="line">    <span class="keyword">if</span> (do_fsync) &#123;</span><br><span class="line">        server.cluster-&gt;todo_before_sleep &amp;= ~CLUSTER_TODO_FSYNC_CONFIG;</span><br><span class="line">        fsync(fd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (content_size != sdslen(ci) &amp;&amp; ftruncate(fd,content_size) == <span class="number">-1</span>) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    sdsfree(ci);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="number">-1</span>) close(fd);</span><br><span class="line">    sdsfree(ci);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterSaveConfigOrDie"><a href="#clusterSaveConfigOrDie" class="headerlink" title="clusterSaveConfigOrDie"></a>clusterSaveConfigOrDie</h5><p>保存配置文件，失败的话退出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterSaveConfigOrDie</span><span class="params">(<span class="keyword">int</span> do_fsync)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (clusterSaveConfig(do_fsync) == <span class="number">-1</span>) &#123;</span><br><span class="line">        serverLog(LL_WARNING,<span class="string">&quot;Fatal: can&#x27;t update cluster config file.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterLockConfig"><a href="#clusterLockConfig" class="headerlink" title="clusterLockConfig"></a>clusterLockConfig</h5><p>对配置文件进行加锁，防止多个实例使用同一个集群配置文件，使用文件锁</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterLockConfig</span><span class="params">(<span class="keyword">char</span> *filename)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(__sun)</span></span><br><span class="line">    <span class="comment">//使用文件所</span></span><br><span class="line">    <span class="keyword">int</span> fd = open(filename,O_WRONLY|O_CREAT,<span class="number">0644</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Can&#x27;t open %s in order to acquire a lock: %s&quot;</span>,</span><br><span class="line">            filename, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flock(fd,LOCK_EX|LOCK_NB) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EWOULDBLOCK) &#123;</span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                 <span class="string">&quot;Sorry, the cluster configuration file %s is already used &quot;</span></span><br><span class="line">                 <span class="string">&quot;by a different Redis Cluster node. Please make sure that &quot;</span></span><br><span class="line">                 <span class="string">&quot;different nodes use different cluster configuration &quot;</span></span><br><span class="line">                 <span class="string">&quot;files.&quot;</span>, filename);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">&quot;Impossible to lock %s: %s&quot;</span>, filename, strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __sun */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterUpdateMyselfFlags"><a href="#clusterUpdateMyselfFlags" class="headerlink" title="clusterUpdateMyselfFlags"></a>clusterUpdateMyselfFlags</h5><p>更新自身的标志</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterUpdateMyselfFlags</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> oldflags = myself-&gt;flags;</span><br><span class="line">    <span class="keyword">int</span> nofailover = server.cluster_slave_no_failover ?</span><br><span class="line">                     CLUSTER_NODE_NOFAILOVER : <span class="number">0</span>;</span><br><span class="line">    myself-&gt;flags &amp;= ~CLUSTER_NODE_NOFAILOVER;</span><br><span class="line">    myself-&gt;flags |= nofailover;</span><br><span class="line">    <span class="keyword">if</span> (myself-&gt;flags != oldflags) &#123;</span><br><span class="line">        clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                             CLUSTER_TODO_UPDATE_STATE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterInit"><a href="#clusterInit" class="headerlink" title="clusterInit"></a>clusterInit</h5><p>集群初始化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterInit</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> saveconf = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    server.cluster = zmalloc(<span class="keyword">sizeof</span>(clusterState));</span><br><span class="line">    server.cluster-&gt;myself = <span class="literal">NULL</span>;</span><br><span class="line">    server.cluster-&gt;currentEpoch = <span class="number">0</span>;</span><br><span class="line">    server.cluster-&gt;state = CLUSTER_FAIL;</span><br><span class="line">    server.cluster-&gt;size = <span class="number">1</span>;</span><br><span class="line">    server.cluster-&gt;todo_before_sleep = <span class="number">0</span>;</span><br><span class="line">    server.cluster-&gt;nodes = dictCreate(&amp;clusterNodesDictType,<span class="literal">NULL</span>);</span><br><span class="line">    server.cluster-&gt;nodes_black_list =</span><br><span class="line">        dictCreate(&amp;clusterNodesBlackListDictType,<span class="literal">NULL</span>);</span><br><span class="line">    server.cluster-&gt;failover_auth_time = <span class="number">0</span>;</span><br><span class="line">    server.cluster-&gt;failover_auth_count = <span class="number">0</span>;</span><br><span class="line">    server.cluster-&gt;failover_auth_rank = <span class="number">0</span>;</span><br><span class="line">    server.cluster-&gt;failover_auth_epoch = <span class="number">0</span>;</span><br><span class="line">    server.cluster-&gt;cant_failover_reason = CLUSTER_CANT_FAILOVER_NONE;</span><br><span class="line">    server.cluster-&gt;lastVoteEpoch = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CLUSTERMSG_TYPE_COUNT; i++) &#123;</span><br><span class="line">        server.cluster-&gt;stats_bus_messages_sent[i] = <span class="number">0</span>;</span><br><span class="line">        server.cluster-&gt;stats_bus_messages_received[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    server.cluster-&gt;stats_pfail_nodes = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(server.cluster-&gt;slots,<span class="number">0</span>, <span class="keyword">sizeof</span>(server.cluster-&gt;slots));</span><br><span class="line">    clusterCloseAllSlots();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//确保每个实例使用单独的配置</span></span><br><span class="line">    <span class="keyword">if</span> (clusterLockConfig(server.cluster_configfile) == C_ERR)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载配置</span></span><br><span class="line">    <span class="keyword">if</span> (clusterLoadConfig(server.cluster_configfile) == C_ERR) &#123;</span><br><span class="line">        <span class="comment">//创建自身节点</span></span><br><span class="line">        myself = server.cluster-&gt;myself =</span><br><span class="line">            createClusterNode(<span class="literal">NULL</span>,CLUSTER_NODE_MYSELF|CLUSTER_NODE_MASTER);</span><br><span class="line">        serverLog(LL_NOTICE,<span class="string">&quot;No cluster configuration found, I&#x27;m %.40s&quot;</span>,</span><br><span class="line">            myself-&gt;name);</span><br><span class="line">        clusterAddNode(myself);</span><br><span class="line">        saveconf = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (saveconf) clusterSaveConfigOrDie(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    server.cfd_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查集群端口上限</span></span><br><span class="line">    <span class="keyword">if</span> (server.port &gt; (<span class="number">65535</span>-CLUSTER_PORT_INCR)) &#123;</span><br><span class="line">        serverLog(LL_WARNING, <span class="string">&quot;Redis port number too high. &quot;</span></span><br><span class="line">                   <span class="string">&quot;Cluster communication port is 10,000 port &quot;</span></span><br><span class="line">                   <span class="string">&quot;numbers higher than your Redis port. &quot;</span></span><br><span class="line">                   <span class="string">&quot;Your Redis port number must be &quot;</span></span><br><span class="line">                   <span class="string">&quot;lower than 55535.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//监听端口</span></span><br><span class="line">    <span class="keyword">if</span> (listenToPort(server.port+CLUSTER_PORT_INCR,</span><br><span class="line">        server.cfd,&amp;server.cfd_count) == C_ERR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//连接处理</span></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.cfd_count; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (aeCreateFileEvent(server.el, server.cfd[j], AE_READABLE,</span><br><span class="line">                clusterAcceptHandler, <span class="literal">NULL</span>) == AE_ERR)</span><br><span class="line">                    serverPanic(<span class="string">&quot;Unrecoverable error creating Redis Cluster &quot;</span></span><br><span class="line">                                <span class="string">&quot;file event.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//槽点路由表</span></span><br><span class="line">    server.cluster-&gt;slots_to_keys = raxNew();</span><br><span class="line">    <span class="built_in">memset</span>(server.cluster-&gt;slots_keys_count,<span class="number">0</span>,</span><br><span class="line">           <span class="keyword">sizeof</span>(server.cluster-&gt;slots_keys_count));</span><br><span class="line"></span><br><span class="line">    myself-&gt;port = server.port;</span><br><span class="line">    myself-&gt;cport = server.port+CLUSTER_PORT_INCR;</span><br><span class="line">    <span class="keyword">if</span> (server.cluster_announce_port)</span><br><span class="line">        myself-&gt;port = server.cluster_announce_port;</span><br><span class="line">    <span class="keyword">if</span> (server.cluster_announce_bus_port)</span><br><span class="line">        myself-&gt;cport = server.cluster_announce_bus_port;</span><br><span class="line"></span><br><span class="line">    server.cluster-&gt;mf_end = <span class="number">0</span>;</span><br><span class="line">    resetManualFailover();</span><br><span class="line">    clusterUpdateMyselfFlags();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterReset"><a href="#clusterReset" class="headerlink" title="clusterReset"></a>clusterReset</h5><p>集群重置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterReset</span><span class="params">(<span class="keyword">int</span> hard)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重置成master</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsSlave(myself)) &#123;</span><br><span class="line">        clusterSetNodeAsMaster(myself);</span><br><span class="line">        replicationUnsetMaster();</span><br><span class="line">        <span class="comment">//清空db</span></span><br><span class="line">        emptyDb(<span class="number">-1</span>,EMPTYDB_NO_FLAGS,<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭槽点&amp;故障修复</span></span><br><span class="line">    clusterCloseAllSlots();</span><br><span class="line">    resetManualFailover();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) clusterDelSlot(j);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//剔除所有节点</span></span><br><span class="line">    di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        clusterNode *node = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node == myself) <span class="keyword">continue</span>;</span><br><span class="line">        clusterDelNode(node);</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//hard模式，设置纪元为0，清空节点名称</span></span><br><span class="line">    <span class="keyword">if</span> (hard) &#123;</span><br><span class="line">        sds oldname;</span><br><span class="line"></span><br><span class="line">        server.cluster-&gt;currentEpoch = <span class="number">0</span>;</span><br><span class="line">        server.cluster-&gt;lastVoteEpoch = <span class="number">0</span>;</span><br><span class="line">        myself-&gt;configEpoch = <span class="number">0</span>;</span><br><span class="line">        serverLog(LL_WARNING, <span class="string">&quot;configEpoch set to 0 via CLUSTER RESET HARD&quot;</span>);</span><br><span class="line"></span><br><span class="line">        oldname = sdsnewlen(myself-&gt;name, CLUSTER_NAMELEN);</span><br><span class="line">        dictDelete(server.cluster-&gt;nodes,oldname);</span><br><span class="line">        sdsfree(oldname);</span><br><span class="line">        getRandomHexChars(myself-&gt;name, CLUSTER_NAMELEN);</span><br><span class="line">        clusterAddNode(myself);</span><br><span class="line">        serverLog(LL_NOTICE,<span class="string">&quot;Node hard reset, now I&#x27;m %.40s&quot;</span>, myself-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                         CLUSTER_TODO_UPDATE_STATE|</span><br><span class="line">                         CLUSTER_TODO_FSYNC_CONFIG);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="节点交流连接"><a href="#节点交流连接" class="headerlink" title="节点交流连接"></a>节点交流连接</h4><h5 id="createClusterLink"><a href="#createClusterLink" class="headerlink" title="createClusterLink"></a>createClusterLink</h5><p>创建连接</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">clusterLink *<span class="title">createClusterLink</span><span class="params">(clusterNode *node)</span> </span>&#123;</span><br><span class="line">    clusterLink *link = zmalloc(<span class="keyword">sizeof</span>(*link));</span><br><span class="line">    link-&gt;ctime = mstime();</span><br><span class="line">    link-&gt;sndbuf = sdsempty();</span><br><span class="line">    link-&gt;rcvbuf = sdsempty();</span><br><span class="line">    link-&gt;node = node;</span><br><span class="line">    link-&gt;fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> link;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="freeClusterLink"><a href="#freeClusterLink" class="headerlink" title="freeClusterLink"></a>freeClusterLink</h5><p>释放连接</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freeClusterLink</span><span class="params">(clusterLink *link)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (link-&gt;fd != <span class="number">-1</span>) &#123;</span><br><span class="line">        aeDeleteFileEvent(server.el, link-&gt;fd, AE_READABLE|AE_WRITABLE);</span><br><span class="line">    &#125;</span><br><span class="line">    sdsfree(link-&gt;sndbuf);</span><br><span class="line">    sdsfree(link-&gt;rcvbuf);</span><br><span class="line">    <span class="keyword">if</span> (link-&gt;node)</span><br><span class="line">        link-&gt;node-&gt;link = <span class="literal">NULL</span>;</span><br><span class="line">    close(link-&gt;fd);</span><br><span class="line">    zfree(link);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterAcceptHandler"><a href="#clusterAcceptHandler" class="headerlink" title="clusterAcceptHandler"></a>clusterAcceptHandler</h5><p>客户端初次连接处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_CLUSTER_ACCEPTS_PER_CALL 1000</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterAcceptHandler</span><span class="params">(aeEventLoop *el, <span class="keyword">int</span> fd, <span class="keyword">void</span> *privdata, <span class="keyword">int</span> mask)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cport, cfd;</span><br><span class="line">    <span class="keyword">int</span> max = MAX_CLUSTER_ACCEPTS_PER_CALL;</span><br><span class="line">    <span class="keyword">char</span> cip[NET_IP_STR_LEN];</span><br><span class="line">    clusterLink *link;</span><br><span class="line">    UNUSED(el);</span><br><span class="line">    UNUSED(mask);</span><br><span class="line">    UNUSED(privdata);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载中</span></span><br><span class="line">    <span class="keyword">if</span> (server.masterhost == <span class="literal">NULL</span> &amp;&amp; server.loading) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(max--) &#123;</span><br><span class="line">        cfd = anetTcpAccept(server.neterr, fd, cip, <span class="keyword">sizeof</span>(cip), &amp;cport);</span><br><span class="line">        <span class="keyword">if</span> (cfd == ANET_ERR) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno != EWOULDBLOCK)</span><br><span class="line">                serverLog(LL_VERBOSE,</span><br><span class="line">                    <span class="string">&quot;Error accepting cluster node: %s&quot;</span>, server.neterr);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更改连接为不阻塞&amp;无延迟</span></span><br><span class="line">        anetNonBlock(<span class="literal">NULL</span>,cfd);</span><br><span class="line">        anetEnableTcpNoDelay(<span class="literal">NULL</span>,cfd);</span><br><span class="line"> </span><br><span class="line">        serverLog(LL_VERBOSE,<span class="string">&quot;Accepted cluster node %s:%d&quot;</span>, cip, cport);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//创建连接</span></span><br><span class="line">        link = createClusterLink(<span class="literal">NULL</span>);</span><br><span class="line">        link-&gt;fd = cfd;</span><br><span class="line">        aeCreateFileEvent(server.el,cfd,AE_READABLE,clusterReadHandler,link);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="键值哈希处理"><a href="#键值哈希处理" class="headerlink" title="键值哈希处理"></a>键值哈希处理</h4><h5 id="keyHashSlot"><a href="#keyHashSlot" class="headerlink" title="keyHashSlot"></a>keyHashSlot</h5><p>key到槽点的映射，当且仅当key中第一对{}中间是非空的, 才会使用{}中间的内容做计算，否则使用整个key</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">keyHashSlot</span><span class="params">(<span class="keyword">char</span> *key, <span class="keyword">int</span> keylen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s, e; <span class="comment">/* start-end indexes of &#123; and &#125; */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (s = <span class="number">0</span>; s &lt; keylen; s++)</span><br><span class="line">        <span class="keyword">if</span> (key[s] == <span class="string">&#x27;&#123;&#x27;</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* No &#x27;&#123;&#x27; ? Hash the whole key. This is the base case. */</span></span><br><span class="line">    <span class="keyword">if</span> (s == keylen) <span class="keyword">return</span> crc16(key,keylen) &amp; <span class="number">0x3FFF</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* &#x27;&#123;&#x27; found? Check if we have the corresponding &#x27;&#125;&#x27;. */</span></span><br><span class="line">    <span class="keyword">for</span> (e = s+<span class="number">1</span>; e &lt; keylen; e++)</span><br><span class="line">        <span class="keyword">if</span> (key[e] == <span class="string">&#x27;&#125;&#x27;</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* No &#x27;&#125;&#x27; or nothing between &#123;&#125; ? Hash the whole key. */</span></span><br><span class="line">    <span class="keyword">if</span> (e == keylen || e == s+<span class="number">1</span>) <span class="keyword">return</span> crc16(key,keylen) &amp; <span class="number">0x3FFF</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we are here there is both a &#123; and a &#125; on its right. Hash</span></span><br><span class="line"><span class="comment">     * what is in the middle between &#123; and &#125;. */</span></span><br><span class="line">    <span class="keyword">return</span> crc16(key+s+<span class="number">1</span>,e-s<span class="number">-1</span>) &amp; <span class="number">0x3FFF</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="节点相关"><a href="#节点相关" class="headerlink" title="节点相关"></a>节点相关</h4><h5 id="createClusterNode"><a href="#createClusterNode" class="headerlink" title="createClusterNode"></a>createClusterNode</h5><p>创建节点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">clusterNode *<span class="title">createClusterNode</span><span class="params">(<span class="keyword">char</span> *nodename, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    clusterNode *node = zmalloc(<span class="keyword">sizeof</span>(*node));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nodename)</span><br><span class="line">        <span class="built_in">memcpy</span>(node-&gt;name, nodename, CLUSTER_NAMELEN);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        getRandomHexChars(node-&gt;name, CLUSTER_NAMELEN);</span><br><span class="line">    node-&gt;ctime = mstime();</span><br><span class="line">    node-&gt;configEpoch = <span class="number">0</span>;</span><br><span class="line">    node-&gt;flags = flags;</span><br><span class="line">    <span class="built_in">memset</span>(node-&gt;slots,<span class="number">0</span>,<span class="keyword">sizeof</span>(node-&gt;slots));</span><br><span class="line">    node-&gt;numslots = <span class="number">0</span>;</span><br><span class="line">    node-&gt;numslaves = <span class="number">0</span>;</span><br><span class="line">    node-&gt;slaves = <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;slaveof = <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;ping_sent = node-&gt;pong_received = <span class="number">0</span>;</span><br><span class="line">    node-&gt;fail_time = <span class="number">0</span>;</span><br><span class="line">    node-&gt;link = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">memset</span>(node-&gt;ip,<span class="number">0</span>,<span class="keyword">sizeof</span>(node-&gt;ip));</span><br><span class="line">    node-&gt;port = <span class="number">0</span>;</span><br><span class="line">    node-&gt;cport = <span class="number">0</span>;</span><br><span class="line">    node-&gt;fail_reports = listCreate();</span><br><span class="line">    node-&gt;voted_time = <span class="number">0</span>;</span><br><span class="line">    node-&gt;orphaned_time = <span class="number">0</span>;</span><br><span class="line">    node-&gt;repl_offset_time = <span class="number">0</span>;</span><br><span class="line">    node-&gt;repl_offset = <span class="number">0</span>;</span><br><span class="line">    listSetFreeMethod(node-&gt;fail_reports,zfree);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterNodeAddFailureReport"><a href="#clusterNodeAddFailureReport" class="headerlink" title="clusterNodeAddFailureReport"></a>clusterNodeAddFailureReport</h5><p>处理新来的汇报某节点挂掉</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterNodeAddFailureReport</span><span class="params">(clusterNode *failing, clusterNode *sender)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">list</span> *l = failing-&gt;fail_reports;</span><br><span class="line">    listNode *ln;</span><br><span class="line">    listIter li;</span><br><span class="line">    clusterNodeFailReport *fr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重复汇报的话，更新汇报时间</span></span><br><span class="line">    listRewind(l,&amp;li);</span><br><span class="line">    <span class="keyword">while</span> ((ln = listNext(&amp;li)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        fr = ln-&gt;value;</span><br><span class="line">        <span class="keyword">if</span> (fr-&gt;node == sender) &#123;</span><br><span class="line">            fr-&gt;time = mstime();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入新的</span></span><br><span class="line">    fr = zmalloc(<span class="keyword">sizeof</span>(*fr));</span><br><span class="line">    fr-&gt;node = sender;</span><br><span class="line">    fr-&gt;time = mstime();</span><br><span class="line">    listAddNodeTail(l,fr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterNodeCleanupFailureReports"><a href="#clusterNodeCleanupFailureReports" class="headerlink" title="clusterNodeCleanupFailureReports"></a>clusterNodeCleanupFailureReports</h5><p>清理汇报时间在很久之前的汇报</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterNodeCleanupFailureReports</span><span class="params">(clusterNode *node)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">list</span> *l = node-&gt;fail_reports;</span><br><span class="line">    listNode *ln;</span><br><span class="line">    listIter li;</span><br><span class="line">    clusterNodeFailReport *fr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//上一次到现在的最大汇报时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> maxtime = server.cluster_node_timeout *</span><br><span class="line">                     CLUSTER_FAIL_REPORT_VALIDITY_MULT;</span><br><span class="line">    <span class="keyword">mstime_t</span> now = mstime();</span><br><span class="line"></span><br><span class="line">    listRewind(l,&amp;li);</span><br><span class="line">    <span class="keyword">while</span> ((ln = listNext(&amp;li)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        fr = ln-&gt;value;</span><br><span class="line">        <span class="keyword">if</span> (now - fr-&gt;time &gt; maxtime) listDelNode(l,ln);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterNodeDelFailureReport"><a href="#clusterNodeDelFailureReport" class="headerlink" title="clusterNodeDelFailureReport"></a>clusterNodeDelFailureReport</h5><p>删除某个来源对某个节点的汇报</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterNodeDelFailureReport</span><span class="params">(clusterNode *node, clusterNode *sender)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">list</span> *l = node-&gt;fail_reports;</span><br><span class="line">    listNode *ln;</span><br><span class="line">    listIter li;</span><br><span class="line">    clusterNodeFailReport *fr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//该来源没有汇报过</span></span><br><span class="line">    listRewind(l,&amp;li);</span><br><span class="line">    <span class="keyword">while</span> ((ln = listNext(&amp;li)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        fr = ln-&gt;value;</span><br><span class="line">        <span class="keyword">if</span> (fr-&gt;node == sender) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ln) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除</span></span><br><span class="line">    listDelNode(l,ln);</span><br><span class="line">    clusterNodeCleanupFailureReports(node);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterNodeFailureReportsCount"><a href="#clusterNodeFailureReportsCount" class="headerlink" title="clusterNodeFailureReportsCount"></a>clusterNodeFailureReportsCount</h5><p>获取节点被汇报的有效数量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterNodeFailureReportsCount</span><span class="params">(clusterNode *node)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//清理无效的汇报</span></span><br><span class="line">    clusterNodeCleanupFailureReports(node);</span><br><span class="line">    <span class="keyword">return</span> listLength(node-&gt;fail_reports);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterNodeRemoveSlave"><a href="#clusterNodeRemoveSlave" class="headerlink" title="clusterNodeRemoveSlave"></a>clusterNodeRemoveSlave</h5><p>删除master下的某个slave</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterNodeRemoveSlave</span><span class="params">(clusterNode *master, clusterNode *slave)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; master-&gt;numslaves; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (master-&gt;slaves[j] == slave) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((j+<span class="number">1</span>) &lt; master-&gt;numslaves) &#123;</span><br><span class="line">                <span class="keyword">int</span> remaining_slaves = (master-&gt;numslaves - j) - <span class="number">1</span>;</span><br><span class="line">                memmove(master-&gt;slaves+j,master-&gt;slaves+(j+<span class="number">1</span>),</span><br><span class="line">                        (<span class="keyword">sizeof</span>(*master-&gt;slaves) * remaining_slaves));</span><br><span class="line">            &#125;</span><br><span class="line">            master-&gt;numslaves--;</span><br><span class="line">            <span class="keyword">if</span> (master-&gt;numslaves == <span class="number">0</span>)</span><br><span class="line">                master-&gt;flags &amp;= ~CLUSTER_NODE_MIGRATE_TO;</span><br><span class="line">            <span class="keyword">return</span> C_OK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> C_ERR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterNodeAddSlave"><a href="#clusterNodeAddSlave" class="headerlink" title="clusterNodeAddSlave"></a>clusterNodeAddSlave</h5><p>master增加slave</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterNodeAddSlave</span><span class="params">(clusterNode *master, clusterNode *slave)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判重</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; master-&gt;numslaves; j++)</span><br><span class="line">        <span class="keyword">if</span> (master-&gt;slaves[j] == slave) <span class="keyword">return</span> C_ERR;</span><br><span class="line"></span><br><span class="line">    master-&gt;slaves = zrealloc(master-&gt;slaves,</span><br><span class="line">        <span class="keyword">sizeof</span>(clusterNode*)*(master-&gt;numslaves+<span class="number">1</span>));</span><br><span class="line">    master-&gt;slaves[master-&gt;numslaves] = slave;</span><br><span class="line">    master-&gt;numslaves++;</span><br><span class="line">    master-&gt;flags |= CLUSTER_NODE_MIGRATE_TO;</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterCountNonFailingSlaves"><a href="#clusterCountNonFailingSlaves" class="headerlink" title="clusterCountNonFailingSlaves"></a>clusterCountNonFailingSlaves</h5><p>统计master状态良好的slave数量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterCountNonFailingSlaves</span><span class="params">(clusterNode *n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j, okslaves = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; n-&gt;numslaves; j++)</span><br><span class="line">        <span class="keyword">if</span> (!nodeFailed(n-&gt;slaves[j])) okslaves++;</span><br><span class="line">    <span class="keyword">return</span> okslaves;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="freeClusterNode"><a href="#freeClusterNode" class="headerlink" title="freeClusterNode"></a>freeClusterNode</h5><p>释放节点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freeClusterNode</span><span class="params">(clusterNode *n)</span> </span>&#123;</span><br><span class="line">    sds nodename;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//slave设置其master为null</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; n-&gt;numslaves; j++)</span><br><span class="line">        n-&gt;slaves[j]-&gt;slaveof = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自身是slave,从其master的slave中删除</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsSlave(n) &amp;&amp; n-&gt;slaveof) clusterNodeRemoveSlave(n-&gt;slaveof,n);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从节点集中删除</span></span><br><span class="line">    nodename = sdsnewlen(n-&gt;name, CLUSTER_NAMELEN);</span><br><span class="line">    serverAssert(dictDelete(server.cluster-&gt;nodes,nodename) == DICT_OK);</span><br><span class="line">    sdsfree(nodename);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//释放连接</span></span><br><span class="line">    <span class="keyword">if</span> (n-&gt;link) freeClusterLink(n-&gt;link);</span><br><span class="line">    listRelease(n-&gt;fail_reports);</span><br><span class="line">    zfree(n-&gt;slaves);</span><br><span class="line">    zfree(n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterAddNode"><a href="#clusterAddNode" class="headerlink" title="clusterAddNode"></a>clusterAddNode</h5><p>增加节点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterAddNode</span><span class="params">(clusterNode *node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    retval = dictAdd(server.cluster-&gt;nodes,</span><br><span class="line">            sdsnewlen(node-&gt;name,CLUSTER_NAMELEN), node);</span><br><span class="line">    <span class="keyword">return</span> (retval == DICT_OK) ? C_OK : C_ERR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterDelNode"><a href="#clusterDelNode" class="headerlink" title="clusterDelNode"></a>clusterDelNode</h5><p>删除节点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterDelNode</span><span class="params">(clusterNode *delnode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理迁出、迁入、槽点路由</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (server.cluster-&gt;importing_slots_from[j] == delnode)</span><br><span class="line">            server.cluster-&gt;importing_slots_from[j] = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (server.cluster-&gt;migrating_slots_to[j] == delnode)</span><br><span class="line">            server.cluster-&gt;migrating_slots_to[j] = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (server.cluster-&gt;slots[j] == delnode)</span><br><span class="line">            clusterDelSlot(j);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除挂掉汇报</span></span><br><span class="line">    di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        clusterNode *node = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node == delnode) <span class="keyword">continue</span>;</span><br><span class="line">        clusterNodeDelFailureReport(node,delnode);</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//释放节点&amp;连接</span></span><br><span class="line">    freeClusterNode(delnode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterLookupNode"><a href="#clusterLookupNode" class="headerlink" title="clusterLookupNode"></a>clusterLookupNode</h5><p>根据名称查找节点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">clusterNode *<span class="title">clusterLookupNode</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span> </span>&#123;</span><br><span class="line">    sds s = sdsnewlen(name, CLUSTER_NAMELEN);</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    de = dictFind(server.cluster-&gt;nodes,s);</span><br><span class="line">    sdsfree(s);</span><br><span class="line">    <span class="keyword">if</span> (de == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> dictGetVal(de);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterRenameNode"><a href="#clusterRenameNode" class="headerlink" title="clusterRenameNode"></a>clusterRenameNode</h5><p>节点重命名</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterRenameNode</span><span class="params">(clusterNode *node, <span class="keyword">char</span> *newname)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    sds s = sdsnewlen(node-&gt;name, CLUSTER_NAMELEN);</span><br><span class="line"></span><br><span class="line">    serverLog(LL_DEBUG,<span class="string">&quot;Renaming node %.40s into %.40s&quot;</span>,</span><br><span class="line">        node-&gt;name, newname);</span><br><span class="line">    retval = dictDelete(server.cluster-&gt;nodes, s);</span><br><span class="line">    sdsfree(s);</span><br><span class="line">    serverAssert(retval == DICT_OK);</span><br><span class="line">    <span class="built_in">memcpy</span>(node-&gt;name, newname, CLUSTER_NAMELEN);</span><br><span class="line">    clusterAddNode(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置纪元"><a href="#配置纪元" class="headerlink" title="配置纪元"></a>配置纪元</h4><h5 id="clusterGetMaxEpoch"><a href="#clusterGetMaxEpoch" class="headerlink" title="clusterGetMaxEpoch"></a>clusterGetMaxEpoch</h5><p>获取所有节点中最大的配置纪元</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">clusterGetMaxEpoch</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> max = <span class="number">0</span>;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        clusterNode *node = dictGetVal(de);</span><br><span class="line">        <span class="keyword">if</span> (node-&gt;configEpoch &gt; max) max = node-&gt;configEpoch;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">    <span class="keyword">if</span> (max &lt; server.cluster-&gt;currentEpoch) max = server.cluster-&gt;currentEpoch;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterBumpConfigEpochWithoutConsensus"><a href="#clusterBumpConfigEpochWithoutConsensus" class="headerlink" title="clusterBumpConfigEpochWithoutConsensus"></a>clusterBumpConfigEpochWithoutConsensus</h5><p>从所有节点中获取最大的纪元，来更新自己的配置纪元，一步到位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterBumpConfigEpochWithoutConsensus</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> maxEpoch = clusterGetMaxEpoch();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (myself-&gt;configEpoch == <span class="number">0</span> ||</span><br><span class="line">        myself-&gt;configEpoch != maxEpoch)</span><br><span class="line">    &#123;</span><br><span class="line">        server.cluster-&gt;currentEpoch++;</span><br><span class="line">        myself-&gt;configEpoch = server.cluster-&gt;currentEpoch;</span><br><span class="line">        clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                             CLUSTER_TODO_FSYNC_CONFIG);</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;New configEpoch set to %llu&quot;</span>,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) myself-&gt;configEpoch);</span><br><span class="line">        <span class="keyword">return</span> C_OK;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterHandleConfigEpochCollision"><a href="#clusterHandleConfigEpochCollision" class="headerlink" title="clusterHandleConfigEpochCollision"></a>clusterHandleConfigEpochCollision</h5><p>根据某个节点的配置纪元，来更新自己的配置纪元，自增</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterHandleConfigEpochCollision</span><span class="params">(clusterNode *sender)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//相同纪元 且 都是master才行</span></span><br><span class="line">    <span class="keyword">if</span> (sender-&gt;configEpoch != myself-&gt;configEpoch ||</span><br><span class="line">        !nodeIsMaster(sender) || !nodeIsMaster(myself)) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//只有新来的名称比自己大才行</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">memcmp</span>(sender-&gt;name,myself-&gt;name,CLUSTER_NAMELEN) &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    server.cluster-&gt;currentEpoch++;</span><br><span class="line">    myself-&gt;configEpoch = server.cluster-&gt;currentEpoch;</span><br><span class="line">    clusterSaveConfigOrDie(<span class="number">1</span>);</span><br><span class="line">    serverLog(LL_VERBOSE,</span><br><span class="line">        <span class="string">&quot;WARNING: configEpoch collision with node %.40s.&quot;</span></span><br><span class="line">        <span class="string">&quot; configEpoch set to %llu&quot;</span>,</span><br><span class="line">        sender-&gt;name,</span><br><span class="line">        (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) myself-&gt;configEpoch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="后备列表"><a href="#后备列表" class="headerlink" title="后备列表"></a>后备列表</h4><p>当我们删除一个节点的时候，为了控制在一段时间内，忽略掉该节点的重新加入，引入了一个后背列表的概念。就是当节点删除后，会把节点放在后背列表中，有新节点要加入的时候，我们会先看一下是否在后备列表中，在的话就忽略了。节点存在于这个列表中的时效是1分钟。</p>
<h5 id="clusterBlacklistCleanup"><a href="#clusterBlacklistCleanup" class="headerlink" title="clusterBlacklistCleanup"></a>clusterBlacklistCleanup</h5><p>清理列表中过期的节点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_BLACKLIST_TTL 60 <span class="comment">//节点在列表中存活时间</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterBlacklistCleanup</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    di = dictGetSafeIterator(server.cluster-&gt;nodes_black_list);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">int64_t</span> expire = dictGetUnsignedIntegerVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (expire &lt; server.unixtime)</span><br><span class="line">            dictDelete(server.cluster-&gt;nodes_black_list,dictGetKey(de));</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterBlacklistAddNode"><a href="#clusterBlacklistAddNode" class="headerlink" title="clusterBlacklistAddNode"></a>clusterBlacklistAddNode</h5><p>向列表中增加节点，如果节点已经存在，则更新过期时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterBlacklistAddNode</span><span class="params">(clusterNode *node)</span> </span>&#123;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    sds id = sdsnewlen(node-&gt;name,CLUSTER_NAMELEN);</span><br><span class="line"></span><br><span class="line">    clusterBlacklistCleanup();</span><br><span class="line">    <span class="keyword">if</span> (dictAdd(server.cluster-&gt;nodes_black_list,id,<span class="literal">NULL</span>) == DICT_OK) &#123;</span><br><span class="line">        id = sdsdup(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    de = dictFind(server.cluster-&gt;nodes_black_list,id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置过期时间</span></span><br><span class="line">    dictSetUnsignedIntegerVal(de,time(<span class="literal">NULL</span>)+CLUSTER_BLACKLIST_TTL);</span><br><span class="line">    sdsfree(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterBlacklistExists"><a href="#clusterBlacklistExists" class="headerlink" title="clusterBlacklistExists"></a>clusterBlacklistExists</h5><p>查找节点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterBlacklistExists</span><span class="params">(<span class="keyword">char</span> *nodeid)</span> </span>&#123;</span><br><span class="line">    sds id = sdsnewlen(nodeid,CLUSTER_NAMELEN);</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先清理过期</span></span><br><span class="line">    clusterBlacklistCleanup();</span><br><span class="line">    retval = dictFind(server.cluster-&gt;nodes_black_list,id) != <span class="literal">NULL</span>;</span><br><span class="line">    sdsfree(id);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="集群消息"><a href="#集群消息" class="headerlink" title="集群消息"></a>集群消息</h4><h5 id="markNodeAsFailingIfNeeded"><a href="#markNodeAsFailingIfNeeded" class="headerlink" title="markNodeAsFailingIfNeeded"></a>markNodeAsFailingIfNeeded</h5><p>标记节点故障</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">markNodeAsFailingIfNeeded</span><span class="params">(clusterNode *node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> failures;</span><br><span class="line">    <span class="comment">//最低票数，所有有效master的一半以上</span></span><br><span class="line">    <span class="keyword">int</span> needed_quorum = (server.cluster-&gt;size / <span class="number">2</span>) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//心跳检测ok</span></span><br><span class="line">    <span class="keyword">if</span> (!nodeTimedOut(node)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//已经标记故障</span></span><br><span class="line">    <span class="keyword">if</span> (nodeFailed(node)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//该节点被其余节点汇报故障的数量</span></span><br><span class="line">    failures = clusterNodeFailureReportsCount(node);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//加上自己一票</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsMaster(myself)) failures++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//需要满足最低票数</span></span><br><span class="line">    <span class="keyword">if</span> (failures &lt; needed_quorum) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    serverLog(LL_NOTICE,</span><br><span class="line">        <span class="string">&quot;Marking node %.40s as failing (quorum reached).&quot;</span>, node-&gt;name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从主观下线-&gt;客观下线</span></span><br><span class="line">    node-&gt;flags &amp;= ~CLUSTER_NODE_PFAIL;</span><br><span class="line">    node-&gt;flags |= CLUSTER_NODE_FAIL;</span><br><span class="line">    node-&gt;fail_time = mstime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//告知其他节点</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsMaster(myself)) clusterSendFail(node-&gt;name);</span><br><span class="line">    clusterDoBeforeSleep(CLUSTER_TODO_UPDATE_STATE|CLUSTER_TODO_SAVE_CONFIG);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clearNodeFailureIfNeeded"><a href="#clearNodeFailureIfNeeded" class="headerlink" title="clearNodeFailureIfNeeded"></a>clearNodeFailureIfNeeded</h5><p>清除故障标记</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clearNodeFailureIfNeeded</span><span class="params">(clusterNode *node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">mstime_t</span> now = mstime();</span><br><span class="line"></span><br><span class="line">    serverAssert(nodeFailed(node));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从节点直接清除</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsSlave(node) || node-&gt;numslots == <span class="number">0</span>) &#123;</span><br><span class="line">        serverLog(LL_NOTICE,</span><br><span class="line">            <span class="string">&quot;Clear FAIL state for node %.40s: %s is reachable again.&quot;</span>,</span><br><span class="line">                node-&gt;name,</span><br><span class="line">                nodeIsSlave(node) ? <span class="string">&quot;replica&quot;</span> : <span class="string">&quot;master without slots&quot;</span>);</span><br><span class="line">        node-&gt;flags &amp;= ~CLUSTER_NODE_FAIL;</span><br><span class="line">        clusterDoBeforeSleep(CLUSTER_TODO_UPDATE_STATE|CLUSTER_TODO_SAVE_CONFIG);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//master的话，则需要满足至少管理一个槽点，且在一段时间内没有其他节点接手其槽点</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsMaster(node) &amp;&amp; node-&gt;numslots &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (now - node-&gt;fail_time) &gt;</span><br><span class="line">        (server.cluster_node_timeout * CLUSTER_FAIL_UNDO_TIME_MULT))</span><br><span class="line">    &#123;</span><br><span class="line">        serverLog(LL_NOTICE,</span><br><span class="line">            <span class="string">&quot;Clear FAIL state for node %.40s: is reachable again and nobody is serving its slots after some time.&quot;</span>,</span><br><span class="line">                node-&gt;name);</span><br><span class="line">        node-&gt;flags &amp;= ~CLUSTER_NODE_FAIL;</span><br><span class="line">        clusterDoBeforeSleep(CLUSTER_TODO_UPDATE_STATE|CLUSTER_TODO_SAVE_CONFIG);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterHandshakeInProgress"><a href="#clusterHandshakeInProgress" class="headerlink" title="clusterHandshakeInProgress"></a>clusterHandshakeInProgress</h5><p>是否有对应的ip&amp;port&amp;cport在握手中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterHandshakeInProgress</span><span class="params">(<span class="keyword">char</span> *ip, <span class="keyword">int</span> port, <span class="keyword">int</span> cport)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        clusterNode *node = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!nodeInHandshake(node)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (!strcasecmp(node-&gt;ip,ip) &amp;&amp;</span><br><span class="line">            node-&gt;port == port &amp;&amp;</span><br><span class="line">            node-&gt;cport == cport) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">    <span class="keyword">return</span> de != <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterStartHandshake"><a href="#clusterStartHandshake" class="headerlink" title="clusterStartHandshake"></a>clusterStartHandshake</h5><p>开始握手</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterStartHandshake</span><span class="params">(<span class="keyword">char</span> *ip, <span class="keyword">int</span> port, <span class="keyword">int</span> cport)</span> </span>&#123;</span><br><span class="line">    clusterNode *n;</span><br><span class="line">    <span class="keyword">char</span> norm_ip[NET_IP_STR_LEN];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">sa</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ip校验</span></span><br><span class="line">    <span class="keyword">if</span> (inet_pton(AF_INET,ip,</span><br><span class="line">            &amp;(((struct sockaddr_in *)&amp;sa)-&gt;sin_addr)))</span><br><span class="line">    &#123;</span><br><span class="line">        sa.ss_family = AF_INET;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inet_pton(AF_INET6,ip,</span><br><span class="line">            &amp;(((struct sockaddr_in6 *)&amp;sa)-&gt;sin6_addr)))</span><br><span class="line">    &#123;</span><br><span class="line">        sa.ss_family = AF_INET6;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        errno = EINVAL;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//端口校验</span></span><br><span class="line">    <span class="keyword">if</span> (port &lt;= <span class="number">0</span> || port &gt; <span class="number">65535</span> || cport &lt;= <span class="number">0</span> || cport &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">        errno = EINVAL;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(norm_ip,<span class="number">0</span>,NET_IP_STR_LEN);</span><br><span class="line">    <span class="keyword">if</span> (sa.ss_family == AF_INET)</span><br><span class="line">        inet_ntop(AF_INET,</span><br><span class="line">            (<span class="keyword">void</span>*)&amp;(((struct sockaddr_in *)&amp;sa)-&gt;sin_addr),</span><br><span class="line">            norm_ip,NET_IP_STR_LEN);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        inet_ntop(AF_INET6,</span><br><span class="line">            (<span class="keyword">void</span>*)&amp;(((struct sockaddr_in6 *)&amp;sa)-&gt;sin6_addr),</span><br><span class="line">            norm_ip,NET_IP_STR_LEN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//去重</span></span><br><span class="line">    <span class="keyword">if</span> (clusterHandshakeInProgress(norm_ip,port,cport)) &#123;</span><br><span class="line">        errno = EAGAIN;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建新的节点，打上标记，在下一次定时时，会创建连接</span></span><br><span class="line">    n = createClusterNode(<span class="literal">NULL</span>,CLUSTER_NODE_HANDSHAKE|CLUSTER_NODE_MEET);</span><br><span class="line">    <span class="built_in">memcpy</span>(n-&gt;ip,norm_ip,<span class="keyword">sizeof</span>(n-&gt;ip));</span><br><span class="line">    n-&gt;port = port;</span><br><span class="line">    n-&gt;cport = cport;</span><br><span class="line">    clusterAddNode(n);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterProcessGossipSection"><a href="#clusterProcessGossipSection" class="headerlink" title="clusterProcessGossipSection"></a>clusterProcessGossipSection</h5><p>处理ping/pong/meet消息中的gossip信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterProcessGossipSection</span><span class="params">(clusterMsg *hdr, clusterLink *link)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//gossip数量</span></span><br><span class="line">    <span class="keyword">uint16_t</span> count = ntohs(hdr-&gt;count);</span><br><span class="line">    clusterMsgDataGossip *g = (clusterMsgDataGossip*) hdr-&gt;data.ping.gossip;</span><br><span class="line">    clusterNode *sender = link-&gt;node ? link-&gt;node : clusterLookupNode(hdr-&gt;sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(count--) &#123;</span><br><span class="line">        <span class="keyword">uint16_t</span> flags = ntohs(g-&gt;flags);</span><br><span class="line">        clusterNode *node;</span><br><span class="line">        sds ci;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (server.verbosity == LL_DEBUG) &#123;</span><br><span class="line">            ci = representClusterNodeFlags(sdsempty(), flags);</span><br><span class="line">            serverLog(LL_DEBUG,<span class="string">&quot;GOSSIP %.40s %s:%d@%d %s&quot;</span>,</span><br><span class="line">                g-&gt;nodename,</span><br><span class="line">                g-&gt;ip,</span><br><span class="line">                ntohs(g-&gt;port),</span><br><span class="line">                ntohs(g-&gt;cport),</span><br><span class="line">                ci);</span><br><span class="line">            sdsfree(ci);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查找节点</span></span><br><span class="line">        node = clusterLookupNode(g-&gt;nodename);</span><br><span class="line">        <span class="keyword">if</span> (node) &#123;</span><br><span class="line">        	<span class="comment">//该节点两边都知道</span></span><br><span class="line"></span><br><span class="line">        	<span class="comment">//消息来源是master</span></span><br><span class="line">            <span class="keyword">if</span> (sender &amp;&amp; nodeIsMaster(sender) &amp;&amp; node != myself) &#123;</span><br><span class="line"></span><br><span class="line">            	<span class="comment">//标记故障状态</span></span><br><span class="line">                <span class="keyword">if</span> (flags &amp; (CLUSTER_NODE_FAIL|CLUSTER_NODE_PFAIL)) &#123;</span><br><span class="line">                	<span class="comment">//新增故障汇报</span></span><br><span class="line">                    <span class="keyword">if</span> (clusterNodeAddFailureReport(node,sender)) &#123;</span><br><span class="line">                        serverLog(LL_VERBOSE,</span><br><span class="line">                            <span class="string">&quot;Node %.40s reported node %.40s as not reachable.&quot;</span>,</span><br><span class="line">                            sender-&gt;name, node-&gt;name);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//打上标记</span></span><br><span class="line">                    markNodeAsFailingIfNeeded(node);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                	<span class="comment">//删除故障标记</span></span><br><span class="line">                    <span class="keyword">if</span> (clusterNodeDelFailureReport(node,sender)) &#123;</span><br><span class="line">                        serverLog(LL_VERBOSE,</span><br><span class="line">                            <span class="string">&quot;Node %.40s reported node %.40s is back online.&quot;</span>,</span><br><span class="line">                            sender-&gt;name, node-&gt;name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//发送方认为该节点没有任何故障，自己这边也没有任何关于其的故障汇报，自己也没发送过ping给该节点，更新最近pong回复</span></span><br><span class="line">            <span class="keyword">if</span> (!(flags &amp; (CLUSTER_NODE_FAIL|CLUSTER_NODE_PFAIL)) &amp;&amp;</span><br><span class="line">                node-&gt;ping_sent == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                clusterNodeFailureReportsCount(node) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">mstime_t</span> pongtime = ntohl(g-&gt;pong_received);</span><br><span class="line">                pongtime *= <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//收到回复时间比我们要大，且不是未来的</span></span><br><span class="line">                <span class="keyword">if</span> (pongtime &lt;= (server.mstime+<span class="number">500</span>) &amp;&amp;</span><br><span class="line">                    pongtime &gt; node-&gt;pong_received)</span><br><span class="line">                &#123;</span><br><span class="line">                    node-&gt;pong_received = pongtime;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//该节点在我们看是故障的，但是发送方看来是ok的，且发送方汇报的ip和port不一样，我们更新其信息，并断开旧连接，使用新信息进行连接</span></span><br><span class="line">            <span class="keyword">if</span> (node-&gt;flags &amp; (CLUSTER_NODE_FAIL|CLUSTER_NODE_PFAIL) &amp;&amp;</span><br><span class="line">                !(flags &amp; CLUSTER_NODE_NOADDR) &amp;&amp;</span><br><span class="line">                !(flags &amp; (CLUSTER_NODE_FAIL|CLUSTER_NODE_PFAIL)) &amp;&amp;</span><br><span class="line">                (strcasecmp(node-&gt;ip,g-&gt;ip) ||</span><br><span class="line">                 node-&gt;port != ntohs(g-&gt;port) ||</span><br><span class="line">                 node-&gt;cport != ntohs(g-&gt;cport)))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (node-&gt;link) freeClusterLink(node-&gt;link);</span><br><span class="line">                <span class="built_in">memcpy</span>(node-&gt;ip,g-&gt;ip,NET_IP_STR_LEN);</span><br><span class="line">                node-&gt;port = ntohs(g-&gt;port);</span><br><span class="line">                node-&gt;cport = ntohs(g-&gt;cport);</span><br><span class="line">                node-&gt;flags &amp;= ~CLUSTER_NODE_NOADDR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//发送方知道节点，我们不知道，看看是否在后备列表中，不在的话，建立连接</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sender &amp;&amp;</span><br><span class="line">                !(flags &amp; CLUSTER_NODE_NOADDR) &amp;&amp;</span><br><span class="line">                !clusterBlacklistExists(g-&gt;nodename))</span><br><span class="line">            &#123;</span><br><span class="line">                clusterStartHandshake(g-&gt;ip,ntohs(g-&gt;port),ntohs(g-&gt;cport));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        g++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="nodeIp2String"><a href="#nodeIp2String" class="headerlink" title="nodeIp2String"></a>nodeIp2String</h5><p>转换ip到字符串</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nodeIp2String</span><span class="params">(<span class="keyword">char</span> *buf, clusterLink *link, <span class="keyword">char</span> *announced_ip)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (announced_ip[<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(buf,announced_ip,NET_IP_STR_LEN);</span><br><span class="line">        buf[NET_IP_STR_LEN<span class="number">-1</span>] = <span class="string">&#x27;\0&#x27;</span>; <span class="comment">/* We are not sure the input is sane. */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        anetPeerToString(link-&gt;fd, buf, NET_IP_STR_LEN, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="nodeUpdateAddressIfNeeded"><a href="#nodeUpdateAddressIfNeeded" class="headerlink" title="nodeUpdateAddressIfNeeded"></a>nodeUpdateAddressIfNeeded</h5><p>更新节点地址，接收到其余节点的发送的gossip消息时，根据其消息里自己的地址和当前连接的地址来更新自己存储的信息，优先级为：消息 &gt; 当前连接</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nodeUpdateAddressIfNeeded</span><span class="params">(clusterNode *node, clusterLink *link,</span></span></span><br><span class="line"><span class="function"><span class="params">                              clusterMsg *hdr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> ip[NET_IP_STR_LEN] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> port = ntohs(hdr-&gt;port);</span><br><span class="line">    <span class="keyword">int</span> cport = ntohs(hdr-&gt;cport);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (link == node-&gt;link) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    nodeIp2String(ip,link,hdr-&gt;myip);</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;port == port &amp;&amp; node-&gt;cport == cport &amp;&amp;</span><br><span class="line">        <span class="built_in">strcmp</span>(ip,node-&gt;ip) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(node-&gt;ip,ip,<span class="keyword">sizeof</span>(ip));</span><br><span class="line">    node-&gt;port = port;</span><br><span class="line">    node-&gt;cport = cport;</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;link) freeClusterLink(node-&gt;link);</span><br><span class="line">    node-&gt;flags &amp;= ~CLUSTER_NODE_NOADDR;</span><br><span class="line">    serverLog(LL_WARNING,<span class="string">&quot;Address updated for node %.40s, now %s:%d&quot;</span>,</span><br><span class="line">        node-&gt;name, node-&gt;ip, node-&gt;port);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//该节点正好是自己的master</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsSlave(myself) &amp;&amp; myself-&gt;slaveof == node)</span><br><span class="line">        replicationSetMaster(node-&gt;ip, node-&gt;port);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterSetNodeAsMaster"><a href="#clusterSetNodeAsMaster" class="headerlink" title="clusterSetNodeAsMaster"></a>clusterSetNodeAsMaster</h5><p>设置节点为master</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterSetNodeAsMaster</span><span class="params">(clusterNode *n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nodeIsMaster(n)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n-&gt;slaveof) &#123;</span><br><span class="line">        clusterNodeRemoveSlave(n-&gt;slaveof,n);</span><br><span class="line">        <span class="keyword">if</span> (n != myself) n-&gt;flags |= CLUSTER_NODE_MIGRATE_TO;</span><br><span class="line">    &#125;</span><br><span class="line">    n-&gt;flags &amp;= ~CLUSTER_NODE_SLAVE;</span><br><span class="line">    n-&gt;flags |= CLUSTER_NODE_MASTER;</span><br><span class="line">    n-&gt;slaveof = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Update config and state. */</span></span><br><span class="line">    clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                         CLUSTER_TODO_UPDATE_STATE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterUpdateSlotsConfigWith"><a href="#clusterUpdateSlotsConfigWith" class="headerlink" title="clusterUpdateSlotsConfigWith"></a>clusterUpdateSlotsConfigWith</h5><p>更新槽点配置，节点交流时，会汇报自己管理的槽点，接收方需要根据此来更新自己的路由表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterUpdateSlotsConfigWith</span><span class="params">(clusterNode *sender, <span class="keyword">uint64_t</span> senderConfigEpoch, <span class="keyword">unsigned</span> <span class="keyword">char</span> *slots)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    clusterNode *curmaster, *newmaster = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">uint16_t</span> dirty_slots[CLUSTER_SLOTS];</span><br><span class="line">    <span class="keyword">int</span> dirty_slots_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    curmaster = nodeIsMaster(myself) ? myself : myself-&gt;slaveof;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sender == myself) &#123;</span><br><span class="line">        serverLog(LL_WARNING,<span class="string">&quot;Discarding UPDATE message about myself.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bitmapTestBit(slots,j)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (server.cluster-&gt;slots[j] == sender) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//迁入中</span></span><br><span class="line">            <span class="keyword">if</span> (server.cluster-&gt;importing_slots_from[j]) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//槽点没有归属或者自己的槽点配置太低了，则更新</span></span><br><span class="line">            <span class="keyword">if</span> (server.cluster-&gt;slots[j] == <span class="literal">NULL</span> ||</span><br><span class="line">                server.cluster-&gt;slots[j]-&gt;configEpoch &lt; senderConfigEpoch)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//脏槽点</span></span><br><span class="line">                <span class="keyword">if</span> (server.cluster-&gt;slots[j] == myself &amp;&amp;</span><br><span class="line">                    countKeysInSlot(j) &amp;&amp;</span><br><span class="line">                    sender != myself)</span><br><span class="line">                &#123;</span><br><span class="line">                    dirty_slots[dirty_slots_count] = j;</span><br><span class="line">                    dirty_slots_count++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//删除旧槽点归属，建立新归属</span></span><br><span class="line">                <span class="keyword">if</span> (server.cluster-&gt;slots[j] == curmaster)</span><br><span class="line">                    newmaster = sender;</span><br><span class="line">                clusterDelSlot(j);</span><br><span class="line">                clusterAddSlot(sender,j);</span><br><span class="line">                clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                                     CLUSTER_TODO_UPDATE_STATE|</span><br><span class="line">                                     CLUSTER_TODO_FSYNC_CONFIG);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.cluster_module_flags &amp; CLUSTER_MODULE_FLAG_NO_REDIRECTION)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newmaster &amp;&amp; curmaster-&gt;numslots == <span class="number">0</span>) &#123;</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Configuration change detected. Reconfiguring myself &quot;</span></span><br><span class="line">            <span class="string">&quot;as a replica of %.40s&quot;</span>, sender-&gt;name);</span><br><span class="line">        clusterSetMaster(sender);</span><br><span class="line">        clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                             CLUSTER_TODO_UPDATE_STATE|</span><br><span class="line">                             CLUSTER_TODO_FSYNC_CONFIG);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dirty_slots_count) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; dirty_slots_count; j++)</span><br><span class="line">            delKeysInSlot(dirty_slots[j]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterProcessPacket"><a href="#clusterProcessPacket" class="headerlink" title="clusterProcessPacket"></a>clusterProcessPacket</h5><p>处理数据包，读取集群节点发送的数据，解析消息执行。在该方法中，需要注意一点，link-&gt;node-&gt;name和hdr-&gt;sender。节点在发送消息时，会在消息里填上自己的name也就是hdr-&gt;sender。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterProcessPacket</span><span class="params">(clusterLink *link)</span> </span>&#123;</span><br><span class="line">    clusterMsg *hdr = (clusterMsg*) link-&gt;rcvbuf;</span><br><span class="line">    <span class="keyword">uint32_t</span> totlen = ntohl(hdr-&gt;totlen);</span><br><span class="line">    <span class="keyword">uint16_t</span> type = ntohs(hdr-&gt;type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//无效消息</span></span><br><span class="line">    <span class="keyword">if</span> (type &lt; CLUSTERMSG_TYPE_COUNT)</span><br><span class="line">        server.cluster-&gt;stats_bus_messages_received[type]++;</span><br><span class="line">    serverLog(LL_DEBUG,<span class="string">&quot;--- Processing packet of type %d, %lu bytes&quot;</span>,</span><br><span class="line">        type, (<span class="keyword">unsigned</span> <span class="keyword">long</span>) totlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//一个消息最小长度，小于16的话，我们还不能处理</span></span><br><span class="line">    <span class="keyword">if</span> (totlen &lt; <span class="number">16</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//一个完整的消息还没接收完</span></span><br><span class="line">    <span class="keyword">if</span> (totlen &gt; sdslen(link-&gt;rcvbuf)) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验版本号</span></span><br><span class="line">    <span class="keyword">if</span> (ntohs(hdr-&gt;ver) != CLUSTER_PROTO_VER) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint16_t</span> flags = ntohs(hdr-&gt;flags);</span><br><span class="line">    <span class="keyword">uint64_t</span> senderCurrentEpoch = <span class="number">0</span>, senderConfigEpoch = <span class="number">0</span>;</span><br><span class="line">    clusterNode *sender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//针对不同消息，获取期望的长度</span></span><br><span class="line">    <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_PING || type == CLUSTERMSG_TYPE_PONG ||</span><br><span class="line">        type == CLUSTERMSG_TYPE_MEET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint16_t</span> count = ntohs(hdr-&gt;count);</span><br><span class="line">        <span class="keyword">uint32_t</span> explen;</span><br><span class="line"></span><br><span class="line">        explen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line">        explen += (<span class="keyword">sizeof</span>(clusterMsgDataGossip)*count);</span><br><span class="line">        <span class="keyword">if</span> (totlen != explen) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_FAIL) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> explen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line"></span><br><span class="line">        explen += <span class="keyword">sizeof</span>(clusterMsgDataFail);</span><br><span class="line">        <span class="keyword">if</span> (totlen != explen) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_PUBLISH) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> explen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line"></span><br><span class="line">        explen += <span class="keyword">sizeof</span>(clusterMsgDataPublish) -</span><br><span class="line">                <span class="number">8</span> +</span><br><span class="line">                ntohl(hdr-&gt;data.publish.msg.channel_len) +</span><br><span class="line">                ntohl(hdr-&gt;data.publish.msg.message_len);</span><br><span class="line">        <span class="keyword">if</span> (totlen != explen) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST ||</span><br><span class="line">               type == CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK ||</span><br><span class="line">               type == CLUSTERMSG_TYPE_MFSTART)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> explen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (totlen != explen) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_UPDATE) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> explen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line"></span><br><span class="line">        explen += <span class="keyword">sizeof</span>(clusterMsgDataUpdate);</span><br><span class="line">        <span class="keyword">if</span> (totlen != explen) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_MODULE) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> explen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line"></span><br><span class="line">        explen += <span class="keyword">sizeof</span>(clusterMsgDataPublish) -</span><br><span class="line">                <span class="number">3</span> + ntohl(hdr-&gt;data.<span class="keyword">module</span>.msg.len);</span><br><span class="line">        <span class="keyword">if</span> (totlen != explen) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查找消息来源节点</span></span><br><span class="line">    sender = clusterLookupNode(hdr-&gt;sender);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//正常的通信</span></span><br><span class="line">    <span class="keyword">if</span> (sender &amp;&amp; !nodeInHandshake(sender)) &#123;</span><br><span class="line">        <span class="comment">//更新纪元</span></span><br><span class="line">        senderCurrentEpoch = ntohu64(hdr-&gt;currentEpoch);</span><br><span class="line">        senderConfigEpoch = ntohu64(hdr-&gt;configEpoch);</span><br><span class="line">        <span class="keyword">if</span> (senderCurrentEpoch &gt; server.cluster-&gt;currentEpoch)</span><br><span class="line">            server.cluster-&gt;currentEpoch = senderCurrentEpoch;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (senderConfigEpoch &gt; sender-&gt;configEpoch) &#123;</span><br><span class="line">            sender-&gt;configEpoch = senderConfigEpoch;</span><br><span class="line">            clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                                 CLUSTER_TODO_FSYNC_CONFIG);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//更新同步偏移量</span></span><br><span class="line">        sender-&gt;repl_offset = ntohu64(hdr-&gt;offset);</span><br><span class="line">        sender-&gt;repl_offset_time = mstime();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//我们是从节点，手动故障修复的情况，收到master的消息，我们记录下暂停的偏移量</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (server.cluster-&gt;mf_end &amp;&amp;</span><br><span class="line">            nodeIsSlave(myself) &amp;&amp;</span><br><span class="line">            myself-&gt;slaveof == sender &amp;&amp;</span><br><span class="line">            hdr-&gt;mflags[<span class="number">0</span>] &amp; CLUSTERMSG_FLAG0_PAUSED &amp;&amp;</span><br><span class="line">            server.cluster-&gt;mf_master_offset == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            server.cluster-&gt;mf_master_offset = sender-&gt;repl_offset;</span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">&quot;Received replication offset for paused &quot;</span></span><br><span class="line">                <span class="string">&quot;master manual failover: %lld&quot;</span>,</span><br><span class="line">                server.cluster-&gt;mf_master_offset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ping&amp;pong</span></span><br><span class="line">    <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_PING || type == CLUSTERMSG_TYPE_MEET) &#123;</span><br><span class="line">        serverLog(LL_DEBUG,<span class="string">&quot;Ping packet received: %p&quot;</span>, (<span class="keyword">void</span>*)link-&gt;node);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//其他节点meet我们时，初始化自己的ip信息</span></span><br><span class="line">        <span class="keyword">if</span> ((type == CLUSTERMSG_TYPE_MEET || myself-&gt;ip[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>) &amp;&amp;</span><br><span class="line">            server.cluster_announce_ip == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> ip[NET_IP_STR_LEN];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (anetSockName(link-&gt;fd,ip,<span class="keyword">sizeof</span>(ip),<span class="literal">NULL</span>) != <span class="number">-1</span> &amp;&amp;</span><br><span class="line">                <span class="built_in">strcmp</span>(ip,myself-&gt;ip))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memcpy</span>(myself-&gt;ip,ip,NET_IP_STR_LEN);</span><br><span class="line">                serverLog(LL_WARNING,<span class="string">&quot;IP address for this node updated to %s&quot;</span>,</span><br><span class="line">                    myself-&gt;ip);</span><br><span class="line">                clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//meet消息，发送方是我们不认识的，则把其当做集群中的一个节点，有且只有meet消息能建立拓扑</span></span><br><span class="line">        <span class="keyword">if</span> (!sender &amp;&amp; type == CLUSTERMSG_TYPE_MEET) &#123;</span><br><span class="line">            clusterNode *node;</span><br><span class="line"></span><br><span class="line">            node = createClusterNode(<span class="literal">NULL</span>,CLUSTER_NODE_HANDSHAKE);</span><br><span class="line">            nodeIp2String(node-&gt;ip,link,hdr-&gt;myip);</span><br><span class="line">            node-&gt;port = ntohs(hdr-&gt;port);</span><br><span class="line">            node-&gt;cport = ntohs(hdr-&gt;cport);</span><br><span class="line">            clusterAddNode(node);</span><br><span class="line">            clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//只要消息是meet，我们就相信他发的拓扑信息</span></span><br><span class="line">        <span class="keyword">if</span> (!sender &amp;&amp; type == CLUSTERMSG_TYPE_MEET)</span><br><span class="line">            clusterProcessGossipSection(hdr,link);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//回复pong</span></span><br><span class="line">        clusterSendPing(link,CLUSTERMSG_TYPE_PONG);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理ping,pong,meet配置信息</span></span><br><span class="line">    <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_PING || type == CLUSTERMSG_TYPE_PONG ||</span><br><span class="line">        type == CLUSTERMSG_TYPE_MEET)</span><br><span class="line">    &#123;</span><br><span class="line">        serverLog(LL_DEBUG,<span class="string">&quot;%s packet received: %p&quot;</span>,</span><br><span class="line">            type == CLUSTERMSG_TYPE_PING ? <span class="string">&quot;ping&quot;</span> : <span class="string">&quot;pong&quot;</span>,</span><br><span class="line">            (<span class="keyword">void</span>*)link-&gt;node);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//link-&gt;node表示是我们的主动连接</span></span><br><span class="line">        <span class="keyword">if</span> (link-&gt;node) &#123;</span><br><span class="line">            <span class="comment">//握手节点的处理</span></span><br><span class="line">            <span class="keyword">if</span> (nodeInHandshake(link-&gt;node)) &#123;</span><br><span class="line">                <span class="comment">//握手阶段我们是不知道该节点的，如果知道的话，是有问题的，尝试更新节点对应的ip&amp;port</span></span><br><span class="line">                <span class="keyword">if</span> (sender) &#123;</span><br><span class="line">                    serverLog(LL_VERBOSE,</span><br><span class="line">                        <span class="string">&quot;Handshake: we already know node %.40s, &quot;</span></span><br><span class="line">                        <span class="string">&quot;updating the address if needed.&quot;</span>, sender-&gt;name);</span><br><span class="line">                    <span class="keyword">if</span> (nodeUpdateAddressIfNeeded(sender,link,hdr))</span><br><span class="line">                    &#123;</span><br><span class="line">                        clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                                             CLUSTER_TODO_UPDATE_STATE);</span><br><span class="line">                    &#125;</span><br><span class="line">                    clusterDelNode(link-&gt;node);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//正常握手结束，命名节点名称 &amp; 去除握手标记</span></span><br><span class="line">                clusterRenameNode(link-&gt;node, hdr-&gt;sender);</span><br><span class="line">                serverLog(LL_DEBUG,<span class="string">&quot;Handshake with node %.40s completed.&quot;</span>,</span><br><span class="line">                    link-&gt;node-&gt;name);</span><br><span class="line">                link-&gt;node-&gt;flags &amp;= ~CLUSTER_NODE_HANDSHAKE;</span><br><span class="line">                link-&gt;node-&gt;flags |= flags&amp;(CLUSTER_NODE_MASTER|CLUSTER_NODE_SLAVE);</span><br><span class="line">                clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">memcmp</span>(link-&gt;node-&gt;name,hdr-&gt;sender,</span><br><span class="line">                        CLUSTER_NAMELEN) != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//我们已知节点名和消息里自报名称不一样，可能是节点发生了重启，id发生了变化，重置连接</span></span><br><span class="line">                serverLog(LL_DEBUG,<span class="string">&quot;PONG contains mismatching sender ID. About node %.40s added %d ms ago, having flags %d&quot;</span>,</span><br><span class="line">                    link-&gt;node-&gt;name,</span><br><span class="line">                    (<span class="keyword">int</span>)(mstime()-(link-&gt;node-&gt;ctime)),</span><br><span class="line">                    link-&gt;node-&gt;flags);</span><br><span class="line">                link-&gt;node-&gt;flags |= CLUSTER_NODE_NOADDR;</span><br><span class="line">                link-&gt;node-&gt;ip[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                link-&gt;node-&gt;port = <span class="number">0</span>;</span><br><span class="line">                link-&gt;node-&gt;cport = <span class="number">0</span>;</span><br><span class="line">                freeClusterLink(link);</span><br><span class="line">                clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新故障标志</span></span><br><span class="line">        <span class="keyword">if</span> (sender) &#123;</span><br><span class="line">            <span class="keyword">int</span> nofailover = flags &amp; CLUSTER_NODE_NOFAILOVER;</span><br><span class="line">            sender-&gt;flags &amp;= ~CLUSTER_NODE_NOFAILOVER;</span><br><span class="line">            sender-&gt;flags |= nofailover;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新尝试更新ip</span></span><br><span class="line">        <span class="keyword">if</span> (sender &amp;&amp; type == CLUSTERMSG_TYPE_PING &amp;&amp;</span><br><span class="line">            !nodeInHandshake(sender) &amp;&amp;</span><br><span class="line">            nodeUpdateAddressIfNeeded(sender,link,hdr))</span><br><span class="line">        &#123;</span><br><span class="line">            clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                                 CLUSTER_TODO_UPDATE_STATE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//其余节点对我们主动发出的心跳检测回复</span></span><br><span class="line">        <span class="keyword">if</span> (link-&gt;node &amp;&amp; type == CLUSTERMSG_TYPE_PONG) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//更新最新pong回复时间，ping发送时间清零</span></span><br><span class="line">            link-&gt;node-&gt;pong_received = mstime();</span><br><span class="line">            link-&gt;node-&gt;ping_sent = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//去除节点的客观下线标记</span></span><br><span class="line">            <span class="keyword">if</span> (nodeTimedOut(link-&gt;node)) &#123;</span><br><span class="line">                link-&gt;node-&gt;flags &amp;= ~CLUSTER_NODE_PFAIL;</span><br><span class="line">                clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                                     CLUSTER_TODO_UPDATE_STATE);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeFailed(link-&gt;node)) &#123;</span><br><span class="line">                <span class="comment">//尝试剔除主观下线标记</span></span><br><span class="line">                clearNodeFailureIfNeeded(link-&gt;node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查master/slave角色变化</span></span><br><span class="line">        <span class="keyword">if</span> (sender) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//节点自报salveof为空，是master</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">memcmp</span>(hdr-&gt;slaveof,CLUSTER_NODE_NULL_NAME,</span><br><span class="line">                <span class="keyword">sizeof</span>(hdr-&gt;slaveof)))</span><br><span class="line">            &#123;</span><br><span class="line">                clusterSetNodeAsMaster(sender);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//自报是slave</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//查找对应的master</span></span><br><span class="line">                clusterNode *master = clusterLookupNode(hdr-&gt;slaveof);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//我们已知是master，现在自报是slave</span></span><br><span class="line">                <span class="keyword">if</span> (nodeIsMaster(sender)) &#123;</span><br><span class="line">                    <span class="comment">//删除槽点管理</span></span><br><span class="line">                    clusterDelNodeSlots(sender);</span><br><span class="line">                    sender-&gt;flags &amp;= ~(CLUSTER_NODE_MASTER|</span><br><span class="line">                                       CLUSTER_NODE_MIGRATE_TO);</span><br><span class="line">                    sender-&gt;flags |= CLUSTER_NODE_SLAVE;</span><br><span class="line"></span><br><span class="line">                    clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                                         CLUSTER_TODO_UPDATE_STATE);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//master发生变化</span></span><br><span class="line">                <span class="keyword">if</span> (master &amp;&amp; sender-&gt;slaveof != master) &#123;</span><br><span class="line">                    <span class="comment">//从旧的master中剔除该slave</span></span><br><span class="line">                    <span class="keyword">if</span> (sender-&gt;slaveof)</span><br><span class="line">                        clusterNodeRemoveSlave(sender-&gt;slaveof,sender);</span><br><span class="line">                    <span class="comment">//新的master增加slave</span></span><br><span class="line">                    clusterNodeAddSlave(master,sender);</span><br><span class="line">                    sender-&gt;slaveof = master;</span><br><span class="line"></span><br><span class="line">                    clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新槽点路由表</span></span><br><span class="line">        clusterNode *sender_master = <span class="literal">NULL</span>; <span class="comment">//消息节点对应的master</span></span><br><span class="line">        <span class="keyword">int</span> dirty_slots = <span class="number">0</span>; <span class="comment">//和我们已知的槽点映射不同的数量</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sender) &#123;</span><br><span class="line">            sender_master = nodeIsMaster(sender) ? sender : sender-&gt;slaveof;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//master已知的话，直接比对槽点位图</span></span><br><span class="line">            <span class="keyword">if</span> (sender_master) &#123;</span><br><span class="line">                dirty_slots = <span class="built_in">memcmp</span>(sender_master-&gt;slots,</span><br><span class="line">                        hdr-&gt;myslots,<span class="keyword">sizeof</span>(hdr-&gt;myslots)) != <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//消息来源是master(我们也只更新master对应的槽点)，并且消息汇报和我们已知的映射有不一样的，更新节点位图和路由表</span></span><br><span class="line">        <span class="keyword">if</span> (sender &amp;&amp; nodeIsMaster(sender) &amp;&amp; dirty_slots)</span><br><span class="line">            clusterUpdateSlotsConfigWith(sender,senderConfigEpoch,hdr-&gt;myslots);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果发送方的信息是滞后的，我们告知其update</span></span><br><span class="line">        <span class="keyword">if</span> (sender &amp;&amp; dirty_slots) &#123;</span><br><span class="line">            <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bitmapTestBit(hdr-&gt;myslots,j)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (server.cluster-&gt;slots[j] == sender ||</span><br><span class="line">                        server.cluster-&gt;slots[j] == <span class="literal">NULL</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//信息滞后    </span></span><br><span class="line">                    <span class="keyword">if</span> (server.cluster-&gt;slots[j]-&gt;configEpoch &gt;</span><br><span class="line">                        senderConfigEpoch)</span><br><span class="line">                    &#123;</span><br><span class="line">                        serverLog(LL_VERBOSE,</span><br><span class="line">                            <span class="string">&quot;Node %.40s has old slots configuration, sending &quot;</span></span><br><span class="line">                            <span class="string">&quot;an UPDATE message about %.40s&quot;</span>,</span><br><span class="line">                                sender-&gt;name, server.cluster-&gt;slots[j]-&gt;name);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//发送update</span></span><br><span class="line">                        clusterSendUpdate(sender-&gt;link,</span><br><span class="line">                            server.cluster-&gt;slots[j]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新配置纪元</span></span><br><span class="line">        <span class="keyword">if</span> (sender &amp;&amp;</span><br><span class="line">            nodeIsMaster(myself) &amp;&amp; nodeIsMaster(sender) &amp;&amp;</span><br><span class="line">            senderConfigEpoch == myself-&gt;configEpoch)</span><br><span class="line">        &#123;</span><br><span class="line">            clusterHandleConfigEpochCollision(sender);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//相信已知节点的拓扑消息</span></span><br><span class="line">        <span class="keyword">if</span> (sender) clusterProcessGossipSection(hdr,link);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_FAIL) &#123;</span><br><span class="line">        <span class="comment">//节点客观下线消息</span></span><br><span class="line">        clusterNode *failing;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sender) &#123;</span><br><span class="line">            failing = clusterLookupNode(hdr-&gt;data.fail.about.nodename);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//只要节点是我们已知的，直接将其标记客观下线，不经过主管-&gt;客观了</span></span><br><span class="line">            <span class="keyword">if</span> (failing &amp;&amp;</span><br><span class="line">                !(failing-&gt;flags &amp; (CLUSTER_NODE_FAIL|CLUSTER_NODE_MYSELF)))</span><br><span class="line">            &#123;</span><br><span class="line">                serverLog(LL_NOTICE,</span><br><span class="line">                    <span class="string">&quot;FAIL message received from %.40s about %.40s&quot;</span>,</span><br><span class="line">                    hdr-&gt;sender, hdr-&gt;data.fail.about.nodename);</span><br><span class="line">                failing-&gt;flags |= CLUSTER_NODE_FAIL;</span><br><span class="line">                failing-&gt;fail_time = mstime();</span><br><span class="line">                failing-&gt;flags &amp;= ~CLUSTER_NODE_PFAIL;</span><br><span class="line">                clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                                     CLUSTER_TODO_UPDATE_STATE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            serverLog(LL_NOTICE,</span><br><span class="line">                <span class="string">&quot;Ignoring FAIL message from unknown node %.40s about %.40s&quot;</span>,</span><br><span class="line">                hdr-&gt;sender, hdr-&gt;data.fail.about.nodename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_PUBLISH) &#123;</span><br><span class="line">        <span class="comment">//发布消息</span></span><br><span class="line">        robj *channel, *message;</span><br><span class="line">        <span class="keyword">uint32_t</span> channel_len, message_len;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//只有当目前频道不为空的时候，才处理</span></span><br><span class="line">        <span class="keyword">if</span> (dictSize(server.pubsub_channels) ||</span><br><span class="line">           listLength(server.pubsub_patterns))</span><br><span class="line">        &#123;</span><br><span class="line">            channel_len = ntohl(hdr-&gt;data.publish.msg.channel_len);</span><br><span class="line">            message_len = ntohl(hdr-&gt;data.publish.msg.message_len);</span><br><span class="line">            channel = createStringObject(</span><br><span class="line">                        (<span class="keyword">char</span>*)hdr-&gt;data.publish.msg.bulk_data,channel_len);</span><br><span class="line">            message = createStringObject(</span><br><span class="line">                        (<span class="keyword">char</span>*)hdr-&gt;data.publish.msg.bulk_data+channel_len,</span><br><span class="line">                        message_len);</span><br><span class="line">            pubsubPublishMessage(channel,message);</span><br><span class="line">            decrRefCount(channel);</span><br><span class="line">            decrRefCount(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST) &#123;</span><br><span class="line">        <span class="comment">//请求投票</span></span><br><span class="line">        <span class="keyword">if</span> (!sender) <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">//不知道节点的话，不回复</span></span><br><span class="line">        clusterSendFailoverAuthIfNeeded(sender,hdr);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK) &#123;</span><br><span class="line">        <span class="comment">//收到投票的同意</span></span><br><span class="line">        <span class="keyword">if</span> (!sender) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//有效的master才算票数</span></span><br><span class="line">        <span class="keyword">if</span> (nodeIsMaster(sender) &amp;&amp; sender-&gt;numslots &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            senderCurrentEpoch &gt;= server.cluster-&gt;failover_auth_epoch)</span><br><span class="line">        &#123;</span><br><span class="line">            server.cluster-&gt;failover_auth_count++;</span><br><span class="line">            clusterDoBeforeSleep(CLUSTER_TODO_HANDLE_FAILOVER);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_MFSTART) &#123;</span><br><span class="line">        <span class="comment">//手动故障修复，只能发生在自己是master，消息来源是我们的一个slave</span></span><br><span class="line">        <span class="keyword">if</span> (!sender || sender-&gt;slaveof != myself) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        resetManualFailover();</span><br><span class="line">        <span class="comment">//故障修复时间截止</span></span><br><span class="line">        server.cluster-&gt;mf_end = mstime() + CLUSTER_MF_TIMEOUT;</span><br><span class="line">        <span class="comment">//故障修复主导的slave</span></span><br><span class="line">        server.cluster-&gt;mf_slave = sender;</span><br><span class="line">        <span class="comment">//暂停客户端</span></span><br><span class="line">        pauseClients(mstime()+(CLUSTER_MF_TIMEOUT*<span class="number">2</span>));</span><br><span class="line">        serverLog(LL_WARNING,<span class="string">&quot;Manual failover requested by replica %.40s.&quot;</span>,</span><br><span class="line">            sender-&gt;name);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_UPDATE) &#123;</span><br><span class="line">        <span class="comment">//更新槽点信息</span></span><br><span class="line">        clusterNode *n;</span><br><span class="line">        <span class="keyword">uint64_t</span> reportedConfigEpoch =</span><br><span class="line">                    ntohu64(hdr-&gt;data.update.nodecfg.configEpoch);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!sender) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        n = clusterLookupNode(hdr-&gt;data.update.nodecfg.nodename);</span><br><span class="line">        <span class="keyword">if</span> (!n) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (n-&gt;configEpoch &gt;= reportedConfigEpoch) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nodeIsSlave(n)) clusterSetNodeAsMaster(n);</span><br><span class="line"></span><br><span class="line">        n-&gt;configEpoch = reportedConfigEpoch;</span><br><span class="line">        clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                             CLUSTER_TODO_FSYNC_CONFIG);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新槽点</span></span><br><span class="line">        clusterUpdateSlotsConfigWith(n,reportedConfigEpoch,</span><br><span class="line">            hdr-&gt;data.update.nodecfg.slots);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_MODULE) &#123;</span><br><span class="line">        <span class="comment">//模块消息</span></span><br><span class="line">        <span class="keyword">if</span> (!sender) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">uint64_t</span> module_id = hdr-&gt;data.<span class="keyword">module</span>.msg.module_id; <span class="comment">/* Endian-safe ID */</span></span><br><span class="line">        <span class="keyword">uint32_t</span> len = ntohl(hdr-&gt;data.<span class="keyword">module</span>.msg.len);</span><br><span class="line">        <span class="keyword">uint8_t</span> type = hdr-&gt;data.<span class="keyword">module</span>.msg.type;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> *payload = hdr-&gt;data.<span class="keyword">module</span>.msg.bulk_data;</span><br><span class="line">        moduleCallClusterReceivers(sender-&gt;name,module_id,type,payload,len);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        serverLog(LL_WARNING,<span class="string">&quot;Received unknown packet type: %d&quot;</span>, type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="handleLinkIOError"><a href="#handleLinkIOError" class="headerlink" title="handleLinkIOError"></a>handleLinkIOError</h5><p>处理连接IO错误</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handleLinkIOError</span><span class="params">(clusterLink *link)</span> </span>&#123;</span><br><span class="line">    freeClusterLink(link);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterWriteHandler"><a href="#clusterWriteHandler" class="headerlink" title="clusterWriteHandler"></a>clusterWriteHandler</h5><p>处理连接写操作，将缓冲区内容发送出去</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterWriteHandler</span><span class="params">(aeEventLoop *el, <span class="keyword">int</span> fd, <span class="keyword">void</span> *privdata, <span class="keyword">int</span> mask)</span> </span>&#123;</span><br><span class="line">    clusterLink *link = (clusterLink*) privdata;</span><br><span class="line">    <span class="keyword">ssize_t</span> nwritten;</span><br><span class="line">    UNUSED(el);</span><br><span class="line">    UNUSED(mask);</span><br><span class="line"></span><br><span class="line">    nwritten = write(fd, link-&gt;sndbuf, sdslen(link-&gt;sndbuf));</span><br><span class="line">    <span class="keyword">if</span> (nwritten &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        serverLog(LL_DEBUG,<span class="string">&quot;I/O error writing to node link: %s&quot;</span>,</span><br><span class="line">            (nwritten == <span class="number">-1</span>) ? strerror(errno) : <span class="string">&quot;short write&quot;</span>);</span><br><span class="line">        handleLinkIOError(link);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sdsrange(link-&gt;sndbuf,nwritten,<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消息发送完了，剔除写事件监听</span></span><br><span class="line">    <span class="keyword">if</span> (sdslen(link-&gt;sndbuf) == <span class="number">0</span>)</span><br><span class="line">        aeDeleteFileEvent(server.el, link-&gt;fd, AE_WRITABLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterReadHandler"><a href="#clusterReadHandler" class="headerlink" title="clusterReadHandler"></a>clusterReadHandler</h5><p>处理连接读操作，在第一次建立完连接后，所有的消息处理都是在这里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterReadHandler</span><span class="params">(aeEventLoop *el, <span class="keyword">int</span> fd, <span class="keyword">void</span> *privdata, <span class="keyword">int</span> mask)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="keyword">sizeof</span>(clusterMsg)];</span><br><span class="line">    <span class="keyword">ssize_t</span> nread;</span><br><span class="line">    clusterMsg *hdr;</span><br><span class="line">    clusterLink *link = (clusterLink*) privdata;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> readlen, rcvbuflen;</span><br><span class="line">    UNUSED(el);</span><br><span class="line">    UNUSED(mask);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//已接收到未处理的长度</span></span><br><span class="line">        rcvbuflen = sdslen(link-&gt;rcvbuf);</span><br><span class="line">        <span class="comment">//我们需要根据头8个字节来判断消息类型和总的消息长度，所以不够8字节的话，要先读够8字节</span></span><br><span class="line">        <span class="keyword">if</span> (rcvbuflen &lt; <span class="number">8</span>) &#123;</span><br><span class="line">            readlen = <span class="number">8</span> - rcvbuflen;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            hdr = (clusterMsg*) link-&gt;rcvbuf;</span><br><span class="line">            <span class="keyword">if</span> (rcvbuflen == <span class="number">8</span>) &#123;</span><br><span class="line">                <span class="comment">//读够8字节，先校验协议和数据长度是否满足最小要求</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">memcmp</span>(hdr-&gt;sig,<span class="string">&quot;RCmb&quot;</span>,<span class="number">4</span>) != <span class="number">0</span> ||</span><br><span class="line">                    ntohl(hdr-&gt;totlen) &lt; CLUSTERMSG_MIN_LEN)</span><br><span class="line">                &#123;</span><br><span class="line">                    serverLog(LL_WARNING,</span><br><span class="line">                        <span class="string">&quot;Bad message length or signature received &quot;</span></span><br><span class="line">                        <span class="string">&quot;from Cluster bus.&quot;</span>);</span><br><span class="line">                    handleLinkIOError(link);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//确定一个完成消息，还需要读取多少字节</span></span><br><span class="line">            readlen = ntohl(hdr-&gt;totlen) - rcvbuflen;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//消息太长的话，分批处理，一次只读固定长度</span></span><br><span class="line">            <span class="keyword">if</span> (readlen &gt; <span class="keyword">sizeof</span>(buf)) readlen = <span class="keyword">sizeof</span>(buf);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nread = read(fd,buf,readlen);</span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span> &amp;&amp; errno == EAGAIN) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* I/O error... */</span></span><br><span class="line">            serverLog(LL_DEBUG,<span class="string">&quot;I/O error reading from node link: %s&quot;</span>,</span><br><span class="line">                (nread == <span class="number">0</span>) ? <span class="string">&quot;connection closed&quot;</span> : strerror(errno));</span><br><span class="line">            handleLinkIOError(link);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//把数据放到link缓冲区</span></span><br><span class="line">            link-&gt;rcvbuf = sdscatlen(link-&gt;rcvbuf,buf,nread);</span><br><span class="line">            hdr = (clusterMsg*) link-&gt;rcvbuf;</span><br><span class="line">            rcvbuflen += nread;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//已经读取到完成的消息了，开始处理</span></span><br><span class="line">        <span class="keyword">if</span> (rcvbuflen &gt;= <span class="number">8</span> &amp;&amp; rcvbuflen == ntohl(hdr-&gt;totlen)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clusterProcessPacket(link)) &#123;</span><br><span class="line">                sdsfree(link-&gt;rcvbuf);</span><br><span class="line">                link-&gt;rcvbuf = sdsempty();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterSendMessage"><a href="#clusterSendMessage" class="headerlink" title="clusterSendMessage"></a>clusterSendMessage</h5><p>向连接发送消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterSendMessage</span><span class="params">(clusterLink *link, <span class="keyword">unsigned</span> <span class="keyword">char</span> *msg, <span class="keyword">size_t</span> msglen)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//当连接没有数据时，建立写监听事件</span></span><br><span class="line">    <span class="keyword">if</span> (sdslen(link-&gt;sndbuf) == <span class="number">0</span> &amp;&amp; msglen != <span class="number">0</span>)</span><br><span class="line">        aeCreateFileEvent(server.el,link-&gt;fd,AE_WRITABLE|AE_BARRIER,</span><br><span class="line">                    clusterWriteHandler,link);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//写入数据到缓冲区</span></span><br><span class="line">    link-&gt;sndbuf = sdscatlen(link-&gt;sndbuf, msg, msglen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//命令统计信息</span></span><br><span class="line">    clusterMsg *hdr = (clusterMsg*) msg;</span><br><span class="line">    <span class="keyword">uint16_t</span> type = ntohs(hdr-&gt;type);</span><br><span class="line">    <span class="keyword">if</span> (type &lt; CLUSTERMSG_TYPE_COUNT)</span><br><span class="line">        server.cluster-&gt;stats_bus_messages_sent[type]++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterBroadcastMessage"><a href="#clusterBroadcastMessage" class="headerlink" title="clusterBroadcastMessage"></a>clusterBroadcastMessage</h5><p>向所有有效节点发送消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterBroadcastMessage</span><span class="params">(<span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        clusterNode *node = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//过滤没有连接和非握手中的节点</span></span><br><span class="line">        <span class="keyword">if</span> (!node-&gt;link) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (node-&gt;flags &amp; (CLUSTER_NODE_MYSELF|CLUSTER_NODE_HANDSHAKE))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        clusterSendMessage(node-&gt;link,buf,len);</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterBuildMessageHdr"><a href="#clusterBuildMessageHdr" class="headerlink" title="clusterBuildMessageHdr"></a>clusterBuildMessageHdr</h5><p>构建消息头</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterBuildMessageHdr</span><span class="params">(clusterMsg *hdr, <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> totlen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> offset;</span><br><span class="line">    clusterNode *master;</span><br><span class="line"></span><br><span class="line">    master = (nodeIsSlave(myself) &amp;&amp; myself-&gt;slaveof) ?</span><br><span class="line">              myself-&gt;slaveof : myself;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//格式化，清零</span></span><br><span class="line">    <span class="built_in">memset</span>(hdr,<span class="number">0</span>,<span class="keyword">sizeof</span>(*hdr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消息版本</span></span><br><span class="line">    hdr-&gt;ver = htons(CLUSTER_PROTO_VER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//头四位标记</span></span><br><span class="line">    hdr-&gt;sig[<span class="number">0</span>] = <span class="string">&#x27;R&#x27;</span>;</span><br><span class="line">    hdr-&gt;sig[<span class="number">1</span>] = <span class="string">&#x27;C&#x27;</span>;</span><br><span class="line">    hdr-&gt;sig[<span class="number">2</span>] = <span class="string">&#x27;m&#x27;</span>;</span><br><span class="line">    hdr-&gt;sig[<span class="number">3</span>] = <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line">    hdr-&gt;type = htons(type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送方名称</span></span><br><span class="line">    <span class="built_in">memcpy</span>(hdr-&gt;sender,myself-&gt;name,CLUSTER_NAMELEN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ip</span></span><br><span class="line">    <span class="built_in">memset</span>(hdr-&gt;myip,<span class="number">0</span>,NET_IP_STR_LEN);</span><br><span class="line">    <span class="keyword">if</span> (server.cluster_announce_ip) &#123;</span><br><span class="line">        <span class="built_in">strncpy</span>(hdr-&gt;myip,server.cluster_announce_ip,NET_IP_STR_LEN);</span><br><span class="line">        hdr-&gt;myip[NET_IP_STR_LEN<span class="number">-1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> announced_port = server.cluster_announce_port ?</span><br><span class="line">                         server.cluster_announce_port : server.port;</span><br><span class="line">    <span class="keyword">int</span> announced_cport = server.cluster_announce_bus_port ?</span><br><span class="line">                          server.cluster_announce_bus_port :</span><br><span class="line">                          (server.port + CLUSTER_PORT_INCR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//master对应的槽点位图                          </span></span><br><span class="line">    <span class="built_in">memcpy</span>(hdr-&gt;myslots,master-&gt;slots,<span class="keyword">sizeof</span>(hdr-&gt;myslots));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//aster名称</span></span><br><span class="line">    <span class="built_in">memset</span>(hdr-&gt;slaveof,<span class="number">0</span>,CLUSTER_NAMELEN);</span><br><span class="line">    <span class="keyword">if</span> (myself-&gt;slaveof != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">memcpy</span>(hdr-&gt;slaveof,myself-&gt;slaveof-&gt;name, CLUSTER_NAMELEN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送方普通端口、集群端口，标记、状态</span></span><br><span class="line">    hdr-&gt;port = htons(announced_port);</span><br><span class="line">    hdr-&gt;cport = htons(announced_cport);</span><br><span class="line">    hdr-&gt;flags = htons(myself-&gt;flags);</span><br><span class="line">    hdr-&gt;state = server.cluster-&gt;state;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//纪元和配置纪元</span></span><br><span class="line">    hdr-&gt;currentEpoch = htonu64(server.cluster-&gt;currentEpoch);</span><br><span class="line">    hdr-&gt;configEpoch = htonu64(master-&gt;configEpoch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主从同步偏移量</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsSlave(myself))</span><br><span class="line">        offset = replicationGetSlaveOffset();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        offset = server.master_repl_offset;</span><br><span class="line">    hdr-&gt;offset = htonu64(offset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消息标志位，客户端暂停标志，目前正进行故障修复</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsMaster(myself) &amp;&amp; server.cluster-&gt;mf_end)</span><br><span class="line">        hdr-&gt;mflags[<span class="number">0</span>] |= CLUSTERMSG_FLAG0_PAUSED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算总的消息长度，这里只计算了FAIL和UPDATE类型，其余类型需要会涉及到消息体数量的问题，所以需要自己计算</span></span><br><span class="line">    <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_FAIL) &#123;</span><br><span class="line">        totlen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line">        totlen += <span class="keyword">sizeof</span>(clusterMsgDataFail);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == CLUSTERMSG_TYPE_UPDATE) &#123;</span><br><span class="line">        totlen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line">        totlen += <span class="keyword">sizeof</span>(clusterMsgDataUpdate);</span><br><span class="line">    &#125;</span><br><span class="line">    hdr-&gt;totlen = htonl(totlen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterNodeIsInGossipSection"><a href="#clusterNodeIsInGossipSection" class="headerlink" title="clusterNodeIsInGossipSection"></a>clusterNodeIsInGossipSection</h5><p>判断某个节点是否在gossip协议中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterNodeIsInGossipSection</span><span class="params">(clusterMsg *hdr, <span class="keyword">int</span> count, clusterNode *n)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; count; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">memcmp</span>(hdr-&gt;data.ping.gossip[j].nodename,n-&gt;name,</span><br><span class="line">                CLUSTER_NAMELEN) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> j != count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterSetGossipEntry"><a href="#clusterSetGossipEntry" class="headerlink" title="clusterSetGossipEntry"></a>clusterSetGossipEntry</h5><p>设置goosip第一个消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterSetGossipEntry</span><span class="params">(clusterMsg *hdr, <span class="keyword">int</span> i, clusterNode *n)</span> </span>&#123;</span><br><span class="line">    clusterMsgDataGossip *gossip;</span><br><span class="line">    gossip = &amp;(hdr-&gt;data.ping.gossip[i]);</span><br><span class="line">    <span class="built_in">memcpy</span>(gossip-&gt;nodename,n-&gt;name,CLUSTER_NAMELEN);</span><br><span class="line">    gossip-&gt;ping_sent = htonl(n-&gt;ping_sent/<span class="number">1000</span>);</span><br><span class="line">    gossip-&gt;pong_received = htonl(n-&gt;pong_received/<span class="number">1000</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(gossip-&gt;ip,n-&gt;ip,<span class="keyword">sizeof</span>(n-&gt;ip));</span><br><span class="line">    gossip-&gt;port = htons(n-&gt;port);</span><br><span class="line">    gossip-&gt;cport = htons(n-&gt;cport);</span><br><span class="line">    gossip-&gt;flags = htons(n-&gt;flags);</span><br><span class="line">    gossip-&gt;notused1 = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterSendPing"><a href="#clusterSendPing" class="headerlink" title="clusterSendPing"></a>clusterSendPing</h5><p>发送心跳检测命令，根据type决定是ping/pong/meet，因为这三者只有类型不同，其余都一样</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterSendPing</span><span class="params">(clusterLink *link, <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf;</span><br><span class="line">    clusterMsg *hdr;</span><br><span class="line">    <span class="keyword">int</span> gossipcount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> wanted; <span class="comment">//期望的goosip数量</span></span><br><span class="line">    <span class="keyword">int</span> totlen; <span class="comment">//数据总长度</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//有效节点数：总的节点数量-自己-发送目标节点</span></span><br><span class="line">    <span class="keyword">int</span> freshnodes = dictSize(server.cluster-&gt;nodes)<span class="number">-2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//期望发送的节点数量，1/10或者三个</span></span><br><span class="line">    wanted = <span class="built_in">floor</span>(dictSize(server.cluster-&gt;nodes)/<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (wanted &lt; <span class="number">3</span>) wanted = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> (wanted &gt; freshnodes) wanted = freshnodes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主观下线的节点都加上，为了更快的完成从主观下线到客观下线</span></span><br><span class="line">    <span class="keyword">int</span> pfail_wanted = server.cluster-&gt;stats_pfail_nodes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算总的消息长度</span></span><br><span class="line">    totlen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line">    totlen += (<span class="keyword">sizeof</span>(clusterMsgDataGossip)*(wanted+pfail_wanted));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (totlen &lt; (<span class="keyword">int</span>)<span class="keyword">sizeof</span>(clusterMsg)) totlen = <span class="keyword">sizeof</span>(clusterMsg);</span><br><span class="line">    buf = zcalloc(totlen);</span><br><span class="line">    hdr = (clusterMsg*) buf;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录ping发送时间</span></span><br><span class="line">    <span class="keyword">if</span> (link-&gt;node &amp;&amp; type == CLUSTERMSG_TYPE_PING)</span><br><span class="line">        link-&gt;node-&gt;ping_sent = mstime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构建消息头</span></span><br><span class="line">    clusterBuildMessageHdr(hdr,type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成gossip内容</span></span><br><span class="line">    <span class="keyword">int</span> maxiterations = wanted*<span class="number">3</span>; <span class="comment">//因为是随机取的节点，所以会有重复的，我们提高随机获取的数量，尽可能的保证接近wanted个不同的节点</span></span><br><span class="line">    <span class="keyword">while</span>(freshnodes &gt; <span class="number">0</span> &amp;&amp; gossipcount &lt; wanted &amp;&amp; maxiterations--) &#123;</span><br><span class="line">        <span class="comment">//随机获取</span></span><br><span class="line">        dictEntry *de = dictGetRandomKey(server.cluster-&gt;nodes);</span><br><span class="line">        clusterNode *<span class="keyword">this</span> = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//剔除自己，因为消息头里有自己</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == myself) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//主观下线的会在后面</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;flags &amp; CLUSTER_NODE_PFAIL) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//剔除握手&amp;没有地址的节点，以及非有效节点</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;flags &amp; (CLUSTER_NODE_HANDSHAKE|CLUSTER_NODE_NOADDR) ||</span><br><span class="line">            (<span class="keyword">this</span>-&gt;link == <span class="literal">NULL</span> &amp;&amp; <span class="keyword">this</span>-&gt;numslots == <span class="number">0</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            freshnodes--;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//去重</span></span><br><span class="line">        <span class="keyword">if</span> (clusterNodeIsInGossipSection(hdr,gossipcount,<span class="keyword">this</span>)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//增加</span></span><br><span class="line">        clusterSetGossipEntry(hdr,gossipcount,<span class="keyword">this</span>);</span><br><span class="line">        freshnodes--;</span><br><span class="line">        gossipcount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加全部的主观下线节点</span></span><br><span class="line">    <span class="keyword">if</span> (pfail_wanted) &#123;</span><br><span class="line">        dictIterator *di;</span><br><span class="line">        dictEntry *de;</span><br><span class="line"></span><br><span class="line">        di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span> &amp;&amp; pfail_wanted &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            clusterNode *node = dictGetVal(de);</span><br><span class="line">            <span class="keyword">if</span> (node-&gt;flags &amp; CLUSTER_NODE_HANDSHAKE) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (node-&gt;flags &amp; CLUSTER_NODE_NOADDR) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (!(node-&gt;flags &amp; CLUSTER_NODE_PFAIL)) <span class="keyword">continue</span>;</span><br><span class="line">            clusterSetGossipEntry(hdr,gossipcount,node);</span><br><span class="line">            freshnodes--;</span><br><span class="line">            gossipcount++;</span><br><span class="line">            pfail_wanted--;</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算总的消息长度</span></span><br><span class="line">    totlen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line">    totlen += (<span class="keyword">sizeof</span>(clusterMsgDataGossip)*gossipcount);</span><br><span class="line">    hdr-&gt;count = htons(gossipcount);</span><br><span class="line">    hdr-&gt;totlen = htonl(totlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送消息</span></span><br><span class="line">    clusterSendMessage(link,buf,totlen);</span><br><span class="line">    zfree(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterBroadcastPong"><a href="#clusterBroadcastPong" class="headerlink" title="clusterBroadcastPong"></a>clusterBroadcastPong</h5><p>向所有节点广播pong消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_BROADCAST_ALL 0 <span class="comment">//所有的节点</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_BROADCAST_LOCAL_SLAVES 1 <span class="comment">//我们的salve节点</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterBroadcastPong</span><span class="params">(<span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        clusterNode *node = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!node-&gt;link) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (node == myself || nodeInHandshake(node)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (target == CLUSTER_BROADCAST_LOCAL_SLAVES) &#123;</span><br><span class="line">            <span class="keyword">int</span> local_slave =</span><br><span class="line">                nodeIsSlave(node) &amp;&amp; node-&gt;slaveof &amp;&amp;</span><br><span class="line">                (node-&gt;slaveof == myself || node-&gt;slaveof == myself-&gt;slaveof);</span><br><span class="line">            <span class="keyword">if</span> (!local_slave) <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        clusterSendPing(node-&gt;link,CLUSTERMSG_TYPE_PONG);</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterSendPublish"><a href="#clusterSendPublish" class="headerlink" title="clusterSendPublish"></a>clusterSendPublish</h5><p>发布消息，link为空时，目标为所有节点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterSendPublish</span><span class="params">(clusterLink *link, robj *channel, robj *message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="keyword">sizeof</span>(clusterMsg)], *payload;</span><br><span class="line">    clusterMsg *hdr = (clusterMsg*) buf;</span><br><span class="line">    <span class="keyword">uint32_t</span> totlen;</span><br><span class="line">    <span class="keyword">uint32_t</span> channel_len, message_len;</span><br><span class="line"></span><br><span class="line">    channel = getDecodedObject(channel);</span><br><span class="line">    message = getDecodedObject(message);</span><br><span class="line">    channel_len = sdslen(channel-&gt;ptr);</span><br><span class="line">    message_len = sdslen(message-&gt;ptr);</span><br><span class="line"></span><br><span class="line">    clusterBuildMessageHdr(hdr,CLUSTERMSG_TYPE_PUBLISH);</span><br><span class="line">    totlen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line">    totlen += <span class="keyword">sizeof</span>(clusterMsgDataPublish) - <span class="number">8</span> + channel_len + message_len;</span><br><span class="line"></span><br><span class="line">    hdr-&gt;data.publish.msg.channel_len = htonl(channel_len);</span><br><span class="line">    hdr-&gt;data.publish.msg.message_len = htonl(message_len);</span><br><span class="line">    hdr-&gt;totlen = htonl(totlen);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (totlen &lt; <span class="keyword">sizeof</span>(buf)) &#123;</span><br><span class="line">        payload = buf;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        payload = zmalloc(totlen);</span><br><span class="line">        <span class="built_in">memcpy</span>(payload,hdr,<span class="keyword">sizeof</span>(*hdr));</span><br><span class="line">        hdr = (clusterMsg*) payload;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(hdr-&gt;data.publish.msg.bulk_data,channel-&gt;ptr,sdslen(channel-&gt;ptr));</span><br><span class="line">    <span class="built_in">memcpy</span>(hdr-&gt;data.publish.msg.bulk_data+sdslen(channel-&gt;ptr),</span><br><span class="line">        message-&gt;ptr,sdslen(message-&gt;ptr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (link)</span><br><span class="line">        clusterSendMessage(link,payload,totlen);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        clusterBroadcastMessage(payload,totlen);</span><br><span class="line"></span><br><span class="line">    decrRefCount(channel);</span><br><span class="line">    decrRefCount(message);</span><br><span class="line">    <span class="keyword">if</span> (payload != buf) zfree(payload);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterSendFail"><a href="#clusterSendFail" class="headerlink" title="clusterSendFail"></a>clusterSendFail</h5><p>广播某个节点客观下线</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterSendFail</span><span class="params">(<span class="keyword">char</span> *nodename)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="keyword">sizeof</span>(clusterMsg)];</span><br><span class="line">    clusterMsg *hdr = (clusterMsg*) buf;</span><br><span class="line"></span><br><span class="line">    clusterBuildMessageHdr(hdr,CLUSTERMSG_TYPE_FAIL);</span><br><span class="line">    <span class="built_in">memcpy</span>(hdr-&gt;data.fail.about.nodename,nodename,CLUSTER_NAMELEN);</span><br><span class="line">    clusterBroadcastMessage(buf,ntohl(hdr-&gt;totlen));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="clusterSendUpdate"><a href="#clusterSendUpdate" class="headerlink" title="clusterSendUpdate"></a>clusterSendUpdate</h5><p>告诉某个节点其配置需要更新</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterSendUpdate</span><span class="params">(clusterLink *link, clusterNode *node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="keyword">sizeof</span>(clusterMsg)];</span><br><span class="line">    clusterMsg *hdr = (clusterMsg*) buf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (link == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">    clusterBuildMessageHdr(hdr,CLUSTERMSG_TYPE_UPDATE);</span><br><span class="line">    <span class="built_in">memcpy</span>(hdr-&gt;data.update.nodecfg.nodename,node-&gt;name,CLUSTER_NAMELEN);</span><br><span class="line">    hdr-&gt;data.update.nodecfg.configEpoch = htonu64(node-&gt;configEpoch);</span><br><span class="line">    <span class="built_in">memcpy</span>(hdr-&gt;data.update.nodecfg.slots,node-&gt;slots,<span class="keyword">sizeof</span>(node-&gt;slots));</span><br><span class="line">    clusterSendMessage(link,buf,ntohl(hdr-&gt;totlen));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterSendModule"><a href="#clusterSendModule" class="headerlink" title="clusterSendModule"></a>clusterSendModule</h5><p>发送模块消息，link为空时，目标为所有节点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterSendModule</span><span class="params">(clusterLink *link, <span class="keyword">uint64_t</span> module_id, <span class="keyword">uint8_t</span> type,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">unsigned</span> <span class="keyword">char</span> *payload, <span class="keyword">uint32_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="keyword">sizeof</span>(clusterMsg)], *heapbuf;</span><br><span class="line">    clusterMsg *hdr = (clusterMsg*) buf;</span><br><span class="line">    <span class="keyword">uint32_t</span> totlen;</span><br><span class="line"></span><br><span class="line">    clusterBuildMessageHdr(hdr,CLUSTERMSG_TYPE_MODULE);</span><br><span class="line">    totlen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line">    totlen += <span class="keyword">sizeof</span>(clusterMsgModule) - <span class="number">3</span> + len;</span><br><span class="line"></span><br><span class="line">    hdr-&gt;data.<span class="keyword">module</span>.msg.module_id = module_id;</span><br><span class="line">    hdr-&gt;data.<span class="keyword">module</span>.msg.type = type;</span><br><span class="line">    hdr-&gt;data.<span class="keyword">module</span>.msg.len = htonl(len);</span><br><span class="line">    hdr-&gt;totlen = htonl(totlen);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (totlen &lt; <span class="keyword">sizeof</span>(buf)) &#123;</span><br><span class="line">        heapbuf = buf;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        heapbuf = zmalloc(totlen);</span><br><span class="line">        <span class="built_in">memcpy</span>(heapbuf,hdr,<span class="keyword">sizeof</span>(*hdr));</span><br><span class="line">        hdr = (clusterMsg*) heapbuf;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(hdr-&gt;data.<span class="keyword">module</span>.msg.bulk_data,payload,len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (link)</span><br><span class="line">        clusterSendMessage(link,heapbuf,totlen);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        clusterBroadcastMessage(heapbuf,totlen);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (heapbuf != buf) zfree(heapbuf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterSendModuleMessageToTarget"><a href="#clusterSendModuleMessageToTarget" class="headerlink" title="clusterSendModuleMessageToTarget"></a>clusterSendModuleMessageToTarget</h5><p>向目标发送模块消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterSendModuleMessageToTarget</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *target, <span class="keyword">uint64_t</span> module_id, <span class="keyword">uint8_t</span> type, <span class="keyword">unsigned</span> <span class="keyword">char</span> *payload, <span class="keyword">uint32_t</span> len)</span> </span>&#123;</span><br><span class="line">    clusterNode *node = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        node = clusterLookupNode(target);</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">NULL</span> || node-&gt;link == <span class="literal">NULL</span>) <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clusterSendModule(target ? node-&gt;link : <span class="literal">NULL</span>,</span><br><span class="line">                      module_id, type, payload, len);</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterPropagatePublish"><a href="#clusterPropagatePublish" class="headerlink" title="clusterPropagatePublish"></a>clusterPropagatePublish</h5><p>广播发布消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterPropagatePublish</span><span class="params">(robj *channel, robj *message)</span> </span>&#123;</span><br><span class="line">    clusterSendPublish(<span class="literal">NULL</span>, channel, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="slave节点相关"><a href="#slave节点相关" class="headerlink" title="slave节点相关"></a>slave节点相关</h4><h5 id="clusterRequestFailoverAuth"><a href="#clusterRequestFailoverAuth" class="headerlink" title="clusterRequestFailoverAuth"></a>clusterRequestFailoverAuth</h5><p>向所有节点发起投票请求</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterRequestFailoverAuth</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="keyword">sizeof</span>(clusterMsg)];</span><br><span class="line">    clusterMsg *hdr = (clusterMsg*) buf;</span><br><span class="line">    <span class="keyword">uint32_t</span> totlen;</span><br><span class="line"></span><br><span class="line">    clusterBuildMessageHdr(hdr,CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//手动开始修复的话，那么这个投票是必须要回应的，哪怕master是良好的</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;mf_end) hdr-&gt;mflags[<span class="number">0</span>] |= CLUSTERMSG_FLAG0_FORCEACK;</span><br><span class="line">    totlen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line">    hdr-&gt;totlen = htonl(totlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//广播消息</span></span><br><span class="line">    clusterBroadcastMessage(buf,totlen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterSendFailoverAuth"><a href="#clusterSendFailoverAuth" class="headerlink" title="clusterSendFailoverAuth"></a>clusterSendFailoverAuth</h5><p>回复投票确认，不投票的节点，是不发这个消息的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterSendFailoverAuth</span><span class="params">(clusterNode *node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="keyword">sizeof</span>(clusterMsg)];</span><br><span class="line">    clusterMsg *hdr = (clusterMsg*) buf;</span><br><span class="line">    <span class="keyword">uint32_t</span> totlen;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!node-&gt;link) <span class="keyword">return</span>;</span><br><span class="line">    clusterBuildMessageHdr(hdr,CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK);</span><br><span class="line">    totlen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line">    hdr-&gt;totlen = htonl(totlen);</span><br><span class="line">    clusterSendMessage(node-&gt;link,buf,totlen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterSendMFStart"><a href="#clusterSendMFStart" class="headerlink" title="clusterSendMFStart"></a>clusterSendMFStart</h5><p>向某个节点发送手动修复消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterSendMFStart</span><span class="params">(clusterNode *node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="keyword">sizeof</span>(clusterMsg)];</span><br><span class="line">    clusterMsg *hdr = (clusterMsg*) buf;</span><br><span class="line">    <span class="keyword">uint32_t</span> totlen;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!node-&gt;link) <span class="keyword">return</span>;</span><br><span class="line">    clusterBuildMessageHdr(hdr,CLUSTERMSG_TYPE_MFSTART);</span><br><span class="line">    totlen = <span class="keyword">sizeof</span>(clusterMsg)-<span class="keyword">sizeof</span>(<span class="keyword">union</span> clusterMsgData);</span><br><span class="line">    hdr-&gt;totlen = htonl(totlen);</span><br><span class="line">    clusterSendMessage(node-&gt;link,buf,totlen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterSendFailoverAuthIfNeeded"><a href="#clusterSendFailoverAuthIfNeeded" class="headerlink" title="clusterSendFailoverAuthIfNeeded"></a>clusterSendFailoverAuthIfNeeded</h5><p>收到请求投票的请求，处理要不要为其投票</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterSendFailoverAuthIfNeeded</span><span class="params">(clusterNode *node, clusterMsg *request)</span> </span>&#123;</span><br><span class="line">    clusterNode *master = node-&gt;slaveof;</span><br><span class="line">    <span class="keyword">uint64_t</span> requestCurrentEpoch = ntohu64(request-&gt;currentEpoch);</span><br><span class="line">    <span class="keyword">uint64_t</span> requestConfigEpoch = ntohu64(request-&gt;configEpoch);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *claimed_slots = request-&gt;myslots;</span><br><span class="line">    <span class="keyword">int</span> force_ack = request-&gt;mflags[<span class="number">0</span>] &amp; CLUSTERMSG_FLAG0_FORCEACK;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//我们不是有效的master</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsSlave(myself) || myself-&gt;numslots == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拒绝为纪元低于我们的投票</span></span><br><span class="line">    <span class="keyword">if</span> (requestCurrentEpoch &lt; server.cluster-&gt;currentEpoch) &#123;</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Failover auth denied to %.40s: reqEpoch (%llu) &lt; curEpoch(%llu)&quot;</span>,</span><br><span class="line">            node-&gt;name,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) requestCurrentEpoch,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) server.cluster-&gt;currentEpoch);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//同一个纪元已经投过票了</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;lastVoteEpoch == server.cluster-&gt;currentEpoch) &#123;</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">&quot;Failover auth denied to %.40s: already voted for epoch %llu&quot;</span>,</span><br><span class="line">                node-&gt;name,</span><br><span class="line">                (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) server.cluster-&gt;currentEpoch);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nodeIsMaster(node) || master == <span class="literal">NULL</span> ||</span><br><span class="line">        (!nodeFailed(master) &amp;&amp; !force_ack))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//投票发起只能是slave</span></span><br><span class="line">        <span class="keyword">if</span> (nodeIsMaster(node)) &#123;</span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                    <span class="string">&quot;Failover auth denied to %.40s: it is a master node&quot;</span>,</span><br><span class="line">                    node-&gt;name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (master == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">//我们不知道其master</span></span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                    <span class="string">&quot;Failover auth denied to %.40s: I don&#x27;t know its master&quot;</span>,</span><br><span class="line">                    node-&gt;name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!nodeFailed(master)) &#123;</span><br><span class="line">            <span class="comment">//master是良好的，拒绝投</span></span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                    <span class="string">&quot;Failover auth denied to %.40s: its master is up&quot;</span>,</span><br><span class="line">                    node-&gt;name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//投票还没有过期</span></span><br><span class="line">    <span class="keyword">if</span> (mstime() - node-&gt;slaveof-&gt;voted_time &lt; server.cluster_node_timeout * <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">&quot;Failover auth denied to %.40s: &quot;</span></span><br><span class="line">                <span class="string">&quot;can&#x27;t vote about this master before %lld milliseconds&quot;</span>,</span><br><span class="line">                node-&gt;name,</span><br><span class="line">                (<span class="keyword">long</span> <span class="keyword">long</span>) ((server.cluster_node_timeout*<span class="number">2</span>)-</span><br><span class="line">                             (mstime() - node-&gt;slaveof-&gt;voted_time)));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//slave保存的master槽点映射是旧的</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bitmapTestBit(claimed_slots, j) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (server.cluster-&gt;slots[j] == <span class="literal">NULL</span> ||</span><br><span class="line">            server.cluster-&gt;slots[j]-&gt;configEpoch &lt;= requestConfigEpoch)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* If we reached this point we found a slot that in our current slots</span></span><br><span class="line"><span class="comment">         * is served by a master with a greater configEpoch than the one claimed</span></span><br><span class="line"><span class="comment">         * by the slave requesting our vote. Refuse to vote for this slave. */</span></span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">&quot;Failover auth denied to %.40s: &quot;</span></span><br><span class="line">                <span class="string">&quot;slot %d epoch (%llu) &gt; reqEpoch (%llu)&quot;</span>,</span><br><span class="line">                node-&gt;name, j,</span><br><span class="line">                (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) server.cluster-&gt;slots[j]-&gt;configEpoch,</span><br><span class="line">                (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) requestConfigEpoch);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录投票纪元和时间</span></span><br><span class="line">    server.cluster-&gt;lastVoteEpoch = server.cluster-&gt;currentEpoch;</span><br><span class="line">    node-&gt;slaveof-&gt;voted_time = mstime();</span><br><span class="line">    clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|CLUSTER_TODO_FSYNC_CONFIG);</span><br><span class="line">    clusterSendFailoverAuth(node);</span><br><span class="line">    serverLog(LL_WARNING, <span class="string">&quot;Failover auth granted to %.40s for epoch %llu&quot;</span>,</span><br><span class="line">        node-&gt;name, (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) server.cluster-&gt;currentEpoch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterGetSlaveRank"><a href="#clusterGetSlaveRank" class="headerlink" title="clusterGetSlaveRank"></a>clusterGetSlaveRank</h5><p>当自己是salve时，其他slave中同步偏移量比自己大的数量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterGetSlaveRank</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> myoffset;</span><br><span class="line">    <span class="keyword">int</span> j, rank = <span class="number">0</span>;</span><br><span class="line">    clusterNode *master;</span><br><span class="line"></span><br><span class="line">    serverAssert(nodeIsSlave(myself));</span><br><span class="line">    master = myself-&gt;slaveof;</span><br><span class="line">    <span class="keyword">if</span> (master == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    myoffset = replicationGetSlaveOffset();</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; master-&gt;numslaves; j++)</span><br><span class="line">        <span class="keyword">if</span> (master-&gt;slaves[j] != myself &amp;&amp;</span><br><span class="line">            !nodeCantFailover(master-&gt;slaves[j]) &amp;&amp;</span><br><span class="line">            master-&gt;slaves[j]-&gt;repl_offset &gt; myoffset) rank++;</span><br><span class="line">    <span class="keyword">return</span> rank;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterLogCantFailover"><a href="#clusterLogCantFailover" class="headerlink" title="clusterLogCantFailover"></a>clusterLogCantFailover</h5><p>记录不能发起故障修复的原因日志</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterLogCantFailover</span><span class="params">(<span class="keyword">int</span> reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *msg;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">time_t</span> lastlog_time = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">mstime_t</span> nolog_fail_time = server.cluster_node_timeout + <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//同个原因一段时间内只记录一次</span></span><br><span class="line">    <span class="keyword">if</span> (reason == server.cluster-&gt;cant_failover_reason &amp;&amp;</span><br><span class="line">        time(<span class="literal">NULL</span>)-lastlog_time &lt; CLUSTER_CANT_FAILOVER_RELOG_PERIOD)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    server.cluster-&gt;cant_failover_reason = reason;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//master客观下线没多久，也不记录</span></span><br><span class="line">    <span class="keyword">if</span> (myself-&gt;slaveof &amp;&amp;</span><br><span class="line">        nodeFailed(myself-&gt;slaveof) &amp;&amp;</span><br><span class="line">        (mstime() - myself-&gt;slaveof-&gt;fail_time) &lt; nolog_fail_time) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(reason) &#123;</span><br><span class="line">    <span class="keyword">case</span> CLUSTER_CANT_FAILOVER_DATA_AGE:</span><br><span class="line">        msg = <span class="string">&quot;Disconnected from master for longer than allowed. &quot;</span></span><br><span class="line">              <span class="string">&quot;Please check the &#x27;cluster-replica-validity-factor&#x27; configuration &quot;</span></span><br><span class="line">              <span class="string">&quot;option.&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CLUSTER_CANT_FAILOVER_WAITING_DELAY:</span><br><span class="line">        msg = <span class="string">&quot;Waiting the delay before I can start a new failover.&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CLUSTER_CANT_FAILOVER_EXPIRED:</span><br><span class="line">        msg = <span class="string">&quot;Failover attempt expired.&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CLUSTER_CANT_FAILOVER_WAITING_VOTES:</span><br><span class="line">        msg = <span class="string">&quot;Waiting for votes, but majority still not reached.&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        msg = <span class="string">&quot;Unknown reason code.&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    lastlog_time = time(<span class="literal">NULL</span>);</span><br><span class="line">    serverLog(LL_WARNING,<span class="string">&quot;Currently unable to failover: %s&quot;</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterFailoverReplaceYourMaster"><a href="#clusterFailoverReplaceYourMaster" class="headerlink" title="clusterFailoverReplaceYourMaster"></a>clusterFailoverReplaceYourMaster</h5><p>从节点在选举成功后，用自己替换掉master</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterFailoverReplaceYourMaster</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    clusterNode *oldmaster = myself-&gt;slaveof;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nodeIsMaster(myself) || oldmaster == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//salve提升为master，master变为slave</span></span><br><span class="line">    clusterSetNodeAsMaster(myself);</span><br><span class="line">    replicationUnsetMaster();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//槽点管理变更</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (clusterNodeGetSlotBit(oldmaster,j)) &#123;</span><br><span class="line">            clusterDelSlot(j);</span><br><span class="line">            clusterAddSlot(myself,j);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新状态&amp;配置</span></span><br><span class="line">    clusterUpdateState();</span><br><span class="line">    clusterSaveConfigOrDie(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通知其他节点</span></span><br><span class="line">    clusterBroadcastPong(CLUSTER_BROADCAST_ALL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//清空故障修复状态</span></span><br><span class="line">    resetManualFailover();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterHandleSlaveFailover"><a href="#clusterHandleSlaveFailover" class="headerlink" title="clusterHandleSlaveFailover"></a>clusterHandleSlaveFailover</h5><p>slave处理故障修复入口，包括发起、修正、重试</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterHandleSlaveFailover</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">mstime_t</span> data_age;</span><br><span class="line">    <span class="keyword">mstime_t</span> auth_age = mstime() - server.cluster-&gt;failover_auth_time;</span><br><span class="line">    <span class="keyword">int</span> needed_quorum = (server.cluster-&gt;size / <span class="number">2</span>) + <span class="number">1</span>; <span class="comment">//需要获取的最低票数</span></span><br><span class="line">    <span class="keyword">int</span> manual_failover = server.cluster-&gt;mf_end != <span class="number">0</span> &amp;&amp; <span class="comment">//是否是手动修复</span></span><br><span class="line">                          server.cluster-&gt;mf_can_start;</span><br><span class="line">    <span class="keyword">mstime_t</span> auth_timeout, auth_retry_time;</span><br><span class="line"></span><br><span class="line">    server.cluster-&gt;todo_before_sleep &amp;= ~CLUSTER_TODO_HANDLE_FAILOVER;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//选举超时时间</span></span><br><span class="line">    auth_timeout = server.cluster_node_timeout*<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (auth_timeout &lt; <span class="number">2000</span>) auth_timeout = <span class="number">2000</span>;</span><br><span class="line">    auth_retry_time = auth_timeout*<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自动发起的条件 1.自己是salve 2.master挂掉了 3.master是有效的槽点管理者</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsMaster(myself) ||</span><br><span class="line">        myself-&gt;slaveof == <span class="literal">NULL</span> ||</span><br><span class="line">        (!nodeFailed(myself-&gt;slaveof) &amp;&amp; !manual_failover) ||</span><br><span class="line">        (server.cluster_slave_no_failover &amp;&amp; !manual_failover) ||</span><br><span class="line">        myself-&gt;slaveof-&gt;numslots == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        server.cluster-&gt;cant_failover_reason = CLUSTER_CANT_FAILOVER_NONE;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录最近一次更新数据的时间</span></span><br><span class="line">    <span class="keyword">if</span> (server.repl_state == REPL_STATE_CONNECTED) &#123;</span><br><span class="line">        data_age = (<span class="keyword">mstime_t</span>)(server.unixtime - server.master-&gt;lastinteraction)</span><br><span class="line">                   * <span class="number">1000</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        data_age = (<span class="keyword">mstime_t</span>)(server.unixtime - server.repl_down_since) * <span class="number">1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data_age &gt; server.cluster_node_timeout)</span><br><span class="line">        data_age -= server.cluster_node_timeout;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.cluster_slave_validity_factor &amp;&amp;</span><br><span class="line">        data_age &gt;</span><br><span class="line">        (((<span class="keyword">mstime_t</span>)server.repl_ping_slave_period * <span class="number">1000</span>) +</span><br><span class="line">         (server.cluster_node_timeout * server.cluster_slave_validity_factor)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!manual_failover) &#123;</span><br><span class="line">            clusterLogCantFailover(CLUSTER_CANT_FAILOVER_DATA_AGE);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发起重试</span></span><br><span class="line">    <span class="keyword">if</span> (auth_age &gt; auth_retry_time) &#123;</span><br><span class="line">    	<span class="comment">//加上额外时间，是让其他节点能够收到fail消息</span></span><br><span class="line">        server.cluster-&gt;failover_auth_time = mstime() +</span><br><span class="line">            <span class="number">500</span> +</span><br><span class="line">            random() % <span class="number">500</span>;</span><br><span class="line">        server.cluster-&gt;failover_auth_count = <span class="number">0</span>;</span><br><span class="line">        server.cluster-&gt;failover_auth_sent = <span class="number">0</span>;</span><br><span class="line">        server.cluster-&gt;failover_auth_rank = clusterGetSlaveRank();</span><br><span class="line">        </span><br><span class="line">        server.cluster-&gt;failover_auth_time +=</span><br><span class="line">            server.cluster-&gt;failover_auth_rank * <span class="number">1000</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//手动修复，不要延迟</span></span><br><span class="line">        <span class="keyword">if</span> (server.cluster-&gt;mf_end) &#123;</span><br><span class="line">            server.cluster-&gt;failover_auth_time = mstime();</span><br><span class="line">            server.cluster-&gt;failover_auth_rank = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Start of election delayed for %lld milliseconds &quot;</span></span><br><span class="line">            <span class="string">&quot;(rank #%d, offset %lld).&quot;</span>,</span><br><span class="line">            server.cluster-&gt;failover_auth_time - mstime(),</span><br><span class="line">            server.cluster-&gt;failover_auth_rank,</span><br><span class="line">            replicationGetSlaveOffset());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//广播信息，通知自己的offset</span></span><br><span class="line">        clusterBroadcastPong(CLUSTER_BROADCAST_LOCAL_SLAVES);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置自动情况下，发起选举的时间</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;failover_auth_sent == <span class="number">0</span> &amp;&amp;</span><br><span class="line">        server.cluster-&gt;mf_end == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> newrank = clusterGetSlaveRank();</span><br><span class="line">        <span class="keyword">if</span> (newrank &gt; server.cluster-&gt;failover_auth_rank) &#123;</span><br><span class="line">            <span class="keyword">long</span> <span class="keyword">long</span> added_delay =</span><br><span class="line">                (newrank - server.cluster-&gt;failover_auth_rank) * <span class="number">1000</span>;</span><br><span class="line">            server.cluster-&gt;failover_auth_time += added_delay;</span><br><span class="line">            server.cluster-&gt;failover_auth_rank = newrank;</span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">&quot;Replica rank updated to #%d, added %lld milliseconds of delay.&quot;</span>,</span><br><span class="line">                newrank, added_delay);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发起时间校验</span></span><br><span class="line">    <span class="keyword">if</span> (mstime() &lt; server.cluster-&gt;failover_auth_time) &#123;</span><br><span class="line">        clusterLogCantFailover(CLUSTER_CANT_FAILOVER_WAITING_DELAY);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//选举过期</span></span><br><span class="line">    <span class="keyword">if</span> (auth_age &gt; auth_timeout) &#123;</span><br><span class="line">        clusterLogCantFailover(CLUSTER_CANT_FAILOVER_EXPIRED);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发起选举</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;failover_auth_sent == <span class="number">0</span>) &#123;</span><br><span class="line">        server.cluster-&gt;currentEpoch++;</span><br><span class="line">        server.cluster-&gt;failover_auth_epoch = server.cluster-&gt;currentEpoch;</span><br><span class="line">        serverLog(LL_WARNING,<span class="string">&quot;Starting a failover election for epoch %llu.&quot;</span>,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) server.cluster-&gt;currentEpoch);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//广播消息，希望其他master为自己投票</span></span><br><span class="line">        clusterRequestFailoverAuth();</span><br><span class="line">        server.cluster-&gt;failover_auth_sent = <span class="number">1</span>;</span><br><span class="line">        clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|</span><br><span class="line">                             CLUSTER_TODO_UPDATE_STATE|</span><br><span class="line">                             CLUSTER_TODO_FSYNC_CONFIG);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查票数是否满足</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;failover_auth_count &gt;= needed_quorum) &#123;</span><br><span class="line"></span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Failover election won: I&#x27;m the new master.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新选举纪元到自己的配置纪元</span></span><br><span class="line">        <span class="keyword">if</span> (myself-&gt;configEpoch &lt; server.cluster-&gt;failover_auth_epoch) &#123;</span><br><span class="line">            myself-&gt;configEpoch = server.cluster-&gt;failover_auth_epoch;</span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">&quot;configEpoch set to %llu after successful failover&quot;</span>,</span><br><span class="line">                (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) myself-&gt;configEpoch);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//替换master</span></span><br><span class="line">        clusterFailoverReplaceYourMaster();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        clusterLogCantFailover(CLUSTER_CANT_FAILOVER_WAITING_VOTES);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="slave迁移"><a href="#slave迁移" class="headerlink" title="slave迁移"></a>slave迁移</h4><h5 id="clusterHandleSlaveMigration"><a href="#clusterHandleSlaveMigration" class="headerlink" title="clusterHandleSlaveMigration"></a>clusterHandleSlaveMigration</h5><p>把salve变成另一个master的salve，为了解决部分master下有多个状态良好的salve，一些master下一个状态良好的salve都没有的情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterHandleSlaveMigration</span><span class="params">(<span class="keyword">int</span> max_slaves)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j, okslaves = <span class="number">0</span>;</span><br><span class="line">    clusterNode *mymaster = myself-&gt;slaveof, *target = <span class="literal">NULL</span>, *candidate = <span class="literal">NULL</span>;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查状态</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;state != CLUSTER_OK) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mymaster == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//状态良好的从节点数量</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; mymaster-&gt;numslaves; j++)</span><br><span class="line">        <span class="keyword">if</span> (!nodeFailed(mymaster-&gt;slaves[j]) &amp;&amp;</span><br><span class="line">            !nodeTimedOut(mymaster-&gt;slaves[j])) okslaves++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数量是否满足要求        </span></span><br><span class="line">    <span class="keyword">if</span> (okslaves &lt;= server.cluster_migration_barrier) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//选中的slave</span></span><br><span class="line">    candidate = myself;</span><br><span class="line">    di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        clusterNode *node = dictGetVal(de);</span><br><span class="line">        <span class="keyword">int</span> okslaves = <span class="number">0</span>, is_orphaned = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//迁移的对象之能是master，且有迁入标识</span></span><br><span class="line">        <span class="keyword">if</span> (nodeIsSlave(node) || nodeFailed(node)) is_orphaned = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(node-&gt;flags &amp; CLUSTER_NODE_MIGRATE_TO)) is_orphaned = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//迁移的对象必须是没有一个状态良好的slave</span></span><br><span class="line">        <span class="keyword">if</span> (nodeIsMaster(node)) okslaves = clusterCountNonFailingSlaves(node);</span><br><span class="line">        <span class="keyword">if</span> (okslaves &gt; <span class="number">0</span>) is_orphaned = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_orphaned) &#123;</span><br><span class="line">        	<span class="comment">//确定迁移的目标和时间</span></span><br><span class="line">            <span class="keyword">if</span> (!target &amp;&amp; node-&gt;numslots &gt; <span class="number">0</span>) target = node;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!node-&gt;orphaned_time) node-&gt;orphaned_time = mstime();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            node-&gt;orphaned_time = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//确定一个id最小的slave</span></span><br><span class="line">        <span class="keyword">if</span> (okslaves == max_slaves) &#123;</span><br><span class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; node-&gt;numslaves; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">memcmp</span>(node-&gt;slaves[j]-&gt;name,</span><br><span class="line">                           candidate-&gt;name,</span><br><span class="line">                           CLUSTER_NAMELEN) &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    candidate = node-&gt;slaves[j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//时间过了延迟等待后，开始迁移</span></span><br><span class="line">    <span class="keyword">if</span> (target &amp;&amp; candidate == myself &amp;&amp;</span><br><span class="line">        (mstime()-target-&gt;orphaned_time) &gt; CLUSTER_SLAVE_MIGRATION_DELAY &amp;&amp;</span><br><span class="line">       !(server.cluster_module_flags &amp; CLUSTER_MODULE_FLAG_NO_FAILOVER))</span><br><span class="line">    &#123;</span><br><span class="line">        serverLog(LL_WARNING,<span class="string">&quot;Migrating to orphaned master %.40s&quot;</span>,</span><br><span class="line">            target-&gt;name);</span><br><span class="line">        clusterSetMaster(target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="手动修复"><a href="#手动修复" class="headerlink" title="手动修复"></a>手动修复</h4><h5 id="resetManualFailover"><a href="#resetManualFailover" class="headerlink" title="resetManualFailover"></a>resetManualFailover</h5><p>重置手动修复信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">resetManualFailover</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;mf_end &amp;&amp; clientsArePaused()) &#123;</span><br><span class="line">        server.clients_pause_end_time = <span class="number">0</span>;</span><br><span class="line">        clientsArePaused();</span><br><span class="line">    &#125;</span><br><span class="line">    server.cluster-&gt;mf_end = <span class="number">0</span>; <span class="comment">//结束时间清零</span></span><br><span class="line">    server.cluster-&gt;mf_can_start = <span class="number">0</span>;</span><br><span class="line">    server.cluster-&gt;mf_slave = <span class="literal">NULL</span>; <span class="comment">//选中主导的salve</span></span><br><span class="line">    server.cluster-&gt;mf_master_offset = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="manualFailoverCheckTimeout"><a href="#manualFailoverCheckTimeout" class="headerlink" title="manualFailoverCheckTimeout"></a>manualFailoverCheckTimeout</h5><p>手动修复过程检查超时</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">manualFailoverCheckTimeout</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;mf_end &amp;&amp; server.cluster-&gt;mf_end &lt; mstime()) &#123;</span><br><span class="line">        serverLog(LL_WARNING,<span class="string">&quot;Manual failover timed out.&quot;</span>);</span><br><span class="line">        resetManualFailover();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterHandleManualFailover"><a href="#clusterHandleManualFailover" class="headerlink" title="clusterHandleManualFailover"></a>clusterHandleManualFailover</h5><p>手动修复入口，用于处理能否向下一步走</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterHandleManualFailover</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//等于0标识没有手动修复流程在跑</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;mf_end == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;mf_can_start) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;mf_master_offset == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//同步偏移量和master一致，可以开始</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;mf_master_offset == replicationGetSlaveOffset()) &#123;</span><br><span class="line">        server.cluster-&gt;mf_can_start = <span class="number">1</span>;</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;All master replication stream processed, &quot;</span></span><br><span class="line">            <span class="string">&quot;manual failover can start.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="集群定时任务"><a href="#集群定时任务" class="headerlink" title="集群定时任务"></a>集群定时任务</h4><h5 id="clusterCron"><a href="#clusterCron" class="headerlink" title="clusterCron"></a>clusterCron</h5><p>和大部分的定时任务一样，都是由上一层的<code>serverCron</code>调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterCron</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">int</span> update_state = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> orphaned_masters; <span class="comment">//正常slave数量为0的master个数</span></span><br><span class="line">    <span class="keyword">int</span> max_slaves; <span class="comment">//最多的正常slave数量</span></span><br><span class="line">    <span class="keyword">int</span> this_slaves; <span class="comment">//自己对应master的正常slave数量</span></span><br><span class="line">    <span class="keyword">mstime_t</span> min_pong = <span class="number">0</span>, now = mstime();</span><br><span class="line">    clusterNode *min_pong_node = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> iteration = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">mstime_t</span> handshake_timeout;</span><br><span class="line"></span><br><span class="line">    iteration++; <span class="comment">//此方法调用次数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查ip是否发生变化，从server.cluster_announce_ip到myself-&gt;ip</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">char</span> *prev_ip = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">char</span> *curr_ip = server.cluster_announce_ip;</span><br><span class="line">        <span class="keyword">int</span> changed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (prev_ip == <span class="literal">NULL</span> &amp;&amp; curr_ip != <span class="literal">NULL</span>) changed = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (prev_ip != <span class="literal">NULL</span> &amp;&amp; curr_ip == <span class="literal">NULL</span>) changed = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (prev_ip &amp;&amp; curr_ip &amp;&amp; <span class="built_in">strcmp</span>(prev_ip,curr_ip)) changed = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">            <span class="keyword">if</span> (prev_ip) zfree(prev_ip);</span><br><span class="line">            prev_ip = curr_ip;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (curr_ip) &#123;</span><br><span class="line">                prev_ip = zstrdup(prev_ip);</span><br><span class="line">                <span class="built_in">strncpy</span>(myself-&gt;ip,server.cluster_announce_ip,NET_IP_STR_LEN);</span><br><span class="line">                myself-&gt;ip[NET_IP_STR_LEN<span class="number">-1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                myself-&gt;ip[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>; <span class="comment">/* Force autodetection. */</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//握手超时时间</span></span><br><span class="line">    handshake_timeout = server.cluster_node_timeout;</span><br><span class="line">    <span class="keyword">if</span> (handshake_timeout &lt; <span class="number">1000</span>) handshake_timeout = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新标记</span></span><br><span class="line">    clusterUpdateMyselfFlags();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//针对没有连接的node创建连接</span></span><br><span class="line">    di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">    server.cluster-&gt;stats_pfail_nodes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        clusterNode *node = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//跳过自己和没有地址的节点</span></span><br><span class="line">        <span class="keyword">if</span> (node-&gt;flags &amp; (CLUSTER_NODE_MYSELF|CLUSTER_NODE_NOADDR)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node-&gt;flags &amp; CLUSTER_NODE_PFAIL)</span><br><span class="line">            server.cluster-&gt;stats_pfail_nodes++;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//握手超时，删除节点</span></span><br><span class="line">        <span class="keyword">if</span> (nodeInHandshake(node) &amp;&amp; now - node-&gt;ctime &gt; handshake_timeout) &#123;</span><br><span class="line">            clusterDelNode(node);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//没有建立连接，创建</span></span><br><span class="line">        <span class="keyword">if</span> (node-&gt;link == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> fd;</span><br><span class="line">            <span class="keyword">mstime_t</span> old_ping_sent;</span><br><span class="line">            clusterLink *link;</span><br><span class="line"></span><br><span class="line">            fd = anetTcpNonBlockBindConnect(server.neterr, node-&gt;ip,</span><br><span class="line">                node-&gt;cport, NET_FIRST_BIND_ADDR);</span><br><span class="line">            <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="comment">//设置ping_sent,为了使超时检测能起作用</span></span><br><span class="line">                <span class="keyword">if</span> (node-&gt;ping_sent == <span class="number">0</span>) node-&gt;ping_sent = mstime();</span><br><span class="line">                serverLog(LL_DEBUG, <span class="string">&quot;Unable to connect to &quot;</span></span><br><span class="line">                    <span class="string">&quot;Cluster Node [%s]:%d -&gt; %s&quot;</span>, node-&gt;ip,</span><br><span class="line">                    node-&gt;cport, server.neterr);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//node&amp;link互相关联，设置fd读时间处理</span></span><br><span class="line">            link = createClusterLink(node);</span><br><span class="line">            link-&gt;fd = fd;</span><br><span class="line">            node-&gt;link = link;</span><br><span class="line">            aeCreateFileEvent(server.el,link-&gt;fd,AE_READABLE,</span><br><span class="line">                    clusterReadHandler,link);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//发送握手信息</span></span><br><span class="line">            old_ping_sent = node-&gt;ping_sent;</span><br><span class="line">            clusterSendPing(link, node-&gt;flags &amp; CLUSTER_NODE_MEET ?</span><br><span class="line">                    CLUSTERMSG_TYPE_MEET : CLUSTERMSG_TYPE_PING);</span><br><span class="line">            <span class="keyword">if</span> (old_ping_sent) &#123;</span><br><span class="line">                node-&gt;ping_sent = old_ping_sent;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//去掉需要发送meet信息标识</span></span><br><span class="line">            node-&gt;flags &amp;= ~CLUSTER_NODE_MEET;</span><br><span class="line"></span><br><span class="line">            serverLog(LL_DEBUG,<span class="string">&quot;Connecting with Node %.40s at %s:%d&quot;</span>,</span><br><span class="line">                    node-&gt;name, node-&gt;ip, node-&gt;cport);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每调用10次，随机选中5个节点，找其中最早的一个节点，发送ping</span></span><br><span class="line">    <span class="keyword">if</span> (!(iteration % <span class="number">10</span>)) &#123;</span><br><span class="line">        <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//随机5个选一个</span></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">5</span>; j++) &#123;</span><br><span class="line">            de = dictGetRandomKey(server.cluster-&gt;nodes);</span><br><span class="line">            clusterNode *<span class="keyword">this</span> = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Don&#x27;t ping nodes disconnected or with a ping currently active. */</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;link == <span class="literal">NULL</span> || <span class="keyword">this</span>-&gt;ping_sent != <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;flags &amp; (CLUSTER_NODE_MYSELF|CLUSTER_NODE_HANDSHAKE))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (min_pong_node == <span class="literal">NULL</span> || min_pong &gt; <span class="keyword">this</span>-&gt;pong_received) &#123;</span><br><span class="line">                min_pong_node = <span class="keyword">this</span>;</span><br><span class="line">                min_pong = <span class="keyword">this</span>-&gt;pong_received;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (min_pong_node) &#123;</span><br><span class="line">            serverLog(LL_DEBUG,<span class="string">&quot;Pinging node %.40s&quot;</span>, min_pong_node-&gt;name);</span><br><span class="line">            clusterSendPing(min_pong_node-&gt;link, CLUSTERMSG_TYPE_PING);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    orphaned_masters = <span class="number">0</span>;</span><br><span class="line">    max_slaves = <span class="number">0</span>;</span><br><span class="line">    this_slaves = <span class="number">0</span>;</span><br><span class="line">    di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        clusterNode *node = dictGetVal(de);</span><br><span class="line">        now = mstime();</span><br><span class="line">        <span class="keyword">mstime_t</span> delay;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node-&gt;flags &amp;</span><br><span class="line">            (CLUSTER_NODE_MYSELF|CLUSTER_NODE_NOADDR|CLUSTER_NODE_HANDSHAKE))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//统计孤儿master数量</span></span><br><span class="line">        <span class="keyword">if</span> (nodeIsSlave(myself) &amp;&amp; nodeIsMaster(node) &amp;&amp; !nodeFailed(node)) &#123;</span><br><span class="line">            <span class="keyword">int</span> okslaves = clusterCountNonFailingSlaves(node);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* A master is orphaned if it is serving a non-zero number of</span></span><br><span class="line"><span class="comment">             * slots, have no working slaves, but used to have at least one</span></span><br><span class="line"><span class="comment">             * slave, or failed over a master that used to have slaves. */</span></span><br><span class="line">            <span class="keyword">if</span> (okslaves == <span class="number">0</span> &amp;&amp; node-&gt;numslots &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                node-&gt;flags &amp; CLUSTER_NODE_MIGRATE_TO)</span><br><span class="line">            &#123;</span><br><span class="line">                orphaned_masters++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (okslaves &gt; max_slaves) max_slaves = okslaves;</span><br><span class="line">            <span class="keyword">if</span> (nodeIsSlave(myself) &amp;&amp; myself-&gt;slaveof == node)</span><br><span class="line">                this_slaves = okslaves;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//心跳检测超时,释放连接，下一次会重新连接</span></span><br><span class="line">        <span class="keyword">if</span> (node-&gt;link &amp;&amp;</span><br><span class="line">            now - node-&gt;link-&gt;ctime &gt;</span><br><span class="line">            server.cluster_node_timeout &amp;&amp;</span><br><span class="line">            node-&gt;ping_sent &amp;&amp; <span class="comment">//已经发送ping</span></span><br><span class="line">            node-&gt;pong_received &lt; node-&gt;ping_sent &amp;&amp; <span class="comment">//等待pong回复</span></span><br><span class="line">            now - node-&gt;ping_sent &gt; server.cluster_node_timeout/<span class="number">2</span>) <span class="comment">//超时</span></span><br><span class="line">        &#123;</span><br><span class="line">            freeClusterLink(node-&gt;link);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//因为上面发送ping是随机的一个，所以可能有一些节点，好久都没选上，这里对这情况处理，保证在超时时间一半的时候，每个节点都有ping发出</span></span><br><span class="line">        <span class="keyword">if</span> (node-&gt;link &amp;&amp;</span><br><span class="line">            node-&gt;ping_sent == <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (now - node-&gt;pong_received) &gt; server.cluster_node_timeout/<span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            clusterSendPing(node-&gt;link, CLUSTERMSG_TYPE_PING);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//来自我们的一个slave手动修复，需要立马给其发送一个ping</span></span><br><span class="line">        <span class="keyword">if</span> (server.cluster-&gt;mf_end &amp;&amp;</span><br><span class="line">            nodeIsMaster(myself) &amp;&amp;</span><br><span class="line">            server.cluster-&gt;mf_slave == node &amp;&amp;</span><br><span class="line">            node-&gt;link)</span><br><span class="line">        &#123;</span><br><span class="line">            clusterSendPing(node-&gt;link, CLUSTERMSG_TYPE_PING);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Check only if we have an active ping for this instance. */</span></span><br><span class="line">        <span class="keyword">if</span> (node-&gt;ping_sent == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检测延迟</span></span><br><span class="line">        delay = now - node-&gt;ping_sent;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (delay &gt; server.cluster_node_timeout) &#123;</span><br><span class="line">            <span class="comment">//在一段时间内，没有有效回复，标记主观下线</span></span><br><span class="line">            <span class="keyword">if</span> (!(node-&gt;flags &amp; (CLUSTER_NODE_PFAIL|CLUSTER_NODE_FAIL))) &#123;</span><br><span class="line">                serverLog(LL_DEBUG,<span class="string">&quot;*** NODE %.40s possibly failing&quot;</span>,</span><br><span class="line">                    node-&gt;name);</span><br><span class="line">                node-&gt;flags |= CLUSTER_NODE_PFAIL;</span><br><span class="line">                update_state = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理主从断掉的情况，重连</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsSlave(myself) &amp;&amp;</span><br><span class="line">        server.masterhost == <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">        myself-&gt;slaveof &amp;&amp;</span><br><span class="line">        nodeHasAddr(myself-&gt;slaveof))</span><br><span class="line">    &#123;</span><br><span class="line">        replicationSetMaster(myself-&gt;slaveof-&gt;ip, myself-&gt;slaveof-&gt;port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//手动修复超时检测</span></span><br><span class="line">    manualFailoverCheckTimeout();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nodeIsSlave(myself)) &#123;</span><br><span class="line">    	<span class="comment">//手动修复推进</span></span><br><span class="line">        clusterHandleManualFailover();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(server.cluster_module_flags &amp; CLUSTER_MODULE_FLAG_NO_FAILOVER))</span><br><span class="line">            clusterHandleSlaveFailover();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//处理slave迁移的流程</span></span><br><span class="line">        <span class="keyword">if</span> (orphaned_masters &amp;&amp; max_slaves &gt;= <span class="number">2</span> &amp;&amp; this_slaves == max_slaves)</span><br><span class="line">            clusterHandleSlaveMigration(max_slaves);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新状态</span></span><br><span class="line">    <span class="keyword">if</span> (update_state || server.cluster-&gt;state == CLUSTER_FAIL)</span><br><span class="line">        clusterUpdateState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterBeforeSleep"><a href="#clusterBeforeSleep" class="headerlink" title="clusterBeforeSleep"></a>clusterBeforeSleep</h5><p>事件循环前要做的事情</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterBeforeSleep</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//自动故障修复推进</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;todo_before_sleep &amp; CLUSTER_TODO_HANDLE_FAILOVER)</span><br><span class="line">        clusterHandleSlaveFailover();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新状态</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;todo_before_sleep &amp; CLUSTER_TODO_UPDATE_STATE)</span><br><span class="line">        clusterUpdateState();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存配置</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;todo_before_sleep &amp; CLUSTER_TODO_SAVE_CONFIG) &#123;</span><br><span class="line">        <span class="keyword">int</span> fsync = server.cluster-&gt;todo_before_sleep &amp;</span><br><span class="line">                    CLUSTER_TODO_FSYNC_CONFIG;</span><br><span class="line">        clusterSaveConfigOrDie(fsync);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重置标志</span></span><br><span class="line">    server.cluster-&gt;todo_before_sleep = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterDoBeforeSleep"><a href="#clusterDoBeforeSleep" class="headerlink" title="clusterDoBeforeSleep"></a>clusterDoBeforeSleep</h5><p>设置事件循环前要做的事</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterDoBeforeSleep</span><span class="params">(<span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    server.cluster-&gt;todo_before_sleep |= flags;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="槽点"><a href="#槽点" class="headerlink" title="槽点"></a>槽点</h4><h5 id="bitmapTestBit"><a href="#bitmapTestBit" class="headerlink" title="bitmapTestBit"></a>bitmapTestBit</h5><p>判断位图中某个槽点是否命中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bitmapTestBit</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *bitmap, <span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">off_t</span> byte = pos/<span class="number">8</span>;</span><br><span class="line">    <span class="keyword">int</span> bit = pos&amp;<span class="number">7</span>;</span><br><span class="line">    <span class="keyword">return</span> (bitmap[byte] &amp; (<span class="number">1</span>&lt;&lt;bit)) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="bitmapSetBit"><a href="#bitmapSetBit" class="headerlink" title="bitmapSetBit"></a>bitmapSetBit</h5><p>设置位图中的某个槽点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bitmapSetBit</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *bitmap, <span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">off_t</span> byte = pos/<span class="number">8</span>;</span><br><span class="line">    <span class="keyword">int</span> bit = pos&amp;<span class="number">7</span>;</span><br><span class="line">    bitmap[byte] |= <span class="number">1</span>&lt;&lt;bit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="bitmapClearBit"><a href="#bitmapClearBit" class="headerlink" title="bitmapClearBit"></a>bitmapClearBit</h5><p>清空位图的某个槽点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bitmapClearBit</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *bitmap, <span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">off_t</span> byte = pos/<span class="number">8</span>;</span><br><span class="line">    <span class="keyword">int</span> bit = pos&amp;<span class="number">7</span>;</span><br><span class="line">    bitmap[byte] &amp;= ~(<span class="number">1</span>&lt;&lt;bit);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="clusterMastersHaveSlaves"><a href="#clusterMastersHaveSlaves" class="headerlink" title="clusterMastersHaveSlaves"></a>clusterMastersHaveSlaves</h5><p>判断所有的master是否至少一个有slave</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterMastersHaveSlaves</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    dictIterator *di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">int</span> slaves = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        clusterNode *node = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nodeIsSlave(node)) <span class="keyword">continue</span>;</span><br><span class="line">        slaves += node-&gt;numslaves;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">    <span class="keyword">return</span> slaves != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterNodeSetSlotBit"><a href="#clusterNodeSetSlotBit" class="headerlink" title="clusterNodeSetSlotBit"></a>clusterNodeSetSlotBit</h5><p>节点位图增加某个槽位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterNodeSetSlotBit</span><span class="params">(clusterNode *n, <span class="keyword">int</span> slot)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> old = bitmapTestBit(n-&gt;slots,slot);</span><br><span class="line">    bitmapSetBit(n-&gt;slots,slot);</span><br><span class="line">    <span class="keyword">if</span> (!old) &#123;</span><br><span class="line">    	<span class="comment">//有效槽位加1</span></span><br><span class="line">        n-&gt;numslots++;</span><br><span class="line">        <span class="keyword">if</span> (n-&gt;numslots == <span class="number">1</span> &amp;&amp; clusterMastersHaveSlaves())</span><br><span class="line">            n-&gt;flags |= CLUSTER_NODE_MIGRATE_TO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> old;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterNodeClearSlotBit"><a href="#clusterNodeClearSlotBit" class="headerlink" title="clusterNodeClearSlotBit"></a>clusterNodeClearSlotBit</h5><p>清空节点位图中的某个槽位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterNodeClearSlotBit</span><span class="params">(clusterNode *n, <span class="keyword">int</span> slot)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> old = bitmapTestBit(n-&gt;slots,slot);</span><br><span class="line">    bitmapClearBit(n-&gt;slots,slot);</span><br><span class="line">    <span class="keyword">if</span> (old) n-&gt;numslots--;</span><br><span class="line">    <span class="keyword">return</span> old;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterNodeGetSlotBit"><a href="#clusterNodeGetSlotBit" class="headerlink" title="clusterNodeGetSlotBit"></a>clusterNodeGetSlotBit</h5><p>获取节点位图中是否包含某个槽位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterNodeGetSlotBit</span><span class="params">(clusterNode *n, <span class="keyword">int</span> slot)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bitmapTestBit(n-&gt;slots,slot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterAddSlot"><a href="#clusterAddSlot" class="headerlink" title="clusterAddSlot"></a>clusterAddSlot</h5><p>节点增加槽位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterAddSlot</span><span class="params">(clusterNode *n, <span class="keyword">int</span> slot)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;slots[slot]) <span class="keyword">return</span> C_ERR;</span><br><span class="line">    clusterNodeSetSlotBit(n,slot);</span><br><span class="line">    server.cluster-&gt;slots[slot] = n;</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterDelSlot"><a href="#clusterDelSlot" class="headerlink" title="clusterDelSlot"></a>clusterDelSlot</h5><p>节点删除槽位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterDelSlot</span><span class="params">(<span class="keyword">int</span> slot)</span> </span>&#123;</span><br><span class="line">    clusterNode *n = server.cluster-&gt;slots[slot];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!n) <span class="keyword">return</span> C_ERR;</span><br><span class="line">    serverAssert(clusterNodeClearSlotBit(n,slot) == <span class="number">1</span>);</span><br><span class="line">    server.cluster-&gt;slots[slot] = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterDelNodeSlots"><a href="#clusterDelNodeSlots" class="headerlink" title="clusterDelNodeSlots"></a>clusterDelNodeSlots</h5><p>删除节点的所有槽位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterDelNodeSlots</span><span class="params">(clusterNode *node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> deleted = <span class="number">0</span>, j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (clusterNodeGetSlotBit(node,j)) &#123;</span><br><span class="line">            clusterDelSlot(j);</span><br><span class="line">            deleted++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> deleted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterCloseAllSlots"><a href="#clusterCloseAllSlots" class="headerlink" title="clusterCloseAllSlots"></a>clusterCloseAllSlots</h5><p>清空所有的迁入迁出槽点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterCloseAllSlots</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(server.cluster-&gt;migrating_slots_to,<span class="number">0</span>,</span><br><span class="line">        <span class="keyword">sizeof</span>(server.cluster-&gt;migrating_slots_to));</span><br><span class="line">    <span class="built_in">memset</span>(server.cluster-&gt;importing_slots_from,<span class="number">0</span>,</span><br><span class="line">        <span class="keyword">sizeof</span>(server.cluster-&gt;importing_slots_from));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="集群状态"><a href="#集群状态" class="headerlink" title="集群状态"></a>集群状态</h4><h5 id="clusterUpdateState"><a href="#clusterUpdateState" class="headerlink" title="clusterUpdateState"></a>clusterUpdateState</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_MAX_REJOIN_DELAY 5000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_MIN_REJOIN_DELAY 500</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLUSTER_WRITABLE_DELAY 2000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterUpdateState</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j, new_state;</span><br><span class="line">    <span class="keyword">int</span> reachable_masters = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">mstime_t</span> among_minority_time;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">mstime_t</span> first_call_time = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    server.cluster-&gt;todo_before_sleep &amp;= ~CLUSTER_TODO_UPDATE_STATE;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (first_call_time == <span class="number">0</span>) first_call_time = mstime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对于master,在从fail-&gt;ok需要等待一段时间</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsMaster(myself) &amp;&amp;</span><br><span class="line">        server.cluster-&gt;state == CLUSTER_FAIL &amp;&amp;</span><br><span class="line">        mstime() - first_call_time &lt; CLUSTER_WRITABLE_DELAY) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    new_state = CLUSTER_OK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查所有槽点是否都覆盖</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster_require_full_coverage) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (server.cluster-&gt;slots[j] == <span class="literal">NULL</span> ||</span><br><span class="line">                server.cluster-&gt;slots[j]-&gt;flags &amp; (CLUSTER_NODE_FAIL))</span><br><span class="line">            &#123;</span><br><span class="line">                new_state = CLUSTER_FAIL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//统计所有的有效master数量</span></span><br><span class="line">    &#123;</span><br><span class="line">        dictIterator *di;</span><br><span class="line">        dictEntry *de;</span><br><span class="line"></span><br><span class="line">        server.cluster-&gt;size = <span class="number">0</span>;</span><br><span class="line">        di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            clusterNode *node = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nodeIsMaster(node) &amp;&amp; node-&gt;numslots) &#123;</span><br><span class="line">                server.cluster-&gt;size++;</span><br><span class="line">                <span class="keyword">if</span> ((node-&gt;flags &amp; (CLUSTER_NODE_FAIL|CLUSTER_NODE_PFAIL)) == <span class="number">0</span>)</span><br><span class="line">                    reachable_masters++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据连接情况，判断状态ok/fail</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> needed_quorum = (server.cluster-&gt;size / <span class="number">2</span>) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (reachable_masters &lt; needed_quorum) &#123;</span><br><span class="line">            new_state = CLUSTER_FAIL;</span><br><span class="line">            among_minority_time = mstime();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录状态变化</span></span><br><span class="line">    <span class="keyword">if</span> (new_state != server.cluster-&gt;state) &#123;</span><br><span class="line">        <span class="keyword">mstime_t</span> rejoin_delay = server.cluster_node_timeout;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rejoin_delay &gt; CLUSTER_MAX_REJOIN_DELAY)</span><br><span class="line">            rejoin_delay = CLUSTER_MAX_REJOIN_DELAY;</span><br><span class="line">        <span class="keyword">if</span> (rejoin_delay &lt; CLUSTER_MIN_REJOIN_DELAY)</span><br><span class="line">            rejoin_delay = CLUSTER_MIN_REJOIN_DELAY;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (new_state == CLUSTER_OK &amp;&amp;</span><br><span class="line">            nodeIsMaster(myself) &amp;&amp;</span><br><span class="line">            mstime() - among_minority_time &lt; rejoin_delay)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Change the state and log the event. */</span></span><br><span class="line">        serverLog(LL_WARNING,<span class="string">&quot;Cluster state changed: %s&quot;</span>,</span><br><span class="line">            new_state == CLUSTER_OK ? <span class="string">&quot;ok&quot;</span> : <span class="string">&quot;fail&quot;</span>);</span><br><span class="line">        server.cluster-&gt;state = new_state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="verifyClusterConfigWithData"><a href="#verifyClusterConfigWithData" class="headerlink" title="verifyClusterConfigWithData"></a>verifyClusterConfigWithData</h5><p>验证集群配置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">verifyClusterConfigWithData</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    <span class="keyword">int</span> update_config = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//模块要求不要转发映射其他槽点</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster_module_flags &amp; CLUSTER_MODULE_FLAG_NO_REDIRECTION)</span><br><span class="line">        <span class="keyword">return</span> C_OK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//只校验master</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsSlave(myself)) <span class="keyword">return</span> C_OK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//确定只使用了db0</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; server.dbnum; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dictSize(server.db[j].dict)) <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查看槽点的情况</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;</span><br><span class="line">    	<span class="comment">//槽点没有任何key</span></span><br><span class="line">        <span class="keyword">if</span> (!countKeysInSlot(j)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//我们负责槽点或者槽点在迁移到我们这</span></span><br><span class="line">        <span class="keyword">if</span> (server.cluster-&gt;slots[j] == myself ||</span><br><span class="line">            server.cluster-&gt;importing_slots_from[j] != <span class="literal">NULL</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//到这里的话，说明槽点没有人管了</span></span><br><span class="line">        update_config++;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//槽点没有分配，我们直接管理</span></span><br><span class="line">        <span class="keyword">if</span> (server.cluster-&gt;slots[j] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            serverLog(LL_WARNING, <span class="string">&quot;I have keys for unassigned slot %d. &quot;</span></span><br><span class="line">                                    <span class="string">&quot;Taking responsibility for it.&quot;</span>,j);</span><br><span class="line">            clusterAddSlot(myself,j);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        	<span class="comment">//槽点是别人负责的</span></span><br><span class="line">            serverLog(LL_WARNING, <span class="string">&quot;I have keys for slot %d, but the slot is &quot;</span></span><br><span class="line">                                    <span class="string">&quot;assigned to another node. &quot;</span></span><br><span class="line">                                    <span class="string">&quot;Setting it to importing state.&quot;</span>,j);</span><br><span class="line">            server.cluster-&gt;importing_slots_from[j] = server.cluster-&gt;slots[j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (update_config) clusterSaveConfigOrDie(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="salve节点操作"><a href="#salve节点操作" class="headerlink" title="salve节点操作"></a>salve节点操作</h4><h5 id="clusterSetMaster"><a href="#clusterSetMaster" class="headerlink" title="clusterSetMaster"></a>clusterSetMaster</h5><p>设置节点n为我们的master</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterSetMaster</span><span class="params">(clusterNode *n)</span> </span>&#123;</span><br><span class="line">    serverAssert(n != myself);</span><br><span class="line">    serverAssert(myself-&gt;numslots == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自己是主节点，切换标识，清空槽点</span></span><br><span class="line">    <span class="keyword">if</span> (nodeIsMaster(myself)) &#123;</span><br><span class="line">        myself-&gt;flags &amp;= ~(CLUSTER_NODE_MASTER|CLUSTER_NODE_MIGRATE_TO);</span><br><span class="line">        myself-&gt;flags |= CLUSTER_NODE_SLAVE;</span><br><span class="line">        clusterCloseAllSlots();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="comment">//从之前的master的slave列表中，把自己删掉</span></span><br><span class="line">        <span class="keyword">if</span> (myself-&gt;slaveof)</span><br><span class="line">            clusterNodeRemoveSlave(myself-&gt;slaveof,myself);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//制定新的master</span></span><br><span class="line">    myself-&gt;slaveof = n;</span><br><span class="line">    clusterNodeAddSlave(n,myself);</span><br><span class="line">    replicationSetMaster(n-&gt;ip, n-&gt;port);</span><br><span class="line">    resetManualFailover();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="节点到字符串的转换"><a href="#节点到字符串的转换" class="headerlink" title="节点到字符串的转换"></a>节点到字符串的转换</h4><h5 id="redisNodeFlags"><a href="#redisNodeFlags" class="headerlink" title="redisNodeFlags"></a>redisNodeFlags</h5><p>节点标志对应的描述说明</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisNodeFlags</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> flag;</span><br><span class="line">    <span class="keyword">char</span> *name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisNodeFlags</span> <span class="title">redisNodeFlagsTable</span>[] =</span> &#123;</span><br><span class="line">    &#123;CLUSTER_NODE_MYSELF,       <span class="string">&quot;myself,&quot;</span>&#125;,</span><br><span class="line">    &#123;CLUSTER_NODE_MASTER,       <span class="string">&quot;master,&quot;</span>&#125;,</span><br><span class="line">    &#123;CLUSTER_NODE_SLAVE,        <span class="string">&quot;slave,&quot;</span>&#125;,</span><br><span class="line">    &#123;CLUSTER_NODE_PFAIL,        <span class="string">&quot;fail?,&quot;</span>&#125;,</span><br><span class="line">    &#123;CLUSTER_NODE_FAIL,         <span class="string">&quot;fail,&quot;</span>&#125;,</span><br><span class="line">    &#123;CLUSTER_NODE_HANDSHAKE,    <span class="string">&quot;handshake,&quot;</span>&#125;,</span><br><span class="line">    &#123;CLUSTER_NODE_NOADDR,       <span class="string">&quot;noaddr,&quot;</span>&#125;,</span><br><span class="line">    &#123;CLUSTER_NODE_NOFAILOVER,   <span class="string">&quot;nofailover,&quot;</span>&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="representClusterNodeFlags"><a href="#representClusterNodeFlags" class="headerlink" title="representClusterNodeFlags"></a>representClusterNodeFlags</h5><p>把标志转换成对应的描述</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">representClusterNodeFlags</span><span class="params">(sds ci, <span class="keyword">uint16_t</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> orig_len = sdslen(ci);</span><br><span class="line">    <span class="keyword">int</span> i, size = <span class="keyword">sizeof</span>(redisNodeFlagsTable)/<span class="keyword">sizeof</span>(struct redisNodeFlags);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">redisNodeFlags</span> *<span class="title">nodeflag</span> =</span> redisNodeFlagsTable + i;</span><br><span class="line">        <span class="keyword">if</span> (flags &amp; nodeflag-&gt;flag) ci = sdscat(ci, nodeflag-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (sdslen(ci) == orig_len) ci = sdscat(ci,<span class="string">&quot;noflags,&quot;</span>);</span><br><span class="line">    <span class="comment">//移除掉最后的一个逗号</span></span><br><span class="line">    sdsIncrLen(ci,<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> ci;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterGenNodeDescription"><a href="#clusterGenNodeDescription" class="headerlink" title="clusterGenNodeDescription"></a>clusterGenNodeDescription</h5><p>获取节点的描述情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">clusterGenNodeDescription</span><span class="params">(clusterNode *node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j, start;</span><br><span class="line">    sds ci;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//名称 IP 端口</span></span><br><span class="line">    ci = sdscatprintf(sdsempty(),<span class="string">&quot;%.40s %s:%d@%d &quot;</span>,</span><br><span class="line">        node-&gt;name,</span><br><span class="line">        node-&gt;ip,</span><br><span class="line">        node-&gt;port,</span><br><span class="line">        node-&gt;cport);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//标志位情况</span></span><br><span class="line">    ci = representClusterNodeFlags(ci, node-&gt;flags);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主从情况</span></span><br><span class="line">    <span class="keyword">if</span> (node-&gt;slaveof)</span><br><span class="line">        ci = sdscatprintf(ci,<span class="string">&quot; %.40s &quot;</span>,node-&gt;slaveof-&gt;name);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ci = sdscatlen(ci,<span class="string">&quot; - &quot;</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//连接心跳情况</span></span><br><span class="line">    ci = sdscatprintf(ci,<span class="string">&quot;%lld %lld %llu %s&quot;</span>,</span><br><span class="line">        (<span class="keyword">long</span> <span class="keyword">long</span>) node-&gt;ping_sent,</span><br><span class="line">        (<span class="keyword">long</span> <span class="keyword">long</span>) node-&gt;pong_received,</span><br><span class="line">        (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) node-&gt;configEpoch,</span><br><span class="line">        (node-&gt;link || node-&gt;flags &amp; CLUSTER_NODE_MYSELF) ?</span><br><span class="line">                    <span class="string">&quot;connected&quot;</span> : <span class="string">&quot;disconnected&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//槽点情况</span></span><br><span class="line">    start = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;</span><br><span class="line">        <span class="keyword">int</span> bit;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((bit = clusterNodeGetSlotBit(node,j)) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (start == <span class="number">-1</span>) start = j;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (start != <span class="number">-1</span> &amp;&amp; (!bit || j == CLUSTER_SLOTS<span class="number">-1</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bit &amp;&amp; j == CLUSTER_SLOTS<span class="number">-1</span>) j++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (start == j<span class="number">-1</span>) &#123;</span><br><span class="line">                ci = sdscatprintf(ci,<span class="string">&quot; %d&quot;</span>,start);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ci = sdscatprintf(ci,<span class="string">&quot; %d-%d&quot;</span>,start,j<span class="number">-1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            start = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//迁入&amp;迁出情况</span></span><br><span class="line">    <span class="keyword">if</span> (node-&gt;flags &amp; CLUSTER_NODE_MYSELF) &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (server.cluster-&gt;migrating_slots_to[j]) &#123;</span><br><span class="line">                ci = sdscatprintf(ci,<span class="string">&quot; [%d-&gt;-%.40s]&quot;</span>,j,</span><br><span class="line">                    server.cluster-&gt;migrating_slots_to[j]-&gt;name);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (server.cluster-&gt;importing_slots_from[j]) &#123;</span><br><span class="line">                ci = sdscatprintf(ci,<span class="string">&quot; [%d-&lt;-%.40s]&quot;</span>,j,</span><br><span class="line">                    server.cluster-&gt;importing_slots_from[j]-&gt;name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ci;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterGenNodesDescription"><a href="#clusterGenNodesDescription" class="headerlink" title="clusterGenNodesDescription"></a>clusterGenNodesDescription</h5><p>排除掉包含某些标志节点，其他节点的描述</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sds <span class="title">clusterGenNodesDescription</span><span class="params">(<span class="keyword">int</span> filter)</span> </span>&#123;</span><br><span class="line">    sds ci = sdsempty(), ni;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        clusterNode *node = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node-&gt;flags &amp; filter) <span class="keyword">continue</span>;</span><br><span class="line">        ni = clusterGenNodeDescription(node);</span><br><span class="line">        ci = sdscatsds(ci,ni);</span><br><span class="line">        sdsfree(ni);</span><br><span class="line">        ci = sdscatlen(ci,<span class="string">&quot;\n&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">    <span class="keyword">return</span> ci;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="集群命令"><a href="#集群命令" class="headerlink" title="集群命令"></a>集群命令</h4><h5 id="clusterGetMessageTypeString"><a href="#clusterGetMessageTypeString" class="headerlink" title="clusterGetMessageTypeString"></a>clusterGetMessageTypeString</h5><p>根据命令类型，获取命令文字描述</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">clusterGetMessageTypeString</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">    <span class="keyword">case</span> CLUSTERMSG_TYPE_PING: <span class="keyword">return</span> <span class="string">&quot;ping&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> CLUSTERMSG_TYPE_PONG: <span class="keyword">return</span> <span class="string">&quot;pong&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> CLUSTERMSG_TYPE_MEET: <span class="keyword">return</span> <span class="string">&quot;meet&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> CLUSTERMSG_TYPE_FAIL: <span class="keyword">return</span> <span class="string">&quot;fail&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> CLUSTERMSG_TYPE_PUBLISH: <span class="keyword">return</span> <span class="string">&quot;publish&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST: <span class="keyword">return</span> <span class="string">&quot;auth-req&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK: <span class="keyword">return</span> <span class="string">&quot;auth-ack&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> CLUSTERMSG_TYPE_UPDATE: <span class="keyword">return</span> <span class="string">&quot;update&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> CLUSTERMSG_TYPE_MFSTART: <span class="keyword">return</span> <span class="string">&quot;mfstart&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> CLUSTERMSG_TYPE_MODULE: <span class="keyword">return</span> <span class="string">&quot;module&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="getSlotOrReply"><a href="#getSlotOrReply" class="headerlink" title="getSlotOrReply"></a>getSlotOrReply</h5><p>校验槽点是否合法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getSlotOrReply</span><span class="params">(client *c, robj *o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> slot;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getLongLongFromObject(o,&amp;slot) != C_OK ||</span><br><span class="line">        slot &lt; <span class="number">0</span> || slot &gt;= CLUSTER_SLOTS)</span><br><span class="line">    &#123;</span><br><span class="line">        addReplyError(c,<span class="string">&quot;Invalid or out of range slot&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>) slot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterReplyMultiBulkSlots"><a href="#clusterReplyMultiBulkSlots" class="headerlink" title="clusterReplyMultiBulkSlots"></a>clusterReplyMultiBulkSlots</h5><p>输出所有槽点的情况，已节点为单位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterReplyMultiBulkSlots</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 格式: 1) 1) start slot</span></span><br><span class="line"><span class="comment">     *            2) end slot</span></span><br><span class="line"><span class="comment">     *            3) 1) master IP</span></span><br><span class="line"><span class="comment">     *               2) master port</span></span><br><span class="line"><span class="comment">     *               3) node ID</span></span><br><span class="line"><span class="comment">     *            4) 1) replica IP</span></span><br><span class="line"><span class="comment">     *               2) replica port</span></span><br><span class="line"><span class="comment">     *               3) node ID</span></span><br><span class="line"><span class="comment">     *           ... continued until done</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> num_masters = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">void</span> *slot_replylen = addDeferredMultiBulkLength(c);</span><br><span class="line"></span><br><span class="line">    dictEntry *de;</span><br><span class="line">    dictIterator *di = dictGetSafeIterator(server.cluster-&gt;nodes);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        clusterNode *node = dictGetVal(de);</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>, start = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//跳过非有效master</span></span><br><span class="line">        <span class="keyword">if</span> (!nodeIsMaster(node) || node-&gt;numslots == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;</span><br><span class="line">            <span class="keyword">int</span> bit, i;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((bit = clusterNodeGetSlotBit(node,j)) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (start == <span class="number">-1</span>) start = j;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (start != <span class="number">-1</span> &amp;&amp; (!bit || j == CLUSTER_SLOTS<span class="number">-1</span>)) &#123;</span><br><span class="line">                <span class="keyword">int</span> nested_elements = <span class="number">3</span>; <span class="comment">/* slots (2) + master addr (1). */</span></span><br><span class="line">                <span class="keyword">void</span> *nested_replylen = addDeferredMultiBulkLength(c);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (bit &amp;&amp; j == CLUSTER_SLOTS<span class="number">-1</span>) j++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (start == j<span class="number">-1</span>) &#123;</span><br><span class="line">                    addReplyLongLong(c, start);</span><br><span class="line">                    addReplyLongLong(c, start);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    addReplyLongLong(c, start);</span><br><span class="line">                    addReplyLongLong(c, j<span class="number">-1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                start = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">                addReplyMultiBulkLen(c, <span class="number">3</span>);</span><br><span class="line">                addReplyBulkCString(c, node-&gt;ip);</span><br><span class="line">                addReplyLongLong(c, node-&gt;port);</span><br><span class="line">                addReplyBulkCBuffer(c, node-&gt;name, CLUSTER_NAMELEN);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//输出salve情况</span></span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; node-&gt;numslaves; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (nodeFailed(node-&gt;slaves[i])) <span class="keyword">continue</span>;</span><br><span class="line">                    addReplyMultiBulkLen(c, <span class="number">3</span>);</span><br><span class="line">                    addReplyBulkCString(c, node-&gt;slaves[i]-&gt;ip);</span><br><span class="line">                    addReplyLongLong(c, node-&gt;slaves[i]-&gt;port);</span><br><span class="line">                    addReplyBulkCBuffer(c, node-&gt;slaves[i]-&gt;name, CLUSTER_NAMELEN);</span><br><span class="line">                    nested_elements++;</span><br><span class="line">                &#125;</span><br><span class="line">                setDeferredMultiBulkLength(c, nested_replylen, nested_elements);</span><br><span class="line">                num_masters++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">    setDeferredMultiBulkLength(c, slot_replylen, num_masters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterCommand"><a href="#clusterCommand" class="headerlink" title="clusterCommand"></a>clusterCommand</h5><p>响应cluster命令的入口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clusterCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//是否开启集群校验</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster_enabled == <span class="number">0</span>) &#123;</span><br><span class="line">        addReplyError(c,<span class="string">&quot;This instance has cluster support disabled&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//help命令</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;argc == <span class="number">2</span> &amp;&amp; !strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;help&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *help[] = &#123;</span><br><span class="line"><span class="string">&quot;ADDSLOTS &lt;slot&gt; [slot ...] -- Assign slots to current node.&quot;</span>,</span><br><span class="line"><span class="string">&quot;BUMPEPOCH -- Advance the cluster config epoch.&quot;</span>,</span><br><span class="line"><span class="string">&quot;COUNT-failure-reports &lt;node-id&gt; -- Return number of failure reports for &lt;node-id&gt;.&quot;</span>,</span><br><span class="line"><span class="string">&quot;COUNTKEYSINSLOT &lt;slot&gt; - Return the number of keys in &lt;slot&gt;.&quot;</span>,</span><br><span class="line"><span class="string">&quot;DELSLOTS &lt;slot&gt; [slot ...] -- Delete slots information from current node.&quot;</span>,</span><br><span class="line"><span class="string">&quot;FAILOVER [force|takeover] -- Promote current replica node to being a master.&quot;</span>,</span><br><span class="line"><span class="string">&quot;FORGET &lt;node-id&gt; -- Remove a node from the cluster.&quot;</span>,</span><br><span class="line"><span class="string">&quot;GETKEYSINSLOT &lt;slot&gt; &lt;count&gt; -- Return key names stored by current node in a slot.&quot;</span>,</span><br><span class="line"><span class="string">&quot;FLUSHSLOTS -- Delete current node own slots information.&quot;</span>,</span><br><span class="line"><span class="string">&quot;INFO - Return onformation about the cluster.&quot;</span>,</span><br><span class="line"><span class="string">&quot;KEYSLOT &lt;key&gt; -- Return the hash slot for &lt;key&gt;.&quot;</span>,</span><br><span class="line"><span class="string">&quot;MEET &lt;ip&gt; &lt;port&gt; [bus-port] -- Connect nodes into a working cluster.&quot;</span>,</span><br><span class="line"><span class="string">&quot;MYID -- Return the node id.&quot;</span>,</span><br><span class="line"><span class="string">&quot;NODES -- Return cluster configuration seen by node. Output format:&quot;</span>,</span><br><span class="line"><span class="string">&quot;    &lt;id&gt; &lt;ip:port&gt; &lt;flags&gt; &lt;master&gt; &lt;pings&gt; &lt;pongs&gt; &lt;epoch&gt; &lt;link&gt; &lt;slot&gt; ... &lt;slot&gt;&quot;</span>,</span><br><span class="line"><span class="string">&quot;REPLICATE &lt;node-id&gt; -- Configure current node as replica to &lt;node-id&gt;.&quot;</span>,</span><br><span class="line"><span class="string">&quot;RESET [hard|soft] -- Reset current node (default: soft).&quot;</span>,</span><br><span class="line"><span class="string">&quot;SET-config-epoch &lt;epoch&gt; - Set config epoch of current node.&quot;</span>,</span><br><span class="line"><span class="string">&quot;SETSLOT &lt;slot&gt; (importing|migrating|stable|node &lt;node-id&gt;) -- Set slot state.&quot;</span>,</span><br><span class="line"><span class="string">&quot;REPLICAS &lt;node-id&gt; -- Return &lt;node-id&gt; replicas.&quot;</span>,</span><br><span class="line"><span class="string">&quot;SLOTS -- Return information about slots range mappings. Each range is made of:&quot;</span>,</span><br><span class="line"><span class="string">&quot;    start, end, master and replicas IP addresses, ports and ids&quot;</span>,</span><br><span class="line"><span class="literal">NULL</span></span><br><span class="line">        &#125;;</span><br><span class="line">        addReplyHelp(c, help);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;meet&quot;</span>) &amp;&amp; (c-&gt;argc == <span class="number">4</span> || c-&gt;argc == <span class="number">5</span>)) &#123;</span><br><span class="line">        <span class="comment">//MEET消息，创建集群 格式：CLUSTER MEET &lt;ip&gt; &lt;port&gt; [cport]</span></span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> port, cport;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getLongLongFromObject(c-&gt;argv[<span class="number">3</span>], &amp;port) != C_OK) &#123;</span><br><span class="line">            addReplyErrorFormat(c,<span class="string">&quot;Invalid TCP base port specified: %s&quot;</span>,</span><br><span class="line">                                (<span class="keyword">char</span>*)c-&gt;argv[<span class="number">3</span>]-&gt;ptr);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc == <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (getLongLongFromObject(c-&gt;argv[<span class="number">4</span>], &amp;cport) != C_OK) &#123;</span><br><span class="line">                addReplyErrorFormat(c,<span class="string">&quot;Invalid TCP bus port specified: %s&quot;</span>,</span><br><span class="line">                                    (<span class="keyword">char</span>*)c-&gt;argv[<span class="number">4</span>]-&gt;ptr);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cport = port + CLUSTER_PORT_INCR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建节点，下一次定时任务会简历连接</span></span><br><span class="line">        <span class="keyword">if</span> (clusterStartHandshake(c-&gt;argv[<span class="number">2</span>]-&gt;ptr,port,cport) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">            errno == EINVAL)</span><br><span class="line">        &#123;</span><br><span class="line">            addReplyErrorFormat(c,<span class="string">&quot;Invalid node address specified: %s:%s&quot;</span>,</span><br><span class="line">                            (<span class="keyword">char</span>*)c-&gt;argv[<span class="number">2</span>]-&gt;ptr, (<span class="keyword">char</span>*)c-&gt;argv[<span class="number">3</span>]-&gt;ptr);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addReply(c,shared.ok);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;nodes&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">//查询节点情况</span></span><br><span class="line">        robj *o;</span><br><span class="line">        sds ci = clusterGenNodesDescription(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        o = createObject(OBJ_STRING,ci);</span><br><span class="line">        addReplyBulk(c,o);</span><br><span class="line">        decrRefCount(o);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;myid&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">//获取运行id</span></span><br><span class="line">        addReplyBulkCBuffer(c,myself-&gt;name, CLUSTER_NAMELEN);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;slots&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">//获取槽点情况</span></span><br><span class="line">        clusterReplyMultiBulkSlots(c);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;flushslots&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">//情况自己管理的所有槽点</span></span><br><span class="line">        <span class="keyword">if</span> (dictSize(server.db[<span class="number">0</span>].dict) != <span class="number">0</span>) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;DB must be empty to perform CLUSTER FLUSHSLOTS.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        clusterDelNodeSlots(myself);</span><br><span class="line">        clusterDoBeforeSleep(CLUSTER_TODO_UPDATE_STATE|CLUSTER_TODO_SAVE_CONFIG);</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;addslots&quot;</span>) ||</span><br><span class="line">               !strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;delslots&quot;</span>)) &amp;&amp; c-&gt;argc &gt;= <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="comment">//增加&amp;删除槽点</span></span><br><span class="line">        <span class="comment">/* CLUSTER ADDSLOTS &lt;slot&gt; [slot] ... */</span></span><br><span class="line">        <span class="comment">/* CLUSTER DELSLOTS &lt;slot&gt; [slot] ... */</span></span><br><span class="line">        <span class="keyword">int</span> j, slot;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> *slots = zmalloc(CLUSTER_SLOTS);</span><br><span class="line">        <span class="keyword">int</span> del = !strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;delslots&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(slots,<span class="number">0</span>,CLUSTER_SLOTS);</span><br><span class="line">        <span class="comment">//检查槽点是否满足增加活删除条件</span></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">2</span>; j &lt; c-&gt;argc; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((slot = getSlotOrReply(c,c-&gt;argv[j])) == <span class="number">-1</span>) &#123;</span><br><span class="line">                zfree(slots);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (del &amp;&amp; server.cluster-&gt;slots[slot] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                addReplyErrorFormat(c,<span class="string">&quot;Slot %d is already unassigned&quot;</span>, slot);</span><br><span class="line">                zfree(slots);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!del &amp;&amp; server.cluster-&gt;slots[slot]) &#123;</span><br><span class="line">                addReplyErrorFormat(c,<span class="string">&quot;Slot %d is already busy&quot;</span>, slot);</span><br><span class="line">                zfree(slots);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (slots[slot]++ == <span class="number">1</span>) &#123;</span><br><span class="line">                addReplyErrorFormat(c,<span class="string">&quot;Slot %d specified multiple times&quot;</span>,</span><br><span class="line">                    (<span class="keyword">int</span>)slot);</span><br><span class="line">                zfree(slots);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//具体操作</span></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (slots[j]) &#123;</span><br><span class="line">                <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (server.cluster-&gt;importing_slots_from[j])</span><br><span class="line">                    server.cluster-&gt;importing_slots_from[j] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">                retval = del ? clusterDelSlot(j) :</span><br><span class="line">                               clusterAddSlot(myself,j);</span><br><span class="line">                serverAssertWithInfo(c,<span class="literal">NULL</span>,retval == C_OK);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        zfree(slots);</span><br><span class="line">        clusterDoBeforeSleep(CLUSTER_TODO_UPDATE_STATE|CLUSTER_TODO_SAVE_CONFIG);</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;setslot&quot;</span>) &amp;&amp; c-&gt;argc &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">    	<span class="comment">//设置槽点情况，包括迁出、迁入、稳定</span></span><br><span class="line">        <span class="comment">/* SETSLOT 10 MIGRATING &lt;node ID&gt; */</span></span><br><span class="line">        <span class="comment">/* SETSLOT 10 IMPORTING &lt;node ID&gt; */</span></span><br><span class="line">        <span class="comment">/* SETSLOT 10 STABLE */</span></span><br><span class="line">        <span class="comment">/* SETSLOT 10 NODE &lt;node ID&gt; */</span></span><br><span class="line">        <span class="keyword">int</span> slot;</span><br><span class="line">        clusterNode *n;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nodeIsSlave(myself)) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;Please use SETSLOT only with masters.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((slot = getSlotOrReply(c,c-&gt;argv[<span class="number">2</span>])) == <span class="number">-1</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//迁出</span></span><br><span class="line">        <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">3</span>]-&gt;ptr,<span class="string">&quot;migrating&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (server.cluster-&gt;slots[slot] != myself) &#123;</span><br><span class="line">                addReplyErrorFormat(c,<span class="string">&quot;I&#x27;m not the owner of hash slot %u&quot;</span>,slot);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((n = clusterLookupNode(c-&gt;argv[<span class="number">4</span>]-&gt;ptr)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                addReplyErrorFormat(c,<span class="string">&quot;I don&#x27;t know about node %s&quot;</span>,</span><br><span class="line">                    (<span class="keyword">char</span>*)c-&gt;argv[<span class="number">4</span>]-&gt;ptr);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            server.cluster-&gt;migrating_slots_to[slot] = n;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">3</span>]-&gt;ptr,<span class="string">&quot;importing&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">5</span>) &#123;</span><br><span class="line">        	<span class="comment">//迁入</span></span><br><span class="line">            <span class="keyword">if</span> (server.cluster-&gt;slots[slot] == myself) &#123;</span><br><span class="line">                addReplyErrorFormat(c,</span><br><span class="line">                    <span class="string">&quot;I&#x27;m already the owner of hash slot %u&quot;</span>,slot);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((n = clusterLookupNode(c-&gt;argv[<span class="number">4</span>]-&gt;ptr)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                addReplyErrorFormat(c,<span class="string">&quot;I don&#x27;t know about node %s&quot;</span>,</span><br><span class="line">                    (<span class="keyword">char</span>*)c-&gt;argv[<span class="number">4</span>]-&gt;ptr);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            server.cluster-&gt;importing_slots_from[slot] = n;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">3</span>]-&gt;ptr,<span class="string">&quot;stable&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">4</span>) &#123;</span><br><span class="line">        	<span class="comment">//迁移结束</span></span><br><span class="line">            <span class="comment">/* CLUSTER SETSLOT &lt;SLOT&gt; STABLE */</span></span><br><span class="line">            server.cluster-&gt;importing_slots_from[slot] = <span class="literal">NULL</span>;</span><br><span class="line">            server.cluster-&gt;migrating_slots_to[slot] = <span class="literal">NULL</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">3</span>]-&gt;ptr,<span class="string">&quot;node&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">5</span>) &#123;</span><br><span class="line">        	<span class="comment">//分配槽点</span></span><br><span class="line">            <span class="comment">/* CLUSTER SETSLOT &lt;SLOT&gt; NODE &lt;NODE ID&gt; */</span></span><br><span class="line">            clusterNode *n = clusterLookupNode(c-&gt;argv[<span class="number">4</span>]-&gt;ptr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!n) &#123;</span><br><span class="line">                addReplyErrorFormat(c,<span class="string">&quot;Unknown node %s&quot;</span>,</span><br><span class="line">                    (<span class="keyword">char</span>*)c-&gt;argv[<span class="number">4</span>]-&gt;ptr);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (server.cluster-&gt;slots[slot] == myself &amp;&amp; n != myself) &#123;</span><br><span class="line">                <span class="keyword">if</span> (countKeysInSlot(slot) != <span class="number">0</span>) &#123;</span><br><span class="line">                    addReplyErrorFormat(c,</span><br><span class="line">                        <span class="string">&quot;Can&#x27;t assign hashslot %d to a different node &quot;</span></span><br><span class="line">                        <span class="string">&quot;while I still hold keys for this hash slot.&quot;</span>, slot);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (countKeysInSlot(slot) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                server.cluster-&gt;migrating_slots_to[slot])</span><br><span class="line">                server.cluster-&gt;migrating_slots_to[slot] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (n == myself &amp;&amp;</span><br><span class="line">                server.cluster-&gt;importing_slots_from[slot])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (clusterBumpConfigEpochWithoutConsensus() == C_OK) &#123;</span><br><span class="line">                    serverLog(LL_WARNING,</span><br><span class="line">                        <span class="string">&quot;configEpoch updated after importing slot %d&quot;</span>, slot);</span><br><span class="line">                &#125;</span><br><span class="line">                server.cluster-&gt;importing_slots_from[slot] = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            clusterDelSlot(slot);</span><br><span class="line">            clusterAddSlot(n,slot);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addReplyError(c,</span><br><span class="line">                <span class="string">&quot;Invalid CLUSTER SETSLOT action or number of arguments. Try CLUSTER HELP&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|CLUSTER_TODO_UPDATE_STATE);</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;bumpepoch&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">//更新纪元</span></span><br><span class="line">        <span class="keyword">int</span> retval = clusterBumpConfigEpochWithoutConsensus();</span><br><span class="line">        sds reply = sdscatprintf(sdsempty(),<span class="string">&quot;+%s %llu\r\n&quot;</span>,</span><br><span class="line">                (retval == C_OK) ? <span class="string">&quot;BUMPED&quot;</span> : <span class="string">&quot;STILL&quot;</span>,</span><br><span class="line">                (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) myself-&gt;configEpoch);</span><br><span class="line">        addReplySds(c,reply);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;info&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">//获取当前节点情况</span></span><br><span class="line">        <span class="keyword">char</span> *statestr[] = &#123;<span class="string">&quot;ok&quot;</span>,<span class="string">&quot;fail&quot;</span>,<span class="string">&quot;needhelp&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> slots_assigned = <span class="number">0</span>, slots_ok = <span class="number">0</span>, slots_pfail = <span class="number">0</span>, slots_fail = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uint64_t</span> myepoch;</span><br><span class="line">        <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CLUSTER_SLOTS; j++) &#123;</span><br><span class="line">            clusterNode *n = server.cluster-&gt;slots[j];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="literal">NULL</span>) <span class="keyword">continue</span>;</span><br><span class="line">            slots_assigned++;</span><br><span class="line">            <span class="keyword">if</span> (nodeFailed(n)) &#123;</span><br><span class="line">                slots_fail++;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeTimedOut(n)) &#123;</span><br><span class="line">                slots_pfail++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                slots_ok++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        myepoch = (nodeIsSlave(myself) &amp;&amp; myself-&gt;slaveof) ?</span><br><span class="line">                  myself-&gt;slaveof-&gt;configEpoch : myself-&gt;configEpoch;</span><br><span class="line"></span><br><span class="line">        sds info = sdscatprintf(sdsempty(),</span><br><span class="line">            <span class="string">&quot;cluster_state:%s\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;cluster_slots_assigned:%d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;cluster_slots_ok:%d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;cluster_slots_pfail:%d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;cluster_slots_fail:%d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;cluster_known_nodes:%lu\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;cluster_size:%d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;cluster_current_epoch:%llu\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;cluster_my_epoch:%llu\r\n&quot;</span></span><br><span class="line">            , statestr[server.cluster-&gt;state],</span><br><span class="line">            slots_assigned,</span><br><span class="line">            slots_ok,</span><br><span class="line">            slots_pfail,</span><br><span class="line">            slots_fail,</span><br><span class="line">            dictSize(server.cluster-&gt;nodes),</span><br><span class="line">            server.cluster-&gt;size,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) server.cluster-&gt;currentEpoch,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) myepoch</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//统计信息</span></span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> tot_msg_sent = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> tot_msg_received = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CLUSTERMSG_TYPE_COUNT; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (server.cluster-&gt;stats_bus_messages_sent[i] == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">            tot_msg_sent += server.cluster-&gt;stats_bus_messages_sent[i];</span><br><span class="line">            info = sdscatprintf(info,</span><br><span class="line">                <span class="string">&quot;cluster_stats_messages_%s_sent:%lld\r\n&quot;</span>,</span><br><span class="line">                clusterGetMessageTypeString(i),</span><br><span class="line">                server.cluster-&gt;stats_bus_messages_sent[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        info = sdscatprintf(info,</span><br><span class="line">            <span class="string">&quot;cluster_stats_messages_sent:%lld\r\n&quot;</span>, tot_msg_sent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CLUSTERMSG_TYPE_COUNT; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (server.cluster-&gt;stats_bus_messages_received[i] == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">            tot_msg_received += server.cluster-&gt;stats_bus_messages_received[i];</span><br><span class="line">            info = sdscatprintf(info,</span><br><span class="line">                <span class="string">&quot;cluster_stats_messages_%s_received:%lld\r\n&quot;</span>,</span><br><span class="line">                clusterGetMessageTypeString(i),</span><br><span class="line">                server.cluster-&gt;stats_bus_messages_received[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        info = sdscatprintf(info,</span><br><span class="line">            <span class="string">&quot;cluster_stats_messages_received:%lld\r\n&quot;</span>, tot_msg_received);</span><br><span class="line"></span><br><span class="line">        addReplySds(c,sdscatprintf(sdsempty(),<span class="string">&quot;$%lu\r\n&quot;</span>,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">long</span>)sdslen(info)));</span><br><span class="line">        addReplySds(c,info);</span><br><span class="line">        addReply(c,shared.crlf);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;saveconfig&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">2</span>) &#123;</span><br><span class="line">    	<span class="comment">//保存配置到磁盘</span></span><br><span class="line">        <span class="keyword">int</span> retval = clusterSaveConfig(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (retval == <span class="number">0</span>)</span><br><span class="line">            addReply(c,shared.ok);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            addReplyErrorFormat(c,<span class="string">&quot;error saving the cluster node config: %s&quot;</span>,</span><br><span class="line">                strerror(errno));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;keyslot&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">3</span>) &#123;</span><br><span class="line">    	<span class="comment">//获取key对应的槽点</span></span><br><span class="line">        <span class="comment">/* CLUSTER KEYSLOT &lt;key&gt; */</span></span><br><span class="line">        sds key = c-&gt;argv[<span class="number">2</span>]-&gt;ptr;</span><br><span class="line"></span><br><span class="line">        addReplyLongLong(c,keyHashSlot(key,sdslen(key)));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;countkeysinslot&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">3</span>) &#123;</span><br><span class="line">    	<span class="comment">//获取槽点中key的数量</span></span><br><span class="line">        <span class="comment">/* CLUSTER COUNTKEYSINSLOT &lt;slot&gt; */</span></span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> slot;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getLongLongFromObjectOrReply(c,c-&gt;argv[<span class="number">2</span>],&amp;slot,<span class="literal">NULL</span>) != C_OK)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (slot &lt; <span class="number">0</span> || slot &gt;= CLUSTER_SLOTS) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;Invalid slot&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        addReplyLongLong(c,countKeysInSlot(slot));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;getkeysinslot&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">4</span>) &#123;</span><br><span class="line">    	<span class="comment">//获取槽点中key的明细</span></span><br><span class="line">        <span class="comment">/* CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;count&gt; */</span></span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> maxkeys, slot;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> numkeys, j;</span><br><span class="line">        robj **keys;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getLongLongFromObjectOrReply(c,c-&gt;argv[<span class="number">2</span>],&amp;slot,<span class="literal">NULL</span>) != C_OK)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (getLongLongFromObjectOrReply(c,c-&gt;argv[<span class="number">3</span>],&amp;maxkeys,<span class="literal">NULL</span>)</span><br><span class="line">            != C_OK)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (slot &lt; <span class="number">0</span> || slot &gt;= CLUSTER_SLOTS || maxkeys &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;Invalid slot or number of keys&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Avoid allocating more than needed in case of large COUNT argument</span></span><br><span class="line"><span class="comment">         * and smaller actual number of keys. */</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> keys_in_slot = countKeysInSlot(slot);</span><br><span class="line">        <span class="keyword">if</span> (maxkeys &gt; keys_in_slot) maxkeys = keys_in_slot;</span><br><span class="line"></span><br><span class="line">        keys = zmalloc(<span class="keyword">sizeof</span>(robj*)*maxkeys);</span><br><span class="line">        numkeys = getKeysInSlot(slot, keys, maxkeys);</span><br><span class="line">        addReplyMultiBulkLen(c,numkeys);</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; numkeys; j++) &#123;</span><br><span class="line">            addReplyBulk(c,keys[j]);</span><br><span class="line">            decrRefCount(keys[j]);</span><br><span class="line">        &#125;</span><br><span class="line">        zfree(keys);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;forget&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">3</span>) &#123;</span><br><span class="line">    	<span class="comment">//删除某个节点</span></span><br><span class="line">        <span class="comment">/* CLUSTER FORGET &lt;NODE ID&gt; */</span></span><br><span class="line">        clusterNode *n = clusterLookupNode(c-&gt;argv[<span class="number">2</span>]-&gt;ptr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!n) &#123;</span><br><span class="line">            addReplyErrorFormat(c,<span class="string">&quot;Unknown node %s&quot;</span>, (<span class="keyword">char</span>*)c-&gt;argv[<span class="number">2</span>]-&gt;ptr);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n == myself) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;I tried hard but I can&#x27;t forget myself...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeIsSlave(myself) &amp;&amp; myself-&gt;slaveof == n) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;Can&#x27;t forget my master!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        clusterBlacklistAddNode(n);</span><br><span class="line">        clusterDelNode(n);</span><br><span class="line">        clusterDoBeforeSleep(CLUSTER_TODO_UPDATE_STATE|</span><br><span class="line">                             CLUSTER_TODO_SAVE_CONFIG);</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;replicate&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">3</span>) &#123;</span><br><span class="line">    	<span class="comment">//设置master节点信息</span></span><br><span class="line">        <span class="comment">/* CLUSTER REPLICATE &lt;NODE ID&gt; */</span></span><br><span class="line">        clusterNode *n = clusterLookupNode(c-&gt;argv[<span class="number">2</span>]-&gt;ptr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检验节点有效</span></span><br><span class="line">        <span class="keyword">if</span> (!n) &#123;</span><br><span class="line">            addReplyErrorFormat(c,<span class="string">&quot;Unknown node %s&quot;</span>, (<span class="keyword">char</span>*)c-&gt;argv[<span class="number">2</span>]-&gt;ptr);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自己校验</span></span><br><span class="line">        <span class="keyword">if</span> (n == myself) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;Can&#x27;t replicate myself&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//目标master校验</span></span><br><span class="line">        <span class="keyword">if</span> (nodeIsSlave(n)) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;I can only replicate a master, not a replica.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自己是有效master，不能扔下负责的槽点</span></span><br><span class="line">        <span class="keyword">if</span> (nodeIsMaster(myself) &amp;&amp;</span><br><span class="line">            (myself-&gt;numslots != <span class="number">0</span> || dictSize(server.db[<span class="number">0</span>].dict) != <span class="number">0</span>)) &#123;</span><br><span class="line">            addReplyError(c,</span><br><span class="line">                <span class="string">&quot;To set a master the node must be empty and &quot;</span></span><br><span class="line">                <span class="string">&quot;without assigned slots.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        clusterSetMaster(n);</span><br><span class="line">        clusterDoBeforeSleep(CLUSTER_TODO_UPDATE_STATE|CLUSTER_TODO_SAVE_CONFIG);</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;slaves&quot;</span>) ||</span><br><span class="line">                !strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;replicas&quot;</span>)) &amp;&amp; c-&gt;argc == <span class="number">3</span>) &#123;</span><br><span class="line">    	<span class="comment">//获取master下所有的slave描述</span></span><br><span class="line">        <span class="comment">/* CLUSTER SLAVES &lt;NODE ID&gt; */</span></span><br><span class="line">        clusterNode *n = clusterLookupNode(c-&gt;argv[<span class="number">2</span>]-&gt;ptr);</span><br><span class="line">        <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Lookup the specified node in our table. */</span></span><br><span class="line">        <span class="keyword">if</span> (!n) &#123;</span><br><span class="line">            addReplyErrorFormat(c,<span class="string">&quot;Unknown node %s&quot;</span>, (<span class="keyword">char</span>*)c-&gt;argv[<span class="number">2</span>]-&gt;ptr);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nodeIsSlave(n)) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;The specified node is not a master&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        addReplyMultiBulkLen(c,n-&gt;numslaves);</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; n-&gt;numslaves; j++) &#123;</span><br><span class="line">            sds ni = clusterGenNodeDescription(n-&gt;slaves[j]);</span><br><span class="line">            addReplyBulkCString(c,ni);</span><br><span class="line">            sdsfree(ni);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;count-failure-reports&quot;</span>) &amp;&amp;</span><br><span class="line">               c-&gt;argc == <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="comment">//获取某个节点的掉线汇报数量</span></span><br><span class="line">        <span class="comment">/* CLUSTER COUNT-FAILURE-REPORTS &lt;NODE ID&gt; */</span></span><br><span class="line">        clusterNode *n = clusterLookupNode(c-&gt;argv[<span class="number">2</span>]-&gt;ptr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!n) &#123;</span><br><span class="line">            addReplyErrorFormat(c,<span class="string">&quot;Unknown node %s&quot;</span>, (<span class="keyword">char</span>*)c-&gt;argv[<span class="number">2</span>]-&gt;ptr);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addReplyLongLong(c,clusterNodeFailureReportsCount(n));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;failover&quot;</span>) &amp;&amp;</span><br><span class="line">               (c-&gt;argc == <span class="number">2</span> || c-&gt;argc == <span class="number">3</span>))</span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="comment">//手动开始故障修复</span></span><br><span class="line">        <span class="comment">/* CLUSTER FAILOVER [FORCE|TAKEOVER] */</span></span><br><span class="line">        <span class="keyword">int</span> force = <span class="number">0</span>, takeover = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc == <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">2</span>]-&gt;ptr,<span class="string">&quot;force&quot;</span>)) &#123;</span><br><span class="line">                force = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">2</span>]-&gt;ptr,<span class="string">&quot;takeover&quot;</span>)) &#123;</span><br><span class="line">                takeover = <span class="number">1</span>;</span><br><span class="line">                force = <span class="number">1</span>; <span class="comment">/* Takeover also implies force. */</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                addReply(c,shared.syntaxerr);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Check preconditions. */</span></span><br><span class="line">        <span class="keyword">if</span> (nodeIsMaster(myself)) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;You should send CLUSTER FAILOVER to a replica&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (myself-&gt;slaveof == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;I&#x27;m a replica but my master is unknown to me&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!force &amp;&amp;</span><br><span class="line">                   (nodeFailed(myself-&gt;slaveof) ||</span><br><span class="line">                    myself-&gt;slaveof-&gt;link == <span class="literal">NULL</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;Master is down or failed, &quot;</span></span><br><span class="line">                            <span class="string">&quot;please use CLUSTER FAILOVER FORCE&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        resetManualFailover();</span><br><span class="line">        server.cluster-&gt;mf_end = mstime() + CLUSTER_MF_TIMEOUT;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (takeover) &#123;</span><br><span class="line">            serverLog(LL_WARNING,<span class="string">&quot;Taking over the master (user request).&quot;</span>);</span><br><span class="line">            clusterBumpConfigEpochWithoutConsensus();</span><br><span class="line">            clusterFailoverReplaceYourMaster();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (force) &#123;</span><br><span class="line">            <span class="comment">//是否强制</span></span><br><span class="line">            serverLog(LL_WARNING,<span class="string">&quot;Forced failover user request accepted.&quot;</span>);</span><br><span class="line">            server.cluster-&gt;mf_can_start = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            serverLog(LL_WARNING,<span class="string">&quot;Manual failover user request accepted.&quot;</span>);</span><br><span class="line">            clusterSendMFStart(myself-&gt;slaveof);</span><br><span class="line">        &#125;</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;set-config-epoch&quot;</span>) &amp;&amp; c-&gt;argc == <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="comment">//设置配置纪元</span></span><br><span class="line">        <span class="comment">// CLUSTER SET-CONFIG-EPOCH &lt;epoch&gt;</span></span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> epoch;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getLongLongFromObjectOrReply(c,c-&gt;argv[<span class="number">2</span>],&amp;epoch,<span class="literal">NULL</span>) != C_OK)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (epoch &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            addReplyErrorFormat(c,<span class="string">&quot;Invalid config epoch specified: %lld&quot;</span>,epoch);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dictSize(server.cluster-&gt;nodes) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;The user can assign a config epoch only when the &quot;</span></span><br><span class="line">                            <span class="string">&quot;node does not know any other node.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (myself-&gt;configEpoch != <span class="number">0</span>) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;Node config epoch is already non-zero&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            myself-&gt;configEpoch = epoch;</span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">&quot;configEpoch set to %llu via CLUSTER SET-CONFIG-EPOCH&quot;</span>,</span><br><span class="line">                (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) myself-&gt;configEpoch);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (server.cluster-&gt;currentEpoch &lt; (<span class="keyword">uint64_t</span>)epoch)</span><br><span class="line">                server.cluster-&gt;currentEpoch = epoch;</span><br><span class="line">            clusterDoBeforeSleep(CLUSTER_TODO_UPDATE_STATE|</span><br><span class="line">                                 CLUSTER_TODO_SAVE_CONFIG);</span><br><span class="line">            addReply(c,shared.ok);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;reset&quot;</span>) &amp;&amp;</span><br><span class="line">               (c-&gt;argc == <span class="number">2</span> || c-&gt;argc == <span class="number">3</span>))</span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="comment">//节点重置</span></span><br><span class="line">        <span class="comment">/* CLUSTER RESET [SOFT|HARD] */</span></span><br><span class="line">        <span class="keyword">int</span> hard = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc == <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">2</span>]-&gt;ptr,<span class="string">&quot;hard&quot;</span>)) &#123;</span><br><span class="line">                hard = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">2</span>]-&gt;ptr,<span class="string">&quot;soft&quot;</span>)) &#123;</span><br><span class="line">                hard = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                addReply(c,shared.syntaxerr);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//有数据的话，不能重置</span></span><br><span class="line">        <span class="keyword">if</span> (nodeIsMaster(myself) &amp;&amp; dictSize(c-&gt;db-&gt;dict) != <span class="number">0</span>) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;CLUSTER RESET can&#x27;t be called with &quot;</span></span><br><span class="line">                            <span class="string">&quot;master nodes containing keys&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        clusterReset(hard);</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addReplySubcommandSyntaxError(c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="createDumpPayload"><a href="#createDumpPayload" class="headerlink" title="createDumpPayload"></a>createDumpPayload</h5><p>序列化redis对象，并存入rio</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createDumpPayload</span><span class="params">(rio *payload, robj *o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> crc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Serialize the object in a RDB-like format. It consist of an object type</span></span><br><span class="line"><span class="comment">     * byte followed by the serialized object. This is understood by RESTORE. */</span></span><br><span class="line">    rioInitWithBuffer(payload,sdsempty());</span><br><span class="line">    serverAssert(rdbSaveObjectType(payload,o));</span><br><span class="line">    serverAssert(rdbSaveObject(payload,o));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Write the footer, this is how it looks like:</span></span><br><span class="line"><span class="comment">     * ----------------+---------------------+---------------+</span></span><br><span class="line"><span class="comment">     * ... RDB payload | 2 bytes RDB version | 8 bytes CRC64 |</span></span><br><span class="line"><span class="comment">     * ----------------+---------------------+---------------+</span></span><br><span class="line"><span class="comment">     * RDB version and CRC are both in little endian.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* RDB version */</span></span><br><span class="line">    buf[<span class="number">0</span>] = RDB_VERSION &amp; <span class="number">0xff</span>;</span><br><span class="line">    buf[<span class="number">1</span>] = (RDB_VERSION &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">    payload-&gt;io.buffer.ptr = sdscatlen(payload-&gt;io.buffer.ptr,buf,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* CRC64 */</span></span><br><span class="line">    crc = crc64(<span class="number">0</span>,(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)payload-&gt;io.buffer.ptr,</span><br><span class="line">                sdslen(payload-&gt;io.buffer.ptr));</span><br><span class="line">    memrev64ifbe(&amp;crc);</span><br><span class="line">    payload-&gt;io.buffer.ptr = sdscatlen(payload-&gt;io.buffer.ptr,&amp;crc,<span class="number">8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="restoreCommand"><a href="#restoreCommand" class="headerlink" title="restoreCommand"></a>restoreCommand</h5><p>恢复key value，使用序列化的数据，格式<code>RESTORE key ttl serialized-value [REPLACE]</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">restoreCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> ttl, lfu_freq = <span class="number">-1</span>, lru_idle = <span class="number">-1</span>, lru_clock = <span class="number">-1</span>;</span><br><span class="line">    rio payload;</span><br><span class="line">    <span class="keyword">int</span> j, type, replace = <span class="number">0</span>, absttl = <span class="number">0</span>;</span><br><span class="line">    robj *obj;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parse additional options */</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">4</span>; j &lt; c-&gt;argc; j++) &#123;</span><br><span class="line">        <span class="keyword">int</span> additional = c-&gt;argc-j<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class="string">&quot;replace&quot;</span>)) &#123;</span><br><span class="line">            replace = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class="string">&quot;absttl&quot;</span>)) &#123;</span><br><span class="line">            absttl = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class="string">&quot;idletime&quot;</span>) &amp;&amp; additional &gt;= <span class="number">1</span> &amp;&amp;</span><br><span class="line">                   lfu_freq == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (getLongLongFromObjectOrReply(c,c-&gt;argv[j+<span class="number">1</span>],&amp;lru_idle,<span class="literal">NULL</span>)</span><br><span class="line">                    != C_OK) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">if</span> (lru_idle &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                addReplyError(c,<span class="string">&quot;Invalid IDLETIME value, must be &gt;= 0&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            lru_clock = LRU_CLOCK();</span><br><span class="line">            j++; <span class="comment">/* Consume additional arg. */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class="string">&quot;freq&quot;</span>) &amp;&amp; additional &gt;= <span class="number">1</span> &amp;&amp;</span><br><span class="line">                   lru_idle == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (getLongLongFromObjectOrReply(c,c-&gt;argv[j+<span class="number">1</span>],&amp;lfu_freq,<span class="literal">NULL</span>)</span><br><span class="line">                    != C_OK) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">if</span> (lfu_freq &lt; <span class="number">0</span> || lfu_freq &gt; <span class="number">255</span>) &#123;</span><br><span class="line">                addReplyError(c,<span class="string">&quot;Invalid FREQ value, must be &gt;= 0 and &lt;= 255&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            j++; <span class="comment">/* Consume additional arg. */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addReply(c,shared.syntaxerr);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Make sure this key does not already exist here... */</span></span><br><span class="line">    <span class="keyword">if</span> (!replace &amp;&amp; lookupKeyWrite(c-&gt;db,c-&gt;argv[<span class="number">1</span>]) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        addReply(c,shared.busykeyerr);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if the TTL value makes sense */</span></span><br><span class="line">    <span class="keyword">if</span> (getLongLongFromObjectOrReply(c,c-&gt;argv[<span class="number">2</span>],&amp;ttl,<span class="literal">NULL</span>) != C_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ttl &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        addReplyError(c,<span class="string">&quot;Invalid TTL value, must be &gt;= 0&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Verify RDB version and data checksum. */</span></span><br><span class="line">    <span class="keyword">if</span> (verifyDumpPayload(c-&gt;argv[<span class="number">3</span>]-&gt;ptr,sdslen(c-&gt;argv[<span class="number">3</span>]-&gt;ptr)) == C_ERR)</span><br><span class="line">    &#123;</span><br><span class="line">        addReplyError(c,<span class="string">&quot;DUMP payload version or checksum are wrong&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rioInitWithBuffer(&amp;payload,c-&gt;argv[<span class="number">3</span>]-&gt;ptr);</span><br><span class="line">    <span class="keyword">if</span> (((type = rdbLoadObjectType(&amp;payload)) == <span class="number">-1</span>) ||</span><br><span class="line">        ((obj = rdbLoadObject(type,&amp;payload)) == <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        addReplyError(c,<span class="string">&quot;Bad data format&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Remove the old key if needed. */</span></span><br><span class="line">    <span class="keyword">if</span> (replace) dbDelete(c-&gt;db,c-&gt;argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create the key and set the TTL if any */</span></span><br><span class="line">    dbAdd(c-&gt;db,c-&gt;argv[<span class="number">1</span>],obj);</span><br><span class="line">    <span class="keyword">if</span> (ttl) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!absttl) ttl+=mstime();</span><br><span class="line">        setExpire(c,c-&gt;db,c-&gt;argv[<span class="number">1</span>],ttl);</span><br><span class="line">    &#125;</span><br><span class="line">    objectSetLRUOrLFU(obj,lfu_freq,lru_idle,lru_clock);</span><br><span class="line">    signalModifiedKey(c-&gt;db,c-&gt;argv[<span class="number">1</span>]);</span><br><span class="line">    addReply(c,shared.ok);</span><br><span class="line">    server.dirty++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="key迁移操作"><a href="#key迁移操作" class="headerlink" title="key迁移操作"></a>key迁移操作</h4><p>redis提供了原子性的key迁移命令，维护了一个跟目标节点连接fd缓存区<code>server.migrate_cached_sockets</code>，防止在短时间内多次迁移需要建立多个连接</p>
<h5 id="migrateGetSocket"><a href="#migrateGetSocket" class="headerlink" title="migrateGetSocket"></a>migrateGetSocket</h5><p>获取跟host的连接，优先从缓存中取</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIGRATE_SOCKET_CACHE_ITEMS 64 <span class="comment">//缓冲区到校</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIGRATE_SOCKET_CACHE_TTL 10 <span class="comment">//缓存有效时间</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">migrateCachedSocket</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">long</span> last_dbid;</span><br><span class="line">    <span class="keyword">time_t</span> last_use_time;</span><br><span class="line">&#125; migrateCachedSocket;</span><br><span class="line"></span><br><span class="line"><span class="function">migrateCachedSocket* <span class="title">migrateGetSocket</span><span class="params">(client *c, robj *host, robj *port, <span class="keyword">long</span> timeout)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    sds name = sdsempty();</span><br><span class="line">    migrateCachedSocket *cs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查看缓存</span></span><br><span class="line">    name = sdscatlen(name,host-&gt;ptr,sdslen(host-&gt;ptr));</span><br><span class="line">    name = sdscatlen(name,<span class="string">&quot;:&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    name = sdscatlen(name,port-&gt;ptr,sdslen(port-&gt;ptr));</span><br><span class="line">    cs = dictFetchValue(server.migrate_cached_sockets,name);</span><br><span class="line">    <span class="keyword">if</span> (cs) &#123;</span><br><span class="line">        sdsfree(name);</span><br><span class="line">        cs-&gt;last_use_time = server.unixtime;</span><br><span class="line">        <span class="keyword">return</span> cs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//缓存区满了，随机删除一个</span></span><br><span class="line">    <span class="keyword">if</span> (dictSize(server.migrate_cached_sockets) == MIGRATE_SOCKET_CACHE_ITEMS) &#123;</span><br><span class="line">        dictEntry *de = dictGetRandomKey(server.migrate_cached_sockets);</span><br><span class="line">        cs = dictGetVal(de);</span><br><span class="line">        close(cs-&gt;fd);</span><br><span class="line">        zfree(cs);</span><br><span class="line">        dictDelete(server.migrate_cached_sockets,dictGetKey(de));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建连接</span></span><br><span class="line">    fd = anetTcpNonBlockConnect(server.neterr,c-&gt;argv[<span class="number">1</span>]-&gt;ptr,</span><br><span class="line">                                atoi(c-&gt;argv[<span class="number">2</span>]-&gt;ptr));</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        sdsfree(name);</span><br><span class="line">        addReplyErrorFormat(c,<span class="string">&quot;Can&#x27;t connect to target node: %s&quot;</span>,</span><br><span class="line">            server.neterr);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    anetEnableTcpNoDelay(server.neterr,fd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查超时</span></span><br><span class="line">    <span class="keyword">if</span> ((aeWait(fd,AE_WRITABLE,timeout) &amp; AE_WRITABLE) == <span class="number">0</span>) &#123;</span><br><span class="line">        sdsfree(name);</span><br><span class="line">        addReplySds(c,</span><br><span class="line">            sdsnew(<span class="string">&quot;-IOERR error or timeout connecting to the client\r\n&quot;</span>));</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加入缓存</span></span><br><span class="line">    cs = zmalloc(<span class="keyword">sizeof</span>(*cs));</span><br><span class="line">    cs-&gt;fd = fd;</span><br><span class="line">    cs-&gt;last_dbid = <span class="number">-1</span>;</span><br><span class="line">    cs-&gt;last_use_time = server.unixtime;</span><br><span class="line">    dictAdd(server.migrate_cached_sockets,name,cs);</span><br><span class="line">    <span class="keyword">return</span> cs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="migrateCloseSocket"><a href="#migrateCloseSocket" class="headerlink" title="migrateCloseSocket"></a>migrateCloseSocket</h5><p>关闭fd连接</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">migrateCloseSocket</span><span class="params">(robj *host, robj *port)</span> </span>&#123;</span><br><span class="line">    sds name = sdsempty();</span><br><span class="line">    migrateCachedSocket *cs;</span><br><span class="line"></span><br><span class="line">    name = sdscatlen(name,host-&gt;ptr,sdslen(host-&gt;ptr));</span><br><span class="line">    name = sdscatlen(name,<span class="string">&quot;:&quot;</span>,<span class="number">1</span>);</span><br><span class="line">    name = sdscatlen(name,port-&gt;ptr,sdslen(port-&gt;ptr));</span><br><span class="line">    cs = dictFetchValue(server.migrate_cached_sockets,name);</span><br><span class="line">    <span class="keyword">if</span> (!cs) &#123;</span><br><span class="line">        sdsfree(name);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(cs-&gt;fd);</span><br><span class="line">    zfree(cs);</span><br><span class="line">    dictDelete(server.migrate_cached_sockets,name);</span><br><span class="line">    sdsfree(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="migrateCloseTimedoutSockets"><a href="#migrateCloseTimedoutSockets" class="headerlink" title="migrateCloseTimedoutSockets"></a>migrateCloseTimedoutSockets</h5><p>关闭一段时间没有使用的fd</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">migrateCloseTimedoutSockets</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    dictIterator *di = dictGetSafeIterator(server.migrate_cached_sockets);</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        migrateCachedSocket *cs = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((server.unixtime - cs-&gt;last_use_time) &gt; MIGRATE_SOCKET_CACHE_TTL) &#123;</span><br><span class="line">            close(cs-&gt;fd);</span><br><span class="line">            zfree(cs);</span><br><span class="line">            dictDelete(server.migrate_cached_sockets,dictGetKey(de));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="migrateCommand"><a href="#migrateCommand" class="headerlink" title="migrateCommand"></a>migrateCommand</h5><p>原子性把一个key迁移到另一个节点，有两种格式</p>
<ol>
<li>单个 <code>MIGRATE host port key dbid timeout [COPY | REPLACE | AUTH password]</code></li>
<li>批量 <code>MIGRATE host port &quot;&quot; dbid timeout [COPY | REPLACE | AUTH password] KEYS key1 key2 keyN</code></li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">migrateCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    migrateCachedSocket *cs;</span><br><span class="line">    <span class="keyword">int</span> copy = <span class="number">0</span>, replace = <span class="number">0</span>, j;</span><br><span class="line">    <span class="keyword">char</span> *password = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">long</span> timeout;</span><br><span class="line">    <span class="keyword">long</span> dbid;</span><br><span class="line">    robj **ov = <span class="literal">NULL</span>;</span><br><span class="line">    robj **kv = <span class="literal">NULL</span>;</span><br><span class="line">    robj **newargv = <span class="literal">NULL</span>;</span><br><span class="line">    rio cmd, payload;</span><br><span class="line">    <span class="keyword">int</span> may_retry = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> write_error = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> argv_rewritten = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> first_key = <span class="number">3</span>; <span class="comment">//第一个迁移key位置</span></span><br><span class="line">    <span class="keyword">int</span> num_keys = <span class="number">1</span>; <span class="comment">//迁移key的数量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析参数，确定key，copy/replace</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">6</span>; j &lt; c-&gt;argc; j++) &#123;</span><br><span class="line">        <span class="keyword">int</span> moreargs = j &lt; c-&gt;argc<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class="string">&quot;copy&quot;</span>)) &#123;</span><br><span class="line">            copy = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class="string">&quot;replace&quot;</span>)) &#123;</span><br><span class="line">            replace = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class="string">&quot;auth&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!moreargs) &#123;</span><br><span class="line">                addReply(c,shared.syntaxerr);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            j++;</span><br><span class="line">            password = c-&gt;argv[j]-&gt;ptr;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class="string">&quot;keys&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sdslen(c-&gt;argv[<span class="number">3</span>]-&gt;ptr) != <span class="number">0</span>) &#123;</span><br><span class="line">                addReplyError(c,</span><br><span class="line">                    <span class="string">&quot;When using MIGRATE KEYS option, the key argument&quot;</span></span><br><span class="line">                    <span class="string">&quot; must be set to the empty string&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            first_key = j+<span class="number">1</span>;</span><br><span class="line">            num_keys = c-&gt;argc - j - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addReply(c,shared.syntaxerr);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//dbid和超时时间格式检查</span></span><br><span class="line">    <span class="keyword">if</span> (getLongFromObjectOrReply(c,c-&gt;argv[<span class="number">5</span>],&amp;timeout,<span class="literal">NULL</span>) != C_OK ||</span><br><span class="line">        getLongFromObjectOrReply(c,c-&gt;argv[<span class="number">4</span>],&amp;dbid,<span class="literal">NULL</span>) != C_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (timeout &lt;= <span class="number">0</span>) timeout = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    ov = zrealloc(ov,<span class="keyword">sizeof</span>(robj*)*num_keys); <span class="comment">//迁移的object value</span></span><br><span class="line">    kv = zrealloc(kv,<span class="keyword">sizeof</span>(robj*)*num_keys); <span class="comment">//迁移的object key</span></span><br><span class="line">    <span class="keyword">int</span> oi = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//筛选有效key</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; num_keys; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((ov[oi] = lookupKeyRead(c-&gt;db,c-&gt;argv[first_key+j])) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            kv[oi] = c-&gt;argv[first_key+j];</span><br><span class="line">            oi++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    num_keys = oi;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//有效key为0</span></span><br><span class="line">    <span class="keyword">if</span> (num_keys == <span class="number">0</span>) &#123;</span><br><span class="line">        zfree(ov); zfree(kv);</span><br><span class="line">        addReplySds(c,sdsnew(<span class="string">&quot;+NOKEY\r\n&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">try_again:</span><br><span class="line">    write_error = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取连接</span></span><br><span class="line">    cs = migrateGetSocket(c,c-&gt;argv[<span class="number">1</span>],c-&gt;argv[<span class="number">2</span>],timeout);</span><br><span class="line">    <span class="keyword">if</span> (cs == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        zfree(ov); zfree(kv);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rioInitWithBuffer(&amp;cmd,sdsempty());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//密码校验</span></span><br><span class="line">    <span class="keyword">if</span> (password) &#123;</span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,rioWriteBulkCount(&amp;cmd,<span class="string">&#x27;*&#x27;</span>,<span class="number">2</span>));</span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,rioWriteBulkString(&amp;cmd,<span class="string">&quot;AUTH&quot;</span>,<span class="number">4</span>));</span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,rioWriteBulkString(&amp;cmd,password,</span><br><span class="line">            sdslen(password)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送select db操作</span></span><br><span class="line">    <span class="keyword">int</span> select = cs-&gt;last_dbid != dbid;</span><br><span class="line">    <span class="keyword">if</span> (select) &#123;</span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,rioWriteBulkCount(&amp;cmd,<span class="string">&#x27;*&#x27;</span>,<span class="number">2</span>));</span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,rioWriteBulkString(&amp;cmd,<span class="string">&quot;SELECT&quot;</span>,<span class="number">6</span>));</span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,rioWriteBulkLongLong(&amp;cmd,dbid));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> non_expired = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; num_keys; j++) &#123;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> ttl = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> expireat = getExpire(c-&gt;db,kv[j]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (expireat != <span class="number">-1</span>) &#123;</span><br><span class="line">            ttl = expireat-mstime();</span><br><span class="line">            <span class="comment">//剔除掉已经过期的key</span></span><br><span class="line">            <span class="keyword">if</span> (ttl &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ttl &lt; <span class="number">1</span>) ttl = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        kv[non_expired++] = kv[j];</span><br><span class="line"></span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,</span><br><span class="line">            rioWriteBulkCount(&amp;cmd,<span class="string">&#x27;*&#x27;</span>,replace ? <span class="number">5</span> : <span class="number">4</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//写入命令</span></span><br><span class="line">        <span class="keyword">if</span> (server.cluster_enabled)</span><br><span class="line">            serverAssertWithInfo(c,<span class="literal">NULL</span>,</span><br><span class="line">                rioWriteBulkString(&amp;cmd,<span class="string">&quot;RESTORE-ASKING&quot;</span>,<span class="number">14</span>));</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            serverAssertWithInfo(c,<span class="literal">NULL</span>,rioWriteBulkString(&amp;cmd,<span class="string">&quot;RESTORE&quot;</span>,<span class="number">7</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置key</span></span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,sdsEncodedObject(kv[j]));</span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,rioWriteBulkString(&amp;cmd,kv[j]-&gt;ptr,</span><br><span class="line">                sdslen(kv[j]-&gt;ptr)));</span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,rioWriteBulkLongLong(&amp;cmd,ttl));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置序列化value</span></span><br><span class="line">        createDumpPayload(&amp;payload,ov[j]);</span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,</span><br><span class="line">            rioWriteBulkString(&amp;cmd,payload.io.buffer.ptr,</span><br><span class="line">                               sdslen(payload.io.buffer.ptr)));</span><br><span class="line">        sdsfree(payload.io.buffer.ptr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置替换命令</span></span><br><span class="line">        <span class="keyword">if</span> (replace)</span><br><span class="line">            serverAssertWithInfo(c,<span class="literal">NULL</span>,rioWriteBulkString(&amp;cmd,<span class="string">&quot;REPLACE&quot;</span>,<span class="number">7</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    num_keys = non_expired;</span><br><span class="line"></span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        sds buf = cmd.io.buffer.ptr;</span><br><span class="line">        <span class="keyword">size_t</span> pos = <span class="number">0</span>, towrite;</span><br><span class="line">        <span class="keyword">int</span> nwritten = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分批发送，每次64K</span></span><br><span class="line">        <span class="keyword">while</span> ((towrite = sdslen(buf)-pos) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            towrite = (towrite &gt; (<span class="number">64</span>*<span class="number">1024</span>) ? (<span class="number">64</span>*<span class="number">1024</span>) : towrite);</span><br><span class="line">            nwritten = syncWrite(cs-&gt;fd,buf+pos,towrite,timeout);</span><br><span class="line">            <span class="keyword">if</span> (nwritten != (<span class="keyword">signed</span>)towrite) &#123;</span><br><span class="line">                write_error = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">goto</span> socket_err;</span><br><span class="line">            &#125;</span><br><span class="line">            pos += nwritten;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf0[<span class="number">1024</span>]; <span class="comment">/* Auth reply. */</span></span><br><span class="line">    <span class="keyword">char</span> buf1[<span class="number">1024</span>]; <span class="comment">/* Select reply. */</span></span><br><span class="line">    <span class="keyword">char</span> buf2[<span class="number">1024</span>]; <span class="comment">/* Restore reply. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//密码校验回复</span></span><br><span class="line">    <span class="keyword">if</span> (password &amp;&amp; syncReadLine(cs-&gt;fd, buf0, <span class="keyword">sizeof</span>(buf0), timeout) &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> socket_err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//select回复</span></span><br><span class="line">    <span class="keyword">if</span> (select &amp;&amp; syncReadLine(cs-&gt;fd, buf1, <span class="keyword">sizeof</span>(buf1), timeout) &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> socket_err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//restore回复</span></span><br><span class="line">    <span class="keyword">int</span> error_from_target = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> socket_error = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> del_idx = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!copy) newargv = zmalloc(<span class="keyword">sizeof</span>(robj*)*(num_keys+<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; num_keys; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (syncReadLine(cs-&gt;fd, buf2, <span class="keyword">sizeof</span>(buf2), timeout) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            socket_error = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((password &amp;&amp; buf0[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) ||</span><br><span class="line">            (select &amp;&amp; buf1[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) ||</span><br><span class="line">            buf2[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">        	<span class="comment">//报错处理</span></span><br><span class="line">            <span class="keyword">if</span> (!error_from_target) &#123;</span><br><span class="line">                cs-&gt;last_dbid = <span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">char</span> *errbuf;</span><br><span class="line">                <span class="keyword">if</span> (password &amp;&amp; buf0[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) errbuf = buf0;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (select &amp;&amp; buf1[<span class="number">0</span>] == <span class="string">&#x27;-&#x27;</span>) errbuf = buf1;</span><br><span class="line">                <span class="keyword">else</span> errbuf = buf2;</span><br><span class="line"></span><br><span class="line">                error_from_target = <span class="number">1</span>;</span><br><span class="line">                addReplyErrorFormat(c,<span class="string">&quot;Target instance replied with error: %s&quot;</span>,</span><br><span class="line">                    errbuf+<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        	<span class="comment">//成功处理</span></span><br><span class="line">            <span class="keyword">if</span> (!copy) &#123;</span><br><span class="line">                <span class="comment">//删除本地key</span></span><br><span class="line">                dbDelete(c-&gt;db,kv[j]);</span><br><span class="line">                signalModifiedKey(c-&gt;db,kv[j]);</span><br><span class="line">                server.dirty++;</span><br><span class="line"></span><br><span class="line">                newargv[del_idx++] = kv[j];</span><br><span class="line">                incrRefCount(kv[j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!error_from_target &amp;&amp; socket_error &amp;&amp; j == <span class="number">0</span> &amp;&amp; may_retry &amp;&amp;</span><br><span class="line">        errno != ETIMEDOUT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">goto</span> socket_err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//网络问题，关闭连接</span></span><br><span class="line">    <span class="keyword">if</span> (socket_error) migrateCloseSocket(c-&gt;argv[<span class="number">1</span>],c-&gt;argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!copy) &#123;</span><br><span class="line">        <span class="comment">//为了主从和aof，替换成del命令</span></span><br><span class="line">        <span class="keyword">if</span> (del_idx &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            newargv[<span class="number">0</span>] = createStringObject(<span class="string">&quot;DEL&quot;</span>,<span class="number">3</span>);</span><br><span class="line">            replaceClientCommandVector(c,del_idx,newargv);</span><br><span class="line">            argv_rewritten = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            zfree(newargv);</span><br><span class="line">        &#125;</span><br><span class="line">        newargv = <span class="literal">NULL</span>; <span class="comment">/* Make it safe to call zfree() on it in the future. */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!error_from_target &amp;&amp; socket_error) &#123;</span><br><span class="line">        may_retry = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> socket_err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新最近使用db</span></span><br><span class="line">    <span class="keyword">if</span> (!error_from_target) &#123;</span><br><span class="line">        cs-&gt;last_dbid = dbid;</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sdsfree(cmd.io.buffer.ptr);</span><br><span class="line">    zfree(ov); zfree(kv); zfree(newargv);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//连接错误</span></span><br><span class="line">socket_err:</span><br><span class="line">    </span><br><span class="line">    sdsfree(cmd.io.buffer.ptr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!argv_rewritten) migrateCloseSocket(c-&gt;argv[<span class="number">1</span>],c-&gt;argv[<span class="number">2</span>]);</span><br><span class="line">    zfree(newargv);</span><br><span class="line">    newargv = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (errno != ETIMEDOUT &amp;&amp; may_retry) &#123;</span><br><span class="line">        may_retry = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> try_again;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    zfree(ov); zfree(kv);</span><br><span class="line">    addReplySds(c,</span><br><span class="line">        sdscatprintf(sdsempty(),</span><br><span class="line">            <span class="string">&quot;-IOERR error or timeout %s to target instance\r\n&quot;</span>,</span><br><span class="line">            write_error ? <span class="string">&quot;writing&quot;</span> : <span class="string">&quot;reading&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="askingCommand"><a href="#askingCommand" class="headerlink" title="askingCommand"></a>askingCommand</h5><p>响应ask命令</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">askingCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (server.cluster_enabled == <span class="number">0</span>) &#123;</span><br><span class="line">        addReplyError(c,<span class="string">&quot;This instance has cluster support disabled&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    c-&gt;flags |= CLIENT_ASKING;</span><br><span class="line">    addReply(c,shared.ok);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="readonlyCommand"><a href="#readonlyCommand" class="headerlink" title="readonlyCommand"></a>readonlyCommand</h5><p>响应客户端进入只读模式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readonlyCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (server.cluster_enabled == <span class="number">0</span>) &#123;</span><br><span class="line">        addReplyError(c,<span class="string">&quot;This instance has cluster support disabled&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    c-&gt;flags |= CLIENT_READONLY;</span><br><span class="line">    addReply(c,shared.ok);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="readwriteCommand"><a href="#readwriteCommand" class="headerlink" title="readwriteCommand"></a>readwriteCommand</h5><p>响应客户端进去写模式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readwriteCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    c-&gt;flags &amp;= ~CLIENT_READONLY;</span><br><span class="line">    addReply(c,shared.ok);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="getNodeByQuery"><a href="#getNodeByQuery" class="headerlink" title="getNodeByQuery"></a>getNodeByQuery</h5><p>查询能处理该命令的节点信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">clusterNode *<span class="title">getNodeByQuery</span><span class="params">(client *c, struct redisCommand *cmd, robj **argv, <span class="keyword">int</span> argc, <span class="keyword">int</span> *hashslot, <span class="keyword">int</span> *error_code)</span> </span>&#123;</span><br><span class="line">    clusterNode *n = <span class="literal">NULL</span>;</span><br><span class="line">    robj *firstkey = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> multiple_keys = <span class="number">0</span>;</span><br><span class="line">    multiState *ms, _ms;</span><br><span class="line">    multiCmd mc;</span><br><span class="line">    <span class="keyword">int</span> i, slot = <span class="number">0</span>, migrating_slot = <span class="number">0</span>, importing_slot = <span class="number">0</span>, missing_keys = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//不需要查询</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster_module_flags &amp; CLUSTER_MODULE_FLAG_NO_REDIRECTION)</span><br><span class="line">        <span class="keyword">return</span> myself;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error_code) *error_code = CLUSTER_REDIR_NONE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cmd-&gt;proc == execCommand) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(c-&gt;flags &amp; CLIENT_MULTI)) <span class="keyword">return</span> myself;</span><br><span class="line">        ms = &amp;c-&gt;mstate;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ms = &amp;_ms;</span><br><span class="line">        _ms.commands = &amp;mc;</span><br><span class="line">        _ms.count = <span class="number">1</span>;</span><br><span class="line">        mc.argv = argv;</span><br><span class="line">        mc.argc = argc;</span><br><span class="line">        mc.cmd = cmd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查命令所有key是否都在同一个槽点里</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ms-&gt;count; i++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">redisCommand</span> *<span class="title">mcmd</span>;</span></span><br><span class="line">        robj **margv;</span><br><span class="line">        <span class="keyword">int</span> margc, *keyindex, numkeys, j;</span><br><span class="line"></span><br><span class="line">        mcmd = ms-&gt;commands[i].cmd;</span><br><span class="line">        margc = ms-&gt;commands[i].argc;</span><br><span class="line">        margv = ms-&gt;commands[i].argv;</span><br><span class="line"></span><br><span class="line">        keyindex = getKeysFromCommand(mcmd,margv,margc,&amp;numkeys);</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; numkeys; j++) &#123;</span><br><span class="line">            robj *thiskey = margv[keyindex[j]];</span><br><span class="line">            <span class="keyword">int</span> thisslot = keyHashSlot((<span class="keyword">char</span>*)thiskey-&gt;ptr,</span><br><span class="line">                                       sdslen(thiskey-&gt;ptr));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (firstkey == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                firstkey = thiskey;</span><br><span class="line">                slot = thisslot;</span><br><span class="line">                n = server.cluster-&gt;slots[slot];</span><br><span class="line"></span><br><span class="line">                <span class="comment">//槽点未分配</span></span><br><span class="line">                <span class="keyword">if</span> (n == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    getKeysFreeResult(keyindex);</span><br><span class="line">                    <span class="keyword">if</span> (error_code)</span><br><span class="line">                        *error_code = CLUSTER_REDIR_DOWN_UNBOUND;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//检查处于迁入，迁出中的key</span></span><br><span class="line">                <span class="keyword">if</span> (n == myself &amp;&amp;</span><br><span class="line">                    server.cluster-&gt;migrating_slots_to[slot] != <span class="literal">NULL</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    migrating_slot = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (server.cluster-&gt;importing_slots_from[slot] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    importing_slot = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!equalStringObjects(firstkey,thiskey)) &#123;</span><br><span class="line">                    <span class="comment">//key分布在不同槽点</span></span><br><span class="line">                    <span class="keyword">if</span> (slot != thisslot) &#123;</span><br><span class="line">                        getKeysFreeResult(keyindex);</span><br><span class="line">                        <span class="keyword">if</span> (error_code)</span><br><span class="line">                            *error_code = CLUSTER_REDIR_CROSS_SLOT;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//多key标识</span></span><br><span class="line">                        multiple_keys = <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//key已经不在我们这了</span></span><br><span class="line">            <span class="keyword">if</span> ((migrating_slot || importing_slot) &amp;&amp;</span><br><span class="line">                lookupKeyRead(&amp;server.db[<span class="number">0</span>],thiskey) == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                missing_keys++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        getKeysFreeResult(keyindex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//没有任何key, 自己就能处理</span></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="literal">NULL</span>) <span class="keyword">return</span> myself;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//槽点状态</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster-&gt;state != CLUSTER_OK) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error_code) *error_code = CLUSTER_REDIR_DOWN_STATE;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回响应的槽点</span></span><br><span class="line">    <span class="keyword">if</span> (hashslot) *hashslot = slot;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((migrating_slot || importing_slot) &amp;&amp; cmd-&gt;proc == migrateCommand)</span><br><span class="line">        <span class="keyword">return</span> myself;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//没有全部key的数量</span></span><br><span class="line">    <span class="keyword">if</span> (migrating_slot &amp;&amp; missing_keys) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error_code) *error_code = CLUSTER_REDIR_ASK;</span><br><span class="line">        <span class="keyword">return</span> server.cluster-&gt;migrating_slots_to[slot];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (importing_slot &amp;&amp;</span><br><span class="line">        (c-&gt;flags &amp; CLIENT_ASKING || cmd-&gt;flags &amp; CMD_ASKING))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (multiple_keys &amp;&amp; missing_keys) &#123;</span><br><span class="line">            <span class="keyword">if</span> (error_code) *error_code = CLUSTER_REDIR_UNSTABLE;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> myself;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//只读模式</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;flags &amp; CLIENT_READONLY &amp;&amp;</span><br><span class="line">        (cmd-&gt;flags &amp; CMD_READONLY || cmd-&gt;proc == evalCommand ||</span><br><span class="line">         cmd-&gt;proc == evalShaCommand) &amp;&amp;</span><br><span class="line">        nodeIsSlave(myself) &amp;&amp;</span><br><span class="line">        myself-&gt;slaveof == n)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> myself;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回MOVE命令</span></span><br><span class="line">    <span class="keyword">if</span> (n != myself &amp;&amp; error_code) *error_code = CLUSTER_REDIR_MOVED;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="clusterRedirectBlockedClientIfNeeded"><a href="#clusterRedirectBlockedClientIfNeeded" class="headerlink" title="clusterRedirectBlockedClientIfNeeded"></a>clusterRedirectBlockedClientIfNeeded</h5><p>对于阻塞的操作，检查存在问题，返回对应的错误</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clusterRedirectBlockedClientIfNeeded</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;flags &amp; CLIENT_BLOCKED &amp;&amp;</span><br><span class="line">        (c-&gt;btype == BLOCKED_LIST ||</span><br><span class="line">         c-&gt;btype == BLOCKED_ZSET ||</span><br><span class="line">         c-&gt;btype == BLOCKED_STREAM))</span><br><span class="line">    &#123;</span><br><span class="line">        dictEntry *de;</span><br><span class="line">        dictIterator *di;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//集群状态fail</span></span><br><span class="line">        <span class="keyword">if</span> (server.cluster-&gt;state == CLUSTER_FAIL) &#123;</span><br><span class="line">            clusterRedirectClient(c,<span class="literal">NULL</span>,<span class="number">0</span>,CLUSTER_REDIR_DOWN_STATE);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//同一个槽点检查</span></span><br><span class="line">        di = dictGetIterator(c-&gt;bpop.keys);</span><br><span class="line">        <span class="keyword">if</span> ((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            robj *key = dictGetKey(de);</span><br><span class="line">            <span class="keyword">int</span> slot = keyHashSlot((<span class="keyword">char</span>*)key-&gt;ptr, sdslen(key-&gt;ptr));</span><br><span class="line">            clusterNode *node = server.cluster-&gt;slots[slot];</span><br><span class="line"></span><br><span class="line">            <span class="comment">//该槽点不是我们负责</span></span><br><span class="line">            <span class="keyword">if</span> (node != myself &amp;&amp;</span><br><span class="line">                server.cluster-&gt;importing_slots_from[slot] == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">            	<span class="comment">//槽点分配</span></span><br><span class="line">                <span class="keyword">if</span> (node == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    clusterRedirectClient(c,<span class="literal">NULL</span>,<span class="number">0</span>,</span><br><span class="line">                        CLUSTER_REDIR_DOWN_UNBOUND);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                	<span class="comment">//需要到别的节点查询</span></span><br><span class="line">                    clusterRedirectClient(c,node,slot,</span><br><span class="line">                        CLUSTER_REDIR_MOVED);</span><br><span class="line">                &#125;</span><br><span class="line">                dictReleaseIterator(di);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"d86b0f2f03d666a5b4d5","clientSecret":"b0a4cdac98cafbe6f866ea2b76d0800306bda397","repo":"suntw2015","owner":"suntw2015","admin":["suntw2015"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/redis/" rel="tag"># redis</a>
              <a href="/tags/cluster/" rel="tag"># cluster</a>
              <a href="/tags/%E9%9B%86%E7%BE%A4/" rel="tag"># 集群</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/11/18/redis-sentinel/" rel="prev" title="redis-哨兵">
                  <i class="fa fa-chevron-left"></i> redis-哨兵
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/02/25/redis-6-0-thread/" rel="next" title="redis-6.0-thread">
                  redis-6.0-thread <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">孙天文</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
