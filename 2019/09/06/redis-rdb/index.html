<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"suntw2015.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.3.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="rdb作为redis的另一种数据持久化方式，其用途有两种。1、数据持久化，把数据存放到磁盘上。2、主从数据同步，当第一次同步或者从节点同步的信息不在主节点的缓冲区内时，会生成一个rdb文件，然后同步给从节点用于生成初始数据集。">
<meta property="og:type" content="article">
<meta property="og:title" content="redis-rdb">
<meta property="og:url" content="http://suntw2015.github.io/2019/09/06/redis-rdb/index.html">
<meta property="og:site_name" content="MadeLife">
<meta property="og:description" content="rdb作为redis的另一种数据持久化方式，其用途有两种。1、数据持久化，把数据存放到磁盘上。2、主从数据同步，当第一次同步或者从节点同步的信息不在主节点的缓冲区内时，会生成一个rdb文件，然后同步给从节点用于生成初始数据集。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://suntw2015.github.io/images/redis_rdb_file.png">
<meta property="article:published_time" content="2019-09-06T02:37:21.000Z">
<meta property="article:modified_time" content="2021-04-06T04:02:09.191Z">
<meta property="article:author" content="孙天文">
<meta property="article:tag" content="redis">
<meta property="article:tag" content="持久化">
<meta property="article:tag" content="rdb">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://suntw2015.github.io/images/redis_rdb_file.png">


<link rel="canonical" href="http://suntw2015.github.io/2019/09/06/redis-rdb/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>redis-rdb | MadeLife</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">MadeLife</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E6%9D%A1%E4%BB%B6"><span class="nav-number">1.</span> <span class="nav-text">开启条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RDB%E6%B5%81%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">RDB流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="nav-number">3.</span> <span class="nav-text">文件格式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%9E%84%E6%88%90"><span class="nav-number">3.1.</span> <span class="nav-text">文件构成</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E8%A7%A3%E6%9E%90"><span class="nav-number">3.2.</span> <span class="nav-text">示例解析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbWriteRaw"><span class="nav-number">4.1.</span> <span class="nav-text">rdbWriteRaw</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadRaw"><span class="nav-number">4.2.</span> <span class="nav-text">rdbLoadRaw</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveType"><span class="nav-number">4.3.</span> <span class="nav-text">rdbSaveType</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadType"><span class="nav-number">4.4.</span> <span class="nav-text">rdbLoadType</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadTime"><span class="nav-number">4.5.</span> <span class="nav-text">rdbLoadTime</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveMillisecondTime"><span class="nav-number">4.6.</span> <span class="nav-text">rdbSaveMillisecondTime</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadMillisecondTime"><span class="nav-number">4.7.</span> <span class="nav-text">rdbLoadMillisecondTime</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveLen"><span class="nav-number">4.8.</span> <span class="nav-text">rdbSaveLen</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadLenByRef"><span class="nav-number">4.9.</span> <span class="nav-text">rdbLoadLenByRef</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadLen"><span class="nav-number">4.10.</span> <span class="nav-text">rdbLoadLen</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbEncodeInteger"><span class="nav-number">4.11.</span> <span class="nav-text">rdbEncodeInteger</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadIntegerObject"><span class="nav-number">4.12.</span> <span class="nav-text">rdbLoadIntegerObject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbTryIntegerEncoding"><span class="nav-number">4.13.</span> <span class="nav-text">rdbTryIntegerEncoding</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveLzfBlob"><span class="nav-number">4.14.</span> <span class="nav-text">rdbSaveLzfBlob</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveLzfStringObject"><span class="nav-number">4.15.</span> <span class="nav-text">rdbSaveLzfStringObject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadLzfStringObject"><span class="nav-number">4.16.</span> <span class="nav-text">rdbLoadLzfStringObject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveRawString"><span class="nav-number">4.17.</span> <span class="nav-text">rdbSaveRawString</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveLongLongAsStringObject"><span class="nav-number">4.18.</span> <span class="nav-text">rdbSaveLongLongAsStringObject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveStringObject"><span class="nav-number">4.19.</span> <span class="nav-text">rdbSaveStringObject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbGenericLoadStringObject"><span class="nav-number">4.20.</span> <span class="nav-text">rdbGenericLoadStringObject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadStringObject"><span class="nav-number">4.21.</span> <span class="nav-text">rdbLoadStringObject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadEncodedStringObject"><span class="nav-number">4.22.</span> <span class="nav-text">rdbLoadEncodedStringObject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveDoubleValue"><span class="nav-number">4.23.</span> <span class="nav-text">rdbSaveDoubleValue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadDoubleValue"><span class="nav-number">4.24.</span> <span class="nav-text">rdbLoadDoubleValue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveBinaryDoubleValue"><span class="nav-number">4.25.</span> <span class="nav-text">rdbSaveBinaryDoubleValue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadBinaryDoubleValue"><span class="nav-number">4.26.</span> <span class="nav-text">rdbLoadBinaryDoubleValue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveBinaryFloatValue"><span class="nav-number">4.27.</span> <span class="nav-text">rdbSaveBinaryFloatValue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadBinaryFloatValue"><span class="nav-number">4.28.</span> <span class="nav-text">rdbLoadBinaryFloatValue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveObjectType"><span class="nav-number">4.29.</span> <span class="nav-text">rdbSaveObjectType</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadObjectType"><span class="nav-number">4.30.</span> <span class="nav-text">rdbLoadObjectType</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveStreamPEL"><span class="nav-number">4.31.</span> <span class="nav-text">rdbSaveStreamPEL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveStreamConsumers"><span class="nav-number">4.32.</span> <span class="nav-text">rdbSaveStreamConsumers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveObject"><span class="nav-number">4.33.</span> <span class="nav-text">rdbSaveObject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSavedObjectLen"><span class="nav-number">4.34.</span> <span class="nav-text">rdbSavedObjectLen</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveKeyValuePair"><span class="nav-number">4.35.</span> <span class="nav-text">rdbSaveKeyValuePair</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveAuxField"><span class="nav-number">4.36.</span> <span class="nav-text">rdbSaveAuxField</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveAuxFieldStrStr"><span class="nav-number">4.37.</span> <span class="nav-text">rdbSaveAuxFieldStrStr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveAuxFieldStrInt"><span class="nav-number">4.38.</span> <span class="nav-text">rdbSaveAuxFieldStrInt</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveInfoAuxFields"><span class="nav-number">4.39.</span> <span class="nav-text">rdbSaveInfoAuxFields</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveRio"><span class="nav-number">4.40.</span> <span class="nav-text">rdbSaveRio</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveRioWithEOFMark"><span class="nav-number">4.41.</span> <span class="nav-text">rdbSaveRioWithEOFMark</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSave"><span class="nav-number">4.42.</span> <span class="nav-text">rdbSave</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveBackground"><span class="nav-number">4.43.</span> <span class="nav-text">rdbSaveBackground</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbRemoveTempFile"><span class="nav-number">4.44.</span> <span class="nav-text">rdbRemoveTempFile</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadCheckModuleValue"><span class="nav-number">4.45.</span> <span class="nav-text">rdbLoadCheckModuleValue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadObject"><span class="nav-number">4.46.</span> <span class="nav-text">rdbLoadObject</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#startLoading"><span class="nav-number">4.47.</span> <span class="nav-text">startLoading</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#loadingProgress"><span class="nav-number">4.48.</span> <span class="nav-text">loadingProgress</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#stopLoading"><span class="nav-number">4.49.</span> <span class="nav-text">stopLoading</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadProgressCallback"><span class="nav-number">4.50.</span> <span class="nav-text">rdbLoadProgressCallback</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoadRio"><span class="nav-number">4.51.</span> <span class="nav-text">rdbLoadRio</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbLoad"><span class="nav-number">4.52.</span> <span class="nav-text">rdbLoad</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#backgroundSaveDoneHandlerDisk"><span class="nav-number">4.53.</span> <span class="nav-text">backgroundSaveDoneHandlerDisk</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#backgroundSaveDoneHandlerSocket"><span class="nav-number">4.54.</span> <span class="nav-text">backgroundSaveDoneHandlerSocket</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#backgroundSaveDoneHandler"><span class="nav-number">4.55.</span> <span class="nav-text">backgroundSaveDoneHandler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbSaveToSlavesSockets"><span class="nav-number">4.56.</span> <span class="nav-text">rdbSaveToSlavesSockets</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#saveCommand"><span class="nav-number">4.57.</span> <span class="nav-text">saveCommand</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bgsaveCommand"><span class="nav-number">4.58.</span> <span class="nav-text">bgsaveCommand</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rdbPopulateSaveInfo"><span class="nav-number">4.59.</span> <span class="nav-text">rdbPopulateSaveInfo</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">孙天文</p>
  <div class="site-description" itemprop="description">记录一些随笔</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/suntw2015" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;suntw2015" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://suntw2015.github.io/2019/09/06/redis-rdb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="孙天文">
      <meta itemprop="description" content="记录一些随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MadeLife">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          redis-rdb
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-09-06 10:37:21" itemprop="dateCreated datePublished" datetime="2019-09-06T10:37:21+08:00">2019-09-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-04-06 12:02:09" itemprop="dateModified" datetime="2021-04-06T12:02:09+08:00">2021-04-06</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>rdb作为redis的另一种数据持久化方式，其用途有两种。1、数据持久化，把数据存放到磁盘上。2、主从数据同步，当第一次同步或者从节点同步的信息不在主节点的缓冲区内时，会生成一个rdb文件，然后同步给从节点用于生成初始数据集。</p>
<span id="more"></span>

<h3 id="开启条件"><a href="#开启条件" class="headerlink" title="开启条件"></a>开启条件</h3><p>rdb的开启，分为主动和被动两种。</p>
<blockquote>
<p>主动</p>
</blockquote>
<p>redis 有一个配置项<code>save seconds changes</code>，表示数据库在seconds后，有changes个key改变了。redis默认有三个配置：1小时改变1次、5分钟改变100次、1分钟改变10000次，此配置可以在redis的配置文件中更改，也可以在运行期间使用<code>config save seconds changes</code>进行修改，<code>config save “”</code> 表示把配置项内容清空。在serverCron中，会去计算距离上一次数据保存过了多久以及数据库有多少个key改变了。然后和save的配置项依次比较，如果满足时间大于等于seconds、改变次数大于等于changes、上一次rdb成功或时间大于失败重试时间(默认5秒)，则进行rdb数据备份。</p>
<blockquote>
<p>被动</p>
</blockquote>
<p>开启rdb也可以通过客户端发送命令<code>save</code>、<code>bgsave</code>来手动开启，<code>save</code>没有创建子进程，而是在主进程进行rdb备份，因此会阻塞其他客户端的请求一直到rdb备份完成，所以需要慎用。<code>bgsave</code>则是正常的创建一个子进程，子进程去负责rdb数据备份。该命令有一个<code>schedule</code>参数，有无该参数影响点是在命令执行时，当有<code>aof</code>或者<code>rdb</code>正在进行的情况。没有该参数的话，会返回错误表明已经有一个子进程在备份数据了；有该参数的话，则会在下一次serverCron时判断是否曼满足没有aof在进行、没有rdb在进行、上一次rdb成功或时间大于失败重试时间(默认5秒)，满足的话进行rdb数据备份。</p>
<p>还有一种情况是在主从数据同步的时候，在一开始亦或者从节点要求同步的数据在主节点的同步数据缓存中找不到，主节点会执行rdb备份，把该文件发送给从节点用于构建数据集。</p>
<h3 id="RDB流程"><a href="#RDB流程" class="headerlink" title="RDB流程"></a>RDB流程</h3><p>主动的数据备份过程可以分为以下几步</p>
<ul>
<li>父进程fock子进程</li>
<li>父进程记录开始时间、子进程id</li>
<li>子进程关闭sockets监听</li>
<li>子进程创建临时文件并进行db数据备份</li>
<li>重命名临时文件为正式文件</li>
</ul>
<h3 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h3><p>rdb为了让最后生成的文件尽可能的小，rdb定义了一系列的操作和数据格式，对于常用的几类数据类型，存储方式如下：</p>
<blockquote>
<p>浮点型：浮点型数据有两种存储形式，一种是转换成字符串写入，一种按照二进制存储</p>
</blockquote>
<blockquote>
<p>字符串：分为压缩和不压缩两种，通用形式都是先存储字符串长度，然后存储内容</p>
</blockquote>
<blockquote>
<p>整形：采用特殊编码规则，根据一个字节的前两位，代表的含义如下</p>
</blockquote>
<p>00|XXXXXX 剩余的6位表示数据长度<br>01|XXXXXX XXXXXXXX 剩余的6位+下个字节的8位共14位表示数据长度<br>10|000000 下个字节开始的32位表示数据长度<br>10|000001 下个字节开始的64位表示数据长度大小<br>11|XXXXXX 特殊编码，具体是那种编码，取决于剩余6位的值，根据值不同分为以下几种：</p>
<p>0：8位整形<br>1：16位整形<br>2：32位整形<br>3：压缩的字符串</p>
<h4 id="文件构成"><a href="#文件构成" class="headerlink" title="文件构成"></a>文件构成</h4><ul>
<li>以REDIS+4位RDB_VERSION开始，然后依次写入</li>
<li>辅助信息，包括<code>redis-ver</code>、<code>redis-bits</code>、<code>ctime</code>、<code>used-mem</code>、<code>aof-preamble</code>字段，如果是在主从同步的场景的话，会额外包含<code>repl-stream-db</code>、<code>repl-id</code>、<code>repl-offset</code>字段。</li>
<li><code>选择DB</code>操作</li>
<li>DB索引</li>
<li>设置DB大小操作</li>
<li>DB存储hash大小</li>
<li>DB过期hash大小</li>
<li>遍历该DB下所有存储节点，依次写入</li>
<li>过期时间操作&amp;过期时间(如果设置过期)</li>
<li>lru操作&amp;信息(如果redis达到最大内存时的淘汰策略为lru)</li>
<li>lfu操作&amp;信息(如果redis达到最大内存时的淘汰策略为lfu)</li>
<li>value对象类型</li>
<li>Key对象(都是string)</li>
<li>value对象</li>
<li>lua脚本信息</li>
<li>结束操作</li>
<li>8个字节的数据校验</li>
</ul>
<h4 id="示例解析"><a href="#示例解析" class="headerlink" title="示例解析"></a>示例解析</h4><p>接下来，以一个简单的rdb文件为例，执行rdb时，redis只有一个(key,value)为(a,100)<br><img src="/images/redis_rdb_file.png"></p>
<ul>
<li>前9个字节，是正常的REDIS+RDB_VERSION，通过后4位可以看出RDB_VERSION版本是9</li>
<li>第10个字节是<code>FA</code>，表示写入辅助信息</li>
<li>第11个字节是<code>09</code>，表示接下来是9个字节的字符串，为辅助信息的key</li>
<li>第12-20个字节是<code>redis-ver</code>，确定key</li>
<li>第21个字节是<code>05</code>，表示接下来是5个字节的字符串，为辅助信息的value</li>
<li>第22-26个字节是<code>5.0.3</code>，确定value</li>
<li>第27个字节是<code>FA</code>，表示写入辅助信息</li>
<li>第28个字节是<code>0A</code>，表示接下来是10个字节的字符串，为辅助信息的value</li>
<li>第29-38个字节是<code>redis-bits</code>，确定key</li>
<li>第39个字节是<code>C0</code>，二进制表示为<code>11000000</code>，<code>11</code>表示为特殊编码类型，后四位<code>0000</code>表示8位无符号整形，综合起来，下一个字节是无符号整形</li>
<li>第40个字节是<code>40</code>，10进制表示为64，确定value，结合key意思为<code>redis-bits</code>是64位</li>
<li>后面一直到第83个字节，都是如此，依次表示辅助信息<code>ctime</code>、<code>used-mem</code>，<code>aof-preamble</code></li>
<li>第68字节是<code>FE</code>，表示选择DB操作</li>
<li>第69字节是<code>00</code>，表示DB索引是0</li>
<li>第70个字节是<code>FB</code>，表示设置DB大小操作</li>
<li>第71、72字节是<code>01</code>和<code>00</code>，分别表示DB存储hash大小为1和过期hash大小为0</li>
<li>第73个字节是<code>00</code>表示value类型是string</li>
<li>第74个字节是<code>01</code>，表示key的长度</li>
<li>第75个字节是<code>61</code>，确定key的值为a</li>
<li>第76个字节是<code>C0</code>，表示8位无符号整形特殊编码</li>
<li>第77个字节是<code>64</code>，确定值为100</li>
<li>第78个字节是<code>FF</code>，表示RDB结束</li>
<li>最后79-86共8个字节，是数据校验的结果</li>
</ul>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><h4 id="rdbWriteRaw"><a href="#rdbWriteRaw" class="headerlink" title="rdbWriteRaw"></a>rdbWriteRaw</h4><p>往rdb中写入原生数据，各种类型的写入都是先进行转换，最后调用该方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rdbWriteRaw</span><span class="params">(rio *rdb, <span class="keyword">void</span> *p, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rdb &amp;&amp; rioWrite(rdb,p,len) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadRaw"><a href="#rdbLoadRaw" class="headerlink" title="rdbLoadRaw"></a>rdbLoadRaw</h4><p>从rdb中读取原生数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rdbLoadRaw</span><span class="params">(rio *rdb, <span class="keyword">void</span> *buf, <span class="keyword">uint64_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rioRead(rdb,buf,len) == <span class="number">0</span>) &#123;</span><br><span class="line">        rdbExitReportCorruptRDB(</span><br><span class="line">            <span class="string">&quot;Impossible to read %llu bytes in rdbLoadRaw()&quot;</span>,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) len);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveType"><a href="#rdbSaveType" class="headerlink" title="rdbSaveType"></a>rdbSaveType</h4><p>保存RDB定义的操作类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveType</span><span class="params">(rio *rdb, <span class="keyword">unsigned</span> <span class="keyword">char</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rdbWriteRaw(rdb,&amp;type,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadType"><a href="#rdbLoadType" class="headerlink" title="rdbLoadType"></a>rdbLoadType</h4><p>读取RDB操作类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbLoadType</span><span class="params">(rio *rdb)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> type;</span><br><span class="line">    <span class="keyword">if</span> (rioRead(rdb,&amp;type,<span class="number">1</span>) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadTime"><a href="#rdbLoadTime" class="headerlink" title="rdbLoadTime"></a>rdbLoadTime</h4><p>读取时间，适用于老版本使用<code>RDB_OPCODE_EXPIRETIME</code>标识过期时间，因此只有读方法，不再提供写方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">time_t</span> <span class="title">rdbLoadTime</span><span class="params">(rio *rdb)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int32_t</span> t32;</span><br><span class="line">    rdbLoadRaw(rdb,&amp;t32,<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">time_t</span>)t32;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveMillisecondTime"><a href="#rdbSaveMillisecondTime" class="headerlink" title="rdbSaveMillisecondTime"></a>rdbSaveMillisecondTime</h4><p>保存毫秒时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveMillisecondTime</span><span class="params">(rio *rdb, <span class="keyword">long</span> <span class="keyword">long</span> t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int64_t</span> t64 = (<span class="keyword">int64_t</span>) t;</span><br><span class="line">    memrev64ifbe(&amp;t64); <span class="comment">//小端存储</span></span><br><span class="line">    <span class="keyword">return</span> rdbWriteRaw(rdb,&amp;t64,<span class="number">8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadMillisecondTime"><a href="#rdbLoadMillisecondTime" class="headerlink" title="rdbLoadMillisecondTime"></a>rdbLoadMillisecondTime</h4><p>读取毫秒时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">rdbLoadMillisecondTime</span><span class="params">(rio *rdb, <span class="keyword">int</span> rdbver)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int64_t</span> t64;</span><br><span class="line">    rdbLoadRaw(rdb,&amp;t64,<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (rdbver &gt;= <span class="number">9</span>) <span class="comment">/* Check the top comment of this function. */</span></span><br><span class="line">        memrev64ifbe(&amp;t64); <span class="comment">/* Convert in big endian if the system is BE. */</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">long</span> <span class="keyword">long</span>)t64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveLen"><a href="#rdbSaveLen" class="headerlink" title="rdbSaveLen"></a>rdbSaveLen</h4><p>保存长度值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveLen</span><span class="params">(rio *rdb, <span class="keyword">uint64_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">size_t</span> nwritten;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len &lt; (<span class="number">1</span>&lt;&lt;<span class="number">6</span>)) &#123;</span><br><span class="line">        <span class="comment">/* Save a 6 bit len */</span></span><br><span class="line">        buf[<span class="number">0</span>] = (len&amp;<span class="number">0xFF</span>)|(RDB_6BITLEN&lt;&lt;<span class="number">6</span>);</span><br><span class="line">        <span class="keyword">if</span> (rdbWriteRaw(rdb,buf,<span class="number">1</span>) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &lt; (<span class="number">1</span>&lt;&lt;<span class="number">14</span>)) &#123;</span><br><span class="line">        <span class="comment">/* Save a 14 bit len */</span></span><br><span class="line">        buf[<span class="number">0</span>] = ((len&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xFF</span>)|(RDB_14BITLEN&lt;&lt;<span class="number">6</span>);</span><br><span class="line">        buf[<span class="number">1</span>] = len&amp;<span class="number">0xFF</span>;</span><br><span class="line">        <span class="keyword">if</span> (rdbWriteRaw(rdb,buf,<span class="number">2</span>) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten = <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &lt;= UINT32_MAX) &#123;</span><br><span class="line">        <span class="comment">/* Save a 32 bit len */</span></span><br><span class="line">        buf[<span class="number">0</span>] = RDB_32BITLEN;</span><br><span class="line">        <span class="keyword">if</span> (rdbWriteRaw(rdb,buf,<span class="number">1</span>) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">uint32_t</span> len32 = htonl(len);</span><br><span class="line">        <span class="keyword">if</span> (rdbWriteRaw(rdb,&amp;len32,<span class="number">4</span>) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten = <span class="number">1</span>+<span class="number">4</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* Save a 64 bit len */</span></span><br><span class="line">        buf[<span class="number">0</span>] = RDB_64BITLEN;</span><br><span class="line">        <span class="keyword">if</span> (rdbWriteRaw(rdb,buf,<span class="number">1</span>) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        len = htonu64(len);</span><br><span class="line">        <span class="keyword">if</span> (rdbWriteRaw(rdb,&amp;len,<span class="number">8</span>) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten = <span class="number">1</span>+<span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nwritten;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadLenByRef"><a href="#rdbLoadLenByRef" class="headerlink" title="rdbLoadLenByRef"></a>rdbLoadLenByRef</h4><p>读取数据长度，<code>isencoded</code>存储是否是额外编码，<code>lenptr</code>表示数据长度或者额外编码的类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbLoadLenByRef</span><span class="params">(rio *rdb, <span class="keyword">int</span> *isencoded, <span class="keyword">uint64_t</span> *lenptr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isencoded) *isencoded = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (rioRead(rdb,buf,<span class="number">1</span>) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    type = (buf[<span class="number">0</span>]&amp;<span class="number">0xC0</span>)&gt;&gt;<span class="number">6</span>;</span><br><span class="line">    <span class="keyword">if</span> (type == RDB_ENCVAL) &#123;</span><br><span class="line">        <span class="comment">/* Read a 6 bit encoding type. */</span></span><br><span class="line">        <span class="keyword">if</span> (isencoded) *isencoded = <span class="number">1</span>;</span><br><span class="line">        *lenptr = buf[<span class="number">0</span>]&amp;<span class="number">0x3F</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == RDB_6BITLEN) &#123;</span><br><span class="line">        <span class="comment">/* Read a 6 bit len. */</span></span><br><span class="line">        *lenptr = buf[<span class="number">0</span>]&amp;<span class="number">0x3F</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == RDB_14BITLEN) &#123;</span><br><span class="line">        <span class="comment">/* Read a 14 bit len. */</span></span><br><span class="line">        <span class="keyword">if</span> (rioRead(rdb,buf+<span class="number">1</span>,<span class="number">1</span>) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        *lenptr = ((buf[<span class="number">0</span>]&amp;<span class="number">0x3F</span>)&lt;&lt;<span class="number">8</span>)|buf[<span class="number">1</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (buf[<span class="number">0</span>] == RDB_32BITLEN) &#123;</span><br><span class="line">        <span class="comment">/* Read a 32 bit len. */</span></span><br><span class="line">        <span class="keyword">uint32_t</span> len;</span><br><span class="line">        <span class="keyword">if</span> (rioRead(rdb,&amp;len,<span class="number">4</span>) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        *lenptr = ntohl(len);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (buf[<span class="number">0</span>] == RDB_64BITLEN) &#123;</span><br><span class="line">        <span class="comment">/* Read a 64 bit len. */</span></span><br><span class="line">        <span class="keyword">uint64_t</span> len;</span><br><span class="line">        <span class="keyword">if</span> (rioRead(rdb,&amp;len,<span class="number">8</span>) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        *lenptr = ntohu64(len);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        rdbExitReportCorruptRDB(</span><br><span class="line">            <span class="string">&quot;Unknown length encoding %d in rdbLoadLen()&quot;</span>,type);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">/* Never reached. */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadLen"><a href="#rdbLoadLen" class="headerlink" title="rdbLoadLen"></a>rdbLoadLen</h4><p>读取数据长度</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">rdbLoadLen</span><span class="params">(rio *rdb, <span class="keyword">int</span> *isencoded)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rdbLoadLenByRef(rdb,isencoded,&amp;len) == <span class="number">-1</span>) <span class="keyword">return</span> RDB_LENERR;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbEncodeInteger"><a href="#rdbEncodeInteger" class="headerlink" title="rdbEncodeInteger"></a>rdbEncodeInteger</h4><p>对整形数字进行编码处理，根据值大小，结果存储在<code>enc</code>中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbEncodeInteger</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> value, <span class="keyword">unsigned</span> <span class="keyword">char</span> *enc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= -(<span class="number">1</span>&lt;&lt;<span class="number">7</span>) &amp;&amp; value &lt;= (<span class="number">1</span>&lt;&lt;<span class="number">7</span>)<span class="number">-1</span>) &#123;</span><br><span class="line">        enc[<span class="number">0</span>] = (RDB_ENCVAL&lt;&lt;<span class="number">6</span>)|RDB_ENC_INT8;</span><br><span class="line">        enc[<span class="number">1</span>] = value&amp;<span class="number">0xFF</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value &gt;= -(<span class="number">1</span>&lt;&lt;<span class="number">15</span>) &amp;&amp; value &lt;= (<span class="number">1</span>&lt;&lt;<span class="number">15</span>)<span class="number">-1</span>) &#123;</span><br><span class="line">        enc[<span class="number">0</span>] = (RDB_ENCVAL&lt;&lt;<span class="number">6</span>)|RDB_ENC_INT16;</span><br><span class="line">        enc[<span class="number">1</span>] = value&amp;<span class="number">0xFF</span>;</span><br><span class="line">        enc[<span class="number">2</span>] = (value&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xFF</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value &gt;= -((<span class="keyword">long</span> <span class="keyword">long</span>)<span class="number">1</span>&lt;&lt;<span class="number">31</span>) &amp;&amp; value &lt;= ((<span class="keyword">long</span> <span class="keyword">long</span>)<span class="number">1</span>&lt;&lt;<span class="number">31</span>)<span class="number">-1</span>) &#123;</span><br><span class="line">        enc[<span class="number">0</span>] = (RDB_ENCVAL&lt;&lt;<span class="number">6</span>)|RDB_ENC_INT32;</span><br><span class="line">        enc[<span class="number">1</span>] = value&amp;<span class="number">0xFF</span>;</span><br><span class="line">        enc[<span class="number">2</span>] = (value&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xFF</span>;</span><br><span class="line">        enc[<span class="number">3</span>] = (value&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xFF</span>;</span><br><span class="line">        enc[<span class="number">4</span>] = (value&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xFF</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadIntegerObject"><a href="#rdbLoadIntegerObject" class="headerlink" title="rdbLoadIntegerObject"></a>rdbLoadIntegerObject</h4><p>从rdb文件中读取一个整形对象，<code>enctype</code>表示按照哪种编码读，根据<code>flag</code>的标志位决定返回类型，具体返回情况参照<code>rdbGenericLoadStringObject</code>说明</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">rdbLoadIntegerObject</span><span class="params">(rio *rdb, <span class="keyword">int</span> enctype, <span class="keyword">int</span> flags, <span class="keyword">size_t</span> *lenptr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> plain = flags &amp; RDB_LOAD_PLAIN;</span><br><span class="line">    <span class="keyword">int</span> sds = flags &amp; RDB_LOAD_SDS;</span><br><span class="line">    <span class="keyword">int</span> encode = flags &amp; RDB_LOAD_ENC;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> enc[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> val;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enctype == RDB_ENC_INT8) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rioRead(rdb,enc,<span class="number">1</span>) == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        val = (<span class="keyword">signed</span> <span class="keyword">char</span>)enc[<span class="number">0</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enctype == RDB_ENC_INT16) &#123;</span><br><span class="line">        <span class="keyword">uint16_t</span> v;</span><br><span class="line">        <span class="keyword">if</span> (rioRead(rdb,enc,<span class="number">2</span>) == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        v = enc[<span class="number">0</span>]|(enc[<span class="number">1</span>]&lt;&lt;<span class="number">8</span>);</span><br><span class="line">        val = (<span class="keyword">int16_t</span>)v;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enctype == RDB_ENC_INT32) &#123;</span><br><span class="line">        <span class="keyword">uint32_t</span> v;</span><br><span class="line">        <span class="keyword">if</span> (rioRead(rdb,enc,<span class="number">4</span>) == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        v = enc[<span class="number">0</span>]|(enc[<span class="number">1</span>]&lt;&lt;<span class="number">8</span>)|(enc[<span class="number">2</span>]&lt;&lt;<span class="number">16</span>)|(enc[<span class="number">3</span>]&lt;&lt;<span class="number">24</span>);</span><br><span class="line">        val = (<span class="keyword">int32_t</span>)v;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        val = <span class="number">0</span>; <span class="comment">/* anti-warning */</span></span><br><span class="line">        rdbExitReportCorruptRDB(<span class="string">&quot;Unknown RDB integer encoding type %d&quot;</span>,enctype);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (plain || sds) &#123;</span><br><span class="line">        <span class="keyword">char</span> buf[LONG_STR_SIZE], *p;</span><br><span class="line">        <span class="keyword">int</span> len = ll2string(buf,<span class="keyword">sizeof</span>(buf),val);</span><br><span class="line">        <span class="keyword">if</span> (lenptr) *lenptr = len;</span><br><span class="line">        p = plain ? zmalloc(len) : sdsnewlen(SDS_NOINIT,len);</span><br><span class="line">        <span class="built_in">memcpy</span>(p,buf,len);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (encode) &#123;</span><br><span class="line">        <span class="keyword">return</span> createStringObjectFromLongLongForValue(val);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createObject(OBJ_STRING,sdsfromlonglong(val));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbTryIntegerEncoding"><a href="#rdbTryIntegerEncoding" class="headerlink" title="rdbTryIntegerEncoding"></a>rdbTryIntegerEncoding</h4><p>尝试将字符串转换成integer类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbTryIntegerEncoding</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">size_t</span> len, <span class="keyword">unsigned</span> <span class="keyword">char</span> *enc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> value;</span><br><span class="line">    <span class="keyword">char</span> *endptr, buf[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试调用系统方法转换，当整个字符串都有效时，&amp;endptr为&#x27;\0&#x27;，通常&amp;endptr存储的是第一个无效字符的地址</span></span><br><span class="line">    value = strtoll(s, &amp;endptr, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (endptr[<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ll2string(buf,<span class="number">32</span>,value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将转换完之后的整形再转换成字符串和原始数据比对，如果不一致的话，也是失败</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(buf) != len || <span class="built_in">memcmp</span>(buf,s,len)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转换整形，结果存放在enc中</span></span><br><span class="line">    <span class="keyword">return</span> rdbEncodeInteger(value,enc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveLzfBlob"><a href="#rdbSaveLzfBlob" class="headerlink" title="rdbSaveLzfBlob"></a>rdbSaveLzfBlob</h4><p>保存lzf压缩过的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">rdbSaveLzfBlob</span><span class="params">(rio *rdb, <span class="keyword">void</span> *data, <span class="keyword">size_t</span> compress_len,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">size_t</span> original_len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> byte;</span><br><span class="line">    <span class="keyword">ssize_t</span> n, nwritten = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存编码类型</span></span><br><span class="line">    byte = (RDB_ENCVAL&lt;&lt;<span class="number">6</span>)|RDB_ENC_LZF;</span><br><span class="line">    <span class="keyword">if</span> ((n = rdbWriteRaw(rdb,&amp;byte,<span class="number">1</span>)) == <span class="number">-1</span>) <span class="keyword">goto</span> writeerr;</span><br><span class="line">    nwritten += n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 依次写入压缩后长度、原始长度、数据</span></span><br><span class="line">    <span class="keyword">if</span> ((n = rdbSaveLen(rdb,compress_len)) == <span class="number">-1</span>) <span class="keyword">goto</span> writeerr;</span><br><span class="line">    nwritten += n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((n = rdbSaveLen(rdb,original_len)) == <span class="number">-1</span>) <span class="keyword">goto</span> writeerr;</span><br><span class="line">    nwritten += n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((n = rdbWriteRaw(rdb,data,compress_len)) == <span class="number">-1</span>) <span class="keyword">goto</span> writeerr;</span><br><span class="line">    nwritten += n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nwritten;</span><br><span class="line"></span><br><span class="line">writeerr:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveLzfStringObject"><a href="#rdbSaveLzfStringObject" class="headerlink" title="rdbSaveLzfStringObject"></a>rdbSaveLzfStringObject</h4><p>保存lzf字符串对象，要求字符串长度不低于5，否则没有压缩的必要</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">rdbSaveLzfStringObject</span><span class="params">(rio *rdb, <span class="keyword">unsigned</span> <span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> comprlen, outlen;</span><br><span class="line">    <span class="keyword">void</span> *out;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 要求至少4个字节</span></span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">4</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    outlen = len<span class="number">-4</span>;</span><br><span class="line">    <span class="keyword">if</span> ((out = zmalloc(outlen+<span class="number">1</span>)) == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 压缩数据</span></span><br><span class="line">    comprlen = lzf_compress(s, len, out, outlen);</span><br><span class="line">    <span class="keyword">if</span> (comprlen == <span class="number">0</span>) &#123;</span><br><span class="line">        zfree(out);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入数据</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nwritten = rdbSaveLzfBlob(rdb, out, comprlen, len);</span><br><span class="line">    zfree(out);</span><br><span class="line">    <span class="keyword">return</span> nwritten;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadLzfStringObject"><a href="#rdbLoadLzfStringObject" class="headerlink" title="rdbLoadLzfStringObject"></a>rdbLoadLzfStringObject</h4><p>从rdb文件中读取lzf字符串对象，返回对象类型取决于flags标志位，参照<code>rdbGenericLoadStringObject</code>说明。此方法是建立在已经确认当前数据是lzf编码的基础上</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">rdbLoadLzfStringObject</span><span class="params">(rio *rdb, <span class="keyword">int</span> flags, <span class="keyword">size_t</span> *lenptr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> plain = flags &amp; RDB_LOAD_PLAIN;</span><br><span class="line">    <span class="keyword">int</span> sds = flags &amp; RDB_LOAD_SDS;</span><br><span class="line">    <span class="keyword">uint64_t</span> len, clen;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *c = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> *val = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 已经确认数据是lzf编码，因此直接读取压缩后长度、原始长度、压缩数据</span></span><br><span class="line">    <span class="keyword">if</span> ((clen = rdbLoadLen(rdb,<span class="literal">NULL</span>)) == RDB_LENERR) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((len = rdbLoadLen(rdb,<span class="literal">NULL</span>)) == RDB_LENERR) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> ((c = zmalloc(clen)) == <span class="literal">NULL</span>) <span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate our target according to the uncompressed size. */</span></span><br><span class="line">    <span class="keyword">if</span> (plain) &#123;</span><br><span class="line">        val = zmalloc(len);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        val = sdsnewlen(SDS_NOINIT,len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (lenptr) *lenptr = len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取数据&amp;解压</span></span><br><span class="line">    <span class="keyword">if</span> (rioRead(rdb,c,clen) == <span class="number">0</span>) <span class="keyword">goto</span> err;</span><br><span class="line">    <span class="keyword">if</span> (lzf_decompress(c,clen,val,len) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rdbCheckMode) rdbCheckSetError(<span class="string">&quot;Invalid LZF compressed string&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    zfree(c);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (plain || sds) &#123;</span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createObject(OBJ_STRING,val);</span><br><span class="line">    &#125;</span><br><span class="line">err:</span><br><span class="line">    zfree(c);</span><br><span class="line">    <span class="keyword">if</span> (plain)</span><br><span class="line">        zfree(val);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        sdsfree(val);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveRawString"><a href="#rdbSaveRawString" class="headerlink" title="rdbSaveRawString"></a>rdbSaveRawString</h4><p>保存字符串内容，会先尝试把字符串转换成整形以节省空间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">rdbSaveRawString</span><span class="params">(rio *rdb, <span class="keyword">unsigned</span> <span class="keyword">char</span> *s, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> enclen;</span><br><span class="line">    <span class="keyword">ssize_t</span> n, nwritten = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试转换整形</span></span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">11</span>) &#123;</span><br><span class="line">    	<span class="comment">// 转换成整形的话，最多是5个字节(1字节表示编码类型32长度，4个字节存储内容)</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">5</span>];</span><br><span class="line">        <span class="keyword">if</span> ((enclen = rdbTryIntegerEncoding((<span class="keyword">char</span>*)s,len,buf)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rdbWriteRaw(rdb,buf,enclen) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">return</span> enclen;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试压缩数据，数据长度低于20的话，跳过</span></span><br><span class="line">    <span class="keyword">if</span> (server.rdb_compression &amp;&amp; len &gt; <span class="number">20</span>) &#123;</span><br><span class="line">        n = rdbSaveLzfStringObject(rdb,s,len);</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (n &gt; <span class="number">0</span>) <span class="keyword">return</span> n;</span><br><span class="line">        <span class="comment">// n等于0时，表示无法压缩，使用原始方法存储</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 原始方法，保存长度&amp;原始内容</span></span><br><span class="line">    <span class="keyword">if</span> ((n = rdbSaveLen(rdb,len)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    nwritten += n;</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rdbWriteRaw(rdb,s,len) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten += len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nwritten;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveLongLongAsStringObject"><a href="#rdbSaveLongLongAsStringObject" class="headerlink" title="rdbSaveLongLongAsStringObject"></a>rdbSaveLongLongAsStringObject</h4><p>保存长整形数据，会先尝试能否按照整形存储，否则转换成字符串存储</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">rdbSaveLongLongAsStringObject</span><span class="params">(rio *rdb, <span class="keyword">long</span> <span class="keyword">long</span> value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">ssize_t</span> n, nwritten = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> enclen = rdbEncodeInteger(value,buf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以转成整形，按照整形存储</span></span><br><span class="line">    <span class="keyword">if</span> (enclen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> rdbWriteRaw(rdb,buf,enclen);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 超出整形范围，转成成字符串存储</span></span><br><span class="line">        enclen = ll2string((<span class="keyword">char</span>*)buf,<span class="number">32</span>,value);</span><br><span class="line">        serverAssert(enclen &lt; <span class="number">32</span>);</span><br><span class="line">        <span class="keyword">if</span> ((n = rdbSaveLen(rdb,enclen)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten += n;</span><br><span class="line">        <span class="keyword">if</span> ((n = rdbWriteRaw(rdb,buf,enclen)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten += n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nwritten;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveStringObject"><a href="#rdbSaveStringObject" class="headerlink" title="rdbSaveStringObject"></a>rdbSaveStringObject</h4><p>保存redis字符串对象，根据字符串编码类型不同，处理也有所不同。如果是数值型编码，按照<code>整形</code>,<code>转换成字符串原始数据</code>的顺序尝试存储，其余类型则按照<code>整形</code>，<code>压缩</code>，<code>原始数据</code>的顺序存储，二者之间的差距就是数值型编码不会尝试压缩处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">rdbSaveStringObject</span><span class="params">(rio *rdb, robj *obj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* Avoid to decode the object, then encode it again, if the</span></span><br><span class="line"><span class="comment">     * object is already integer encoded. */</span></span><br><span class="line">    <span class="keyword">if</span> (obj-&gt;encoding == OBJ_ENCODING_INT) &#123;</span><br><span class="line">        <span class="keyword">return</span> rdbSaveLongLongAsStringObject(rdb,(<span class="keyword">long</span>)obj-&gt;ptr);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        serverAssertWithInfo(<span class="literal">NULL</span>,obj,sdsEncodedObject(obj));</span><br><span class="line">        <span class="keyword">return</span> rdbSaveRawString(rdb,obj-&gt;ptr,sdslen(obj-&gt;ptr));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbGenericLoadStringObject"><a href="#rdbGenericLoadStringObject" class="headerlink" title="rdbGenericLoadStringObject"></a>rdbGenericLoadStringObject</h4><p>从rdb文件中读取字符串对象，<code>flags</code>决定了返回的对象类型，flags可以是一下几种的结合：</p>
<p>RDB_LOAD_NONE: 返回一个rdb对象，不用任何编码<br>RDB_LOAD_ENC: 如果返回是一个redis对象，尝试特殊对其进行特殊编码<br>RDB_LOAD_PLAIN: 返回一个字符串是zmalloc创建的而非redis对象<br>RDB_LOAD_SDS: 返回一个SDS字符串而非redis对象</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">rdbGenericLoadStringObject</span><span class="params">(rio *rdb, <span class="keyword">int</span> flags, <span class="keyword">size_t</span> *lenptr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> encode = flags &amp; RDB_LOAD_ENC;</span><br><span class="line">    <span class="keyword">int</span> plain = flags &amp; RDB_LOAD_PLAIN;</span><br><span class="line">    <span class="keyword">int</span> sds = flags &amp; RDB_LOAD_SDS;</span><br><span class="line">    <span class="keyword">int</span> isencoded;</span><br><span class="line">    <span class="keyword">uint64_t</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先读取一个字节，看数据采用了何种编码</span></span><br><span class="line">    len = rdbLoadLen(rdb,&amp;isencoded);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 特殊编码情况，11XXXX开始</span></span><br><span class="line">    <span class="keyword">if</span> (isencoded) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(len) &#123;</span><br><span class="line">        <span class="keyword">case</span> RDB_ENC_INT8:</span><br><span class="line">        <span class="keyword">case</span> RDB_ENC_INT16:</span><br><span class="line">        <span class="keyword">case</span> RDB_ENC_INT32:</span><br><span class="line">            <span class="keyword">return</span> rdbLoadIntegerObject(rdb,len,flags,lenptr);</span><br><span class="line">        <span class="keyword">case</span> RDB_ENC_LZF:</span><br><span class="line">            <span class="keyword">return</span> rdbLoadLzfStringObject(rdb,flags,lenptr);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            rdbExitReportCorruptRDB(<span class="string">&quot;Unknown RDB string encoding type %d&quot;</span>,len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非采用rdb规定的编码情况</span></span><br><span class="line">    <span class="keyword">if</span> (len == RDB_LENERR) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回字符串</span></span><br><span class="line">    <span class="keyword">if</span> (plain || sds) &#123;</span><br><span class="line">        <span class="keyword">void</span> *buf = plain ? zmalloc(len) : sdsnewlen(SDS_NOINIT,len);</span><br><span class="line">        <span class="keyword">if</span> (lenptr) *lenptr = len;</span><br><span class="line">        <span class="keyword">if</span> (len &amp;&amp; rioRead(rdb,buf,len) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (plain)</span><br><span class="line">                zfree(buf);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                sdsfree(buf);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buf;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="comment">// 采用embstr编码还是原始数据</span></span><br><span class="line">        robj *o = encode ? createStringObject(SDS_NOINIT,len) :</span><br><span class="line">                           createRawStringObject(SDS_NOINIT,len);</span><br><span class="line">        <span class="keyword">if</span> (len &amp;&amp; rioRead(rdb,o-&gt;ptr,len) == <span class="number">0</span>) &#123;</span><br><span class="line">            decrRefCount(o);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadStringObject"><a href="#rdbLoadStringObject" class="headerlink" title="rdbLoadStringObject"></a>rdbLoadStringObject</h4><p>从rdb文件中读取string对象，不采用任何编码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">robj *<span class="title">rdbLoadStringObject</span><span class="params">(rio *rdb)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rdbGenericLoadStringObject(rdb,RDB_LOAD_NONE,<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadEncodedStringObject"><a href="#rdbLoadEncodedStringObject" class="headerlink" title="rdbLoadEncodedStringObject"></a>rdbLoadEncodedStringObject</h4><p>从rdb中读取string对象，尝试采用embstr编码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">robj *<span class="title">rdbLoadEncodedStringObject</span><span class="params">(rio *rdb)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rdbGenericLoadStringObject(rdb,RDB_LOAD_ENC,<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveDoubleValue"><a href="#rdbSaveDoubleValue" class="headerlink" title="rdbSaveDoubleValue"></a>rdbSaveDoubleValue</h4><p>往rdb中保存double类型数据，转换成字符串存储，其首个字节表示类型，如下：</p>
<p>253: 不是一个数字 NAN 0.0/0.0<br>254: 正无穷大 +INF 1.0/0.0<br>255: 负无穷大 -INF -1.0/0.0</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveDoubleValue</span><span class="params">(rio *rdb, <span class="keyword">double</span> val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isnan(val)) &#123;</span><br><span class="line">        buf[<span class="number">0</span>] = <span class="number">253</span>;</span><br><span class="line">        len = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isfinite(val)) &#123;</span><br><span class="line">        len = <span class="number">1</span>;</span><br><span class="line">        buf[<span class="number">0</span>] = (val &lt; <span class="number">0</span>) ? <span class="number">255</span> : <span class="number">254</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (DBL_MANT_DIG &gt;= 52) &amp;&amp; (LLONG_MAX == 0x7fffffffffffffffLL)</span></span><br><span class="line">        <span class="comment">/* Check if the float is in a safe range to be casted into a</span></span><br><span class="line"><span class="comment">         * long long. We are assuming that long long is 64 bit here.</span></span><br><span class="line"><span class="comment">         * Also we are assuming that there are no implementations around where</span></span><br><span class="line"><span class="comment">         * double has precision &lt; 52 bit.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Under this assumptions we test if a double is inside an interval</span></span><br><span class="line"><span class="comment">         * where casting to long long is safe. Then using two castings we</span></span><br><span class="line"><span class="comment">         * make sure the decimal part is zero. If all this is true we use</span></span><br><span class="line"><span class="comment">         * integer printing function that is much faster. */</span></span><br><span class="line">        <span class="keyword">double</span> min = <span class="number">-4503599627370495</span>; <span class="comment">/* (2^52)-1 */</span></span><br><span class="line">        <span class="keyword">double</span> max = <span class="number">4503599627370496</span>; <span class="comment">/* -(2^52) */</span></span><br><span class="line">        <span class="keyword">if</span> (val &gt; min &amp;&amp; val &lt; max &amp;&amp; val == ((<span class="keyword">double</span>)((<span class="keyword">long</span> <span class="keyword">long</span>)val)))</span><br><span class="line">            ll2string((<span class="keyword">char</span>*)buf+<span class="number">1</span>,<span class="keyword">sizeof</span>(buf)<span class="number">-1</span>,(<span class="keyword">long</span> <span class="keyword">long</span>)val);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="built_in">snprintf</span>((<span class="keyword">char</span>*)buf+<span class="number">1</span>,<span class="keyword">sizeof</span>(buf)<span class="number">-1</span>,<span class="string">&quot;%.17g&quot;</span>,val);</span><br><span class="line">        buf[<span class="number">0</span>] = <span class="built_in">strlen</span>((<span class="keyword">char</span>*)buf+<span class="number">1</span>);</span><br><span class="line">        len = buf[<span class="number">0</span>]+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rdbWriteRaw(rdb,buf,len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadDoubleValue"><a href="#rdbLoadDoubleValue" class="headerlink" title="rdbLoadDoubleValue"></a>rdbLoadDoubleValue</h4><p>从rdb读取double类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbLoadDoubleValue</span><span class="params">(rio *rdb, <span class="keyword">double</span> *val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先读取类型，处理NAN、INF的情况</span></span><br><span class="line">    <span class="keyword">if</span> (rioRead(rdb,&amp;len,<span class="number">1</span>) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">switch</span>(len) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">255</span>: *val = R_NegInf; <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">254</span>: *val = R_PosInf; <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">253</span>: *val = R_Nan; <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    	<span class="comment">// 读取正常数值</span></span><br><span class="line">        <span class="keyword">if</span> (rioRead(rdb,buf,len) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        buf[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%lg&quot;</span>, val);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveBinaryDoubleValue"><a href="#rdbSaveBinaryDoubleValue" class="headerlink" title="rdbSaveBinaryDoubleValue"></a>rdbSaveBinaryDoubleValue</h4><p>保存二进制格式的double数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveBinaryDoubleValue</span><span class="params">(rio *rdb, <span class="keyword">double</span> val)</span> </span>&#123;</span><br><span class="line">    memrev64ifbe(&amp;val);</span><br><span class="line">    <span class="keyword">return</span> rdbWriteRaw(rdb,&amp;val,<span class="keyword">sizeof</span>(val));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadBinaryDoubleValue"><a href="#rdbLoadBinaryDoubleValue" class="headerlink" title="rdbLoadBinaryDoubleValue"></a>rdbLoadBinaryDoubleValue</h4><p>从rdb读取二进制格式double类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbLoadBinaryDoubleValue</span><span class="params">(rio *rdb, <span class="keyword">double</span> *val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rioRead(rdb,val,<span class="keyword">sizeof</span>(*val)) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    memrev64ifbe(val);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveBinaryFloatValue"><a href="#rdbSaveBinaryFloatValue" class="headerlink" title="rdbSaveBinaryFloatValue"></a>rdbSaveBinaryFloatValue</h4><p>保存二进制格式的float数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveBinaryFloatValue</span><span class="params">(rio *rdb, <span class="keyword">float</span> val)</span> </span>&#123;</span><br><span class="line">    memrev32ifbe(&amp;val);</span><br><span class="line">    <span class="keyword">return</span> rdbWriteRaw(rdb,&amp;val,<span class="keyword">sizeof</span>(val));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="rdbLoadBinaryFloatValue"><a href="#rdbLoadBinaryFloatValue" class="headerlink" title="rdbLoadBinaryFloatValue"></a>rdbLoadBinaryFloatValue</h4><p>从rdb读取二进制格式float类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbLoadBinaryFloatValue</span><span class="params">(rio *rdb, <span class="keyword">float</span> *val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rioRead(rdb,val,<span class="keyword">sizeof</span>(*val)) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    memrev32ifbe(val);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveObjectType"><a href="#rdbSaveObjectType" class="headerlink" title="rdbSaveObjectType"></a>rdbSaveObjectType</h4><p>保存redis对象类型，从redis对象类型映射到rdb对象类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveObjectType</span><span class="params">(rio *rdb, robj *o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (o-&gt;type) &#123;</span><br><span class="line">    <span class="keyword">case</span> OBJ_STRING:</span><br><span class="line">        <span class="keyword">return</span> rdbSaveType(rdb,RDB_TYPE_STRING);</span><br><span class="line">    <span class="keyword">case</span> OBJ_LIST:</span><br><span class="line">        <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_QUICKLIST)</span><br><span class="line">            <span class="keyword">return</span> rdbSaveType(rdb,RDB_TYPE_LIST_QUICKLIST);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            serverPanic(<span class="string">&quot;Unknown list encoding&quot;</span>);</span><br><span class="line">    <span class="keyword">case</span> OBJ_SET:</span><br><span class="line">        <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_INTSET)</span><br><span class="line">            <span class="keyword">return</span> rdbSaveType(rdb,RDB_TYPE_SET_INTSET);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_HT)</span><br><span class="line">            <span class="keyword">return</span> rdbSaveType(rdb,RDB_TYPE_SET);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            serverPanic(<span class="string">&quot;Unknown set encoding&quot;</span>);</span><br><span class="line">    <span class="keyword">case</span> OBJ_ZSET:</span><br><span class="line">        <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_ZIPLIST)</span><br><span class="line">            <span class="keyword">return</span> rdbSaveType(rdb,RDB_TYPE_ZSET_ZIPLIST);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_SKIPLIST)</span><br><span class="line">            <span class="keyword">return</span> rdbSaveType(rdb,RDB_TYPE_ZSET_2);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            serverPanic(<span class="string">&quot;Unknown sorted set encoding&quot;</span>);</span><br><span class="line">    <span class="keyword">case</span> OBJ_HASH:</span><br><span class="line">        <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_ZIPLIST)</span><br><span class="line">            <span class="keyword">return</span> rdbSaveType(rdb,RDB_TYPE_HASH_ZIPLIST);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_HT)</span><br><span class="line">            <span class="keyword">return</span> rdbSaveType(rdb,RDB_TYPE_HASH);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            serverPanic(<span class="string">&quot;Unknown hash encoding&quot;</span>);</span><br><span class="line">    <span class="keyword">case</span> OBJ_STREAM:</span><br><span class="line">        <span class="keyword">return</span> rdbSaveType(rdb,RDB_TYPE_STREAM_LISTPACKS);</span><br><span class="line">    <span class="keyword">case</span> OBJ_MODULE:</span><br><span class="line">        <span class="keyword">return</span> rdbSaveType(rdb,RDB_TYPE_MODULE_2);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        serverPanic(<span class="string">&quot;Unknown object type&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">/* avoid warning */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadObjectType"><a href="#rdbLoadObjectType" class="headerlink" title="rdbLoadObjectType"></a>rdbLoadObjectType</h4><p>从rdb中读取对象类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbLoadObjectType</span><span class="params">(rio *rdb)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">if</span> ((type = rdbLoadType(rdb)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (!rdbIsObjectType(type)) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveStreamPEL"><a href="#rdbSaveStreamPEL" class="headerlink" title="rdbSaveStreamPEL"></a>rdbSaveStreamPEL</h4><p>序列化消费者待处理列表，并写入rdb文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">rdbSaveStreamPEL</span><span class="params">(rio *rdb, rax *pel, <span class="keyword">int</span> nacks)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> n, nwritten = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Number of entries in the PEL. */</span></span><br><span class="line">    <span class="keyword">if</span> ((n = rdbSaveLen(rdb,raxSize(pel))) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    nwritten += n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Save each entry. */</span></span><br><span class="line">    raxIterator ri;</span><br><span class="line">    raxStart(&amp;ri,pel);</span><br><span class="line">    raxSeek(&amp;ri,<span class="string">&quot;^&quot;</span>,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">while</span>(raxNext(&amp;ri)) &#123;</span><br><span class="line">        <span class="comment">/* We store IDs in raw form as 128 big big endian numbers, like</span></span><br><span class="line"><span class="comment">         * they are inside the radix tree key. */</span></span><br><span class="line">        <span class="keyword">if</span> ((n = rdbWriteRaw(rdb,ri.key,<span class="keyword">sizeof</span>(streamID))) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten += n;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nacks) &#123;</span><br><span class="line">            streamNACK *nack = ri.data;</span><br><span class="line">            <span class="keyword">if</span> ((n = rdbSaveMillisecondTime(rdb,nack-&gt;delivery_time)) == <span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            nwritten += n;</span><br><span class="line">            <span class="keyword">if</span> ((n = rdbSaveLen(rdb,nack-&gt;delivery_count)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            nwritten += n;</span><br><span class="line">            <span class="comment">/* We don&#x27;t save the consumer name: we&#x27;ll save the pending IDs</span></span><br><span class="line"><span class="comment">             * for each consumer in the consumer PEL, and resolve the consumer</span></span><br><span class="line"><span class="comment">             * at loading time. */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    raxStop(&amp;ri);</span><br><span class="line">    <span class="keyword">return</span> nwritten;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveStreamConsumers"><a href="#rdbSaveStreamConsumers" class="headerlink" title="rdbSaveStreamConsumers"></a>rdbSaveStreamConsumers</h4><p>序列化流式消费者，并保存到rdb中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">rdbSaveStreamConsumers</span><span class="params">(rio *rdb, streamCG *cg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> n, nwritten = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Number of consumers in this consumer group. */</span></span><br><span class="line">    <span class="keyword">if</span> ((n = rdbSaveLen(rdb,raxSize(cg-&gt;consumers))) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    nwritten += n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Save each consumer. */</span></span><br><span class="line">    raxIterator ri;</span><br><span class="line">    raxStart(&amp;ri,cg-&gt;consumers);</span><br><span class="line">    raxSeek(&amp;ri,<span class="string">&quot;^&quot;</span>,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">while</span>(raxNext(&amp;ri)) &#123;</span><br><span class="line">        streamConsumer *consumer = ri.data;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Consumer name. */</span></span><br><span class="line">        <span class="keyword">if</span> ((n = rdbSaveRawString(rdb,ri.key,ri.key_len)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten += n;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Last seen time. */</span></span><br><span class="line">        <span class="keyword">if</span> ((n = rdbSaveMillisecondTime(rdb,consumer-&gt;seen_time)) == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten += n;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Consumer PEL, without the ACKs (see last parameter of the function</span></span><br><span class="line"><span class="comment">         * passed with value of 0), at loading time we&#x27;ll lookup the ID</span></span><br><span class="line"><span class="comment">         * in the consumer group global PEL and will put a reference in the</span></span><br><span class="line"><span class="comment">         * consumer local PEL. */</span></span><br><span class="line">        <span class="keyword">if</span> ((n = rdbSaveStreamPEL(rdb,consumer-&gt;pel,<span class="number">0</span>)) == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten += n;</span><br><span class="line">    &#125;</span><br><span class="line">    raxStop(&amp;ri);</span><br><span class="line">    <span class="keyword">return</span> nwritten;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveObject"><a href="#rdbSaveObject" class="headerlink" title="rdbSaveObject"></a>rdbSaveObject</h4><p>保存redis对象内容，分为<code>string</code>,<code>list</code>,<code>set</code>,<code>zset</code>,<code>hash</code>,<code>stream</code>,<code>module</code>类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">rdbSaveObject</span><span class="params">(rio *rdb, robj *o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> n = <span class="number">0</span>, nwritten = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (o-&gt;type == OBJ_STRING) &#123;</span><br><span class="line">        <span class="comment">/* Save a string value */</span></span><br><span class="line">        <span class="keyword">if</span> ((n = rdbSaveStringObject(rdb,o)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten += n;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o-&gt;type == OBJ_LIST) &#123;</span><br><span class="line">        <span class="comment">/* Save a list value */</span></span><br><span class="line">        <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_QUICKLIST) &#123;</span><br><span class="line">            quicklist *ql = o-&gt;ptr;</span><br><span class="line">            quicklistNode *node = ql-&gt;head;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((n = rdbSaveLen(rdb,ql-&gt;len)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            nwritten += n;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(node) &#123;</span><br><span class="line">                <span class="keyword">if</span> (quicklistNodeIsCompressed(node)) &#123;</span><br><span class="line">                    <span class="keyword">void</span> *data;</span><br><span class="line">                    <span class="keyword">size_t</span> compress_len = quicklistGetLzf(node, &amp;data);</span><br><span class="line">                    <span class="keyword">if</span> ((n = rdbSaveLzfBlob(rdb,data,compress_len,node-&gt;sz)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                    nwritten += n;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((n = rdbSaveRawString(rdb,node-&gt;zl,node-&gt;sz)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                    nwritten += n;</span><br><span class="line">                &#125;</span><br><span class="line">                node = node-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            serverPanic(<span class="string">&quot;Unknown list encoding&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o-&gt;type == OBJ_SET) &#123;</span><br><span class="line">        <span class="comment">/* Save a set value */</span></span><br><span class="line">        <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_HT) &#123;</span><br><span class="line">            dict *<span class="built_in">set</span> = o-&gt;ptr;</span><br><span class="line">            dictIterator *di = dictGetIterator(<span class="built_in">set</span>);</span><br><span class="line">            dictEntry *de;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((n = rdbSaveLen(rdb,dictSize(<span class="built_in">set</span>))) == <span class="number">-1</span>) &#123;</span><br><span class="line">                dictReleaseIterator(di);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            nwritten += n;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                sds ele = dictGetKey(de);</span><br><span class="line">                <span class="keyword">if</span> ((n = rdbSaveRawString(rdb,(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)ele,sdslen(ele)))</span><br><span class="line">                    == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    dictReleaseIterator(di);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                nwritten += n;</span><br><span class="line">            &#125;</span><br><span class="line">            dictReleaseIterator(di);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_INTSET) &#123;</span><br><span class="line">            <span class="keyword">size_t</span> l = intsetBlobLen((intset*)o-&gt;ptr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((n = rdbSaveRawString(rdb,o-&gt;ptr,l)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            nwritten += n;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            serverPanic(<span class="string">&quot;Unknown set encoding&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o-&gt;type == OBJ_ZSET) &#123;</span><br><span class="line">        <span class="comment">/* Save a sorted set value */</span></span><br><span class="line">        <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_ZIPLIST) &#123;</span><br><span class="line">            <span class="keyword">size_t</span> l = ziplistBlobLen((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)o-&gt;ptr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((n = rdbSaveRawString(rdb,o-&gt;ptr,l)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            nwritten += n;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_SKIPLIST) &#123;</span><br><span class="line">            zset *zs = o-&gt;ptr;</span><br><span class="line">            zskiplist *zsl = zs-&gt;zsl;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((n = rdbSaveLen(rdb,zsl-&gt;length)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            nwritten += n;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* We save the skiplist elements from the greatest to the smallest</span></span><br><span class="line"><span class="comment">             * (that&#x27;s trivial since the elements are already ordered in the</span></span><br><span class="line"><span class="comment">             * skiplist): this improves the load process, since the next loaded</span></span><br><span class="line"><span class="comment">             * element will always be the smaller, so adding to the skiplist</span></span><br><span class="line"><span class="comment">             * will always immediately stop at the head, making the insertion</span></span><br><span class="line"><span class="comment">             * O(1) instead of O(log(N)). */</span></span><br><span class="line">            zskiplistNode *zn = zsl-&gt;tail;</span><br><span class="line">            <span class="keyword">while</span> (zn != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((n = rdbSaveRawString(rdb,</span><br><span class="line">                    (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)zn-&gt;ele,sdslen(zn-&gt;ele))) == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                nwritten += n;</span><br><span class="line">                <span class="keyword">if</span> ((n = rdbSaveBinaryDoubleValue(rdb,zn-&gt;score)) == <span class="number">-1</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                nwritten += n;</span><br><span class="line">                zn = zn-&gt;backward;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            serverPanic(<span class="string">&quot;Unknown sorted set encoding&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o-&gt;type == OBJ_HASH) &#123;</span><br><span class="line">        <span class="comment">/* Save a hash value */</span></span><br><span class="line">        <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_ZIPLIST) &#123;</span><br><span class="line">            <span class="keyword">size_t</span> l = ziplistBlobLen((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)o-&gt;ptr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((n = rdbSaveRawString(rdb,o-&gt;ptr,l)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            nwritten += n;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_HT) &#123;</span><br><span class="line">            dictIterator *di = dictGetIterator(o-&gt;ptr);</span><br><span class="line">            dictEntry *de;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((n = rdbSaveLen(rdb,dictSize((dict*)o-&gt;ptr))) == <span class="number">-1</span>) &#123;</span><br><span class="line">                dictReleaseIterator(di);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            nwritten += n;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                sds field = dictGetKey(de);</span><br><span class="line">                sds value = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((n = rdbSaveRawString(rdb,(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)field,</span><br><span class="line">                        sdslen(field))) == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    dictReleaseIterator(di);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                nwritten += n;</span><br><span class="line">                <span class="keyword">if</span> ((n = rdbSaveRawString(rdb,(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)value,</span><br><span class="line">                        sdslen(value))) == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    dictReleaseIterator(di);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                nwritten += n;</span><br><span class="line">            &#125;</span><br><span class="line">            dictReleaseIterator(di);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            serverPanic(<span class="string">&quot;Unknown hash encoding&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o-&gt;type == OBJ_STREAM) &#123;</span><br><span class="line">        <span class="comment">/* Store how many listpacks we have inside the radix tree. */</span></span><br><span class="line">        stream *s = o-&gt;ptr;</span><br><span class="line">        rax *rax = s-&gt;rax;</span><br><span class="line">        <span class="keyword">if</span> ((n = rdbSaveLen(rdb,raxSize(rax))) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten += n;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Serialize all the listpacks inside the radix tree as they are,</span></span><br><span class="line"><span class="comment">         * when loading back, we&#x27;ll use the first entry of each listpack</span></span><br><span class="line"><span class="comment">         * to insert it back into the radix tree. */</span></span><br><span class="line">        raxIterator ri;</span><br><span class="line">        raxStart(&amp;ri,rax);</span><br><span class="line">        raxSeek(&amp;ri,<span class="string">&quot;^&quot;</span>,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">while</span> (raxNext(&amp;ri)) &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> *lp = ri.data;</span><br><span class="line">            <span class="keyword">size_t</span> lp_bytes = lpBytes(lp);</span><br><span class="line">            <span class="keyword">if</span> ((n = rdbSaveRawString(rdb,ri.key,ri.key_len)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            nwritten += n;</span><br><span class="line">            <span class="keyword">if</span> ((n = rdbSaveRawString(rdb,lp,lp_bytes)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            nwritten += n;</span><br><span class="line">        &#125;</span><br><span class="line">        raxStop(&amp;ri);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Save the number of elements inside the stream. We cannot obtain</span></span><br><span class="line"><span class="comment">         * this easily later, since our macro nodes should be checked for</span></span><br><span class="line"><span class="comment">         * number of items: not a great CPU / space tradeoff. */</span></span><br><span class="line">        <span class="keyword">if</span> ((n = rdbSaveLen(rdb,s-&gt;length)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten += n;</span><br><span class="line">        <span class="comment">/* Save the last entry ID. */</span></span><br><span class="line">        <span class="keyword">if</span> ((n = rdbSaveLen(rdb,s-&gt;last_id.ms)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten += n;</span><br><span class="line">        <span class="keyword">if</span> ((n = rdbSaveLen(rdb,s-&gt;last_id.seq)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten += n;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* The consumer groups and their clients are part of the stream</span></span><br><span class="line"><span class="comment">         * type, so serialize every consumer group. */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Save the number of groups. */</span></span><br><span class="line">        <span class="keyword">size_t</span> num_cgroups = s-&gt;cgroups ? raxSize(s-&gt;cgroups) : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((n = rdbSaveLen(rdb,num_cgroups)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        nwritten += n;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (num_cgroups) &#123;</span><br><span class="line">            <span class="comment">/* Serialize each consumer group. */</span></span><br><span class="line">            raxStart(&amp;ri,s-&gt;cgroups);</span><br><span class="line">            raxSeek(&amp;ri,<span class="string">&quot;^&quot;</span>,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">while</span>(raxNext(&amp;ri)) &#123;</span><br><span class="line">                streamCG *cg = ri.data;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* Save the group name. */</span></span><br><span class="line">                <span class="keyword">if</span> ((n = rdbSaveRawString(rdb,ri.key,ri.key_len)) == <span class="number">-1</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                nwritten += n;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* Last ID. */</span></span><br><span class="line">                <span class="keyword">if</span> ((n = rdbSaveLen(rdb,cg-&gt;last_id.ms)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                nwritten += n;</span><br><span class="line">                <span class="keyword">if</span> ((n = rdbSaveLen(rdb,cg-&gt;last_id.seq)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                nwritten += n;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* Save the global PEL. */</span></span><br><span class="line">                <span class="keyword">if</span> ((n = rdbSaveStreamPEL(rdb,cg-&gt;pel,<span class="number">1</span>)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                nwritten += n;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* Save the consumers of this group. */</span></span><br><span class="line">                <span class="keyword">if</span> ((n = rdbSaveStreamConsumers(rdb,cg)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                nwritten += n;</span><br><span class="line">            &#125;</span><br><span class="line">            raxStop(&amp;ri);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o-&gt;type == OBJ_MODULE) &#123;</span><br><span class="line">        <span class="comment">/* Save a module-specific value. */</span></span><br><span class="line">        RedisModuleIO io;</span><br><span class="line">        moduleValue *mv = o-&gt;ptr;</span><br><span class="line">        moduleType *mt = mv-&gt;type;</span><br><span class="line">        moduleInitIOContext(io,mt,rdb);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Write the &quot;module&quot; identifier as prefix, so that we&#x27;ll be able</span></span><br><span class="line"><span class="comment">         * to call the right module during loading. */</span></span><br><span class="line">        <span class="keyword">int</span> retval = rdbSaveLen(rdb,mt-&gt;id);</span><br><span class="line">        <span class="keyword">if</span> (retval == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        io.bytes += retval;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Then write the module-specific representation + EOF marker. */</span></span><br><span class="line">        mt-&gt;rdb_save(&amp;io,mv-&gt;value);</span><br><span class="line">        retval = rdbSaveLen(rdb,RDB_MODULE_OPCODE_EOF);</span><br><span class="line">        <span class="keyword">if</span> (retval == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        io.bytes += retval;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (io.ctx) &#123;</span><br><span class="line">            moduleFreeContext(io.ctx);</span><br><span class="line">            zfree(io.ctx);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> io.error ? <span class="number">-1</span> : (<span class="keyword">ssize_t</span>)io.bytes;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        serverPanic(<span class="string">&quot;Unknown object type&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nwritten;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSavedObjectLen"><a href="#rdbSavedObjectLen" class="headerlink" title="rdbSavedObjectLen"></a>rdbSavedObjectLen</h4><p>获取redis对象如果写入文件时，所需要的长度，为了懒省事就用<code>rdbSaveObject</code>方法，rio参数传了NULL，这样只返回长度，实际上是没有写入到文件的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">rdbSavedObjectLen</span><span class="params">(robj *o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> len = rdbSaveObject(<span class="literal">NULL</span>,o);</span><br><span class="line">    serverAssertWithInfo(<span class="literal">NULL</span>,o,len != <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveKeyValuePair"><a href="#rdbSaveKeyValuePair" class="headerlink" title="rdbSaveKeyValuePair"></a>rdbSaveKeyValuePair</h4><p>写入一对key、value数据到rdb中，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveKeyValuePair</span><span class="params">(rio *rdb, robj *key, robj *val, <span class="keyword">long</span> <span class="keyword">long</span> expiretime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> savelru = server.maxmemory_policy &amp; MAXMEMORY_FLAG_LRU;</span><br><span class="line">    <span class="keyword">int</span> savelfu = server.maxmemory_policy &amp; MAXMEMORY_FLAG_LFU;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存过期时间</span></span><br><span class="line">    <span class="keyword">if</span> (expiretime != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_EXPIRETIME_MS) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveMillisecondTime(rdb,expiretime) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存LRU信息</span></span><br><span class="line">    <span class="keyword">if</span> (savelru) &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> idletime = estimateObjectIdleTime(val);</span><br><span class="line">        idletime /= <span class="number">1000</span>; <span class="comment">/* Using seconds is enough and requires less space.*/</span></span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_IDLE) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveLen(rdb,idletime) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存LFU信息</span></span><br><span class="line">    <span class="keyword">if</span> (savelfu) &#123;</span><br><span class="line">        <span class="keyword">uint8_t</span> buf[<span class="number">1</span>];</span><br><span class="line">        buf[<span class="number">0</span>] = LFUDecrAndReturn(val);</span><br><span class="line">        <span class="comment">/* We can encode this in exactly two bytes: the opcode and an 8</span></span><br><span class="line"><span class="comment">         * bit counter, since the frequency is logarithmic with a 0-255 range.</span></span><br><span class="line"><span class="comment">         * Note that we do not store the halving time because to reset it</span></span><br><span class="line"><span class="comment">         * a single time when loading does not affect the frequency much. */</span></span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_FREQ) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (rdbWriteRaw(rdb,buf,<span class="number">1</span>) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存value类型,key,value</span></span><br><span class="line">    <span class="keyword">if</span> (rdbSaveObjectType(rdb,val) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveStringObject(rdb,key) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveObject(rdb,val) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveAuxField"><a href="#rdbSaveAuxField" class="headerlink" title="rdbSaveAuxField"></a>rdbSaveAuxField</h4><p>写入一组辅助信息到rdb中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">rdbSaveAuxField</span><span class="params">(rio *rdb, <span class="keyword">void</span> *key, <span class="keyword">size_t</span> keylen, <span class="keyword">void</span> *val, <span class="keyword">size_t</span> vallen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">ssize_t</span> ret, len = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 先写入标识标识次信息是辅助信息</span></span><br><span class="line">    <span class="keyword">if</span> ((ret = rdbSaveType(rdb,RDB_OPCODE_AUX)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    len += ret;</span><br><span class="line">    <span class="comment">// 写入key</span></span><br><span class="line">    <span class="keyword">if</span> ((ret = rdbSaveRawString(rdb,key,keylen)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    len += ret;</span><br><span class="line">    <span class="comment">// 写入value</span></span><br><span class="line">    <span class="keyword">if</span> ((ret = rdbSaveRawString(rdb,val,vallen)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    len += ret;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveAuxFieldStrStr"><a href="#rdbSaveAuxFieldStrStr" class="headerlink" title="rdbSaveAuxFieldStrStr"></a>rdbSaveAuxFieldStrStr</h4><p>写入一对辅助信息到rdb文件，此方法应用于key,value可以用strlen确定长度的场景，否则用<code>rdbSaveAuxField</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">rdbSaveAuxFieldStrStr</span><span class="params">(rio *rdb, <span class="keyword">char</span> *key, <span class="keyword">char</span> *val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rdbSaveAuxField(rdb,key,<span class="built_in">strlen</span>(key),val,<span class="built_in">strlen</span>(val));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveAuxFieldStrInt"><a href="#rdbSaveAuxFieldStrInt" class="headerlink" title="rdbSaveAuxFieldStrInt"></a>rdbSaveAuxFieldStrInt</h4><p>写入一对辅助信息到rdb文件，如果辅助信息的value是<code>long long</code>类型，最终还是转换成string存储</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">rdbSaveAuxFieldStrInt</span><span class="params">(rio *rdb, <span class="keyword">char</span> *key, <span class="keyword">long</span> <span class="keyword">long</span> val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[LONG_STR_SIZE];</span><br><span class="line">    <span class="keyword">int</span> vlen = ll2string(buf,<span class="keyword">sizeof</span>(buf),val);</span><br><span class="line">    <span class="keyword">return</span> rdbSaveAuxField(rdb,key,<span class="built_in">strlen</span>(key),buf,vlen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveInfoAuxFields"><a href="#rdbSaveInfoAuxFields" class="headerlink" title="rdbSaveInfoAuxFields"></a>rdbSaveInfoAuxFields</h4><p>写入所有辅助信息到rdb文件中，写入辅助信息的入口，写入的信息包括<code>redis-ver</code>,<code>redis-bits</code>,<code>ctime</code>,<code>used-mem</code>,<code>repl-stream-db</code>,<code>repl-id</code>,<code>repl-offset</code>,<code>aof-preamble</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveInfoAuxFields</span><span class="params">(rio *rdb, <span class="keyword">int</span> flags, rdbSaveInfo *rsi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> redis_bits = (<span class="keyword">sizeof</span>(<span class="keyword">void</span>*) == <span class="number">8</span>) ? <span class="number">64</span> : <span class="number">32</span>;</span><br><span class="line">    <span class="keyword">int</span> aof_preamble = (flags &amp; RDB_SAVE_AOF_PREAMBLE) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Add a few fields about the state when the RDB was created. */</span></span><br><span class="line">    <span class="keyword">if</span> (rdbSaveAuxFieldStrStr(rdb,<span class="string">&quot;redis-ver&quot;</span>,REDIS_VERSION) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveAuxFieldStrInt(rdb,<span class="string">&quot;redis-bits&quot;</span>,redis_bits) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveAuxFieldStrInt(rdb,<span class="string">&quot;ctime&quot;</span>,time(<span class="literal">NULL</span>)) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveAuxFieldStrInt(rdb,<span class="string">&quot;used-mem&quot;</span>,zmalloc_used_memory()) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Handle saving options that generate aux fields. */</span></span><br><span class="line">    <span class="keyword">if</span> (rsi) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveAuxFieldStrInt(rdb,<span class="string">&quot;repl-stream-db&quot;</span>,rsi-&gt;repl_stream_db)</span><br><span class="line">            == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveAuxFieldStrStr(rdb,<span class="string">&quot;repl-id&quot;</span>,server.replid)</span><br><span class="line">            == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveAuxFieldStrInt(rdb,<span class="string">&quot;repl-offset&quot;</span>,server.master_repl_offset)</span><br><span class="line">            == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveAuxFieldStrInt(rdb,<span class="string">&quot;aof-preamble&quot;</span>,aof_preamble) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveRio"><a href="#rdbSaveRio" class="headerlink" title="rdbSaveRio"></a>rdbSaveRio</h4><p>rdb真正干事情的入口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveRio</span><span class="params">(rio *rdb, <span class="keyword">int</span> *error, <span class="keyword">int</span> flags, rdbSaveInfo *rsi)</span> </span>&#123;</span><br><span class="line">    dictIterator *di = <span class="literal">NULL</span>;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">char</span> magic[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    <span class="keyword">uint64_t</span> cksum;</span><br><span class="line">    <span class="keyword">size_t</span> processed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.rdb_checksum)</span><br><span class="line">        rdb-&gt;update_cksum = rioGenericUpdateChecksum;</span><br><span class="line">    <span class="comment">//写入 REDISXXXX(版本号) 开始</span></span><br><span class="line">    <span class="built_in">snprintf</span>(magic,<span class="keyword">sizeof</span>(magic),<span class="string">&quot;REDIS%04d&quot;</span>,RDB_VERSION);</span><br><span class="line">    <span class="keyword">if</span> (rdbWriteRaw(rdb,magic,<span class="number">9</span>) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//写入辅助信息</span></span><br><span class="line">    <span class="keyword">if</span> (rdbSaveInfoAuxFields(rdb,flags,rsi) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历所有DB,依次写入每个DB</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.dbnum; j++) &#123;</span><br><span class="line">        redisDb *db = server.db+j;</span><br><span class="line">        dict *d = db-&gt;dict;</span><br><span class="line">        <span class="keyword">if</span> (dictSize(d) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        di = dictGetSafeIterator(d);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入select标识</span></span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_SELECTDB) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveLen(rdb,j) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入DB大小标识</span></span><br><span class="line">        <span class="keyword">uint64_t</span> db_size, expires_size;</span><br><span class="line">        db_size = dictSize(db-&gt;dict);</span><br><span class="line">        expires_size = dictSize(db-&gt;expires);</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_RESIZEDB) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveLen(rdb,db_size) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">        <span class="keyword">if</span> (rdbSaveLen(rdb,expires_size) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历DB保存数据的hash表，保存每一对key,value</span></span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            sds keystr = dictGetKey(de);</span><br><span class="line">            robj key, *o = dictGetVal(de);</span><br><span class="line">            <span class="keyword">long</span> <span class="keyword">long</span> expire;</span><br><span class="line"></span><br><span class="line">            initStaticStringObject(key,keystr);</span><br><span class="line">            expire = getExpire(db,&amp;key);</span><br><span class="line">            <span class="keyword">if</span> (rdbSaveKeyValuePair(rdb,&amp;key,o,expire) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果此操作是aof需要的，处理一定数据量之后需要去读取一下aof父进程发送的差异数据</span></span><br><span class="line">            <span class="keyword">if</span> (flags &amp; RDB_SAVE_AOF_PREAMBLE &amp;&amp;</span><br><span class="line">                rdb-&gt;processed_bytes &gt; processed+AOF_READ_DIFF_INTERVAL_BYTES)</span><br><span class="line">            &#123;</span><br><span class="line">                processed = rdb-&gt;processed_bytes;</span><br><span class="line">                aofReadDiffFromParent();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di);</span><br><span class="line">        di = <span class="literal">NULL</span>; <span class="comment">/* So that we don&#x27;t release it again on error. */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存lua脚本信息</span></span><br><span class="line">    <span class="keyword">if</span> (rsi &amp;&amp; dictSize(server.lua_scripts)) &#123;</span><br><span class="line">        di = dictGetIterator(server.lua_scripts);</span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            robj *body = dictGetVal(de);</span><br><span class="line">            <span class="keyword">if</span> (rdbSaveAuxField(rdb,<span class="string">&quot;lua&quot;</span>,<span class="number">3</span>,body-&gt;ptr,sdslen(body-&gt;ptr)) == <span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">goto</span> werr;</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di);</span><br><span class="line">        di = <span class="literal">NULL</span>; <span class="comment">/* So that we don&#x27;t release it again on error. */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入RDB结束标识</span></span><br><span class="line">    <span class="keyword">if</span> (rdbSaveType(rdb,RDB_OPCODE_EOF) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入校验码</span></span><br><span class="line">    cksum = rdb-&gt;cksum;</span><br><span class="line">    memrev64ifbe(&amp;cksum);</span><br><span class="line">    <span class="keyword">if</span> (rioWrite(rdb,&amp;cksum,<span class="number">8</span>) == <span class="number">0</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line"></span><br><span class="line">werr:</span><br><span class="line">    <span class="keyword">if</span> (error) *error = errno;</span><br><span class="line">    <span class="keyword">if</span> (di) dictReleaseIterator(di);</span><br><span class="line">    <span class="keyword">return</span> C_ERR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveRioWithEOFMark"><a href="#rdbSaveRioWithEOFMark" class="headerlink" title="rdbSaveRioWithEOFMark"></a>rdbSaveRioWithEOFMark</h4><p>在正常的rdb内容前后加入一个前缀和后缀，前缀是<code>$EOF:&lt;40 bytes unguessable hex string&gt;\r\n</code>,后缀是<code>&lt;40 bytes unguessable hex string&gt;</code>，后缀是用来标识结束位置。这个方法主要是用在主从同步的场景。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveRioWithEOFMark</span><span class="params">(rio *rdb, <span class="keyword">int</span> *error, rdbSaveInfo *rsi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> eofmark[RDB_EOF_MARK_SIZE];</span><br><span class="line"></span><br><span class="line">    getRandomHexChars(eofmark,RDB_EOF_MARK_SIZE);</span><br><span class="line">    <span class="keyword">if</span> (error) *error = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (rioWrite(rdb,<span class="string">&quot;$EOF:&quot;</span>,<span class="number">5</span>) == <span class="number">0</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (rioWrite(rdb,eofmark,RDB_EOF_MARK_SIZE) == <span class="number">0</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (rioWrite(rdb,<span class="string">&quot;\r\n&quot;</span>,<span class="number">2</span>) == <span class="number">0</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (rdbSaveRio(rdb,error,RDB_SAVE_NONE,rsi) == C_ERR) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (rioWrite(rdb,eofmark,RDB_EOF_MARK_SIZE) == <span class="number">0</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line"></span><br><span class="line">werr: <span class="comment">/* Write error. */</span></span><br><span class="line">    <span class="comment">/* Set &#x27;error&#x27; only if not already set by rdbSaveRio() call. */</span></span><br><span class="line">    <span class="keyword">if</span> (error &amp;&amp; *error == <span class="number">0</span>) *error = errno;</span><br><span class="line">    <span class="keyword">return</span> C_ERR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSave"><a href="#rdbSave" class="headerlink" title="rdbSave"></a>rdbSave</h4><p>往文件中写入rdb内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSave</span><span class="params">(<span class="keyword">char</span> *filename, rdbSaveInfo *rsi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> tmpfile[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">char</span> cwd[MAXPATHLEN]; <span class="comment">/* Current working dir path for error messages. */</span></span><br><span class="line">    FILE *fp;</span><br><span class="line">    rio rdb;</span><br><span class="line">    <span class="keyword">int</span> error = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义临时文件</span></span><br><span class="line">    <span class="built_in">snprintf</span>(tmpfile,<span class="number">256</span>,<span class="string">&quot;temp-%d.rdb&quot;</span>, (<span class="keyword">int</span>) getpid());</span><br><span class="line">    fp = fopen(tmpfile,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp) &#123;</span><br><span class="line">        <span class="keyword">char</span> *cwdp = getcwd(cwd,MAXPATHLEN);</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Failed opening the RDB file %s (in server root dir %s) &quot;</span></span><br><span class="line">            <span class="string">&quot;for saving: %s&quot;</span>,</span><br><span class="line">            filename,</span><br><span class="line">            cwdp ? cwdp : <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">            strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用文件初始化rio</span></span><br><span class="line">    rioInitWithFile(&amp;rdb,fp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置sync策略</span></span><br><span class="line">    <span class="keyword">if</span> (server.rdb_save_incremental_fsync)</span><br><span class="line">        rioSetAutoSync(&amp;rdb,REDIS_AUTOSYNC_BYTES);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行rdb操作</span></span><br><span class="line">    <span class="keyword">if</span> (rdbSaveRio(&amp;rdb,&amp;error,RDB_SAVE_NONE,rsi) == C_ERR) &#123;</span><br><span class="line">        errno = error;</span><br><span class="line">        <span class="keyword">goto</span> werr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 手动flush，确保os层面的buffer都写入</span></span><br><span class="line">    <span class="keyword">if</span> (fflush(fp) == EOF) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (fsync(fileno(fp)) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (fclose(fp) == EOF) <span class="keyword">goto</span> werr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重命名文件 临时-&gt;要求</span></span><br><span class="line">    <span class="keyword">if</span> (rename(tmpfile,filename) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> *cwdp = getcwd(cwd,MAXPATHLEN);</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Error moving temp DB file %s on the final &quot;</span></span><br><span class="line">            <span class="string">&quot;destination %s (in server root dir %s): %s&quot;</span>,</span><br><span class="line">            tmpfile,</span><br><span class="line">            filename,</span><br><span class="line">            cwdp ? cwdp : <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">            strerror(errno));</span><br><span class="line">        unlink(tmpfile);</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serverLog(LL_NOTICE,<span class="string">&quot;DB saved on disk&quot;</span>);</span><br><span class="line">    server.dirty = <span class="number">0</span>;</span><br><span class="line">    server.lastsave = time(<span class="literal">NULL</span>);</span><br><span class="line">    server.lastbgsave_status = C_OK;</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line"></span><br><span class="line">werr:</span><br><span class="line">    serverLog(LL_WARNING,<span class="string">&quot;Write error saving DB on disk: %s&quot;</span>, strerror(errno));</span><br><span class="line">    fclose(fp);</span><br><span class="line">    unlink(tmpfile);</span><br><span class="line">    <span class="keyword">return</span> C_ERR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveBackground"><a href="#rdbSaveBackground" class="headerlink" title="rdbSaveBackground"></a>rdbSaveBackground</h4><p>创建子进程进行rdb</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveBackground</span><span class="params">(<span class="keyword">char</span> *filename, rdbSaveInfo *rsi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> childpid;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> start;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.aof_child_pid != <span class="number">-1</span> || server.rdb_child_pid != <span class="number">-1</span>) <span class="keyword">return</span> C_ERR;</span><br><span class="line"></span><br><span class="line">    server.dirty_before_bgsave = server.dirty;</span><br><span class="line">    server.lastbgsave_try = time(<span class="literal">NULL</span>);</span><br><span class="line">    openChildInfoPipe();</span><br><span class="line"></span><br><span class="line">    start = ustime();</span><br><span class="line">    <span class="keyword">if</span> ((childpid = fork()) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 子进程</span></span><br><span class="line">        closeListeningSockets(<span class="number">0</span>);</span><br><span class="line">        redisSetProcTitle(<span class="string">&quot;redis-rdb-bgsave&quot;</span>);</span><br><span class="line">        retval = rdbSave(filename,rsi);</span><br><span class="line">        <span class="keyword">if</span> (retval == C_OK) &#123;</span><br><span class="line">            <span class="keyword">size_t</span> private_dirty = zmalloc_get_private_dirty(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (private_dirty) &#123;</span><br><span class="line">                serverLog(LL_NOTICE,</span><br><span class="line">                    <span class="string">&quot;RDB: %zu MB of memory used by copy-on-write&quot;</span>,</span><br><span class="line">                    private_dirty/(<span class="number">1024</span>*<span class="number">1024</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            server.child_info_data.cow_size = private_dirty;</span><br><span class="line">            sendChildInfo(CHILD_INFO_TYPE_RDB);</span><br><span class="line">        &#125;</span><br><span class="line">        exitFromChild((retval == C_OK) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 父进程</span></span><br><span class="line">        server.stat_fork_time = ustime()-start;</span><br><span class="line">        server.stat_fork_rate = (<span class="keyword">double</span>) zmalloc_used_memory() * <span class="number">1000000</span> / server.stat_fork_time / (<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>); <span class="comment">/* GB per second. */</span></span><br><span class="line">        latencyAddSampleIfNeeded(<span class="string">&quot;fork&quot;</span>,server.stat_fork_time/<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">if</span> (childpid == <span class="number">-1</span>) &#123;</span><br><span class="line">            closeChildInfoPipe();</span><br><span class="line">            server.lastbgsave_status = C_ERR;</span><br><span class="line">            serverLog(LL_WARNING,<span class="string">&quot;Can&#x27;t save in background: fork: %s&quot;</span>,</span><br><span class="line">                strerror(errno));</span><br><span class="line">            <span class="keyword">return</span> C_ERR;</span><br><span class="line">        &#125;</span><br><span class="line">        serverLog(LL_NOTICE,<span class="string">&quot;Background saving started by pid %d&quot;</span>,childpid);</span><br><span class="line">        server.rdb_save_time_start = time(<span class="literal">NULL</span>);</span><br><span class="line">        server.rdb_child_pid = childpid;</span><br><span class="line">        server.rdb_child_type = RDB_CHILD_TYPE_DISK;</span><br><span class="line">        updateDictResizePolicy();</span><br><span class="line">        <span class="keyword">return</span> C_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> C_OK; <span class="comment">/* unreached */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbRemoveTempFile"><a href="#rdbRemoveTempFile" class="headerlink" title="rdbRemoveTempFile"></a>rdbRemoveTempFile</h4><p>删除子进程生成的临时文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rdbRemoveTempFile</span><span class="params">(<span class="keyword">pid_t</span> childpid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> tmpfile[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(tmpfile,<span class="keyword">sizeof</span>(tmpfile),<span class="string">&quot;temp-%d.rdb&quot;</span>, (<span class="keyword">int</span>) childpid);</span><br><span class="line">    unlink(tmpfile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadCheckModuleValue"><a href="#rdbLoadCheckModuleValue" class="headerlink" title="rdbLoadCheckModuleValue"></a>rdbLoadCheckModuleValue</h4><p>读取check module数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">robj *<span class="title">rdbLoadCheckModuleValue</span><span class="params">(rio *rdb, <span class="keyword">char</span> *modulename)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> opcode;</span><br><span class="line">    <span class="keyword">while</span>((opcode = rdbLoadLen(rdb,<span class="literal">NULL</span>)) != RDB_MODULE_OPCODE_EOF) &#123;</span><br><span class="line">        <span class="keyword">if</span> (opcode == RDB_MODULE_OPCODE_SINT ||</span><br><span class="line">            opcode == RDB_MODULE_OPCODE_UINT)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> len;</span><br><span class="line">            <span class="keyword">if</span> (rdbLoadLenByRef(rdb,<span class="literal">NULL</span>,&amp;len) == <span class="number">-1</span>) &#123;</span><br><span class="line">                rdbExitReportCorruptRDB(</span><br><span class="line">                    <span class="string">&quot;Error reading integer from module %s value&quot;</span>, modulename);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opcode == RDB_MODULE_OPCODE_STRING) &#123;</span><br><span class="line">            robj *o = rdbGenericLoadStringObject(rdb,RDB_LOAD_NONE,<span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (o == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                rdbExitReportCorruptRDB(</span><br><span class="line">                    <span class="string">&quot;Error reading string from module %s value&quot;</span>, modulename);</span><br><span class="line">            &#125;</span><br><span class="line">            decrRefCount(o);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opcode == RDB_MODULE_OPCODE_FLOAT) &#123;</span><br><span class="line">            <span class="keyword">float</span> val;</span><br><span class="line">            <span class="keyword">if</span> (rdbLoadBinaryFloatValue(rdb,&amp;val) == <span class="number">-1</span>) &#123;</span><br><span class="line">                rdbExitReportCorruptRDB(</span><br><span class="line">                    <span class="string">&quot;Error reading float from module %s value&quot;</span>, modulename);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opcode == RDB_MODULE_OPCODE_DOUBLE) &#123;</span><br><span class="line">            <span class="keyword">double</span> val;</span><br><span class="line">            <span class="keyword">if</span> (rdbLoadBinaryDoubleValue(rdb,&amp;val) == <span class="number">-1</span>) &#123;</span><br><span class="line">                rdbExitReportCorruptRDB(</span><br><span class="line">                    <span class="string">&quot;Error reading double from module %s value&quot;</span>, modulename);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> createStringObject(<span class="string">&quot;module-dummy-value&quot;</span>,<span class="number">18</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadObject"><a href="#rdbLoadObject" class="headerlink" title="rdbLoadObject"></a>rdbLoadObject</h4><p>从特殊文件读取redis对象</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">robj *<span class="title">rdbLoadObject</span><span class="params">(<span class="keyword">int</span> rdbtype, rio *rdb)</span> </span>&#123;</span><br><span class="line">    robj *o = <span class="literal">NULL</span>, *ele, *dec;</span><br><span class="line">    <span class="keyword">uint64_t</span> len;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rdbtype == RDB_TYPE_STRING) &#123;</span><br><span class="line">        <span class="comment">/* Read string value */</span></span><br><span class="line">        <span class="keyword">if</span> ((o = rdbLoadEncodedStringObject(rdb)) == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        o = tryObjectEncoding(o);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rdbtype == RDB_TYPE_LIST) &#123;</span><br><span class="line">        <span class="comment">/* Read list value */</span></span><br><span class="line">        <span class="keyword">if</span> ((len = rdbLoadLen(rdb,<span class="literal">NULL</span>)) == RDB_LENERR) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        o = createQuicklistObject();</span><br><span class="line">        quicklistSetOptions(o-&gt;ptr, server.list_max_ziplist_size,</span><br><span class="line">                            server.list_compress_depth);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Load every single element of the list */</span></span><br><span class="line">        <span class="keyword">while</span>(len--) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((ele = rdbLoadEncodedStringObject(rdb)) == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            dec = getDecodedObject(ele);</span><br><span class="line">            <span class="keyword">size_t</span> len = sdslen(dec-&gt;ptr);</span><br><span class="line">            quicklistPushTail(o-&gt;ptr, dec-&gt;ptr, len);</span><br><span class="line">            decrRefCount(dec);</span><br><span class="line">            decrRefCount(ele);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rdbtype == RDB_TYPE_SET) &#123;</span><br><span class="line">        <span class="comment">/* Read Set value */</span></span><br><span class="line">        <span class="keyword">if</span> ((len = rdbLoadLen(rdb,<span class="literal">NULL</span>)) == RDB_LENERR) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Use a regular set when there are too many entries. */</span></span><br><span class="line">        <span class="keyword">if</span> (len &gt; server.set_max_intset_entries) &#123;</span><br><span class="line">            o = createSetObject();</span><br><span class="line">            <span class="comment">/* It&#x27;s faster to expand the dict to the right size asap in order</span></span><br><span class="line"><span class="comment">             * to avoid rehashing */</span></span><br><span class="line">            <span class="keyword">if</span> (len &gt; DICT_HT_INITIAL_SIZE)</span><br><span class="line">                dictExpand(o-&gt;ptr,len);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            o = createIntsetObject();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Load every single element of the set */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="keyword">long</span> <span class="keyword">long</span> llval;</span><br><span class="line">            sds sdsele;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((sdsele = rdbGenericLoadStringObject(rdb,RDB_LOAD_SDS,<span class="literal">NULL</span>))</span><br><span class="line">                == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_INTSET) &#123;</span><br><span class="line">                <span class="comment">/* Fetch integer value from element. */</span></span><br><span class="line">                <span class="keyword">if</span> (isSdsRepresentableAsLongLong(sdsele,&amp;llval) == C_OK) &#123;</span><br><span class="line">                    o-&gt;ptr = intsetAdd(o-&gt;ptr,llval,<span class="literal">NULL</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    setTypeConvert(o,OBJ_ENCODING_HT);</span><br><span class="line">                    dictExpand(o-&gt;ptr,len);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* This will also be called when the set was just converted</span></span><br><span class="line"><span class="comment">             * to a regular hash table encoded set. */</span></span><br><span class="line">            <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_HT) &#123;</span><br><span class="line">                dictAdd((dict*)o-&gt;ptr,sdsele,<span class="literal">NULL</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sdsfree(sdsele);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rdbtype == RDB_TYPE_ZSET_2 || rdbtype == RDB_TYPE_ZSET) &#123;</span><br><span class="line">        <span class="comment">/* Read list/set value. */</span></span><br><span class="line">        <span class="keyword">uint64_t</span> zsetlen;</span><br><span class="line">        <span class="keyword">size_t</span> maxelelen = <span class="number">0</span>;</span><br><span class="line">        zset *zs;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((zsetlen = rdbLoadLen(rdb,<span class="literal">NULL</span>)) == RDB_LENERR) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        o = createZsetObject();</span><br><span class="line">        zs = o-&gt;ptr;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (zsetlen &gt; DICT_HT_INITIAL_SIZE)</span><br><span class="line">            dictExpand(zs-&gt;dict,zsetlen);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Load every single element of the sorted set. */</span></span><br><span class="line">        <span class="keyword">while</span>(zsetlen--) &#123;</span><br><span class="line">            sds sdsele;</span><br><span class="line">            <span class="keyword">double</span> score;</span><br><span class="line">            zskiplistNode *znode;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((sdsele = rdbGenericLoadStringObject(rdb,RDB_LOAD_SDS,<span class="literal">NULL</span>))</span><br><span class="line">                == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (rdbtype == RDB_TYPE_ZSET_2) &#123;</span><br><span class="line">                <span class="keyword">if</span> (rdbLoadBinaryDoubleValue(rdb,&amp;score) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (rdbLoadDoubleValue(rdb,&amp;score) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Don&#x27;t care about integer-encoded strings. */</span></span><br><span class="line">            <span class="keyword">if</span> (sdslen(sdsele) &gt; maxelelen) maxelelen = sdslen(sdsele);</span><br><span class="line"></span><br><span class="line">            znode = zslInsert(zs-&gt;zsl,score,sdsele);</span><br><span class="line">            dictAdd(zs-&gt;dict,sdsele,&amp;znode-&gt;score);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Convert *after* loading, since sorted sets are not stored ordered. */</span></span><br><span class="line">        <span class="keyword">if</span> (zsetLength(o) &lt;= server.zset_max_ziplist_entries &amp;&amp;</span><br><span class="line">            maxelelen &lt;= server.zset_max_ziplist_value)</span><br><span class="line">                zsetConvert(o,OBJ_ENCODING_ZIPLIST);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rdbtype == RDB_TYPE_HASH) &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> len;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line">        sds field, value;</span><br><span class="line"></span><br><span class="line">        len = rdbLoadLen(rdb, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (len == RDB_LENERR) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        o = createHashObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Too many entries? Use a hash table. */</span></span><br><span class="line">        <span class="keyword">if</span> (len &gt; server.hash_max_ziplist_entries)</span><br><span class="line">            hashTypeConvert(o, OBJ_ENCODING_HT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Load every field and value into the ziplist */</span></span><br><span class="line">        <span class="keyword">while</span> (o-&gt;encoding == OBJ_ENCODING_ZIPLIST &amp;&amp; len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            len--;</span><br><span class="line">            <span class="comment">/* Load raw strings */</span></span><br><span class="line">            <span class="keyword">if</span> ((field = rdbGenericLoadStringObject(rdb,RDB_LOAD_SDS,<span class="literal">NULL</span>))</span><br><span class="line">                == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">if</span> ((value = rdbGenericLoadStringObject(rdb,RDB_LOAD_SDS,<span class="literal">NULL</span>))</span><br><span class="line">                == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Add pair to ziplist */</span></span><br><span class="line">            o-&gt;ptr = ziplistPush(o-&gt;ptr, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)field,</span><br><span class="line">                    sdslen(field), ZIPLIST_TAIL);</span><br><span class="line">            o-&gt;ptr = ziplistPush(o-&gt;ptr, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)value,</span><br><span class="line">                    sdslen(value), ZIPLIST_TAIL);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Convert to hash table if size threshold is exceeded */</span></span><br><span class="line">            <span class="keyword">if</span> (sdslen(field) &gt; server.hash_max_ziplist_value ||</span><br><span class="line">                sdslen(value) &gt; server.hash_max_ziplist_value)</span><br><span class="line">            &#123;</span><br><span class="line">                sdsfree(field);</span><br><span class="line">                sdsfree(value);</span><br><span class="line">                hashTypeConvert(o, OBJ_ENCODING_HT);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            sdsfree(field);</span><br><span class="line">            sdsfree(value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_HT &amp;&amp; len &gt; DICT_HT_INITIAL_SIZE)</span><br><span class="line">            dictExpand(o-&gt;ptr,len);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Load remaining fields and values into the hash table */</span></span><br><span class="line">        <span class="keyword">while</span> (o-&gt;encoding == OBJ_ENCODING_HT &amp;&amp; len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            len--;</span><br><span class="line">            <span class="comment">/* Load encoded strings */</span></span><br><span class="line">            <span class="keyword">if</span> ((field = rdbGenericLoadStringObject(rdb,RDB_LOAD_SDS,<span class="literal">NULL</span>))</span><br><span class="line">                == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">if</span> ((value = rdbGenericLoadStringObject(rdb,RDB_LOAD_SDS,<span class="literal">NULL</span>))</span><br><span class="line">                == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Add pair to hash table */</span></span><br><span class="line">            ret = dictAdd((dict*)o-&gt;ptr, field, value);</span><br><span class="line">            <span class="keyword">if</span> (ret == DICT_ERR) &#123;</span><br><span class="line">                rdbExitReportCorruptRDB(<span class="string">&quot;Duplicate keys detected&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* All pairs should be read by now */</span></span><br><span class="line">        serverAssert(len == <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rdbtype == RDB_TYPE_LIST_QUICKLIST) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((len = rdbLoadLen(rdb,<span class="literal">NULL</span>)) == RDB_LENERR) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        o = createQuicklistObject();</span><br><span class="line">        quicklistSetOptions(o-&gt;ptr, server.list_max_ziplist_size,</span><br><span class="line">                            server.list_compress_depth);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (len--) &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> *zl =</span><br><span class="line">                rdbGenericLoadStringObject(rdb,RDB_LOAD_PLAIN,<span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (zl == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            quicklistAppendZiplist(o-&gt;ptr, zl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rdbtype == RDB_TYPE_HASH_ZIPMAP  ||</span><br><span class="line">               rdbtype == RDB_TYPE_LIST_ZIPLIST ||</span><br><span class="line">               rdbtype == RDB_TYPE_SET_INTSET   ||</span><br><span class="line">               rdbtype == RDB_TYPE_ZSET_ZIPLIST ||</span><br><span class="line">               rdbtype == RDB_TYPE_HASH_ZIPLIST)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> *encoded =</span><br><span class="line">            rdbGenericLoadStringObject(rdb,RDB_LOAD_PLAIN,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (encoded == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        o = createObject(OBJ_STRING,encoded); <span class="comment">/* Obj type fixed below. */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Fix the object encoding, and make sure to convert the encoded</span></span><br><span class="line"><span class="comment">         * data type into the base type if accordingly to the current</span></span><br><span class="line"><span class="comment">         * configuration there are too many elements in the encoded data</span></span><br><span class="line"><span class="comment">         * type. Note that we only check the length and not max element</span></span><br><span class="line"><span class="comment">         * size as this is an O(N) scan. Eventually everything will get</span></span><br><span class="line"><span class="comment">         * converted. */</span></span><br><span class="line">        <span class="keyword">switch</span>(rdbtype) &#123;</span><br><span class="line">            <span class="keyword">case</span> RDB_TYPE_HASH_ZIPMAP:</span><br><span class="line">                <span class="comment">/* Convert to ziplist encoded hash. This must be deprecated</span></span><br><span class="line"><span class="comment">                 * when loading dumps created by Redis 2.4 gets deprecated. */</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">unsigned</span> <span class="keyword">char</span> *zl = ziplistNew();</span><br><span class="line">                    <span class="keyword">unsigned</span> <span class="keyword">char</span> *zi = zipmapRewind(o-&gt;ptr);</span><br><span class="line">                    <span class="keyword">unsigned</span> <span class="keyword">char</span> *fstr, *vstr;</span><br><span class="line">                    <span class="keyword">unsigned</span> <span class="keyword">int</span> flen, vlen;</span><br><span class="line">                    <span class="keyword">unsigned</span> <span class="keyword">int</span> maxlen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> ((zi = zipmapNext(zi, &amp;fstr, &amp;flen, &amp;vstr, &amp;vlen)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (flen &gt; maxlen) maxlen = flen;</span><br><span class="line">                        <span class="keyword">if</span> (vlen &gt; maxlen) maxlen = vlen;</span><br><span class="line">                        zl = ziplistPush(zl, fstr, flen, ZIPLIST_TAIL);</span><br><span class="line">                        zl = ziplistPush(zl, vstr, vlen, ZIPLIST_TAIL);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    zfree(o-&gt;ptr);</span><br><span class="line">                    o-&gt;ptr = zl;</span><br><span class="line">                    o-&gt;type = OBJ_HASH;</span><br><span class="line">                    o-&gt;encoding = OBJ_ENCODING_ZIPLIST;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (hashTypeLength(o) &gt; server.hash_max_ziplist_entries ||</span><br><span class="line">                        maxlen &gt; server.hash_max_ziplist_value)</span><br><span class="line">                    &#123;</span><br><span class="line">                        hashTypeConvert(o, OBJ_ENCODING_HT);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RDB_TYPE_LIST_ZIPLIST:</span><br><span class="line">                o-&gt;type = OBJ_LIST;</span><br><span class="line">                o-&gt;encoding = OBJ_ENCODING_ZIPLIST;</span><br><span class="line">                listTypeConvert(o,OBJ_ENCODING_QUICKLIST);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RDB_TYPE_SET_INTSET:</span><br><span class="line">                o-&gt;type = OBJ_SET;</span><br><span class="line">                o-&gt;encoding = OBJ_ENCODING_INTSET;</span><br><span class="line">                <span class="keyword">if</span> (intsetLen(o-&gt;ptr) &gt; server.set_max_intset_entries)</span><br><span class="line">                    setTypeConvert(o,OBJ_ENCODING_HT);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RDB_TYPE_ZSET_ZIPLIST:</span><br><span class="line">                o-&gt;type = OBJ_ZSET;</span><br><span class="line">                o-&gt;encoding = OBJ_ENCODING_ZIPLIST;</span><br><span class="line">                <span class="keyword">if</span> (zsetLength(o) &gt; server.zset_max_ziplist_entries)</span><br><span class="line">                    zsetConvert(o,OBJ_ENCODING_SKIPLIST);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RDB_TYPE_HASH_ZIPLIST:</span><br><span class="line">                o-&gt;type = OBJ_HASH;</span><br><span class="line">                o-&gt;encoding = OBJ_ENCODING_ZIPLIST;</span><br><span class="line">                <span class="keyword">if</span> (hashTypeLength(o) &gt; server.hash_max_ziplist_entries)</span><br><span class="line">                    hashTypeConvert(o, OBJ_ENCODING_HT);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                rdbExitReportCorruptRDB(<span class="string">&quot;Unknown RDB encoding type %d&quot;</span>,rdbtype);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rdbtype == RDB_TYPE_STREAM_LISTPACKS) &#123;</span><br><span class="line">        o = createStreamObject();</span><br><span class="line">        stream *s = o-&gt;ptr;</span><br><span class="line">        <span class="keyword">uint64_t</span> listpacks = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(listpacks--) &#123;</span><br><span class="line">            <span class="comment">/* Get the master ID, the one we&#x27;ll use as key of the radix tree</span></span><br><span class="line"><span class="comment">             * node: the entries inside the listpack itself are delta-encoded</span></span><br><span class="line"><span class="comment">             * relatively to this ID. */</span></span><br><span class="line">            sds nodekey = rdbGenericLoadStringObject(rdb,RDB_LOAD_SDS,<span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (sdslen(nodekey) != <span class="keyword">sizeof</span>(streamID)) &#123;</span><br><span class="line">                rdbExitReportCorruptRDB(<span class="string">&quot;Stream node key entry is not the &quot;</span></span><br><span class="line">                                        <span class="string">&quot;size of a stream ID&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Load the listpack. */</span></span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> *lp =</span><br><span class="line">                rdbGenericLoadStringObject(rdb,RDB_LOAD_PLAIN,<span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (lp == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> *first = lpFirst(lp);</span><br><span class="line">            <span class="keyword">if</span> (first == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">/* Serialized listpacks should never be empty, since on</span></span><br><span class="line"><span class="comment">                 * deletion we should remove the radix tree key if the</span></span><br><span class="line"><span class="comment">                 * resulting listpack is empty. */</span></span><br><span class="line">                rdbExitReportCorruptRDB(<span class="string">&quot;Empty listpack inside stream&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Insert the key in the radix tree. */</span></span><br><span class="line">            <span class="keyword">int</span> retval = raxInsert(s-&gt;rax,</span><br><span class="line">                (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)nodekey,<span class="keyword">sizeof</span>(streamID),lp,<span class="literal">NULL</span>);</span><br><span class="line">            sdsfree(nodekey);</span><br><span class="line">            <span class="keyword">if</span> (!retval)</span><br><span class="line">                rdbExitReportCorruptRDB(<span class="string">&quot;Listpack re-added with existing key&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* Load total number of items inside the stream. */</span></span><br><span class="line">        s-&gt;length = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">/* Load the last entry ID. */</span></span><br><span class="line">        s-&gt;last_id.ms = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line">        s-&gt;last_id.seq = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Consumer groups loading */</span></span><br><span class="line">        <span class="keyword">size_t</span> cgroups_count = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">while</span>(cgroups_count--) &#123;</span><br><span class="line">            <span class="comment">/* Get the consumer group name and ID. We can then create the</span></span><br><span class="line"><span class="comment">             * consumer group ASAP and populate its structure as</span></span><br><span class="line"><span class="comment">             * we read more data. */</span></span><br><span class="line">            streamID cg_id;</span><br><span class="line">            sds cgname = rdbGenericLoadStringObject(rdb,RDB_LOAD_SDS,<span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (cgname == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                rdbExitReportCorruptRDB(</span><br><span class="line">                    <span class="string">&quot;Error reading the consumer group name from Stream&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            cg_id.ms = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line">            cg_id.seq = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line">            streamCG *cgroup = streamCreateCG(s,cgname,sdslen(cgname),&amp;cg_id);</span><br><span class="line">            <span class="keyword">if</span> (cgroup == <span class="literal">NULL</span>)</span><br><span class="line">                rdbExitReportCorruptRDB(<span class="string">&quot;Duplicated consumer group name %s&quot;</span>,</span><br><span class="line">                                         cgname);</span><br><span class="line">            sdsfree(cgname);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Load the global PEL for this consumer group, however we&#x27;ll</span></span><br><span class="line"><span class="comment">             * not yet populate the NACK structures with the message</span></span><br><span class="line"><span class="comment">             * owner, since consumers for this group and their messages will</span></span><br><span class="line"><span class="comment">             * be read as a next step. So for now leave them not resolved</span></span><br><span class="line"><span class="comment">             * and later populate it. */</span></span><br><span class="line">            <span class="keyword">size_t</span> pel_size = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">while</span>(pel_size--) &#123;</span><br><span class="line">                <span class="keyword">unsigned</span> <span class="keyword">char</span> rawid[<span class="keyword">sizeof</span>(streamID)];</span><br><span class="line">                rdbLoadRaw(rdb,rawid,<span class="keyword">sizeof</span>(rawid));</span><br><span class="line">                streamNACK *nack = streamCreateNACK(<span class="literal">NULL</span>);</span><br><span class="line">                nack-&gt;delivery_time = rdbLoadMillisecondTime(rdb,RDB_VERSION);</span><br><span class="line">                nack-&gt;delivery_count = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">if</span> (!raxInsert(cgroup-&gt;pel,rawid,<span class="keyword">sizeof</span>(rawid),nack,<span class="literal">NULL</span>))</span><br><span class="line">                    rdbExitReportCorruptRDB(<span class="string">&quot;Duplicated gobal PEL entry &quot;</span></span><br><span class="line">                                            <span class="string">&quot;loading stream consumer group&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Now that we loaded our global PEL, we need to load the</span></span><br><span class="line"><span class="comment">             * consumers and their local PELs. */</span></span><br><span class="line">            <span class="keyword">size_t</span> consumers_num = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">while</span>(consumers_num--) &#123;</span><br><span class="line">                sds cname = rdbGenericLoadStringObject(rdb,RDB_LOAD_SDS,<span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">if</span> (cname == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    rdbExitReportCorruptRDB(</span><br><span class="line">                        <span class="string">&quot;Error reading the consumer name from Stream group&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                streamConsumer *consumer = streamLookupConsumer(cgroup,cname,</span><br><span class="line">                                           <span class="number">1</span>);</span><br><span class="line">                sdsfree(cname);</span><br><span class="line">                consumer-&gt;seen_time = rdbLoadMillisecondTime(rdb,RDB_VERSION);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* Load the PEL about entries owned by this specific</span></span><br><span class="line"><span class="comment">                 * consumer. */</span></span><br><span class="line">                pel_size = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">while</span>(pel_size--) &#123;</span><br><span class="line">                    <span class="keyword">unsigned</span> <span class="keyword">char</span> rawid[<span class="keyword">sizeof</span>(streamID)];</span><br><span class="line">                    rdbLoadRaw(rdb,rawid,<span class="keyword">sizeof</span>(rawid));</span><br><span class="line">                    streamNACK *nack = raxFind(cgroup-&gt;pel,rawid,<span class="keyword">sizeof</span>(rawid));</span><br><span class="line">                    <span class="keyword">if</span> (nack == raxNotFound)</span><br><span class="line">                        rdbExitReportCorruptRDB(<span class="string">&quot;Consumer entry not found in &quot;</span></span><br><span class="line">                                                <span class="string">&quot;group global PEL&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/* Set the NACK consumer, that was left to NULL when</span></span><br><span class="line"><span class="comment">                     * loading the global PEL. Then set the same shared</span></span><br><span class="line"><span class="comment">                     * NACK structure also in the consumer-specific PEL. */</span></span><br><span class="line">                    nack-&gt;consumer = consumer;</span><br><span class="line">                    <span class="keyword">if</span> (!raxInsert(consumer-&gt;pel,rawid,<span class="keyword">sizeof</span>(rawid),nack,<span class="literal">NULL</span>))</span><br><span class="line">                        rdbExitReportCorruptRDB(<span class="string">&quot;Duplicated consumer PEL entry &quot;</span></span><br><span class="line">                                                <span class="string">&quot; loading a stream consumer &quot;</span></span><br><span class="line">                                                <span class="string">&quot;group&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rdbtype == RDB_TYPE_MODULE || rdbtype == RDB_TYPE_MODULE_2) &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> moduleid = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line">        moduleType *mt = moduleTypeLookupModuleByID(moduleid);</span><br><span class="line">        <span class="keyword">char</span> name[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rdbCheckMode &amp;&amp; rdbtype == RDB_TYPE_MODULE_2) &#123;</span><br><span class="line">            moduleTypeNameByID(name,moduleid);</span><br><span class="line">            <span class="keyword">return</span> rdbLoadCheckModuleValue(rdb,name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mt == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            moduleTypeNameByID(name,moduleid);</span><br><span class="line">            serverLog(LL_WARNING,<span class="string">&quot;The RDB file contains module data I can&#x27;t load: no matching module &#x27;%s&#x27;&quot;</span>, name);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        RedisModuleIO io;</span><br><span class="line">        moduleInitIOContext(io,mt,rdb);</span><br><span class="line">        io.ver = (rdbtype == RDB_TYPE_MODULE) ? <span class="number">1</span> : <span class="number">2</span>;</span><br><span class="line">        <span class="comment">/* Call the rdb_load method of the module providing the 10 bit</span></span><br><span class="line"><span class="comment">         * encoding version in the lower 10 bits of the module ID. */</span></span><br><span class="line">        <span class="keyword">void</span> *ptr = mt-&gt;rdb_load(&amp;io,moduleid&amp;<span class="number">1023</span>);</span><br><span class="line">        <span class="keyword">if</span> (io.ctx) &#123;</span><br><span class="line">            moduleFreeContext(io.ctx);</span><br><span class="line">            zfree(io.ctx);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Module v2 serialization has an EOF mark at the end. */</span></span><br><span class="line">        <span class="keyword">if</span> (io.ver == <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> eof = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (eof != RDB_MODULE_OPCODE_EOF) &#123;</span><br><span class="line">                serverLog(LL_WARNING,<span class="string">&quot;The RDB file contains module data for the module &#x27;%s&#x27; that is not terminated by the proper module value EOF marker&quot;</span>, name);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            moduleTypeNameByID(name,moduleid);</span><br><span class="line">            serverLog(LL_WARNING,<span class="string">&quot;The RDB file contains module data for the module type &#x27;%s&#x27;, that the responsible module is not able to load. Check for modules log above for additional clues.&quot;</span>, name);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        o = createModuleObject(mt,ptr);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        rdbExitReportCorruptRDB(<span class="string">&quot;Unknown RDB encoding type %d&quot;</span>,rdbtype);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="startLoading"><a href="#startLoading" class="headerlink" title="startLoading"></a>startLoading</h4><p>开始加载，设置全局变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startLoading</span><span class="params">(FILE *fp)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">sb</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Load the DB */</span></span><br><span class="line">    server.loading = <span class="number">1</span>;</span><br><span class="line">    server.loading_start_time = time(<span class="literal">NULL</span>);</span><br><span class="line">    server.loading_loaded_bytes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (fstat(fileno(fp), &amp;sb) == <span class="number">-1</span>) &#123;</span><br><span class="line">        server.loading_total_bytes = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        server.loading_total_bytes = sb.st_size;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="loadingProgress"><a href="#loadingProgress" class="headerlink" title="loadingProgress"></a>loadingProgress</h4><p>更新加载进度</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadingProgress</span><span class="params">(<span class="keyword">off_t</span> pos)</span> </span>&#123;</span><br><span class="line">    server.loading_loaded_bytes = pos;</span><br><span class="line">    <span class="keyword">if</span> (server.stat_peak_memory &lt; zmalloc_used_memory())</span><br><span class="line">        server.stat_peak_memory = zmalloc_used_memory();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="stopLoading"><a href="#stopLoading" class="headerlink" title="stopLoading"></a>stopLoading</h4><p>停止加载，设置全局变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stopLoading</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    server.loading = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadProgressCallback"><a href="#rdbLoadProgressCallback" class="headerlink" title="rdbLoadProgressCallback"></a>rdbLoadProgressCallback</h4><p>rdb加载回调</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rdbLoadProgressCallback</span><span class="params">(rio *r, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (server.rdb_checksum)</span><br><span class="line">        rioGenericUpdateChecksum(r, buf, len);</span><br><span class="line">    <span class="keyword">if</span> (server.loading_process_events_interval_bytes &amp;&amp;</span><br><span class="line">        (r-&gt;processed_bytes + len)/server.loading_process_events_interval_bytes &gt; r-&gt;processed_bytes/server.loading_process_events_interval_bytes)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* The DB can take some non trivial amount of time to load. Update</span></span><br><span class="line"><span class="comment">         * our cached time since it is used to create and update the last</span></span><br><span class="line"><span class="comment">         * interaction time with clients and for other important things. */</span></span><br><span class="line">        updateCachedTime();</span><br><span class="line">        <span class="keyword">if</span> (server.masterhost &amp;&amp; server.repl_state == REPL_STATE_TRANSFER)</span><br><span class="line">            replicationSendNewlineToMaster();</span><br><span class="line">        loadingProgress(r-&gt;processed_bytes);</span><br><span class="line">        processEventsWhileBlocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoadRio"><a href="#rdbLoadRio" class="headerlink" title="rdbLoadRio"></a>rdbLoadRio</h4><p>真正加载rdb文件的入口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbLoadRio</span><span class="params">(rio *rdb, rdbSaveInfo *rsi, <span class="keyword">int</span> loading_aof)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> dbid;</span><br><span class="line">    <span class="keyword">int</span> type, rdbver;</span><br><span class="line">    redisDb *db = server.db+<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    rdb-&gt;update_cksum = rdbLoadProgressCallback;</span><br><span class="line">    rdb-&gt;max_processing_chunk = server.loading_process_events_interval_bytes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取开头REDISXXXX 验证版本信息</span></span><br><span class="line">    <span class="keyword">if</span> (rioRead(rdb,buf,<span class="number">9</span>) == <span class="number">0</span>) <span class="keyword">goto</span> eoferr;</span><br><span class="line">    buf[<span class="number">9</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">memcmp</span>(buf,<span class="string">&quot;REDIS&quot;</span>,<span class="number">5</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        serverLog(LL_WARNING,<span class="string">&quot;Wrong signature trying to load DB from file&quot;</span>);</span><br><span class="line">        errno = EINVAL;</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    rdbver = atoi(buf+<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">if</span> (rdbver &lt; <span class="number">1</span> || rdbver &gt; RDB_VERSION) &#123;</span><br><span class="line">        serverLog(LL_WARNING,<span class="string">&quot;Can&#x27;t handle RDB format version %d&quot;</span>,rdbver);</span><br><span class="line">        errno = EINVAL;</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Key-specific attributes, set by opcodes before the key type. */</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> lru_idle = <span class="number">-1</span>, lfu_freq = <span class="number">-1</span>, expiretime = <span class="number">-1</span>, now = mstime();</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> lru_clock = LRU_CLOCK();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        robj *key, *val;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取操作标识</span></span><br><span class="line">        <span class="keyword">if</span> ((type = rdbLoadType(rdb)) == <span class="number">-1</span>) <span class="keyword">goto</span> eoferr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断操作类型</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 过期时间 格式：时间，key，value</span></span><br><span class="line">        <span class="keyword">if</span> (type == RDB_OPCODE_EXPIRETIME) &#123;</span><br><span class="line">            expiretime = rdbLoadTime(rdb);</span><br><span class="line">            expiretime *= <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">continue</span>; <span class="comment">/* Read next opcode. */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == RDB_OPCODE_EXPIRETIME_MS) &#123;</span><br><span class="line">            <span class="comment">// 过期时间毫秒</span></span><br><span class="line">            expiretime = rdbLoadMillisecondTime(rdb,rdbver);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == RDB_OPCODE_FREQ) &#123;</span><br><span class="line">            <span class="comment">// LFU</span></span><br><span class="line">            <span class="keyword">uint8_t</span> byte;</span><br><span class="line">            <span class="keyword">if</span> (rioRead(rdb,&amp;byte,<span class="number">1</span>) == <span class="number">0</span>) <span class="keyword">goto</span> eoferr;</span><br><span class="line">            lfu_freq = byte;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == RDB_OPCODE_IDLE) &#123;</span><br><span class="line">            <span class="comment">// LRU</span></span><br><span class="line">            <span class="keyword">uint64_t</span> qword;</span><br><span class="line">            <span class="keyword">if</span> ((qword = rdbLoadLen(rdb,<span class="literal">NULL</span>)) == RDB_LENERR) <span class="keyword">goto</span> eoferr;</span><br><span class="line">            lru_idle = qword;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == RDB_OPCODE_EOF) &#123;</span><br><span class="line">            <span class="comment">// RDB结束</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == RDB_OPCODE_SELECTDB) &#123;</span><br><span class="line">            <span class="comment">// 选择DB,接下来是db索引</span></span><br><span class="line">            <span class="keyword">if</span> ((dbid = rdbLoadLen(rdb,<span class="literal">NULL</span>)) == RDB_LENERR) <span class="keyword">goto</span> eoferr;</span><br><span class="line">            <span class="keyword">if</span> (dbid &gt;= (<span class="keyword">unsigned</span>)server.dbnum) &#123;</span><br><span class="line">                serverLog(LL_WARNING,</span><br><span class="line">                    <span class="string">&quot;FATAL: Data file was created with a Redis &quot;</span></span><br><span class="line">                    <span class="string">&quot;server configured to handle more than %d &quot;</span></span><br><span class="line">                    <span class="string">&quot;databases. Exiting\n&quot;</span>, server.dbnum);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            db = server.db+dbid;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == RDB_OPCODE_RESIZEDB) &#123;</span><br><span class="line">            <span class="comment">// 设置DB大小 </span></span><br><span class="line">            <span class="keyword">uint64_t</span> db_size, expires_size;</span><br><span class="line">            <span class="keyword">if</span> ((db_size = rdbLoadLen(rdb,<span class="literal">NULL</span>)) == RDB_LENERR)</span><br><span class="line">                <span class="keyword">goto</span> eoferr;</span><br><span class="line">            <span class="keyword">if</span> ((expires_size = rdbLoadLen(rdb,<span class="literal">NULL</span>)) == RDB_LENERR)</span><br><span class="line">                <span class="keyword">goto</span> eoferr;</span><br><span class="line">            dictExpand(db-&gt;dict,db_size);</span><br><span class="line">            dictExpand(db-&gt;expires,expires_size);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == RDB_OPCODE_AUX) &#123;</span><br><span class="line">            <span class="comment">// 辅助信息，格式:key value</span></span><br><span class="line">            robj *auxkey, *auxval;</span><br><span class="line">            <span class="keyword">if</span> ((auxkey = rdbLoadStringObject(rdb)) == <span class="literal">NULL</span>) <span class="keyword">goto</span> eoferr;</span><br><span class="line">            <span class="keyword">if</span> ((auxval = rdbLoadStringObject(rdb)) == <span class="literal">NULL</span>) <span class="keyword">goto</span> eoferr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (((<span class="keyword">char</span>*)auxkey-&gt;ptr)[<span class="number">0</span>] == <span class="string">&#x27;%&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">/* All the fields with a name staring with &#x27;%&#x27; are considered</span></span><br><span class="line"><span class="comment">                 * information fields and are logged at startup with a log</span></span><br><span class="line"><span class="comment">                 * level of NOTICE. */</span></span><br><span class="line">                serverLog(LL_NOTICE,<span class="string">&quot;RDB &#x27;%s&#x27;: %s&quot;</span>,</span><br><span class="line">                    (<span class="keyword">char</span>*)auxkey-&gt;ptr,</span><br><span class="line">                    (<span class="keyword">char</span>*)auxval-&gt;ptr);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(auxkey-&gt;ptr,<span class="string">&quot;repl-stream-db&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (rsi) rsi-&gt;repl_stream_db = atoi(auxval-&gt;ptr);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(auxkey-&gt;ptr,<span class="string">&quot;repl-id&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (rsi &amp;&amp; sdslen(auxval-&gt;ptr) == CONFIG_RUN_ID_SIZE) &#123;</span><br><span class="line">                    <span class="built_in">memcpy</span>(rsi-&gt;repl_id,auxval-&gt;ptr,CONFIG_RUN_ID_SIZE+<span class="number">1</span>);</span><br><span class="line">                    rsi-&gt;repl_id_is_set = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(auxkey-&gt;ptr,<span class="string">&quot;repl-offset&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (rsi) rsi-&gt;repl_offset = strtoll(auxval-&gt;ptr,<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(auxkey-&gt;ptr,<span class="string">&quot;lua&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">/* Load the script back in memory. */</span></span><br><span class="line">                <span class="keyword">if</span> (luaCreateFunction(<span class="literal">NULL</span>,server.lua,auxval) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    rdbExitReportCorruptRDB(</span><br><span class="line">                        <span class="string">&quot;Can&#x27;t load Lua script from RDB file! &quot;</span></span><br><span class="line">                        <span class="string">&quot;BODY: %s&quot;</span>, auxval-&gt;ptr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* We ignore fields we don&#x27;t understand, as by AUX field</span></span><br><span class="line"><span class="comment">                 * contract. */</span></span><br><span class="line">                serverLog(LL_DEBUG,<span class="string">&quot;Unrecognized RDB AUX field: &#x27;%s&#x27;&quot;</span>,</span><br><span class="line">                    (<span class="keyword">char</span>*)auxkey-&gt;ptr);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            decrRefCount(auxkey);</span><br><span class="line">            decrRefCount(auxval);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == RDB_OPCODE_MODULE_AUX) &#123;</span><br><span class="line">            <span class="comment">// 模块辅助信息</span></span><br><span class="line">            <span class="keyword">uint64_t</span> moduleid = rdbLoadLen(rdb,<span class="literal">NULL</span>);</span><br><span class="line">            moduleType *mt = moduleTypeLookupModuleByID(moduleid);</span><br><span class="line">            <span class="keyword">char</span> name[<span class="number">10</span>];</span><br><span class="line">            moduleTypeNameByID(name,moduleid);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!rdbCheckMode &amp;&amp; mt == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">/* Unknown module. */</span></span><br><span class="line">                serverLog(LL_WARNING,<span class="string">&quot;The RDB file contains AUX module data I can&#x27;t load: no matching module &#x27;%s&#x27;&quot;</span>, name);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!rdbCheckMode &amp;&amp; mt != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">/* This version of Redis actually does not know what to do</span></span><br><span class="line"><span class="comment">                 * with modules AUX data... */</span></span><br><span class="line">                serverLog(LL_WARNING,<span class="string">&quot;The RDB file contains AUX module data I can&#x27;t load for the module &#x27;%s&#x27;. Probably you want to use a newer version of Redis which implements aux data callbacks&quot;</span>, name);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* RDB check mode. */</span></span><br><span class="line">                robj *aux = rdbLoadCheckModuleValue(rdb,name);</span><br><span class="line">                decrRefCount(aux);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取key</span></span><br><span class="line">        <span class="keyword">if</span> ((key = rdbLoadStringObject(rdb)) == <span class="literal">NULL</span>) <span class="keyword">goto</span> eoferr;</span><br><span class="line">        <span class="comment">// 读取value</span></span><br><span class="line">        <span class="keyword">if</span> ((val = rdbLoadObject(type,rdb)) == <span class="literal">NULL</span>) <span class="keyword">goto</span> eoferr;</span><br><span class="line">        <span class="comment">// 检查是否过期，在redis启动使用rdb时</span></span><br><span class="line">        <span class="keyword">if</span> (server.masterhost == <span class="literal">NULL</span> &amp;&amp; !loading_aof &amp;&amp; expiretime != <span class="number">-1</span> &amp;&amp; expiretime &lt; now) &#123;</span><br><span class="line">            decrRefCount(key);</span><br><span class="line">            decrRefCount(val);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//key是可用的，插入</span></span><br><span class="line">            dbAdd(db,key,val);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Set the expire time if needed */</span></span><br><span class="line">            <span class="keyword">if</span> (expiretime != <span class="number">-1</span>) setExpire(<span class="literal">NULL</span>,db,key,expiretime);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/* Set usage information (for eviction). */</span></span><br><span class="line">            objectSetLRUOrLFU(val,lfu_freq,lru_idle,lru_clock);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Decrement the key refcount since dbAdd() will take its</span></span><br><span class="line"><span class="comment">             * own reference. */</span></span><br><span class="line">            decrRefCount(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Reset the state that is key-specified and is populated by</span></span><br><span class="line"><span class="comment">         * opcodes before the key, so that we start from scratch again. */</span></span><br><span class="line">        expiretime = <span class="number">-1</span>;</span><br><span class="line">        lfu_freq = <span class="number">-1</span>;</span><br><span class="line">        lru_idle = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查数据完整性</span></span><br><span class="line">    <span class="keyword">if</span> (rdbver &gt;= <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> cksum, expected = rdb-&gt;cksum;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rioRead(rdb,&amp;cksum,<span class="number">8</span>) == <span class="number">0</span>) <span class="keyword">goto</span> eoferr;</span><br><span class="line">        <span class="keyword">if</span> (server.rdb_checksum) &#123;</span><br><span class="line">            memrev64ifbe(&amp;cksum);</span><br><span class="line">            <span class="keyword">if</span> (cksum == <span class="number">0</span>) &#123;</span><br><span class="line">                serverLog(LL_WARNING,<span class="string">&quot;RDB file was saved with checksum disabled: no check performed.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cksum != expected) &#123;</span><br><span class="line">                serverLog(LL_WARNING,<span class="string">&quot;Wrong RDB checksum. Aborting now.&quot;</span>);</span><br><span class="line">                rdbExitReportCorruptRDB(<span class="string">&quot;RDB CRC error&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line"></span><br><span class="line">eoferr: <span class="comment">/* unexpected end of file is handled here with a fatal exit */</span></span><br><span class="line">    serverLog(LL_WARNING,<span class="string">&quot;Short read or OOM loading DB. Unrecoverable error, aborting now.&quot;</span>);</span><br><span class="line">    rdbExitReportCorruptRDB(<span class="string">&quot;Unexpected EOF reading RDB file&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> C_ERR; <span class="comment">/* Just to avoid warning */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbLoad"><a href="#rdbLoad" class="headerlink" title="rdbLoad"></a>rdbLoad</h4><p>从指定文件中加载rdb</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbLoad</span><span class="params">(<span class="keyword">char</span> *filename, rdbSaveInfo *rsi)</span> </span>&#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    rio rdb;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fp = fopen(filename,<span class="string">&quot;r&quot;</span>)) == <span class="literal">NULL</span>) <span class="keyword">return</span> C_ERR;</span><br><span class="line">    startLoading(fp);</span><br><span class="line">    rioInitWithFile(&amp;rdb,fp);</span><br><span class="line">    retval = rdbLoadRio(&amp;rdb,rsi,<span class="number">0</span>);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    stopLoading();</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="backgroundSaveDoneHandlerDisk"><a href="#backgroundSaveDoneHandlerDisk" class="headerlink" title="backgroundSaveDoneHandlerDisk"></a>backgroundSaveDoneHandlerDisk</h4><p>以子进程执行rdb持久化时，子进程结束后，处理后续工作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backgroundSaveDoneHandlerDisk</span><span class="params">(<span class="keyword">int</span> exitcode, <span class="keyword">int</span> bysignal)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 成功：重新计算数据库更改次数`server.dirty`，归零保存开始时间，标记上一次操作状态为成功</span></span><br><span class="line">    <span class="keyword">if</span> (!bysignal &amp;&amp; exitcode == <span class="number">0</span>) &#123;</span><br><span class="line">        serverLog(LL_NOTICE,</span><br><span class="line">            <span class="string">&quot;Background saving terminated with success&quot;</span>);</span><br><span class="line">        server.dirty = server.dirty - server.dirty_before_bgsave;</span><br><span class="line">        server.lastsave = time(<span class="literal">NULL</span>);</span><br><span class="line">        server.lastbgsave_status = C_OK;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!bysignal &amp;&amp; exitcode != <span class="number">0</span>) &#123;</span><br><span class="line">        serverLog(LL_WARNING, <span class="string">&quot;Background saving error&quot;</span>);</span><br><span class="line">        server.lastbgsave_status = C_ERR;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">mstime_t</span> latency;</span><br><span class="line"></span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Background saving terminated by signal %d&quot;</span>, bysignal);</span><br><span class="line">        latencyStartMonitor(latency);</span><br><span class="line">        rdbRemoveTempFile(server.rdb_child_pid);</span><br><span class="line">        latencyEndMonitor(latency);</span><br><span class="line">        latencyAddSampleIfNeeded(<span class="string">&quot;rdb-unlink-temp-file&quot;</span>,latency);</span><br><span class="line">        <span class="comment">/* SIGUSR1 is whitelisted, so we have a way to kill a child without</span></span><br><span class="line"><span class="comment">         * tirggering an error condition. */</span></span><br><span class="line">        <span class="keyword">if</span> (bysignal != SIGUSR1)</span><br><span class="line">            server.lastbgsave_status = C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    server.rdb_child_pid = <span class="number">-1</span>;</span><br><span class="line">    server.rdb_child_type = RDB_CHILD_TYPE_NONE;</span><br><span class="line">    server.rdb_save_time_last = time(<span class="literal">NULL</span>)-server.rdb_save_time_start;</span><br><span class="line">    server.rdb_save_time_start = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">/* Possibly there are slaves waiting for a BGSAVE in order to be served</span></span><br><span class="line"><span class="comment">     * (the first stage of SYNC is a bulk transfer of dump.rdb) */</span></span><br><span class="line">    updateSlavesWaitingBgsave((!bysignal &amp;&amp; exitcode == <span class="number">0</span>) ? C_OK : C_ERR, RDB_CHILD_TYPE_DISK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="backgroundSaveDoneHandlerSocket"><a href="#backgroundSaveDoneHandlerSocket" class="headerlink" title="backgroundSaveDoneHandlerSocket"></a>backgroundSaveDoneHandlerSocket</h4><p>以子进程执行rdb，为了主从同步，子进程结束后，处理后续工作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backgroundSaveDoneHandlerSocket</span><span class="params">(<span class="keyword">int</span> exitcode, <span class="keyword">int</span> bysignal)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> *ok_slaves;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!bysignal &amp;&amp; exitcode == <span class="number">0</span>) &#123;</span><br><span class="line">        serverLog(LL_NOTICE,</span><br><span class="line">            <span class="string">&quot;Background RDB transfer terminated with success&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!bysignal &amp;&amp; exitcode != <span class="number">0</span>) &#123;</span><br><span class="line">        serverLog(LL_WARNING, <span class="string">&quot;Background transfer error&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Background transfer terminated by signal %d&quot;</span>, bysignal);</span><br><span class="line">    &#125;</span><br><span class="line">    server.rdb_child_pid = <span class="number">-1</span>;</span><br><span class="line">    server.rdb_child_type = RDB_CHILD_TYPE_NONE;</span><br><span class="line">    server.rdb_save_time_start = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the child returns an OK exit code, read the set of slave client</span></span><br><span class="line"><span class="comment">     * IDs and the associated status code. We&#x27;ll terminate all the slaves</span></span><br><span class="line"><span class="comment">     * in error state.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * If the process returned an error, consider the list of slaves that</span></span><br><span class="line"><span class="comment">     * can continue to be empty, so that it&#x27;s just a special case of the</span></span><br><span class="line"><span class="comment">     * normal code path. */</span></span><br><span class="line">    ok_slaves = zmalloc(<span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)); <span class="comment">/* Make space for the count. */</span></span><br><span class="line">    ok_slaves[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!bysignal &amp;&amp; exitcode == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> readlen = <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (read(server.rdb_pipe_read_result_from_child, ok_slaves, readlen) ==</span><br><span class="line">                 readlen)</span><br><span class="line">        &#123;</span><br><span class="line">            readlen = ok_slaves[<span class="number">0</span>]*<span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)*<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Make space for enough elements as specified by the first</span></span><br><span class="line"><span class="comment">             * uint64_t element in the array. */</span></span><br><span class="line">            ok_slaves = zrealloc(ok_slaves,<span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)+readlen);</span><br><span class="line">            <span class="keyword">if</span> (readlen &amp;&amp;</span><br><span class="line">                read(server.rdb_pipe_read_result_from_child, ok_slaves+<span class="number">1</span>,</span><br><span class="line">                     readlen) != readlen)</span><br><span class="line">            &#123;</span><br><span class="line">                ok_slaves[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(server.rdb_pipe_read_result_from_child);</span><br><span class="line">    close(server.rdb_pipe_write_result_to_parent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We can continue the replication process with all the slaves that</span></span><br><span class="line"><span class="comment">     * correctly received the full payload. Others are terminated. */</span></span><br><span class="line">    listNode *ln;</span><br><span class="line">    listIter li;</span><br><span class="line"></span><br><span class="line">    listRewind(server.slaves,&amp;li);</span><br><span class="line">    <span class="keyword">while</span>((ln = listNext(&amp;li))) &#123;</span><br><span class="line">        client *slave = ln-&gt;value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (slave-&gt;replstate == SLAVE_STATE_WAIT_BGSAVE_END) &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> j;</span><br><span class="line">            <span class="keyword">int</span> errorcode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Search for the slave ID in the reply. In order for a slave to</span></span><br><span class="line"><span class="comment">             * continue the replication process, we need to find it in the list,</span></span><br><span class="line"><span class="comment">             * and it must have an error code set to 0 (which means success). */</span></span><br><span class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; ok_slaves[<span class="number">0</span>]; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (slave-&gt;id == ok_slaves[<span class="number">2</span>*j+<span class="number">1</span>]) &#123;</span><br><span class="line">                    errorcode = ok_slaves[<span class="number">2</span>*j+<span class="number">2</span>];</span><br><span class="line">                    <span class="keyword">break</span>; <span class="comment">/* Found in slaves list. */</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (j == ok_slaves[<span class="number">0</span>] || errorcode != <span class="number">0</span>) &#123;</span><br><span class="line">                serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">&quot;Closing slave %s: child-&gt;slave RDB transfer failed: %s&quot;</span>,</span><br><span class="line">                    replicationGetSlaveName(slave),</span><br><span class="line">                    (errorcode == <span class="number">0</span>) ? <span class="string">&quot;RDB transfer child aborted&quot;</span></span><br><span class="line">                                     : strerror(errorcode));</span><br><span class="line">                freeClient(slave);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">&quot;Slave %s correctly received the streamed RDB file.&quot;</span>,</span><br><span class="line">                    replicationGetSlaveName(slave));</span><br><span class="line">                <span class="comment">/* Restore the socket as non-blocking. */</span></span><br><span class="line">                anetNonBlock(<span class="literal">NULL</span>,slave-&gt;fd);</span><br><span class="line">                anetSendTimeout(<span class="literal">NULL</span>,slave-&gt;fd,<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    zfree(ok_slaves);</span><br><span class="line"></span><br><span class="line">    updateSlavesWaitingBgsave((!bysignal &amp;&amp; exitcode == <span class="number">0</span>) ? C_OK : C_ERR, RDB_CHILD_TYPE_SOCKET);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="backgroundSaveDoneHandler"><a href="#backgroundSaveDoneHandler" class="headerlink" title="backgroundSaveDoneHandler"></a>backgroundSaveDoneHandler</h4><p>以子进程执行rdb，进程结束后，处理后续工作总的入口，分为两类持久化到磁盘&amp;主从同步</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backgroundSaveDoneHandler</span><span class="params">(<span class="keyword">int</span> exitcode, <span class="keyword">int</span> bysignal)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(server.rdb_child_type) &#123;</span><br><span class="line">    <span class="keyword">case</span> RDB_CHILD_TYPE_DISK:</span><br><span class="line">        backgroundSaveDoneHandlerDisk(exitcode,bysignal);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> RDB_CHILD_TYPE_SOCKET:</span><br><span class="line">        backgroundSaveDoneHandlerSocket(exitcode,bysignal);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        serverPanic(<span class="string">&quot;Unknown RDB child type.&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbSaveToSlavesSockets"><a href="#rdbSaveToSlavesSockets" class="headerlink" title="rdbSaveToSlavesSockets"></a>rdbSaveToSlavesSockets</h4><p>生成rdb文件，把该文件同步给从节点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rdbSaveToSlavesSockets</span><span class="params">(rdbSaveInfo *rsi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> *fds;</span><br><span class="line">    <span class="keyword">uint64_t</span> *clientids;</span><br><span class="line">    <span class="keyword">int</span> numfds;</span><br><span class="line">    listNode *ln;</span><br><span class="line">    listIter li;</span><br><span class="line">    <span class="keyword">pid_t</span> childpid;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> start;</span><br><span class="line">    <span class="keyword">int</span> pipefds[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.aof_child_pid != <span class="number">-1</span> || server.rdb_child_pid != <span class="number">-1</span>) <span class="keyword">return</span> C_ERR;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Before to fork, create a pipe that will be used in order to</span></span><br><span class="line"><span class="comment">     * send back to the parent the IDs of the slaves that successfully</span></span><br><span class="line"><span class="comment">     * received all the writes. */</span></span><br><span class="line">    <span class="keyword">if</span> (pipe(pipefds) == <span class="number">-1</span>) <span class="keyword">return</span> C_ERR;</span><br><span class="line">    server.rdb_pipe_read_result_from_child = pipefds[<span class="number">0</span>];</span><br><span class="line">    server.rdb_pipe_write_result_to_parent = pipefds[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Collect the file descriptors of the slaves we want to transfer</span></span><br><span class="line"><span class="comment">     * the RDB to, which are i WAIT_BGSAVE_START state. */</span></span><br><span class="line">    fds = zmalloc(<span class="keyword">sizeof</span>(<span class="keyword">int</span>)*listLength(server.slaves));</span><br><span class="line">    <span class="comment">/* We also allocate an array of corresponding client IDs. This will</span></span><br><span class="line"><span class="comment">     * be useful for the child process in order to build the report</span></span><br><span class="line"><span class="comment">     * (sent via unix pipe) that will be sent to the parent. */</span></span><br><span class="line">    clientids = zmalloc(<span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)*listLength(server.slaves));</span><br><span class="line">    numfds = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    listRewind(server.slaves,&amp;li);</span><br><span class="line">    <span class="keyword">while</span>((ln = listNext(&amp;li))) &#123;</span><br><span class="line">        client *slave = ln-&gt;value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (slave-&gt;replstate == SLAVE_STATE_WAIT_BGSAVE_START) &#123;</span><br><span class="line">            clientids[numfds] = slave-&gt;id;</span><br><span class="line">            fds[numfds++] = slave-&gt;fd;</span><br><span class="line">            replicationSetupSlaveForFullResync(slave,getPsyncInitialOffset());</span><br><span class="line">            <span class="comment">/* Put the socket in blocking mode to simplify RDB transfer.</span></span><br><span class="line"><span class="comment">             * We&#x27;ll restore it when the children returns (since duped socket</span></span><br><span class="line"><span class="comment">             * will share the O_NONBLOCK attribute with the parent). */</span></span><br><span class="line">            anetBlock(<span class="literal">NULL</span>,slave-&gt;fd);</span><br><span class="line">            anetSendTimeout(<span class="literal">NULL</span>,slave-&gt;fd,server.repl_timeout*<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create the child process. */</span></span><br><span class="line">    openChildInfoPipe();</span><br><span class="line">    start = ustime();</span><br><span class="line">    <span class="keyword">if</span> ((childpid = fork()) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* Child */</span></span><br><span class="line">        <span class="keyword">int</span> retval;</span><br><span class="line">        rio slave_sockets;</span><br><span class="line"></span><br><span class="line">        rioInitWithFdset(&amp;slave_sockets,fds,numfds);</span><br><span class="line">        zfree(fds);</span><br><span class="line"></span><br><span class="line">        closeListeningSockets(<span class="number">0</span>);</span><br><span class="line">        redisSetProcTitle(<span class="string">&quot;redis-rdb-to-slaves&quot;</span>);</span><br><span class="line"></span><br><span class="line">        retval = rdbSaveRioWithEOFMark(&amp;slave_sockets,<span class="literal">NULL</span>,rsi);</span><br><span class="line">        <span class="keyword">if</span> (retval == C_OK &amp;&amp; rioFlush(&amp;slave_sockets) == <span class="number">0</span>)</span><br><span class="line">            retval = C_ERR;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (retval == C_OK) &#123;</span><br><span class="line">            <span class="keyword">size_t</span> private_dirty = zmalloc_get_private_dirty(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (private_dirty) &#123;</span><br><span class="line">                serverLog(LL_NOTICE,</span><br><span class="line">                    <span class="string">&quot;RDB: %zu MB of memory used by copy-on-write&quot;</span>,</span><br><span class="line">                    private_dirty/(<span class="number">1024</span>*<span class="number">1024</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            server.child_info_data.cow_size = private_dirty;</span><br><span class="line">            sendChildInfo(CHILD_INFO_TYPE_RDB);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* If we are returning OK, at least one slave was served</span></span><br><span class="line"><span class="comment">             * with the RDB file as expected, so we need to send a report</span></span><br><span class="line"><span class="comment">             * to the parent via the pipe. The format of the message is:</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * &lt;len&gt; &lt;slave[0].id&gt; &lt;slave[0].error&gt; ...</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * len, slave IDs, and slave errors, are all uint64_t integers,</span></span><br><span class="line"><span class="comment">             * so basically the reply is composed of 64 bits for the len field</span></span><br><span class="line"><span class="comment">             * plus 2 additional 64 bit integers for each entry, for a total</span></span><br><span class="line"><span class="comment">             * of &#x27;len&#x27; entries.</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * The &#x27;id&#x27; represents the slave&#x27;s client ID, so that the master</span></span><br><span class="line"><span class="comment">             * can match the report with a specific slave, and &#x27;error&#x27; is</span></span><br><span class="line"><span class="comment">             * set to 0 if the replication process terminated with a success</span></span><br><span class="line"><span class="comment">             * or the error code if an error occurred. */</span></span><br><span class="line">            <span class="keyword">void</span> *msg = zmalloc(<span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)*(<span class="number">1</span>+<span class="number">2</span>*numfds));</span><br><span class="line">            <span class="keyword">uint64_t</span> *len = msg;</span><br><span class="line">            <span class="keyword">uint64_t</span> *ids = len+<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">int</span> j, msglen;</span><br><span class="line"></span><br><span class="line">            *len = numfds;</span><br><span class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; numfds; j++) &#123;</span><br><span class="line">                *ids++ = clientids[j];</span><br><span class="line">                *ids++ = slave_sockets.io.fdset.state[j];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Write the message to the parent. If we have no good slaves or</span></span><br><span class="line"><span class="comment">             * we are unable to transfer the message to the parent, we exit</span></span><br><span class="line"><span class="comment">             * with an error so that the parent will abort the replication</span></span><br><span class="line"><span class="comment">             * process with all the childre that were waiting. */</span></span><br><span class="line">            msglen = <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)*(<span class="number">1</span>+<span class="number">2</span>*numfds);</span><br><span class="line">            <span class="keyword">if</span> (*len == <span class="number">0</span> ||</span><br><span class="line">                write(server.rdb_pipe_write_result_to_parent,msg,msglen)</span><br><span class="line">                != msglen)</span><br><span class="line">            &#123;</span><br><span class="line">                retval = C_ERR;</span><br><span class="line">            &#125;</span><br><span class="line">            zfree(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        zfree(clientids);</span><br><span class="line">        rioFreeFdset(&amp;slave_sockets);</span><br><span class="line">        exitFromChild((retval == C_OK) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* Parent */</span></span><br><span class="line">        <span class="keyword">if</span> (childpid == <span class="number">-1</span>) &#123;</span><br><span class="line">            serverLog(LL_WARNING,<span class="string">&quot;Can&#x27;t save in background: fork: %s&quot;</span>,</span><br><span class="line">                strerror(errno));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Undo the state change. The caller will perform cleanup on</span></span><br><span class="line"><span class="comment">             * all the slaves in BGSAVE_START state, but an early call to</span></span><br><span class="line"><span class="comment">             * replicationSetupSlaveForFullResync() turned it into BGSAVE_END */</span></span><br><span class="line">            listRewind(server.slaves,&amp;li);</span><br><span class="line">            <span class="keyword">while</span>((ln = listNext(&amp;li))) &#123;</span><br><span class="line">                client *slave = ln-&gt;value;</span><br><span class="line">                <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; numfds; j++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (slave-&gt;id == clientids[j]) &#123;</span><br><span class="line">                        slave-&gt;replstate = SLAVE_STATE_WAIT_BGSAVE_START;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            close(pipefds[<span class="number">0</span>]);</span><br><span class="line">            close(pipefds[<span class="number">1</span>]);</span><br><span class="line">            closeChildInfoPipe();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            server.stat_fork_time = ustime()-start;</span><br><span class="line">            server.stat_fork_rate = (<span class="keyword">double</span>) zmalloc_used_memory() * <span class="number">1000000</span> / server.stat_fork_time / (<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>); <span class="comment">/* GB per second. */</span></span><br><span class="line">            latencyAddSampleIfNeeded(<span class="string">&quot;fork&quot;</span>,server.stat_fork_time/<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">            serverLog(LL_NOTICE,<span class="string">&quot;Background RDB transfer started by pid %d&quot;</span>,</span><br><span class="line">                childpid);</span><br><span class="line">            server.rdb_save_time_start = time(<span class="literal">NULL</span>);</span><br><span class="line">            server.rdb_child_pid = childpid;</span><br><span class="line">            server.rdb_child_type = RDB_CHILD_TYPE_SOCKET;</span><br><span class="line">            updateDictResizePolicy();</span><br><span class="line">        &#125;</span><br><span class="line">        zfree(clientids);</span><br><span class="line">        zfree(fds);</span><br><span class="line">        <span class="keyword">return</span> (childpid == <span class="number">-1</span>) ? C_ERR : C_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> C_OK; <span class="comment">/* Unreached. */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="saveCommand"><a href="#saveCommand" class="headerlink" title="saveCommand"></a>saveCommand</h4><p>客户端执行<code>save</code>命令，同步执行rdb</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (server.rdb_child_pid != <span class="number">-1</span>) &#123;</span><br><span class="line">        addReplyError(c,<span class="string">&quot;Background save already in progress&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    rdbSaveInfo rsi, *rsiptr;</span><br><span class="line">    rsiptr = rdbPopulateSaveInfo(&amp;rsi);</span><br><span class="line">    <span class="keyword">if</span> (rdbSave(server.rdb_filename,rsiptr) == C_OK) &#123;</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addReply(c,shared.err);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="bgsaveCommand"><a href="#bgsaveCommand" class="headerlink" title="bgsaveCommand"></a>bgsaveCommand</h4><p>客户端执行<code>bgsave</code>命令，分两种情况，一种是现在立即执行，一种是计划任务(如果现在不能执行的话，在后面serverCron中执行，如果满足条件的话)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bgsaveCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> schedule = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The SCHEDULE option changes the behavior of BGSAVE when an AOF rewrite</span></span><br><span class="line"><span class="comment">     * is in progress. Instead of returning an error a BGSAVE gets scheduled. */</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;argc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc == <span class="number">2</span> &amp;&amp; !strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;schedule&quot;</span>)) &#123;</span><br><span class="line">            schedule = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addReply(c,shared.syntaxerr);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rdbSaveInfo rsi, *rsiptr;</span><br><span class="line">    rsiptr = rdbPopulateSaveInfo(&amp;rsi);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.rdb_child_pid != <span class="number">-1</span>) &#123;</span><br><span class="line">        addReplyError(c,<span class="string">&quot;Background save already in progress&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (server.aof_child_pid != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (schedule) &#123;</span><br><span class="line">            server.rdb_bgsave_scheduled = <span class="number">1</span>;</span><br><span class="line">            addReplyStatus(c,<span class="string">&quot;Background saving scheduled&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addReplyError(c,</span><br><span class="line">                <span class="string">&quot;An AOF log rewriting in progress: can&#x27;t BGSAVE right now. &quot;</span></span><br><span class="line">                <span class="string">&quot;Use BGSAVE SCHEDULE in order to schedule a BGSAVE whenever &quot;</span></span><br><span class="line">                <span class="string">&quot;possible.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rdbSaveBackground(server.rdb_filename,rsiptr) == C_OK) &#123;</span><br><span class="line">        addReplyStatus(c,<span class="string">&quot;Background saving started&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addReply(c,shared.err);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbPopulateSaveInfo"><a href="#rdbPopulateSaveInfo" class="headerlink" title="rdbPopulateSaveInfo"></a>rdbPopulateSaveInfo</h4><p>填充<code>rdbSaveInfo</code>结构体，结构体的信息影响到rdb的动作，主要是主从同步的附带信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">rdbSaveInfo *<span class="title">rdbPopulateSaveInfo</span><span class="params">(rdbSaveInfo *rsi)</span> </span>&#123;</span><br><span class="line">    rdbSaveInfo rsi_init = RDB_SAVE_INFO_INIT;</span><br><span class="line">    *rsi = rsi_init;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前实例是主节点，且主节点同步缓冲区有内容</span></span><br><span class="line">    <span class="keyword">if</span> (!server.masterhost &amp;&amp; server.repl_backlog) &#123;</span><br><span class="line">        <span class="comment">// slaveseldb==-1 表示主节点从上次全量同步之后没有响应任何写命令。这时候就写-1，等下次响应写命令后，就会变化</span></span><br><span class="line">        rsi-&gt;repl_stream_db = server.slaveseldb == <span class="number">-1</span> ? <span class="number">0</span> : server.slaveseldb;</span><br><span class="line">        <span class="keyword">return</span> rsi;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前节点是从节点，带上主节点的dbId</span></span><br><span class="line">    <span class="keyword">if</span> (server.master) &#123;</span><br><span class="line">        rsi-&gt;repl_stream_db = server.master-&gt;db-&gt;id;</span><br><span class="line">        <span class="keyword">return</span> rsi;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (server.cached_master) &#123;</span><br><span class="line">        rsi-&gt;repl_stream_db = server.cached_master-&gt;db-&gt;id;</span><br><span class="line">        <span class="keyword">return</span> rsi;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"d86b0f2f03d666a5b4d5","clientSecret":"b0a4cdac98cafbe6f866ea2b76d0800306bda397","repo":"suntw2015","owner":"suntw2015","admin":["suntw2015"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/redis/" rel="tag"># redis</a>
              <a href="/tags/%E6%8C%81%E4%B9%85%E5%8C%96/" rel="tag"># 持久化</a>
              <a href="/tags/rdb/" rel="tag"># rdb</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/08/22/redis-rio/" rel="prev" title="redis-rio">
                  <i class="fa fa-chevron-left"></i> redis-rio
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/09/16/redis-replication/" rel="next" title="redis-主从">
                  redis-主从 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">孙天文</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
