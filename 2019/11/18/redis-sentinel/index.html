<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"suntw2015.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.3.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="为了提高redis服务的高可用性，redis提供了一个哨兵模式。在该模式下，哨兵会做以下三件事：  监控master节点和slave节点的运行情况； 当某个节点出现异常时，通知告警当前情况； 当master节点发生故障时，哨兵会从slave节点中挑选一个节点成为新的master，并通知其他的slave节点将服务器配置改为新的master，当客户端尝试连接原来的master时，会向客户端返回新的ma">
<meta property="og:type" content="article">
<meta property="og:title" content="redis-哨兵">
<meta property="og:url" content="http://suntw2015.github.io/2019/11/18/redis-sentinel/index.html">
<meta property="og:site_name" content="MadeLife">
<meta property="og:description" content="为了提高redis服务的高可用性，redis提供了一个哨兵模式。在该模式下，哨兵会做以下三件事：  监控master节点和slave节点的运行情况； 当某个节点出现异常时，通知告警当前情况； 当master节点发生故障时，哨兵会从slave节点中挑选一个节点成为新的master，并通知其他的slave节点将服务器配置改为新的master，当客户端尝试连接原来的master时，会向客户端返回新的ma">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://suntw2015.github.io/images/redis-sentinel-find.png">
<meta property="og:image" content="http://suntw2015.github.io/images/redis-sentinel-run.png">
<meta property="og:image" content="http://suntw2015.github.io/images/redis-sentinel-down.png">
<meta property="og:image" content="http://suntw2015.github.io/images/redis-sentinel-failover.png">
<meta property="article:published_time" content="2019-11-18T02:55:37.000Z">
<meta property="article:modified_time" content="2021-04-06T04:02:09.194Z">
<meta property="article:author" content="孙天文">
<meta property="article:tag" content="redis">
<meta property="article:tag" content="sentinel">
<meta property="article:tag" content="哨兵">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://suntw2015.github.io/images/redis-sentinel-find.png">


<link rel="canonical" href="http://suntw2015.github.io/2019/11/18/redis-sentinel/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>redis-哨兵 | MadeLife</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">MadeLife</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8"><span class="nav-number">1.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="nav-number">2.</span> <span class="nav-text">运行原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84"><span class="nav-number">2.1.</span> <span class="nav-text">获取拓扑结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7"><span class="nav-number">2.2.</span> <span class="nav-text">监控</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8A%A5%E8%AD%A6"><span class="nav-number">2.3.</span> <span class="nav-text">报警</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E4%BF%AE%E5%A4%8D"><span class="nav-number">2.4.</span> <span class="nav-text">故障修复</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.5.</span> <span class="nav-text">配置文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.1.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redisAeReadEvent"><span class="nav-number">3.2.</span> <span class="nav-text">redisAeReadEvent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redisAeWriteEvent"><span class="nav-number">3.3.</span> <span class="nav-text">redisAeWriteEvent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redisAeAddRead"><span class="nav-number">3.4.</span> <span class="nav-text">redisAeAddRead</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redisAeDelRead"><span class="nav-number">3.5.</span> <span class="nav-text">redisAeDelRead</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redisAeAddWrite"><span class="nav-number">3.6.</span> <span class="nav-text">redisAeAddWrite</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redisAeDelWrite"><span class="nav-number">3.7.</span> <span class="nav-text">redisAeDelWrite</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redisAeCleanup"><span class="nav-number">3.8.</span> <span class="nav-text">redisAeCleanup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redisAeAttach"><span class="nav-number">3.9.</span> <span class="nav-text">redisAeAttach</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%8E%A5%E5%8F%97%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="nav-number">3.10.</span> <span class="nav-text">哨兵模式下接受的命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#initSentinelConfig"><span class="nav-number">3.11.</span> <span class="nav-text">initSentinelConfig</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#initSentinel"><span class="nav-number">3.12.</span> <span class="nav-text">initSentinel</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sentinelIsRunning"><span class="nav-number">3.13.</span> <span class="nav-text">sentinelIsRunning</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#createSentinelAddr"><span class="nav-number">3.14.</span> <span class="nav-text">createSentinelAddr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dupSentinelAddr"><span class="nav-number">3.15.</span> <span class="nav-text">dupSentinelAddr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#releaseSentinelAddr"><span class="nav-number">3.16.</span> <span class="nav-text">releaseSentinelAddr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sentinelAddrIsEqual"><span class="nav-number">3.17.</span> <span class="nav-text">sentinelAddrIsEqual</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sentinelEvent"><span class="nav-number">3.18.</span> <span class="nav-text">sentinelEvent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sentinelGenerateInitialMonitorEvents"><span class="nav-number">3.19.</span> <span class="nav-text">sentinelGenerateInitialMonitorEvents</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC"><span class="nav-number">3.20.</span> <span class="nav-text">脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelReleaseScriptJob"><span class="nav-number">3.20.1.</span> <span class="nav-text">sentinelReleaseScriptJob</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelScheduleScriptExecution"><span class="nav-number">3.20.2.</span> <span class="nav-text">sentinelScheduleScriptExecution</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelGetScriptListNodeByPid"><span class="nav-number">3.20.3.</span> <span class="nav-text">sentinelGetScriptListNodeByPid</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelRunPendingScripts"><span class="nav-number">3.20.4.</span> <span class="nav-text">sentinelRunPendingScripts</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelScriptRetryDelay"><span class="nav-number">3.20.5.</span> <span class="nav-text">sentinelScriptRetryDelay</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelCollectTerminatedScripts"><span class="nav-number">3.20.6.</span> <span class="nav-text">sentinelCollectTerminatedScripts</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelKillTimedoutScripts"><span class="nav-number">3.20.7.</span> <span class="nav-text">sentinelKillTimedoutScripts</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelPendingScriptsCommand"><span class="nav-number">3.20.8.</span> <span class="nav-text">sentinelPendingScriptsCommand</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelCallClientReconfScript"><span class="nav-number">3.20.9.</span> <span class="nav-text">sentinelCallClientReconfScript</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E7%9B%B8%E5%85%B3"><span class="nav-number">3.21.</span> <span class="nav-text">连接相关</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#createInstanceLink"><span class="nav-number">3.21.1.</span> <span class="nav-text">createInstanceLink</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#instanceLinkCloseConnection"><span class="nav-number">3.21.2.</span> <span class="nav-text">instanceLinkCloseConnection</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#releaseInstanceLink"><span class="nav-number">3.21.3.</span> <span class="nav-text">releaseInstanceLink</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelTryConnectionSharing"><span class="nav-number">3.21.4.</span> <span class="nav-text">sentinelTryConnectionSharing</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelUpdateSentinelAddressInAllMasters"><span class="nav-number">3.21.5.</span> <span class="nav-text">sentinelUpdateSentinelAddressInAllMasters</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#instanceLinkConnectionError"><span class="nav-number">3.21.6.</span> <span class="nav-text">instanceLinkConnectionError</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelLinkEstablishedCallback"><span class="nav-number">3.21.7.</span> <span class="nav-text">sentinelLinkEstablishedCallback</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelDisconnectCallback"><span class="nav-number">3.21.8.</span> <span class="nav-text">sentinelDisconnectCallback</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%93%A8%E5%85%B5%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E5%AE%9E%E4%BE%8B"><span class="nav-number">3.22.</span> <span class="nav-text">哨兵管理节点实例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#createSentinelRedisInstance"><span class="nav-number">3.22.1.</span> <span class="nav-text">createSentinelRedisInstance</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#releaseSentinelRedisInstance"><span class="nav-number">3.22.2.</span> <span class="nav-text">releaseSentinelRedisInstance</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelRedisInstanceLookupSlave"><span class="nav-number">3.22.3.</span> <span class="nav-text">sentinelRedisInstanceLookupSlave</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelRedisInstanceTypeStr"><span class="nav-number">3.22.4.</span> <span class="nav-text">sentinelRedisInstanceTypeStr</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#removeMatchingSentinelFromMaster"><span class="nav-number">3.22.5.</span> <span class="nav-text">removeMatchingSentinelFromMaster</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#getSentinelRedisInstanceByAddrAndRunID"><span class="nav-number">3.22.6.</span> <span class="nav-text">getSentinelRedisInstanceByAddrAndRunID</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelGetMasterByName"><span class="nav-number">3.22.7.</span> <span class="nav-text">sentinelGetMasterByName</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelAddFlagsToDictOfRedisInstances"><span class="nav-number">3.22.8.</span> <span class="nav-text">sentinelAddFlagsToDictOfRedisInstances</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelDelFlagsToDictOfRedisInstances"><span class="nav-number">3.22.9.</span> <span class="nav-text">sentinelDelFlagsToDictOfRedisInstances</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelResetMaster"><span class="nav-number">3.22.10.</span> <span class="nav-text">sentinelResetMaster</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelResetMastersByPattern"><span class="nav-number">3.22.11.</span> <span class="nav-text">sentinelResetMastersByPattern</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelResetMasterAndChangeAddress"><span class="nav-number">3.22.12.</span> <span class="nav-text">sentinelResetMasterAndChangeAddress</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelRedisInstanceNoDownFor"><span class="nav-number">3.22.13.</span> <span class="nav-text">sentinelRedisInstanceNoDownFor</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelGetCurrentMasterAddress"><span class="nav-number">3.22.14.</span> <span class="nav-text">sentinelGetCurrentMasterAddress</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelPropagateDownAfterPeriod"><span class="nav-number">3.22.15.</span> <span class="nav-text">sentinelPropagateDownAfterPeriod</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelGetInstanceTypeString"><span class="nav-number">3.22.16.</span> <span class="nav-text">sentinelGetInstanceTypeString</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelInstanceMapCommand"><span class="nav-number">3.22.17.</span> <span class="nav-text">sentinelInstanceMapCommand</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%9B%B8%E5%85%B3"><span class="nav-number">3.23.</span> <span class="nav-text">配置相关</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelHandleConfiguration"><span class="nav-number">3.23.1.</span> <span class="nav-text">sentinelHandleConfiguration</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#rewriteConfigSentinelOption"><span class="nav-number">3.23.2.</span> <span class="nav-text">rewriteConfigSentinelOption</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelFlushConfig"><span class="nav-number">3.23.3.</span> <span class="nav-text">sentinelFlushConfig</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#hiredis"><span class="nav-number">3.24.</span> <span class="nav-text">hiredis</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelSendAuthIfNeeded"><span class="nav-number">3.24.1.</span> <span class="nav-text">sentinelSendAuthIfNeeded</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelSetClientName"><span class="nav-number">3.24.2.</span> <span class="nav-text">sentinelSetClientName</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelReconnectInstance"><span class="nav-number">3.24.3.</span> <span class="nav-text">sentinelReconnectInstance</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelMasterLooksSane"><span class="nav-number">3.24.4.</span> <span class="nav-text">sentinelMasterLooksSane</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelRefreshInstanceInfo"><span class="nav-number">3.24.5.</span> <span class="nav-text">sentinelRefreshInstanceInfo</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelInfoReplyCallback"><span class="nav-number">3.24.6.</span> <span class="nav-text">sentinelInfoReplyCallback</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelDiscardReplyCallback"><span class="nav-number">3.24.7.</span> <span class="nav-text">sentinelDiscardReplyCallback</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelPingReplyCallback"><span class="nav-number">3.24.8.</span> <span class="nav-text">sentinelPingReplyCallback</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelPublishReplyCallback"><span class="nav-number">3.24.9.</span> <span class="nav-text">sentinelPublishReplyCallback</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelProcessHelloMessage"><span class="nav-number">3.24.10.</span> <span class="nav-text">sentinelProcessHelloMessage</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelReceiveHelloMessages"><span class="nav-number">3.24.11.</span> <span class="nav-text">sentinelReceiveHelloMessages</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelSendHello"><span class="nav-number">3.24.12.</span> <span class="nav-text">sentinelSendHello</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelForceHelloUpdateDictOfRedisInstances"><span class="nav-number">3.24.13.</span> <span class="nav-text">sentinelForceHelloUpdateDictOfRedisInstances</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelForceHelloUpdateForMaster"><span class="nav-number">3.24.14.</span> <span class="nav-text">sentinelForceHelloUpdateForMaster</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelSendPing"><span class="nav-number">3.24.15.</span> <span class="nav-text">sentinelSendPing</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelSendPeriodicCommands"><span class="nav-number">3.24.16.</span> <span class="nav-text">sentinelSendPeriodicCommands</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%93%8D%E5%BA%94%E5%91%BD%E4%BB%A4"><span class="nav-number">3.25.</span> <span class="nav-text">响应命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelFailoverStateStr"><span class="nav-number">3.25.1.</span> <span class="nav-text">sentinelFailoverStateStr</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#addReplySentinelRedisInstance"><span class="nav-number">3.25.2.</span> <span class="nav-text">addReplySentinelRedisInstance</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#addReplyDictOfRedisInstances"><span class="nav-number">3.25.3.</span> <span class="nav-text">addReplyDictOfRedisInstances</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelGetMasterByNameOrReplyError"><span class="nav-number">3.25.4.</span> <span class="nav-text">sentinelGetMasterByNameOrReplyError</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelIsQuorumReachable"><span class="nav-number">3.25.5.</span> <span class="nav-text">sentinelIsQuorumReachable</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelCommand"><span class="nav-number">3.25.6.</span> <span class="nav-text">sentinelCommand</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelInfoCommand"><span class="nav-number">3.25.7.</span> <span class="nav-text">sentinelInfoCommand</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelRoleCommand"><span class="nav-number">3.25.8.</span> <span class="nav-text">sentinelRoleCommand</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelSetCommand"><span class="nav-number">3.25.9.</span> <span class="nav-text">sentinelSetCommand</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelPublishCommand"><span class="nav-number">3.25.10.</span> <span class="nav-text">sentinelPublishCommand</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A4%E6%96%AD%E6%A0%A1%E9%AA%8C"><span class="nav-number">3.26.</span> <span class="nav-text">判断校验</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelCheckSubjectivelyDown"><span class="nav-number">3.26.1.</span> <span class="nav-text">sentinelCheckSubjectivelyDown</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelCheckObjectivelyDown"><span class="nav-number">3.26.2.</span> <span class="nav-text">sentinelCheckObjectivelyDown</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelReceiveIsMasterDownReply"><span class="nav-number">3.26.3.</span> <span class="nav-text">sentinelReceiveIsMasterDownReply</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelAskMasterStateToOtherSentinels"><span class="nav-number">3.26.4.</span> <span class="nav-text">sentinelAskMasterStateToOtherSentinels</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E4%BF%AE%E5%A4%8D-1"><span class="nav-number">3.27.</span> <span class="nav-text">故障修复</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelSimFailureCrash"><span class="nav-number">3.27.1.</span> <span class="nav-text">sentinelSimFailureCrash</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#sentinelVoteLeader"><span class="nav-number">3.27.1.1.</span> <span class="nav-text">sentinelVoteLeader</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelLeaderIncr"><span class="nav-number">3.27.2.</span> <span class="nav-text">sentinelLeaderIncr</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelGetLeader"><span class="nav-number">3.27.3.</span> <span class="nav-text">sentinelGetLeader</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelSendSlaveOf"><span class="nav-number">3.27.4.</span> <span class="nav-text">sentinelSendSlaveOf</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelStartFailover"><span class="nav-number">3.27.5.</span> <span class="nav-text">sentinelStartFailover</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelStartFailoverIfNeeded"><span class="nav-number">3.27.6.</span> <span class="nav-text">sentinelStartFailoverIfNeeded</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#compareSlavesForPromotion"><span class="nav-number">3.27.7.</span> <span class="nav-text">compareSlavesForPromotion</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelSelectSlave"><span class="nav-number">3.27.8.</span> <span class="nav-text">sentinelSelectSlave</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E4%BF%AE%E5%A4%8D%E5%90%84%E4%B8%AA%E8%8A%82%E7%82%B9%E5%A4%84%E7%90%86"><span class="nav-number">3.28.</span> <span class="nav-text">故障修复各个节点处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelFailoverWaitStart"><span class="nav-number">3.28.1.</span> <span class="nav-text">sentinelFailoverWaitStart</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelFailoverSelectSlave"><span class="nav-number">3.28.2.</span> <span class="nav-text">sentinelFailoverSelectSlave</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelFailoverSendSlaveOfNoOne"><span class="nav-number">3.28.3.</span> <span class="nav-text">sentinelFailoverSendSlaveOfNoOne</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelFailoverWaitPromotion"><span class="nav-number">3.28.4.</span> <span class="nav-text">sentinelFailoverWaitPromotion</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelFailoverDetectEnd"><span class="nav-number">3.28.5.</span> <span class="nav-text">sentinelFailoverDetectEnd</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelFailoverReconfNextSlave"><span class="nav-number">3.28.6.</span> <span class="nav-text">sentinelFailoverReconfNextSlave</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelFailoverSwitchToPromotedSlave"><span class="nav-number">3.28.7.</span> <span class="nav-text">sentinelFailoverSwitchToPromotedSlave</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelFailoverStateMachine"><span class="nav-number">3.28.8.</span> <span class="nav-text">sentinelFailoverStateMachine</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelAbortFailover"><span class="nav-number">3.28.9.</span> <span class="nav-text">sentinelAbortFailover</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="nav-number">3.29.</span> <span class="nav-text">定时任务</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelHandleRedisInstance"><span class="nav-number">3.29.1.</span> <span class="nav-text">sentinelHandleRedisInstance</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelHandleDictOfRedisInstances"><span class="nav-number">3.29.2.</span> <span class="nav-text">sentinelHandleDictOfRedisInstances</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelCheckTiltCondition"><span class="nav-number">3.29.3.</span> <span class="nav-text">sentinelCheckTiltCondition</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sentinelTimer"><span class="nav-number">3.29.4.</span> <span class="nav-text">sentinelTimer</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">孙天文</p>
  <div class="site-description" itemprop="description">记录一些随笔</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/suntw2015" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;suntw2015" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://suntw2015.github.io/2019/11/18/redis-sentinel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="孙天文">
      <meta itemprop="description" content="记录一些随笔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MadeLife">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          redis-哨兵
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-11-18 10:55:37" itemprop="dateCreated datePublished" datetime="2019-11-18T10:55:37+08:00">2019-11-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-04-06 12:02:09" itemprop="dateModified" datetime="2021-04-06T12:02:09+08:00">2021-04-06</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>为了提高redis服务的高可用性，redis提供了一个哨兵模式。在该模式下，哨兵会做以下三件事：</p>
<ol>
<li>监控master节点和slave节点的运行情况；</li>
<li>当某个节点出现异常时，通知告警当前情况；</li>
<li>当master节点发生故障时，哨兵会从slave节点中挑选一个节点成为新的master，并通知其他的slave节点将服务器配置改为新的master，当客户端尝试连接原来的master时，会向客户端返回新的master地址。当运行哨兵模式的时候，都是多个哨兵一起运行，否则哨兵只能提供监控&amp;告警的功能，故障修复功能则永远不会触发。</li>
</ol>
<span id="more"></span>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>哨兵是一种运行在redis-server下的特殊模式，可以通过<code>redis-server /path/to/sentinel.conf --sentinel</code>来启动，也可以直接通过<code>redis-sentinel /path/to/sentinel.conf</code>来启动。无论哪种形式启动，都必须指定哨兵的配置文件。</p>
<h3 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h3><h4 id="获取拓扑结构"><a href="#获取拓扑结构" class="headerlink" title="获取拓扑结构"></a>获取拓扑结构</h4><p>哨兵启动的时候，会指定需要监控的master节点信息，通过向master节点发送<code>info</code>命令，获取master下的所有slave节点信息。同时订阅master节点下的<code>__sentinel__:hello</code>频道来获取监控该master的其他哨兵。因为哨兵在监控一个master时，都会定时的向该频道发送自己的信息。如下图所示，左边是发现<code>slave</code>，右边是发现其他<code>sentinel</code><br><img src="/images/redis-sentinel-find.png"></p>
<h4 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h4><p>哨兵向自己发现的拓扑结构中的所有节点，定时发送<code>INFO</code>，<code>PING</code>命令检测节点的存活情况。对于<code>PING</code>命令，<code>PONG</code>正常响应、<code>LOADING</code>启动中、<code>MASTERDOWN</code>节点还没有连接上master都算是有效回复。对于<code>INFO</code>命令，除了获取拓扑结构外，也会根据返回的角色，来判断一个节点角色的变化。如果一个节点原本是slave，后面被人为的改成master，且原master是状态良好的话，哨兵会向该节点发送<code>slaveof ip port</code>命令，恢复原有的拓扑结构。正常运行情况如下所示：<br><img src="/images/redis-sentinel-run.png"></p>
<p>当一个节点最近一次的响应时间超过设置后，则该节点被当前哨兵标记成主观下线。<br>当一个节点被多个哨兵标记成主观下线后，改节点会被当前哨兵标记成客观下线，哨兵通过彼此间的交流得知他人的结果。主观下线只适用于master节点，哨兵节点和slave节点不存在该状态，如下图所示：<br><img src="/images/redis-sentinel-down.png"></p>
<h4 id="报警"><a href="#报警" class="headerlink" title="报警"></a>报警</h4><p>当哨兵发现各种异常后，会触发配置的脚本且向频道发布消息，部分频道如下：</p>
<ul>
<li><code>+slave</code> ：哨兵发现的新的slave节点</li>
<li><code>+sentinel</code> : 哨兵发现新的哨兵节点</li>
<li><code>+sdown</code> ：一个节点被标记成主观下线</li>
</ul>
<h4 id="故障修复"><a href="#故障修复" class="headerlink" title="故障修复"></a>故障修复</h4><p>当一个master节点被哨兵标记成客观下线后，哨兵之间会采用<code>Raft</code>算法选举出一个Leader。该Leader会进行以下操作：</p>
<ul>
<li>从该master节点的所有slave节点中选出一个，发送<code>slaveof no one</code>命令，使其成为新的master节点</li>
<li>通知其他哨兵，更新对应的配置</li>
<li>向其他的slave发送<code>slaveof ip port</code>命令，更换master</li>
<li>故障修复完成，恢复正常</li>
</ul>
<p>选举Leader的过程如下：</p>
<ul>
<li>哨兵发现节点变成客观下线，把自己的纪元+1，然后准备选举自己成为这个纪元内的leader</li>
<li>向其他哨兵同步信息的时候，带上自己的运行id，期望他人投自己一票</li>
<li>其他哨兵接收到选举信息后，如果发现消息里的纪元比自己的要大，那么就以消息里的为准，来更新自己的纪元，并为该消息里的哨兵投上自己的一票，然后返回自己的投票结果</li>
<li>哨兵每隔一段时间，都会基于询问的结果，看看那个哨兵获得的投票最多，如果最多的票数大于等于两个数（1.总的哨兵节点/2+1 2.设置的最低票数），则会当选Leader</li>
</ul>
<p>操作如下图所示：<br><img src="/images/redis-sentinel-failover.png"></p>
<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 60000</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br></pre></td></tr></table></figure>

<p>所有和哨兵相关的配置都是以<code>sentinel</code>开始，第一行是最主要的配置，表示监控一个名为<code>mymaster</code>的节点，后面是节点的ip为<code>127.0.0.1</code>、端口<code>6397</code>以及该节点发生故障时，需要至少<code>2</code>个哨兵达成一致才可以。其余的配置都是针对<code>mymaster</code>的节点进一步参数配置，详细如下：</p>
<ul>
<li><code>down-after-milliseconds</code>表示哨兵认为节点下线所需要的毫秒</li>
<li><code>failover-timeout</code>表示故障修复流程的超时时间</li>
<li><code>parallel-syncs</code>表示故障修复期间，最多有多少个slave节点可以同步到新的master</li>
</ul>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>哨兵模式的运行主要入口是定时任务<code>sentinelTimer</code>，上一级是<code>serverCron</code>，运行频率和<code>serverCron</code>一样。</p>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ip&amp;端口</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">sentinelAddr</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *ip;</span><br><span class="line">    <span class="keyword">int</span> port;</span><br><span class="line">&#125; sentinelAddr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRI_MASTER  (1&lt;&lt;0)  <span class="comment">//标识master节点</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRI_SLAVE   (1&lt;&lt;1)  <span class="comment">//标识slave节点</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRI_SENTINEL (1&lt;&lt;2) <span class="comment">//标识哨兵节点</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRI_S_DOWN (1&lt;&lt;3)   <span class="comment">// 标识主观下线</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRI_O_DOWN (1&lt;&lt;4)   <span class="comment">// 标识客观下线</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRI_MASTER_DOWN (1&lt;&lt;5) <span class="comment">//标识master下线</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRI_FAILOVER_IN_PROGRESS (1&lt;&lt;6) <span class="comment">//标识故障修复中</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRI_PROMOTED (1&lt;&lt;7)            <span class="comment">//标识slave被选举成新的master</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRI_RECONF_SENT (1&lt;&lt;8)     <span class="comment">//slave被发送slaveof命令</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRI_RECONF_INPROG (1&lt;&lt;9)   <span class="comment">//slave更换master中</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRI_RECONF_DONE (1&lt;&lt;10)     <span class="comment">//slave更换master结束</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRI_FORCE_FAILOVER (1&lt;&lt;11)  <span class="comment">//强制故障修复，在master良好的情况下</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRI_SCRIPT_KILL_SENT (1&lt;&lt;12) <span class="comment">//发送kill脚本</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//各种过期时间，毫秒单位</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_INFO_PERIOD 10000 <span class="comment">//发送info的间隔时间</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_PING_PERIOD 1000   <span class="comment">//发送ping的间隔时间</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_ASK_PERIOD 1000    <span class="comment">//询问其他哨兵master是否下线的时间间隔</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_PUBLISH_PERIOD 2000    <span class="comment">//向频道发送自身信息的时间间隔</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_DEFAULT_DOWN_AFTER 30000   <span class="comment">//默认的判断下线的时间</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_HELLO_CHANNEL <span class="meta-string">&quot;__sentinel__:hello&quot;</span> <span class="comment">//哨兵之间交流的频道</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_TILT_TRIGGER 2000  <span class="comment">//触发tilt的间隔</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_TILT_PERIOD (SENTINEL_PING_PERIOD*30) <span class="comment">//tilt判断的时间间隔</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_DEFAULT_SLAVE_PRIORITY 100 <span class="comment">//slave节点的默认优先级</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_SLAVE_RECONF_TIMEOUT 10000 <span class="comment">//slave节点更新的默认超时时间</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_DEFAULT_PARALLEL_SYNCS 1 <span class="comment">//故障修复时，有多少个slave节点同时进行同步的默认值</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_MIN_LINK_RECONNECT_PERIOD 15000 <span class="comment">//建立连接的时间间隔</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_DEFAULT_FAILOVER_TIMEOUT (60*3*1000) <span class="comment">//故障恢复的默认超时时间</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_MAX_PENDING_COMMANDS 100 <span class="comment">//最多的等待发送命令数量，PING、INFO、PUBLISH</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_ELECTION_TIMEOUT 10000 <span class="comment">//选举的超时时间</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_MAX_DESYNC 1000 <span class="comment">//故障修复开始的最大延迟时间</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_DEFAULT_DENY_SCRIPTS_RECONFIG 1 <span class="comment">//默认的脚本重写</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//故障修复的状态</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_NONE 0  <span class="comment">//无故障</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_WAIT_START 1  <span class="comment">//等待开始</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_SELECT_SLAVE 2 <span class="comment">//选出一个slave成为新的master</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE 3 <span class="comment">//选出的slave成为master</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_WAIT_PROMOTION 4 <span class="comment">//等待选出的slave改变自身的角色slave-&gt;master</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_RECONF_SLAVES 5 <span class="comment">//剩余的slave更新master</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_FAILOVER_STATE_UPDATE_CONFIG 6 <span class="comment">//更新哨兵的配置</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_MASTER_LINK_STATUS_UP 0 <span class="comment">//master正常在线</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_MASTER_LINK_STATUS_DOWN 1 <span class="comment">//master下线</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_NO_FLAGS 0 <span class="comment">//无任何标识</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_GENERATE_EVENT (1&lt;&lt;16) <span class="comment">//附带制造event</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_LEADER (1&lt;&lt;17) <span class="comment">//哨兵当选leader</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_OBSERVER (1&lt;&lt;18) <span class="comment">//哨兵是观察者</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_SCRIPT_NONE 0 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_SCRIPT_RUNNING 1 <span class="comment">//脚本运行中</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_SCRIPT_MAX_QUEUE 256 <span class="comment">//脚本队列最大量</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_SCRIPT_MAX_RUNNING 16 <span class="comment">//最大运行的脚本数量</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_SCRIPT_MAX_RUNTIME 60000 <span class="comment">//脚本的最大运行时长</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_SCRIPT_MAX_RETRY 10 <span class="comment">//脚本失败重试的最大次数</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_SCRIPT_RETRY_DELAY 30000 <span class="comment">//重试的时间间隔</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_SIMFAILURE_NONE 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION (1&lt;&lt;0) <span class="comment">//选举完之后退出</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION (1&lt;&lt;1) <span class="comment">//晋升完之后退出</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//哨兵和每一个master,slave,其他哨兵节点的连接信息，分为两类，1.普通连接 2.发布订阅的连接</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">instanceLink</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> refcount;          <span class="comment">// 引用计数</span></span><br><span class="line">    <span class="keyword">int</span> disconnected;      <span class="comment">// 断开是否连接</span></span><br><span class="line">    <span class="keyword">int</span> pending_commands;  <span class="comment">// 等待回复的命令数量</span></span><br><span class="line">    redisAsyncContext *cc; <span class="comment">// 普通连接的上下文</span></span><br><span class="line">    redisAsyncContext *pc; <span class="comment">// 发布订阅连接的上下文</span></span><br><span class="line">    <span class="keyword">mstime_t</span> cc_conn_time; <span class="comment">// 普通连接的建立连接时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> pc_conn_time; <span class="comment">// 发布订阅连接的建立连接时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> pc_last_activity; <span class="comment">// 上一次接收到任意消息的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> last_avail_time; <span class="comment">// 上一次有效回复ping命令的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> act_ping_time;   <span class="comment">//上一次ping发送的时间，没有收到PONG回复的那次，收到PONG之后归0</span></span><br><span class="line">    <span class="keyword">mstime_t</span> last_ping_time;  <span class="comment">//上一次发送ping的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> last_pong_time;  <span class="comment">//上一次收到ping回复的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> last_reconn_time;  <span class="comment">//上一次重连的时间</span></span><br><span class="line">&#125; instanceLink;</span><br><span class="line"></span><br><span class="line"><span class="comment">//管理其他哨兵、master、slave节点的结构体</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">sentinelRedisInstance</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> flags;      <span class="comment">//标志位，标识当前节点属性和状态，详见SRI_....定义</span></span><br><span class="line">    <span class="keyword">char</span> *name;     <span class="comment">//配置文件中master的名字</span></span><br><span class="line">    <span class="keyword">char</span> *runid;    <span class="comment">//当前实例的运行id</span></span><br><span class="line">    <span class="keyword">uint64_t</span> config_epoch;  <span class="comment">//设置纪元</span></span><br><span class="line">    sentinelAddr *addr; <span class="comment">//master地址</span></span><br><span class="line">    instanceLink *link; <span class="comment">//连接信息</span></span><br><span class="line">    <span class="keyword">mstime_t</span> last_pub_time;   <span class="comment">//上一次往hello频道发送消息的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> last_hello_time; <span class="comment">//上一次从hello频道收到消息的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> last_master_down_reply_time; <span class="comment">//上一次回复is-master-down command的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> s_down_since_time; <span class="comment">//标记成主观下线的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> o_down_since_time; <span class="comment">//标记成客观下线的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> down_after_period; <span class="comment">//过了多久没有有效回复，认为下线的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> info_refresh;  <span class="comment">//收到info回复的时间</span></span><br><span class="line">    dict *renamed_commands;     <span class="comment">//重命名的命令集</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//节点报告自己角色</span></span><br><span class="line">    <span class="keyword">int</span> role_reported;</span><br><span class="line">    <span class="keyword">mstime_t</span> role_reported_time; <span class="comment">//汇报节点的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> slave_conf_change_time; <span class="comment">//上一次slave节点conf变更的时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//master节点专有</span></span><br><span class="line">    dict *sentinels;    <span class="comment">//监听该master的其他哨兵</span></span><br><span class="line">    dict *slaves;       <span class="comment">//该master的slave节点</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> quorum;<span class="comment">//成为leader,需要多少个哨兵需要达成一致</span></span><br><span class="line">    <span class="keyword">int</span> parallel_syncs; <span class="comment">//同时有多少个slave节点更新配置</span></span><br><span class="line">    <span class="keyword">char</span> *auth_pass;    <span class="comment">//连接的密码</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//slave节点专有</span></span><br><span class="line">    <span class="keyword">mstime_t</span> master_link_down_time; <span class="comment">//和master同步连接断开的时间</span></span><br><span class="line">    <span class="keyword">int</span> slave_priority; <span class="comment">//优先级</span></span><br><span class="line">    <span class="keyword">mstime_t</span> slave_reconf_sent_time; <span class="comment">//发送slaveof的时间</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sentinelRedisInstance</span> *<span class="title">master</span>;</span> <span class="comment">//master的信息</span></span><br><span class="line">    <span class="keyword">char</span> *slave_master_host;    <span class="comment">//master的host信息，info命令出来的</span></span><br><span class="line">    <span class="keyword">int</span> slave_master_port;      <span class="comment">//master的port信息，info命令出来的</span></span><br><span class="line">    <span class="keyword">int</span> slave_master_link_status; <span class="comment">//master连接的状态，info命令出来的</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> slave_repl_offset; <span class="comment">//slave同步的偏移量</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//故障修复专有</span></span><br><span class="line">    <span class="keyword">char</span> *leader;       <span class="comment">//对于master来说，是需要主导故障修复的哨兵节点，对于哨兵来说，表示投票的对象</span></span><br><span class="line">    <span class="keyword">uint64_t</span> failover_epoch; <span class="comment">//故障修复的纪元</span></span><br><span class="line">    <span class="keyword">int</span> failover_state; <span class="comment">//故障修复的进度状态，详见SENTINEL_FAILOVER_*</span></span><br><span class="line">    <span class="keyword">mstime_t</span> failover_state_change_time; <span class="comment">//故障修复状态变更的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> failover_start_time;   <span class="comment">//上一次故障修复开始的时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> failover_timeout;      <span class="comment">//故障修复的超时时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> failover_delay_logged; <span class="comment">//记录的延迟时间</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sentinelRedisInstance</span> *<span class="title">promoted_slave</span>;</span> <span class="comment">//从slave中选举出来新的master</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通知脚本</span></span><br><span class="line">    <span class="keyword">char</span> *notification_script;</span><br><span class="line">    <span class="keyword">char</span> *client_reconfig_script;</span><br><span class="line">    sds info; <span class="comment">//节点info命令返回的信息</span></span><br><span class="line">&#125; sentinelRedisInstance;</span><br><span class="line"></span><br><span class="line"><span class="comment">//哨兵模式</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sentinelState</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> myid[CONFIG_RUN_ID_SIZE+<span class="number">1</span>]; <span class="comment">//哨兵id</span></span><br><span class="line">    <span class="keyword">uint64_t</span> current_epoch;         <span class="comment">//当前纪元</span></span><br><span class="line">    dict *masters;      <span class="comment">//当前哨兵监听的所有master信息，key是配置中的名字，value是sentinelRedisInstance</span></span><br><span class="line">    <span class="keyword">int</span> tilt;           <span class="comment">//是否在tilt模式</span></span><br><span class="line">    <span class="keyword">int</span> running_scripts;    <span class="comment">//运行中的脚本数量</span></span><br><span class="line">    <span class="keyword">mstime_t</span> tilt_start_time;       <span class="comment">//tilt开始时间</span></span><br><span class="line">    <span class="keyword">mstime_t</span> previous_time;         <span class="comment">//上一次运行定时任务的时间</span></span><br><span class="line">    <span class="built_in">list</span> *scripts_queue;            <span class="comment">//脚本队列</span></span><br><span class="line">    <span class="keyword">char</span> *announce_ip;  <span class="comment">//哨兵之间沟通的，表明自己的ip</span></span><br><span class="line">    <span class="keyword">int</span> announce_port;  <span class="comment">//哨兵之间沟通的，表明自己的port</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> simfailure_flags; <span class="comment">//标志</span></span><br><span class="line">    <span class="keyword">int</span> deny_scripts_reconfig; <span class="comment">//是否允许在运行期间改变脚本的路径信息</span></span><br><span class="line">&#125; sentinel;</span><br><span class="line"></span><br><span class="line"><span class="comment">//哨兵脚本任务</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">sentinelScriptJob</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> flags;              <span class="comment">//标志位，详见SENTINEL_SCRIPT_*</span></span><br><span class="line">    <span class="keyword">int</span> retry_num;          <span class="comment">//失败重试次数</span></span><br><span class="line">    <span class="keyword">char</span> **argv;            <span class="comment">//参数</span></span><br><span class="line">    <span class="keyword">mstime_t</span> start_time;    <span class="comment">//脚本运行开始时间</span></span><br><span class="line">    <span class="keyword">pid_t</span> pid;              <span class="comment">//脚本运行进程id</span></span><br><span class="line">&#125; sentinelScriptJob;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//适配的事件循环</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisAeEvents</span> &#123;</span></span><br><span class="line">    redisAsyncContext *context; <span class="comment">//异步连接上下文</span></span><br><span class="line">    aeEventLoop *loop; <span class="comment">//事件循环</span></span><br><span class="line">    <span class="keyword">int</span> fd; <span class="comment">//连接fd</span></span><br><span class="line">    <span class="keyword">int</span> reading, writing;</span><br><span class="line">&#125; redisAeEvents;</span><br></pre></td></tr></table></figure>

<h4 id="redisAeReadEvent"><a href="#redisAeReadEvent" class="headerlink" title="redisAeReadEvent"></a>redisAeReadEvent</h4><p>处理读事件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">redisAeReadEvent</span><span class="params">(aeEventLoop *el, <span class="keyword">int</span> fd, <span class="keyword">void</span> *privdata, <span class="keyword">int</span> mask)</span> </span>&#123;</span><br><span class="line">    ((<span class="keyword">void</span>)el); ((<span class="keyword">void</span>)fd); ((<span class="keyword">void</span>)mask);</span><br><span class="line"></span><br><span class="line">    redisAeEvents *e = (redisAeEvents*)privdata;</span><br><span class="line">    redisAsyncHandleRead(e-&gt;context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="redisAeWriteEvent"><a href="#redisAeWriteEvent" class="headerlink" title="redisAeWriteEvent"></a>redisAeWriteEvent</h4><p>写事件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">redisAeWriteEvent</span><span class="params">(aeEventLoop *el, <span class="keyword">int</span> fd, <span class="keyword">void</span> *privdata, <span class="keyword">int</span> mask)</span> </span>&#123;</span><br><span class="line">    ((<span class="keyword">void</span>)el); ((<span class="keyword">void</span>)fd); ((<span class="keyword">void</span>)mask);</span><br><span class="line"></span><br><span class="line">    redisAeEvents *e = (redisAeEvents*)privdata;</span><br><span class="line">    redisAsyncHandleWrite(e-&gt;context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="redisAeAddRead"><a href="#redisAeAddRead" class="headerlink" title="redisAeAddRead"></a>redisAeAddRead</h4><p>增加读事件处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">redisAeAddRead</span><span class="params">(<span class="keyword">void</span> *privdata)</span> </span>&#123;</span><br><span class="line">    redisAeEvents *e = (redisAeEvents*)privdata;</span><br><span class="line">    aeEventLoop *loop = e-&gt;loop;</span><br><span class="line">    <span class="keyword">if</span> (!e-&gt;reading) &#123;</span><br><span class="line">        e-&gt;reading = <span class="number">1</span>;</span><br><span class="line">        aeCreateFileEvent(loop,e-&gt;fd,AE_READABLE,redisAeReadEvent,e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="redisAeDelRead"><a href="#redisAeDelRead" class="headerlink" title="redisAeDelRead"></a>redisAeDelRead</h4><p>删除读处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">redisAeDelRead</span><span class="params">(<span class="keyword">void</span> *privdata)</span> </span>&#123;</span><br><span class="line">    redisAeEvents *e = (redisAeEvents*)privdata;</span><br><span class="line">    aeEventLoop *loop = e-&gt;loop;</span><br><span class="line">    <span class="keyword">if</span> (e-&gt;reading) &#123;</span><br><span class="line">        e-&gt;reading = <span class="number">0</span>;</span><br><span class="line">        aeDeleteFileEvent(loop,e-&gt;fd,AE_READABLE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="redisAeAddWrite"><a href="#redisAeAddWrite" class="headerlink" title="redisAeAddWrite"></a>redisAeAddWrite</h4><p>添加写事件处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">redisAeAddWrite</span><span class="params">(<span class="keyword">void</span> *privdata)</span> </span>&#123;</span><br><span class="line">    redisAeEvents *e = (redisAeEvents*)privdata;</span><br><span class="line">    aeEventLoop *loop = e-&gt;loop;</span><br><span class="line">    <span class="keyword">if</span> (!e-&gt;writing) &#123;</span><br><span class="line">        e-&gt;writing = <span class="number">1</span>;</span><br><span class="line">        aeCreateFileEvent(loop,e-&gt;fd,AE_WRITABLE,redisAeWriteEvent,e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="redisAeDelWrite"><a href="#redisAeDelWrite" class="headerlink" title="redisAeDelWrite"></a>redisAeDelWrite</h4><p>删除写处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">redisAeDelWrite</span><span class="params">(<span class="keyword">void</span> *privdata)</span> </span>&#123;</span><br><span class="line">    redisAeEvents *e = (redisAeEvents*)privdata;</span><br><span class="line">    aeEventLoop *loop = e-&gt;loop;</span><br><span class="line">    <span class="keyword">if</span> (e-&gt;writing) &#123;</span><br><span class="line">        e-&gt;writing = <span class="number">0</span>;</span><br><span class="line">        aeDeleteFileEvent(loop,e-&gt;fd,AE_WRITABLE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="redisAeCleanup"><a href="#redisAeCleanup" class="headerlink" title="redisAeCleanup"></a>redisAeCleanup</h4><p>删除写处理&amp;读处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">redisAeCleanup</span><span class="params">(<span class="keyword">void</span> *privdata)</span> </span>&#123;</span><br><span class="line">    redisAeEvents *e = (redisAeEvents*)privdata;</span><br><span class="line">    redisAeDelRead(privdata);</span><br><span class="line">    redisAeDelWrite(privdata);</span><br><span class="line">    zfree(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="redisAeAttach"><a href="#redisAeAttach" class="headerlink" title="redisAeAttach"></a>redisAeAttach</h4><p>把异步的相应信息添加到主事件循环中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">redisAeAttach</span><span class="params">(aeEventLoop *loop, redisAsyncContext *ac)</span> </span>&#123;</span><br><span class="line">    redisContext *c = &amp;(ac-&gt;c);</span><br><span class="line">    redisAeEvents *e;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//已经挂载了</span></span><br><span class="line">    <span class="keyword">if</span> (ac-&gt;ev.data != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line"></span><br><span class="line">    e = (redisAeEvents*)zmalloc(<span class="keyword">sizeof</span>(*e));</span><br><span class="line">    e-&gt;context = ac;</span><br><span class="line">    e-&gt;loop = loop;</span><br><span class="line">    e-&gt;fd = c-&gt;fd;</span><br><span class="line">    e-&gt;reading = e-&gt;writing = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册各种情况下的处理</span></span><br><span class="line">    ac-&gt;ev.addRead = redisAeAddRead;</span><br><span class="line">    ac-&gt;ev.delRead = redisAeDelRead;</span><br><span class="line">    ac-&gt;ev.addWrite = redisAeAddWrite;</span><br><span class="line">    ac-&gt;ev.delWrite = redisAeDelWrite;</span><br><span class="line">    ac-&gt;ev.cleanup = redisAeCleanup;</span><br><span class="line">    ac-&gt;ev.data = e;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="哨兵模式下接受的命令"><a href="#哨兵模式下接受的命令" class="headerlink" title="哨兵模式下接受的命令"></a>哨兵模式下接受的命令</h4><p>哨兵模式是一种特殊的redis模式，只能响应部分命令</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisCommand</span> <span class="title">sentinelcmds</span>[] =</span> &#123;</span><br><span class="line">    &#123;<span class="string">&quot;ping&quot;</span>,pingCommand,<span class="number">1</span>,<span class="string">&quot;&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;sentinel&quot;</span>,sentinelCommand,<span class="number">-2</span>,<span class="string">&quot;&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;subscribe&quot;</span>,subscribeCommand,<span class="number">-2</span>,<span class="string">&quot;&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;unsubscribe&quot;</span>,unsubscribeCommand,<span class="number">-1</span>,<span class="string">&quot;&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;psubscribe&quot;</span>,psubscribeCommand,<span class="number">-2</span>,<span class="string">&quot;&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;punsubscribe&quot;</span>,punsubscribeCommand,<span class="number">-1</span>,<span class="string">&quot;&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;publish&quot;</span>,sentinelPublishCommand,<span class="number">3</span>,<span class="string">&quot;&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;info&quot;</span>,sentinelInfoCommand,<span class="number">-1</span>,<span class="string">&quot;&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;role&quot;</span>,sentinelRoleCommand,<span class="number">1</span>,<span class="string">&quot;l&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;client&quot;</span>,clientCommand,<span class="number">-2</span>,<span class="string">&quot;rs&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;shutdown&quot;</span>,shutdownCommand,<span class="number">-1</span>,<span class="string">&quot;&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;auth&quot;</span>,authCommand,<span class="number">2</span>,<span class="string">&quot;sltF&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="initSentinelConfig"><a href="#initSentinelConfig" class="headerlink" title="initSentinelConfig"></a>initSentinelConfig</h4><p>初始化哨兵的配置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initSentinelConfig</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    server.port = REDIS_SENTINEL_PORT;  <span class="comment">//哨兵模式的端口</span></span><br><span class="line">    server.protected_mode = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="initSentinel"><a href="#initSentinel" class="headerlink" title="initSentinel"></a>initSentinel</h4><p>初始化哨兵</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initSentinel</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//清空正常模式的命令集</span></span><br><span class="line">    dictEmpty(server.commands,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把哨兵模式下的命令添加进去</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="keyword">sizeof</span>(sentinelcmds)/<span class="keyword">sizeof</span>(sentinelcmds[<span class="number">0</span>]); j++) &#123;</span><br><span class="line">        <span class="keyword">int</span> retval;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">redisCommand</span> *<span class="title">cmd</span> =</span> sentinelcmds+j;</span><br><span class="line"></span><br><span class="line">        retval = dictAdd(server.commands, sdsnew(cmd-&gt;name), cmd);</span><br><span class="line">        serverAssert(retval == DICT_OK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化信息</span></span><br><span class="line">    sentinel.current_epoch = <span class="number">0</span>;</span><br><span class="line">    sentinel.masters = dictCreate(&amp;instancesDictType,<span class="literal">NULL</span>);</span><br><span class="line">    sentinel.tilt = <span class="number">0</span>;</span><br><span class="line">    sentinel.tilt_start_time = <span class="number">0</span>;</span><br><span class="line">    sentinel.previous_time = mstime();</span><br><span class="line">    sentinel.running_scripts = <span class="number">0</span>;</span><br><span class="line">    sentinel.scripts_queue = listCreate();</span><br><span class="line">    sentinel.announce_ip = <span class="literal">NULL</span>;</span><br><span class="line">    sentinel.announce_port = <span class="number">0</span>;</span><br><span class="line">    sentinel.simfailure_flags = SENTINEL_SIMFAILURE_NONE;</span><br><span class="line">    sentinel.deny_scripts_reconfig = SENTINEL_DEFAULT_DENY_SCRIPTS_RECONFIG;</span><br><span class="line">    <span class="built_in">memset</span>(sentinel.myid,<span class="number">0</span>,<span class="keyword">sizeof</span>(sentinel.myid));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="sentinelIsRunning"><a href="#sentinelIsRunning" class="headerlink" title="sentinelIsRunning"></a>sentinelIsRunning</h4><p>检查哨兵模式下的必要条件，创建运行id，更新配置到文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelIsRunning</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查必要条件，配置文件</span></span><br><span class="line">    <span class="keyword">if</span> (server.configfile == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Sentinel started without a config file. Exiting...&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (access(server.configfile,W_OK) == <span class="number">-1</span>) &#123;</span><br><span class="line">        serverLog(LL_WARNING,</span><br><span class="line">            <span class="string">&quot;Sentinel config file %s is not writable: %s. Exiting...&quot;</span>,</span><br><span class="line">            server.configfile,strerror(errno));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查运行id</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; CONFIG_RUN_ID_SIZE; j++)</span><br><span class="line">        <span class="keyword">if</span> (sentinel.myid[j] != <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成一个id</span></span><br><span class="line">    <span class="keyword">if</span> (j == CONFIG_RUN_ID_SIZE) &#123;</span><br><span class="line">        getRandomHexChars(sentinel.myid,CONFIG_RUN_ID_SIZE);</span><br><span class="line">        sentinelFlushConfig();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serverLog(LL_WARNING,<span class="string">&quot;Sentinel ID is %s&quot;</span>, sentinel.myid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成+monitor事件，对于监控的每一个master</span></span><br><span class="line">    sentinelGenerateInitialMonitorEvents();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="createSentinelAddr"><a href="#createSentinelAddr" class="headerlink" title="createSentinelAddr"></a>createSentinelAddr</h4><p>创建哨兵地址结构体，根据host和端口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sentinelAddr *<span class="title">createSentinelAddr</span><span class="params">(<span class="keyword">char</span> *hostname, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> ip[NET_IP_STR_LEN];</span><br><span class="line">    sentinelAddr *sa;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查端口</span></span><br><span class="line">    <span class="keyword">if</span> (port &lt; <span class="number">0</span> || port &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">        errno = EINVAL;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//host转换成ip</span></span><br><span class="line">    <span class="keyword">if</span> (anetResolve(<span class="literal">NULL</span>,hostname,ip,<span class="keyword">sizeof</span>(ip)) == ANET_ERR) &#123;</span><br><span class="line">        errno = ENOENT;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sa = zmalloc(<span class="keyword">sizeof</span>(*sa));</span><br><span class="line">    sa-&gt;ip = sdsnew(ip);</span><br><span class="line">    sa-&gt;port = port;</span><br><span class="line">    <span class="keyword">return</span> sa;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="dupSentinelAddr"><a href="#dupSentinelAddr" class="headerlink" title="dupSentinelAddr"></a>dupSentinelAddr</h4><p>复制一个地址结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sentinelAddr *<span class="title">dupSentinelAddr</span><span class="params">(sentinelAddr *src)</span> </span>&#123;</span><br><span class="line">    sentinelAddr *sa;</span><br><span class="line"></span><br><span class="line">    sa = zmalloc(<span class="keyword">sizeof</span>(*sa));</span><br><span class="line">    sa-&gt;ip = sdsnew(src-&gt;ip);</span><br><span class="line">    sa-&gt;port = src-&gt;port;</span><br><span class="line">    <span class="keyword">return</span> sa;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="releaseSentinelAddr"><a href="#releaseSentinelAddr" class="headerlink" title="releaseSentinelAddr"></a>releaseSentinelAddr</h4><p>释放地址结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">releaseSentinelAddr</span><span class="params">(sentinelAddr *sa)</span> </span>&#123;</span><br><span class="line">    sdsfree(sa-&gt;ip);</span><br><span class="line">    zfree(sa);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="sentinelAddrIsEqual"><a href="#sentinelAddrIsEqual" class="headerlink" title="sentinelAddrIsEqual"></a>sentinelAddrIsEqual</h4><p>判断两个地址结构体是否一样</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelAddrIsEqual</span><span class="params">(sentinelAddr *a, sentinelAddr *b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a-&gt;port == b-&gt;port &amp;&amp; !strcasecmp(a-&gt;ip,b-&gt;ip);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="sentinelEvent"><a href="#sentinelEvent" class="headerlink" title="sentinelEvent"></a>sentinelEvent</h4><p>产生一个哨兵事件</p>
<p>level表示日志等级，只有LL_WARNING级别的才会触发脚本通知<br>fmt以‘%@’开始，表示输出ri节点的信息，格式为 <instance type> <instance name> <ip> <port>，如果ri不是master节点，会再添加上一段信息@ <master name> <master ip> <master port></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelEvent</span><span class="params">(<span class="keyword">int</span> level, <span class="keyword">char</span> *type, sentinelRedisInstance *ri,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123;</span><br><span class="line">    va_list ap;</span><br><span class="line">    <span class="keyword">char</span> msg[LOG_MAX_LEN];</span><br><span class="line">    robj *channel, *payload;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理特殊格式</span></span><br><span class="line">    <span class="keyword">if</span> (fmt[<span class="number">0</span>] == <span class="string">&#x27;%&#x27;</span> &amp;&amp; fmt[<span class="number">1</span>] == <span class="string">&#x27;@&#x27;</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *master = (ri-&gt;flags &amp; SRI_MASTER) ?</span><br><span class="line">                                         <span class="literal">NULL</span> : ri-&gt;master;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (master) &#123;</span><br><span class="line">            <span class="built_in">snprintf</span>(msg, <span class="keyword">sizeof</span>(msg), <span class="string">&quot;%s %s %s %d @ %s %s %d&quot;</span>,</span><br><span class="line">                sentinelRedisInstanceTypeStr(ri),</span><br><span class="line">                ri-&gt;name, ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port,</span><br><span class="line">                master-&gt;name, master-&gt;addr-&gt;ip, master-&gt;addr-&gt;port);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">snprintf</span>(msg, <span class="keyword">sizeof</span>(msg), <span class="string">&quot;%s %s %s %d&quot;</span>,</span><br><span class="line">                sentinelRedisInstanceTypeStr(ri),</span><br><span class="line">                ri-&gt;name, ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port);</span><br><span class="line">        &#125;</span><br><span class="line">        fmt += <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理剩余的格式</span></span><br><span class="line">    <span class="keyword">if</span> (fmt[<span class="number">0</span>] != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        va_start(ap, fmt);</span><br><span class="line">        vsnprintf(msg+<span class="built_in">strlen</span>(msg), <span class="keyword">sizeof</span>(msg)-<span class="built_in">strlen</span>(msg), fmt, ap);</span><br><span class="line">        va_end(ap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录下来</span></span><br><span class="line">    <span class="keyword">if</span> (level &gt;= server.verbosity)</span><br><span class="line">        serverLog(level,<span class="string">&quot;%s %s&quot;</span>,type,msg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//非debug模式，往type频道内发送消息</span></span><br><span class="line">    <span class="keyword">if</span> (level != LL_DEBUG) &#123;</span><br><span class="line">        channel = createStringObject(type,<span class="built_in">strlen</span>(type));</span><br><span class="line">        payload = createStringObject(msg,<span class="built_in">strlen</span>(msg));</span><br><span class="line">        pubsubPublishMessage(channel,payload);</span><br><span class="line">        decrRefCount(channel);</span><br><span class="line">        decrRefCount(payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//启动脚本处理</span></span><br><span class="line">    <span class="keyword">if</span> (level == LL_WARNING &amp;&amp; ri != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *master = (ri-&gt;flags &amp; SRI_MASTER) ?</span><br><span class="line">                                         ri : ri-&gt;master;</span><br><span class="line">        <span class="keyword">if</span> (master &amp;&amp; master-&gt;notification_script) &#123;</span><br><span class="line">            sentinelScheduleScriptExecution(master-&gt;notification_script,</span><br><span class="line">                type,msg,<span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="sentinelGenerateInitialMonitorEvents"><a href="#sentinelGenerateInitialMonitorEvents" class="headerlink" title="sentinelGenerateInitialMonitorEvents"></a>sentinelGenerateInitialMonitorEvents</h4><p>产生+monitor事件，在初始化的时候针对监控的每一个master触发</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelGenerateInitialMonitorEvents</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历当前哨兵监控的所有master</span></span><br><span class="line">    di = dictGetIterator(sentinel.masters);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line">        sentinelEvent(LL_WARNING,<span class="string">&quot;+monitor&quot;</span>,ri,<span class="string">&quot;%@ quorum %d&quot;</span>,ri-&gt;quorum);</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h4><h5 id="sentinelReleaseScriptJob"><a href="#sentinelReleaseScriptJob" class="headerlink" title="sentinelReleaseScriptJob"></a>sentinelReleaseScriptJob</h5><p>释放脚本作业</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelReleaseScriptJob</span><span class="params">(sentinelScriptJob *sj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(sj-&gt;argv[j]) sdsfree(sj-&gt;argv[j++]);</span><br><span class="line">    zfree(sj-&gt;argv);</span><br><span class="line">    zfree(sj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelScheduleScriptExecution"><a href="#sentinelScheduleScriptExecution" class="headerlink" title="sentinelScheduleScriptExecution"></a>sentinelScheduleScriptExecution</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_SCRIPT_MAX_ARGS 16 <span class="comment">//脚本最大的参数数量</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelScheduleScriptExecution</span><span class="params">(<span class="keyword">char</span> *path, ...)</span> </span>&#123;</span><br><span class="line">    va_list ap;</span><br><span class="line">    <span class="keyword">char</span> *argv[SENTINEL_SCRIPT_MAX_ARGS+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> argc = <span class="number">1</span>;</span><br><span class="line">    sentinelScriptJob *sj;</span><br><span class="line"></span><br><span class="line">    va_start(ap, path);</span><br><span class="line">    <span class="keyword">while</span>(argc &lt; SENTINEL_SCRIPT_MAX_ARGS) &#123;</span><br><span class="line">        argv[argc] = va_arg(ap,<span class="keyword">char</span>*);</span><br><span class="line">        <span class="keyword">if</span> (!argv[argc]) <span class="keyword">break</span>;</span><br><span class="line">        argv[argc] = sdsnew(argv[argc]); <span class="comment">/* Copy the string. */</span></span><br><span class="line">        argc++;</span><br><span class="line">    &#125;</span><br><span class="line">    va_end(ap);</span><br><span class="line">    argv[<span class="number">0</span>] = sdsnew(path);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置任务的属性</span></span><br><span class="line">    sj = zmalloc(<span class="keyword">sizeof</span>(*sj));</span><br><span class="line">    sj-&gt;flags = SENTINEL_SCRIPT_NONE;</span><br><span class="line">    sj-&gt;retry_num = <span class="number">0</span>;</span><br><span class="line">    sj-&gt;argv = zmalloc(<span class="keyword">sizeof</span>(<span class="keyword">char</span>*)*(argc+<span class="number">1</span>));</span><br><span class="line">    sj-&gt;start_time = <span class="number">0</span>;</span><br><span class="line">    sj-&gt;pid = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(sj-&gt;argv,argv,<span class="keyword">sizeof</span>(<span class="keyword">char</span>*)*(argc+<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加到任务队列</span></span><br><span class="line">    listAddNodeTail(sentinel.scripts_queue,sj);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当任务队列已经满的时候，删除最早的未执行的任务</span></span><br><span class="line">    <span class="keyword">if</span> (listLength(sentinel.scripts_queue) &gt; SENTINEL_SCRIPT_MAX_QUEUE) &#123;</span><br><span class="line">        listNode *ln;</span><br><span class="line">        listIter li;</span><br><span class="line"></span><br><span class="line">        listRewind(sentinel.scripts_queue,&amp;li);</span><br><span class="line">        <span class="keyword">while</span> ((ln = listNext(&amp;li)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            sj = ln-&gt;value;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) <span class="keyword">continue</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//删除</span></span><br><span class="line">            listDelNode(sentinel.scripts_queue,ln);</span><br><span class="line">            sentinelReleaseScriptJob(sj);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        serverAssert(listLength(sentinel.scripts_queue) &lt;=</span><br><span class="line">                    SENTINEL_SCRIPT_MAX_QUEUE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelGetScriptListNodeByPid"><a href="#sentinelGetScriptListNodeByPid" class="headerlink" title="sentinelGetScriptListNodeByPid"></a>sentinelGetScriptListNodeByPid</h5><p>根据进程id，获取对应的任务</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">listNode *<span class="title">sentinelGetScriptListNodeByPid</span><span class="params">(<span class="keyword">pid_t</span> pid)</span> </span>&#123;</span><br><span class="line">    listNode *ln;</span><br><span class="line">    listIter li;</span><br><span class="line"></span><br><span class="line">    listRewind(sentinel.scripts_queue,&amp;li);</span><br><span class="line">    <span class="keyword">while</span> ((ln = listNext(&amp;li)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelScriptJob *sj = ln-&gt;value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//匹配运行中的脚本</span></span><br><span class="line">        <span class="keyword">if</span> ((sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) &amp;&amp; sj-&gt;pid == pid)</span><br><span class="line">            <span class="keyword">return</span> ln;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelRunPendingScripts"><a href="#sentinelRunPendingScripts" class="headerlink" title="sentinelRunPendingScripts"></a>sentinelRunPendingScripts</h5><p>运行脚本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelRunPendingScripts</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    listNode *ln;</span><br><span class="line">    listIter li;</span><br><span class="line">    <span class="keyword">mstime_t</span> now = mstime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查找任务队列&amp;执行，如果运行中的数量还没有达到最大限制</span></span><br><span class="line">    listRewind(sentinel.scripts_queue,&amp;li);</span><br><span class="line">    <span class="keyword">while</span> (sentinel.running_scripts &lt; SENTINEL_SCRIPT_MAX_RUNNING &amp;&amp;</span><br><span class="line">           (ln = listNext(&amp;li)) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sentinelScriptJob *sj = ln-&gt;value;</span><br><span class="line">        <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//跳过运行中的</span></span><br><span class="line">        <span class="keyword">if</span> (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//跳过重试的，但还没有到时间的</span></span><br><span class="line">        <span class="keyword">if</span> (sj-&gt;start_time &amp;&amp; sj-&gt;start_time &gt; now) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//标记运行中&amp;记录时间&amp;重试次数</span></span><br><span class="line">        sj-&gt;flags |= SENTINEL_SCRIPT_RUNNING;</span><br><span class="line">        sj-&gt;start_time = mstime();</span><br><span class="line">        sj-&gt;retry_num++;</span><br><span class="line">        pid = fork();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">-1</span>) &#123;</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;-script-error&quot;</span>,<span class="literal">NULL</span>,</span><br><span class="line">                          <span class="string">&quot;%s %d %d&quot;</span>, sj-&gt;argv[<span class="number">0</span>], <span class="number">99</span>, <span class="number">0</span>);</span><br><span class="line">            sj-&gt;flags &amp;= ~SENTINEL_SCRIPT_RUNNING;</span><br><span class="line">            sj-&gt;pid = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//子进程</span></span><br><span class="line">            execve(sj-&gt;argv[<span class="number">0</span>],sj-&gt;argv,environ);</span><br><span class="line">            _exit(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//父进程，维护运行中的脚本数量和任务运行的进程id</span></span><br><span class="line">            sentinel.running_scripts++;</span><br><span class="line">            sj-&gt;pid = pid;</span><br><span class="line">            sentinelEvent(LL_DEBUG,<span class="string">&quot;+script-child&quot;</span>,<span class="literal">NULL</span>,<span class="string">&quot;%ld&quot;</span>,(<span class="keyword">long</span>)pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelScriptRetryDelay"><a href="#sentinelScriptRetryDelay" class="headerlink" title="sentinelScriptRetryDelay"></a>sentinelScriptRetryDelay</h5><p>根据失败次数获取下一次执行任务的延迟时间，每失败一次时间久翻倍</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">mstime_t</span> <span class="title">sentinelScriptRetryDelay</span><span class="params">(<span class="keyword">int</span> retry_num)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">mstime_t</span> delay = SENTINEL_SCRIPT_RETRY_DELAY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (retry_num-- &gt; <span class="number">1</span>) delay *= <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> delay;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelCollectTerminatedScripts"><a href="#sentinelCollectTerminatedScripts" class="headerlink" title="sentinelCollectTerminatedScripts"></a>sentinelCollectTerminatedScripts</h5><p>根据脚本进程的退出情况，处理后续</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelCollectTerminatedScripts</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> statloc;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查是否有子进程退出</span></span><br><span class="line">    <span class="keyword">while</span> ((pid = wait3(&amp;statloc,WNOHANG,<span class="literal">NULL</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> exitcode = WEXITSTATUS(statloc);</span><br><span class="line">        <span class="keyword">int</span> bysignal = <span class="number">0</span>;</span><br><span class="line">        listNode *ln;</span><br><span class="line">        sentinelScriptJob *sj;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (WIFSIGNALED(statloc)) bysignal = WTERMSIG(statloc);</span><br><span class="line">        sentinelEvent(LL_DEBUG,<span class="string">&quot;-script-child&quot;</span>,<span class="literal">NULL</span>,<span class="string">&quot;%ld %d %d&quot;</span>,</span><br><span class="line">            (<span class="keyword">long</span>)pid, exitcode, bysignal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取队列中对应的任务</span></span><br><span class="line">        ln = sentinelGetScriptListNodeByPid(pid);</span><br><span class="line">        <span class="keyword">if</span> (ln == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            serverLog(LL_WARNING,<span class="string">&quot;wait3() returned a pid (%ld) we can&#x27;t find in our scripts execution queue!&quot;</span>, (<span class="keyword">long</span>)pid);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        sj = ln-&gt;value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//接收到信号退出，或者返回码为1表示重试</span></span><br><span class="line">        <span class="keyword">if</span> ((bysignal || exitcode == <span class="number">1</span>) &amp;&amp;</span><br><span class="line">            sj-&gt;retry_num != SENTINEL_SCRIPT_MAX_RETRY)</span><br><span class="line">        &#123;</span><br><span class="line">            sj-&gt;flags &amp;= ~SENTINEL_SCRIPT_RUNNING;</span><br><span class="line">            sj-&gt;pid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//下次执行时间加倍</span></span><br><span class="line">            sj-&gt;start_time = mstime() +</span><br><span class="line">                             sentinelScriptRetryDelay(sj-&gt;retry_num);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//移除任务，虽然任务不是完美的方式退出，可能有失败</span></span><br><span class="line">            <span class="keyword">if</span> (bysignal || exitcode != <span class="number">0</span>) &#123;</span><br><span class="line">                sentinelEvent(LL_WARNING,<span class="string">&quot;-script-error&quot;</span>,<span class="literal">NULL</span>,</span><br><span class="line">                              <span class="string">&quot;%s %d %d&quot;</span>, sj-&gt;argv[<span class="number">0</span>], bysignal, exitcode);</span><br><span class="line">            &#125;</span><br><span class="line">            listDelNode(sentinel.scripts_queue,ln);</span><br><span class="line">            sentinelReleaseScriptJob(sj);</span><br><span class="line">            sentinel.running_scripts--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelKillTimedoutScripts"><a href="#sentinelKillTimedoutScripts" class="headerlink" title="sentinelKillTimedoutScripts"></a>sentinelKillTimedoutScripts</h5><p>干掉运行超时的脚本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelKillTimedoutScripts</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    listNode *ln;</span><br><span class="line">    listIter li;</span><br><span class="line">    <span class="keyword">mstime_t</span> now = mstime();</span><br><span class="line"></span><br><span class="line">    listRewind(sentinel.scripts_queue,&amp;li);</span><br><span class="line">    <span class="keyword">while</span> ((ln = listNext(&amp;li)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelScriptJob *sj = ln-&gt;value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//运行中&amp;超时</span></span><br><span class="line">        <span class="keyword">if</span> (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING &amp;&amp;</span><br><span class="line">            (now - sj-&gt;start_time) &gt; SENTINEL_SCRIPT_MAX_RUNTIME)</span><br><span class="line">        &#123;</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;-script-timeout&quot;</span>,<span class="literal">NULL</span>,<span class="string">&quot;%s %ld&quot;</span>,</span><br><span class="line">                sj-&gt;argv[<span class="number">0</span>], (<span class="keyword">long</span>)sj-&gt;pid);</span><br><span class="line">            kill(sj-&gt;pid,SIGKILL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelPendingScriptsCommand"><a href="#sentinelPendingScriptsCommand" class="headerlink" title="sentinelPendingScriptsCommand"></a>sentinelPendingScriptsCommand</h5><p>响应sentinel pending-script命令，获取任务队列中的脚本信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelPendingScriptsCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    listNode *ln;</span><br><span class="line">    listIter li;</span><br><span class="line"></span><br><span class="line">    addReplyMultiBulkLen(c,listLength(sentinel.scripts_queue));</span><br><span class="line">    listRewind(sentinel.scripts_queue,&amp;li);</span><br><span class="line">    <span class="keyword">while</span> ((ln = listNext(&amp;li)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelScriptJob *sj = ln-&gt;value;</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        addReplyMultiBulkLen(c,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;argv&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (sj-&gt;argv[j]) j++;</span><br><span class="line">        addReplyMultiBulkLen(c,j);</span><br><span class="line">        j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (sj-&gt;argv[j]) addReplyBulkCString(c,sj-&gt;argv[j++]);</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;flags&quot;</span>);</span><br><span class="line">        addReplyBulkCString(c,</span><br><span class="line">            (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) ? <span class="string">&quot;running&quot;</span> : <span class="string">&quot;scheduled&quot;</span>);</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;pid&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,sj-&gt;pid);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sj-&gt;flags &amp; SENTINEL_SCRIPT_RUNNING) &#123;</span><br><span class="line">            addReplyBulkCString(c,<span class="string">&quot;run-time&quot;</span>);</span><br><span class="line">            addReplyBulkLongLong(c,mstime() - sj-&gt;start_time);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">mstime_t</span> delay = sj-&gt;start_time ? (sj-&gt;start_time-mstime()) : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (delay &lt; <span class="number">0</span>) delay = <span class="number">0</span>;</span><br><span class="line">            addReplyBulkCString(c,<span class="string">&quot;run-delay&quot;</span>);</span><br><span class="line">            addReplyBulkLongLong(c,delay);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;retry-num&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,sj-&gt;retry_num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelCallClientReconfScript"><a href="#sentinelCallClientReconfScript" class="headerlink" title="sentinelCallClientReconfScript"></a>sentinelCallClientReconfScript</h5><p>slave节点更新配置时，触发的脚本</p>
<p>脚本的参数为<master-name> <role> <state> <from-ip> <from-port> <to-ip> <to-port></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelCallClientReconfScript</span><span class="params">(sentinelRedisInstance *master, <span class="keyword">int</span> role, <span class="keyword">char</span> *state, sentinelAddr *from, sentinelAddr *to)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> fromport[<span class="number">32</span>], toport[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (master-&gt;client_reconfig_script == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">    ll2string(fromport,<span class="keyword">sizeof</span>(fromport),from-&gt;port);</span><br><span class="line">    ll2string(toport,<span class="keyword">sizeof</span>(toport),to-&gt;port);</span><br><span class="line">    sentinelScheduleScriptExecution(master-&gt;client_reconfig_script,</span><br><span class="line">        master-&gt;name,</span><br><span class="line">        (role == SENTINEL_LEADER) ? <span class="string">&quot;leader&quot;</span> : <span class="string">&quot;observer&quot;</span>,</span><br><span class="line">        state, from-&gt;ip, fromport, to-&gt;ip, toport, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="连接相关"><a href="#连接相关" class="headerlink" title="连接相关"></a>连接相关</h4><p>哨兵和master,slave,其他哨兵的连接，都是使用<code>instanceLink</code>结构体存储，分为普通命令连接和发布订阅连接两种，都是异步的流程</p>
<h5 id="createInstanceLink"><a href="#createInstanceLink" class="headerlink" title="createInstanceLink"></a>createInstanceLink</h5><p>创建连接</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">instanceLink *<span class="title">createInstanceLink</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    instanceLink *link = zmalloc(<span class="keyword">sizeof</span>(*link));</span><br><span class="line"></span><br><span class="line">    link-&gt;refcount = <span class="number">1</span>;</span><br><span class="line">    link-&gt;disconnected = <span class="number">1</span>;</span><br><span class="line">    link-&gt;pending_commands = <span class="number">0</span>;</span><br><span class="line">    link-&gt;cc = <span class="literal">NULL</span>;</span><br><span class="line">    link-&gt;pc = <span class="literal">NULL</span>;</span><br><span class="line">    link-&gt;cc_conn_time = <span class="number">0</span>;</span><br><span class="line">    link-&gt;pc_conn_time = <span class="number">0</span>;</span><br><span class="line">    link-&gt;last_reconn_time = <span class="number">0</span>;</span><br><span class="line">    link-&gt;pc_last_activity = <span class="number">0</span>;</span><br><span class="line">    link-&gt;act_ping_time = mstime();</span><br><span class="line">    link-&gt;last_ping_time = <span class="number">0</span>;</span><br><span class="line">    link-&gt;last_avail_time = mstime();</span><br><span class="line">    link-&gt;last_pong_time = mstime();</span><br><span class="line">    <span class="keyword">return</span> link;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="instanceLinkCloseConnection"><a href="#instanceLinkCloseConnection" class="headerlink" title="instanceLinkCloseConnection"></a>instanceLinkCloseConnection</h5><p>关闭特定的连接，普通命令连接或者发布订阅连接</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">instanceLinkCloseConnection</span><span class="params">(instanceLink *link, redisAsyncContext *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//普通连接</span></span><br><span class="line">    <span class="keyword">if</span> (link-&gt;cc == c) &#123;</span><br><span class="line">        link-&gt;cc = <span class="literal">NULL</span>;</span><br><span class="line">        link-&gt;pending_commands = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发布订阅</span></span><br><span class="line">    <span class="keyword">if</span> (link-&gt;pc == c) link-&gt;pc = <span class="literal">NULL</span>;</span><br><span class="line">    c-&gt;data = <span class="literal">NULL</span>;</span><br><span class="line">    link-&gt;disconnected = <span class="number">1</span>;</span><br><span class="line">    redisAsyncFree(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="releaseInstanceLink"><a href="#releaseInstanceLink" class="headerlink" title="releaseInstanceLink"></a>releaseInstanceLink</h5><p>释放连接，连接都是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">instanceLink *<span class="title">releaseInstanceLink</span><span class="params">(instanceLink *link, sentinelRedisInstance *ri)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    serverAssert(link-&gt;refcount &gt; <span class="number">0</span>);</span><br><span class="line">    link-&gt;refcount--;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果还有其他节点使用该连接，那么在hiredis的上下文中，替换其回调函数为忽略任何信息</span></span><br><span class="line">    <span class="keyword">if</span> (link-&gt;refcount != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ri &amp;&amp; ri-&gt;link-&gt;cc) &#123;</span><br><span class="line">            redisCallback *cb;</span><br><span class="line">            redisCallbackList *callbacks = &amp;link-&gt;cc-&gt;replies;</span><br><span class="line"></span><br><span class="line">            cb = callbacks-&gt;head;</span><br><span class="line">            <span class="keyword">while</span>(cb) &#123;</span><br><span class="line">                <span class="comment">//替换</span></span><br><span class="line">                <span class="keyword">if</span> (cb-&gt;privdata == ri) &#123;</span><br><span class="line">                    cb-&gt;fn = sentinelDiscardReplyCallback;</span><br><span class="line">                    cb-&gt;privdata = <span class="literal">NULL</span>; <span class="comment">/* Not strictly needed. */</span></span><br><span class="line">                &#125;</span><br><span class="line">                cb = cb-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> link;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//没有人使用了，关闭普通连接&amp;发布订阅连接</span></span><br><span class="line">    instanceLinkCloseConnection(link,link-&gt;cc);</span><br><span class="line">    instanceLinkCloseConnection(link,link-&gt;pc);</span><br><span class="line">    zfree(link);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelTryConnectionSharing"><a href="#sentinelTryConnectionSharing" class="headerlink" title="sentinelTryConnectionSharing"></a>sentinelTryConnectionSharing</h5><p>尝试共享连接，当一个哨兵监听多个master时，每个master的sentinels里，都有一个sentinelRedisInstance哨兵节点，那么这些哨兵的节点是可以共用一个的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelTryConnectionSharing</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    serverAssert(ri-&gt;flags &amp; SRI_SENTINEL);</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;runid == <span class="literal">NULL</span>) <span class="keyword">return</span> C_ERR; <span class="comment">//无法辨识</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;link-&gt;refcount &gt; <span class="number">1</span>) <span class="keyword">return</span> C_ERR; <span class="comment">//当前节点的连接已经共享了，无需替换</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历所有的master节点</span></span><br><span class="line">    di = dictGetIterator(sentinel.masters);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *master = dictGetVal(de), *match;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//跳过自己当前的master</span></span><br><span class="line">        <span class="keyword">if</span> (master == ri-&gt;master) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从master的哨兵里查找相同运行id的节点</span></span><br><span class="line">        match = getSentinelRedisInstanceByAddrAndRunID(master-&gt;sentinels,</span><br><span class="line">                                                       <span class="literal">NULL</span>,<span class="number">0</span>,ri-&gt;runid);</span><br><span class="line">        <span class="keyword">if</span> (match == <span class="literal">NULL</span>) <span class="keyword">continue</span>; <span class="comment">//没有找到</span></span><br><span class="line">        <span class="keyword">if</span> (match == ri) <span class="keyword">continue</span>; <span class="comment">//找到自己，虽然永远不会发生</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//找一个可以共用的，那么就可以把自己的连接给释放掉了</span></span><br><span class="line">        releaseInstanceLink(ri-&gt;link,<span class="literal">NULL</span>);</span><br><span class="line">        ri-&gt;link = match-&gt;link;</span><br><span class="line">        match-&gt;link-&gt;refcount++;</span><br><span class="line">        <span class="keyword">return</span> C_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">    <span class="keyword">return</span> C_ERR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelUpdateSentinelAddressInAllMasters"><a href="#sentinelUpdateSentinelAddressInAllMasters" class="headerlink" title="sentinelUpdateSentinelAddressInAllMasters"></a>sentinelUpdateSentinelAddressInAllMasters</h5><p>更新所有master中的某一个哨兵的地址信息，使用ri中的地址替换</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelUpdateSentinelAddressInAllMasters</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    serverAssert(ri-&gt;flags &amp; SRI_SENTINEL);</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">int</span> reconfigured = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历所有master</span></span><br><span class="line">    di = dictGetIterator(sentinel.masters);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *master = dictGetVal(de), *match;</span><br><span class="line">        match = getSentinelRedisInstanceByAddrAndRunID(master-&gt;sentinels,</span><br><span class="line">                                                       <span class="literal">NULL</span>,<span class="number">0</span>,ri-&gt;runid);</span><br><span class="line">        <span class="comment">//没找到</span></span><br><span class="line">        <span class="keyword">if</span> (match == <span class="literal">NULL</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//断开连接</span></span><br><span class="line">        <span class="keyword">if</span> (match-&gt;link-&gt;cc != <span class="literal">NULL</span>)</span><br><span class="line">            instanceLinkCloseConnection(match-&gt;link,match-&gt;link-&gt;cc);</span><br><span class="line">        <span class="keyword">if</span> (match-&gt;link-&gt;pc != <span class="literal">NULL</span>)</span><br><span class="line">            instanceLinkCloseConnection(match-&gt;link,match-&gt;link-&gt;pc);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (match == ri) <span class="keyword">continue</span>;<span class="comment">//找到自己</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//释放旧的地址，复制新的</span></span><br><span class="line">        releaseSentinelAddr(match-&gt;addr);</span><br><span class="line">        match-&gt;addr = dupSentinelAddr(ri-&gt;addr);</span><br><span class="line">        reconfigured++;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通知</span></span><br><span class="line">    <span class="keyword">if</span> (reconfigured)</span><br><span class="line">        sentinelEvent(LL_NOTICE,<span class="string">&quot;+sentinel-address-update&quot;</span>, ri,</span><br><span class="line">                    <span class="string">&quot;%@ %d additional matching instances&quot;</span>, reconfigured);</span><br><span class="line">    <span class="keyword">return</span> reconfigured;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="instanceLinkConnectionError"><a href="#instanceLinkConnectionError" class="headerlink" title="instanceLinkConnectionError"></a>instanceLinkConnectionError</h5><p>连接出错</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">instanceLinkConnectionError</span><span class="params">(<span class="keyword">const</span> redisAsyncContext *c)</span> </span>&#123;</span><br><span class="line">    instanceLink *link = c-&gt;data;</span><br><span class="line">    <span class="keyword">int</span> pubsub;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!link) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    pubsub = (link-&gt;pc == c);</span><br><span class="line">    <span class="keyword">if</span> (pubsub)</span><br><span class="line">        link-&gt;pc = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        link-&gt;cc = <span class="literal">NULL</span>;</span><br><span class="line">    link-&gt;disconnected = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelLinkEstablishedCallback"><a href="#sentinelLinkEstablishedCallback" class="headerlink" title="sentinelLinkEstablishedCallback"></a>sentinelLinkEstablishedCallback</h5><p>确定连接结果的回调，只处理失败的情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelLinkEstablishedCallback</span><span class="params">(<span class="keyword">const</span> redisAsyncContext *c, <span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (status != C_OK) instanceLinkConnectionError(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelDisconnectCallback"><a href="#sentinelDisconnectCallback" class="headerlink" title="sentinelDisconnectCallback"></a>sentinelDisconnectCallback</h5><p>断开连接的回调</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelDisconnectCallback</span><span class="params">(<span class="keyword">const</span> redisAsyncContext *c, <span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">    UNUSED(status);</span><br><span class="line">    instanceLinkConnectionError(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="哨兵管理节点实例"><a href="#哨兵管理节点实例" class="headerlink" title="哨兵管理节点实例"></a>哨兵管理节点实例</h4><p>每一个master、slave、其他的哨兵都是在该对象下管理</p>
<h5 id="createSentinelRedisInstance"><a href="#createSentinelRedisInstance" class="headerlink" title="createSentinelRedisInstance"></a>createSentinelRedisInstance</h5><p>创建节点实例</p>
<p>name 节点实例的名字，对于master，是在配置文件中指定的；对于salve，是ip:port；对于其他哨兵，是起runid<br>flags 节点实例类型，master、slave、哨兵<br>hostname 实例主机名<br>port 实例端口<br>quorum master节点发生故障时，需要多少个哨兵达成一致才可以<br>master 创建slave、哨兵节点实例的时候，对应的master信息，创建master时，为NULL</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sentinelRedisInstance *<span class="title">createSentinelRedisInstance</span><span class="params">(<span class="keyword">char</span> *name, <span class="keyword">int</span> flags, <span class="keyword">char</span> *hostname, <span class="keyword">int</span> port, <span class="keyword">int</span> quorum, sentinelRedisInstance *master)</span> </span>&#123;</span><br><span class="line">    sentinelRedisInstance *ri;</span><br><span class="line">    sentinelAddr *addr;</span><br><span class="line">    dict *table = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> slavename[NET_PEER_ID_LEN], *sdsname;</span><br><span class="line"></span><br><span class="line">    serverAssert(flags &amp; (SRI_MASTER|SRI_SLAVE|SRI_SENTINEL));</span><br><span class="line">    serverAssert((flags &amp; SRI_MASTER) || master != <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查host&amp;port是否可用</span></span><br><span class="line">    addr = createSentinelAddr(hostname,port);</span><br><span class="line">    <span class="keyword">if</span> (addr == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对于slave节点，ip:port作为其名字</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; SRI_SLAVE) &#123;</span><br><span class="line">        anetFormatAddr(slavename, <span class="keyword">sizeof</span>(slavename), hostname, port);</span><br><span class="line">        name = slavename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//确定新节点要插入的位置</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; SRI_MASTER) table = sentinel.masters;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (flags &amp; SRI_SLAVE) table = master-&gt;slaves;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (flags &amp; SRI_SENTINEL) table = master-&gt;sentinels;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查是否已经存在</span></span><br><span class="line">    sdsname = sdsnew(name);</span><br><span class="line">    <span class="keyword">if</span> (dictFind(table,sdsname)) &#123;</span><br><span class="line">        releaseSentinelAddr(addr);</span><br><span class="line">        sdsfree(sdsname);</span><br><span class="line">        errno = EBUSY;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建实例，连接状态为断开，下一次时间循环时会处理连接</span></span><br><span class="line">    ri = zmalloc(<span class="keyword">sizeof</span>(*ri));</span><br><span class="line">    </span><br><span class="line">    ri-&gt;flags = flags;</span><br><span class="line">    ri-&gt;name = sdsname;</span><br><span class="line">    ri-&gt;runid = <span class="literal">NULL</span>;</span><br><span class="line">    ri-&gt;config_epoch = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;addr = addr;</span><br><span class="line">    ri-&gt;link = createInstanceLink();</span><br><span class="line">    ri-&gt;last_pub_time = mstime();</span><br><span class="line">    ri-&gt;last_hello_time = mstime();</span><br><span class="line">    ri-&gt;last_master_down_reply_time = mstime();</span><br><span class="line">    ri-&gt;s_down_since_time = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;o_down_since_time = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;down_after_period = master ? master-&gt;down_after_period :</span><br><span class="line">                            SENTINEL_DEFAULT_DOWN_AFTER;</span><br><span class="line">    ri-&gt;master_link_down_time = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;auth_pass = <span class="literal">NULL</span>;</span><br><span class="line">    ri-&gt;slave_priority = SENTINEL_DEFAULT_SLAVE_PRIORITY;</span><br><span class="line">    ri-&gt;slave_reconf_sent_time = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;slave_master_host = <span class="literal">NULL</span>;</span><br><span class="line">    ri-&gt;slave_master_port = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;slave_master_link_status = SENTINEL_MASTER_LINK_STATUS_DOWN;</span><br><span class="line">    ri-&gt;slave_repl_offset = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;sentinels = dictCreate(&amp;instancesDictType,<span class="literal">NULL</span>);</span><br><span class="line">    ri-&gt;quorum = quorum;</span><br><span class="line">    ri-&gt;parallel_syncs = SENTINEL_DEFAULT_PARALLEL_SYNCS;</span><br><span class="line">    ri-&gt;master = master;</span><br><span class="line">    ri-&gt;slaves = dictCreate(&amp;instancesDictType,<span class="literal">NULL</span>);</span><br><span class="line">    ri-&gt;info_refresh = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;renamed_commands = dictCreate(&amp;renamedCommandsDictType,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Failover state. */</span></span><br><span class="line">    ri-&gt;leader = <span class="literal">NULL</span>;</span><br><span class="line">    ri-&gt;leader_epoch = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;failover_epoch = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_NONE;</span><br><span class="line">    ri-&gt;failover_state_change_time = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;failover_start_time = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;failover_timeout = SENTINEL_DEFAULT_FAILOVER_TIMEOUT;</span><br><span class="line">    ri-&gt;failover_delay_logged = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;promoted_slave = <span class="literal">NULL</span>;</span><br><span class="line">    ri-&gt;notification_script = <span class="literal">NULL</span>;</span><br><span class="line">    ri-&gt;client_reconfig_script = <span class="literal">NULL</span>;</span><br><span class="line">    ri-&gt;info = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//角色</span></span><br><span class="line">    ri-&gt;role_reported = ri-&gt;flags &amp; (SRI_MASTER|SRI_SLAVE);</span><br><span class="line">    ri-&gt;role_reported_time = mstime();</span><br><span class="line">    ri-&gt;slave_conf_change_time = mstime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加到正确的位置</span></span><br><span class="line">    dictAdd(table, ri-&gt;name, ri);</span><br><span class="line">    <span class="keyword">return</span> ri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="releaseSentinelRedisInstance"><a href="#releaseSentinelRedisInstance" class="headerlink" title="releaseSentinelRedisInstance"></a>releaseSentinelRedisInstance</h5><p>释放节点实例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">releaseSentinelRedisInstance</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    dictRelease(ri-&gt;sentinels);</span><br><span class="line">    dictRelease(ri-&gt;slaves);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//断开连接</span></span><br><span class="line">    releaseInstanceLink(ri-&gt;link,ri);</span><br><span class="line"></span><br><span class="line">    sdsfree(ri-&gt;name);</span><br><span class="line">    sdsfree(ri-&gt;runid);</span><br><span class="line">    sdsfree(ri-&gt;notification_script);</span><br><span class="line">    sdsfree(ri-&gt;client_reconfig_script);</span><br><span class="line">    sdsfree(ri-&gt;slave_master_host);</span><br><span class="line">    sdsfree(ri-&gt;leader);</span><br><span class="line">    sdsfree(ri-&gt;auth_pass);</span><br><span class="line">    sdsfree(ri-&gt;info);</span><br><span class="line">    releaseSentinelAddr(ri-&gt;addr);</span><br><span class="line">    dictRelease(ri-&gt;renamed_commands);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果释放的节点是被选中成为新master的节点，那么更新master中的被选中节点信息</span></span><br><span class="line">    <span class="keyword">if</span> ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp; (ri-&gt;flags &amp; SRI_PROMOTED) &amp;&amp; ri-&gt;master)</span><br><span class="line">        ri-&gt;master-&gt;promoted_slave = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    zfree(ri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelRedisInstanceLookupSlave"><a href="#sentinelRedisInstanceLookupSlave" class="headerlink" title="sentinelRedisInstanceLookupSlave"></a>sentinelRedisInstanceLookupSlave</h5><p>根据ip和端口在master节点中查找对应的slave节点实例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sentinelRedisInstance *<span class="title">sentinelRedisInstanceLookupSlave</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                sentinelRedisInstance *ri, <span class="keyword">char</span> *ip, <span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sds key;</span><br><span class="line">    sentinelRedisInstance *slave;</span><br><span class="line">    <span class="keyword">char</span> buf[NET_PEER_ID_LEN];</span><br><span class="line"></span><br><span class="line">    serverAssert(ri-&gt;flags &amp; SRI_MASTER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//组装名称ip:port</span></span><br><span class="line">    anetFormatAddr(buf,<span class="keyword">sizeof</span>(buf),ip,port);</span><br><span class="line">    key = sdsnew(buf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查找</span></span><br><span class="line">    slave = dictFetchValue(ri-&gt;slaves,key);</span><br><span class="line">    sdsfree(key);</span><br><span class="line">    <span class="keyword">return</span> slave;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelRedisInstanceTypeStr"><a href="#sentinelRedisInstanceTypeStr" class="headerlink" title="sentinelRedisInstanceTypeStr"></a>sentinelRedisInstanceTypeStr</h5><p>返回实例对应的类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">sentinelRedisInstanceTypeStr</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_MASTER) <span class="keyword">return</span> <span class="string">&quot;master&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_SLAVE) <span class="keyword">return</span> <span class="string">&quot;slave&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_SENTINEL) <span class="keyword">return</span> <span class="string">&quot;sentinel&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="removeMatchingSentinelFromMaster"><a href="#removeMatchingSentinelFromMaster" class="headerlink" title="removeMatchingSentinelFromMaster"></a>removeMatchingSentinelFromMaster</h5><p>从master的监听哨兵中移除一个哨兵，根据runid</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">removeMatchingSentinelFromMaster</span><span class="params">(sentinelRedisInstance *master, <span class="keyword">char</span> *runid)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">int</span> removed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (runid == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    di = dictGetSafeIterator(master-&gt;sentinels);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//匹配runid</span></span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;runid &amp;&amp; <span class="built_in">strcmp</span>(ri-&gt;runid,runid) == <span class="number">0</span>) &#123;</span><br><span class="line">            dictDelete(master-&gt;sentinels,ri-&gt;name);</span><br><span class="line">            removed++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">    <span class="keyword">return</span> removed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="getSentinelRedisInstanceByAddrAndRunID"><a href="#getSentinelRedisInstanceByAddrAndRunID" class="headerlink" title="getSentinelRedisInstanceByAddrAndRunID"></a>getSentinelRedisInstanceByAddrAndRunID</h5><p>在节点字典里，根绝ip,port,runid查找节点，ip和runid必须有一个非空</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sentinelRedisInstance *<span class="title">getSentinelRedisInstanceByAddrAndRunID</span><span class="params">(dict *instances, <span class="keyword">char</span> *ip, <span class="keyword">int</span> port, <span class="keyword">char</span> *runid)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    sentinelRedisInstance *instance = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ip&amp;runid至少有一个非空</span></span><br><span class="line">    serverAssert(ip || runid);</span><br><span class="line">    di = dictGetIterator(instances);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (runid &amp;&amp; !ri-&gt;runid) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> ((runid == <span class="literal">NULL</span> || <span class="built_in">strcmp</span>(ri-&gt;runid, runid) == <span class="number">0</span>) &amp;&amp;</span><br><span class="line">            (ip == <span class="literal">NULL</span> || (<span class="built_in">strcmp</span>(ri-&gt;addr-&gt;ip, ip) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                            ri-&gt;addr-&gt;port == port)))</span><br><span class="line">        &#123;</span><br><span class="line">            instance = ri;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelGetMasterByName"><a href="#sentinelGetMasterByName" class="headerlink" title="sentinelGetMasterByName"></a>sentinelGetMasterByName</h5><p>根据名称获取master节点实例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sentinelRedisInstance *<span class="title">sentinelGetMasterByName</span><span class="params">(<span class="keyword">char</span> *name)</span> </span>&#123;</span><br><span class="line">    sentinelRedisInstance *ri;</span><br><span class="line">    sds sdsname = sdsnew(name);</span><br><span class="line"></span><br><span class="line">    ri = dictFetchValue(sentinel.masters,sdsname);</span><br><span class="line">    sdsfree(sdsname);</span><br><span class="line">    <span class="keyword">return</span> ri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelAddFlagsToDictOfRedisInstances"><a href="#sentinelAddFlagsToDictOfRedisInstances" class="headerlink" title="sentinelAddFlagsToDictOfRedisInstances"></a>sentinelAddFlagsToDictOfRedisInstances</h5><p>向一堆节点添加标志位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelAddFlagsToDictOfRedisInstances</span><span class="params">(dict *instances, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    di = dictGetIterator(instances);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line">        ri-&gt;flags |= flags;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelDelFlagsToDictOfRedisInstances"><a href="#sentinelDelFlagsToDictOfRedisInstances" class="headerlink" title="sentinelDelFlagsToDictOfRedisInstances"></a>sentinelDelFlagsToDictOfRedisInstances</h5><p>向一堆节点删除标志位</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelDelFlagsToDictOfRedisInstances</span><span class="params">(dict *instances, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    di = dictGetIterator(instances);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line">        ri-&gt;flags &amp;= ~flags;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelResetMaster"><a href="#sentinelResetMaster" class="headerlink" title="sentinelResetMaster"></a>sentinelResetMaster</h5><p>重置master节点信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_RESET_NO_SENTINELS (1&lt;&lt;0)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelResetMaster</span><span class="params">(sentinelRedisInstance *ri, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    serverAssert(ri-&gt;flags &amp; SRI_MASTER);</span><br><span class="line">    dictRelease(ri-&gt;slaves);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//清空对应的slave节点信息</span></span><br><span class="line">    ri-&gt;slaves = dictCreate(&amp;instancesDictType,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//清空对应的哨兵节点信息</span></span><br><span class="line">    <span class="keyword">if</span> (!(flags &amp; SENTINEL_RESET_NO_SENTINELS)) &#123;</span><br><span class="line">        dictRelease(ri-&gt;sentinels);</span><br><span class="line">        ri-&gt;sentinels = dictCreate(&amp;instancesDictType,<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭连接</span></span><br><span class="line">    instanceLinkCloseConnection(ri-&gt;link,ri-&gt;link-&gt;cc);</span><br><span class="line">    instanceLinkCloseConnection(ri-&gt;link,ri-&gt;link-&gt;pc);</span><br><span class="line">    ri-&gt;flags &amp;= SRI_MASTER;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//清除leader信息</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;leader) &#123;</span><br><span class="line">        sdsfree(ri-&gt;leader);</span><br><span class="line">        ri-&gt;leader = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//故障修复状态归零</span></span><br><span class="line">    ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_NONE;</span><br><span class="line">    ri-&gt;failover_state_change_time = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;failover_start_time = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;promoted_slave = <span class="literal">NULL</span>;</span><br><span class="line">    sdsfree(ri-&gt;runid);</span><br><span class="line">    sdsfree(ri-&gt;slave_master_host);</span><br><span class="line">    ri-&gt;runid = <span class="literal">NULL</span>;</span><br><span class="line">    ri-&gt;slave_master_host = <span class="literal">NULL</span>;</span><br><span class="line">    ri-&gt;link-&gt;act_ping_time = mstime();</span><br><span class="line">    ri-&gt;link-&gt;last_ping_time = <span class="number">0</span>;</span><br><span class="line">    ri-&gt;link-&gt;last_avail_time = mstime();</span><br><span class="line">    ri-&gt;link-&gt;last_pong_time = mstime();</span><br><span class="line">    ri-&gt;role_reported_time = mstime();</span><br><span class="line">    ri-&gt;role_reported = SRI_MASTER;</span><br><span class="line">    <span class="keyword">if</span> (flags &amp; SENTINEL_GENERATE_EVENT)</span><br><span class="line">        sentinelEvent(LL_WARNING,<span class="string">&quot;+reset-master&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelResetMastersByPattern"><a href="#sentinelResetMastersByPattern" class="headerlink" title="sentinelResetMastersByPattern"></a>sentinelResetMastersByPattern</h5><p>正则匹配，重置master</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelResetMastersByPattern</span><span class="params">(<span class="keyword">char</span> *pattern, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">int</span> reset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    di = dictGetIterator(sentinel.masters);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;name) &#123;</span><br><span class="line">            <span class="keyword">if</span> (stringmatch(pattern,ri-&gt;name,<span class="number">0</span>)) &#123;</span><br><span class="line">                sentinelResetMaster(ri,flags);</span><br><span class="line">                reset++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">    <span class="keyword">return</span> reset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelResetMasterAndChangeAddress"><a href="#sentinelResetMasterAndChangeAddress" class="headerlink" title="sentinelResetMasterAndChangeAddress"></a>sentinelResetMasterAndChangeAddress</h5><p>重置master并改变ip和port</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelResetMasterAndChangeAddress</span><span class="params">(sentinelRedisInstance *master, <span class="keyword">char</span> *ip, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">    sentinelAddr *oldaddr, *newaddr;</span><br><span class="line">    sentinelAddr **slaves = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> numslaves = <span class="number">0</span>, j;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验ip&amp;port</span></span><br><span class="line">    newaddr = createSentinelAddr(ip,port);</span><br><span class="line">    <span class="keyword">if</span> (newaddr == <span class="literal">NULL</span>) <span class="keyword">return</span> C_ERR;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在master下的所有的slave节点中去除掉匹配中的slave，针对于某个slave提升为master的情况</span></span><br><span class="line">    di = dictGetIterator(master-&gt;slaves);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *slave = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sentinelAddrIsEqual(slave-&gt;addr,newaddr)) <span class="keyword">continue</span>;</span><br><span class="line">        slaves = zrealloc(slaves,<span class="keyword">sizeof</span>(sentinelAddr*)*(numslaves+<span class="number">1</span>));</span><br><span class="line">        slaves[numslaves++] = createSentinelAddr(slave-&gt;addr-&gt;ip,</span><br><span class="line">                                                 slave-&gt;addr-&gt;port);</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把之前的master加入到slave节点中去，为了后面改节点恢复成master</span></span><br><span class="line">    <span class="keyword">if</span> (!sentinelAddrIsEqual(newaddr,master-&gt;addr)) &#123;</span><br><span class="line">        slaves = zrealloc(slaves,<span class="keyword">sizeof</span>(sentinelAddr*)*(numslaves+<span class="number">1</span>));</span><br><span class="line">        slaves[numslaves++] = createSentinelAddr(master-&gt;addr-&gt;ip,</span><br><span class="line">                                                 master-&gt;addr-&gt;port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重置master信息，指定新的ip和port</span></span><br><span class="line">    sentinelResetMaster(master,SENTINEL_RESET_NO_SENTINELS);</span><br><span class="line">    oldaddr = master-&gt;addr;</span><br><span class="line">    master-&gt;addr = newaddr;</span><br><span class="line">    master-&gt;o_down_since_time = <span class="number">0</span>;</span><br><span class="line">    master-&gt;s_down_since_time = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把salve节点 归到 新的master下</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; numslaves; j++) &#123;</span><br><span class="line">        sentinelRedisInstance *slave;</span><br><span class="line"></span><br><span class="line">        slave = createSentinelRedisInstance(<span class="literal">NULL</span>,SRI_SLAVE,slaves[j]-&gt;ip,</span><br><span class="line">                    slaves[j]-&gt;port, master-&gt;quorum, master);</span><br><span class="line">        releaseSentinelAddr(slaves[j]);</span><br><span class="line">        <span class="keyword">if</span> (slave) sentinelEvent(LL_NOTICE,<span class="string">&quot;+slave&quot;</span>,slave,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    zfree(slaves);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新配置</span></span><br><span class="line">    releaseSentinelAddr(oldaddr);</span><br><span class="line">    sentinelFlushConfig();</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelRedisInstanceNoDownFor"><a href="#sentinelRedisInstanceNoDownFor" class="headerlink" title="sentinelRedisInstanceNoDownFor"></a>sentinelRedisInstanceNoDownFor</h5><p>判断节点在指定的超时时间内，是否有下线转态，非0表示没有</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelRedisInstanceNoDownFor</span><span class="params">(sentinelRedisInstance *ri, <span class="keyword">mstime_t</span> ms)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">mstime_t</span> most_recent;</span><br><span class="line"></span><br><span class="line">    most_recent = ri-&gt;s_down_since_time;</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;o_down_since_time &gt; most_recent)</span><br><span class="line">        most_recent = ri-&gt;o_down_since_time;</span><br><span class="line">    <span class="keyword">return</span> most_recent == <span class="number">0</span> || (mstime() - most_recent) &gt; ms;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelGetCurrentMasterAddress"><a href="#sentinelGetCurrentMasterAddress" class="headerlink" title="sentinelGetCurrentMasterAddress"></a>sentinelGetCurrentMasterAddress</h5><p>获取当前节点master的地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sentinelAddr *<span class="title">sentinelGetCurrentMasterAddress</span><span class="params">(sentinelRedisInstance *master)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果是故障恢复中，且选出提升的salve已经提升为master了，返回新master的信息</span></span><br><span class="line">    <span class="keyword">if</span> ((master-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) &amp;&amp;</span><br><span class="line">        master-&gt;promoted_slave &amp;&amp;</span><br><span class="line">        master-&gt;failover_state &gt;= SENTINEL_FAILOVER_STATE_RECONF_SLAVES)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> master-&gt;promoted_slave-&gt;addr;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//返回旧的master</span></span><br><span class="line">        <span class="keyword">return</span> master-&gt;addr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelPropagateDownAfterPeriod"><a href="#sentinelPropagateDownAfterPeriod" class="headerlink" title="sentinelPropagateDownAfterPeriod"></a>sentinelPropagateDownAfterPeriod</h5><p>更新master下的所有slave、哨兵节点的 变为下线所需要的时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelPropagateDownAfterPeriod</span><span class="params">(sentinelRedisInstance *master)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    dict *d[] = &#123;master-&gt;slaves, master-&gt;sentinels, <span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; d[j]; j++) &#123;</span><br><span class="line">        di = dictGetIterator(d[j]);</span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line">            ri-&gt;down_after_period = master-&gt;down_after_period;</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelGetInstanceTypeString"><a href="#sentinelGetInstanceTypeString" class="headerlink" title="sentinelGetInstanceTypeString"></a>sentinelGetInstanceTypeString</h5><p>获取节点类型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">sentinelGetInstanceTypeString</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_MASTER) <span class="keyword">return</span> <span class="string">&quot;master&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_SLAVE) <span class="keyword">return</span> <span class="string">&quot;slave&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_SENTINEL) <span class="keyword">return</span> <span class="string">&quot;sentinel&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelInstanceMapCommand"><a href="#sentinelInstanceMapCommand" class="headerlink" title="sentinelInstanceMapCommand"></a>sentinelInstanceMapCommand</h5><p>获取重命名的命令，当我们从哨兵节点向master发送命令的时候，可能需要采用别名；因为master方面可能为了安全考虑，已经更换了conf,saleof的名字</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">sentinelInstanceMapCommand</span><span class="params">(sentinelRedisInstance *ri, <span class="keyword">char</span> *command)</span> </span>&#123;</span><br><span class="line">    sds sc = sdsnew(command);</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;master) ri = ri-&gt;master;</span><br><span class="line">    <span class="keyword">char</span> *retval = dictFetchValue(ri-&gt;renamed_commands, sc);</span><br><span class="line">    sdsfree(sc);</span><br><span class="line">    <span class="keyword">return</span> retval ? retval : command;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置相关"><a href="#配置相关" class="headerlink" title="配置相关"></a>配置相关</h4><h5 id="sentinelHandleConfiguration"><a href="#sentinelHandleConfiguration" class="headerlink" title="sentinelHandleConfiguration"></a>sentinelHandleConfiguration</h5><p>处理配置文件中相关的配置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">sentinelHandleConfiguration</span><span class="params">(<span class="keyword">char</span> **argv, <span class="keyword">int</span> argc)</span> </span>&#123;</span><br><span class="line">    sentinelRedisInstance *ri;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;monitor&quot;</span>) &amp;&amp; argc == <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="comment">//监听master 格式:monitor &lt;name&gt; &lt;host&gt; &lt;port&gt; &lt;quorum&gt; </span></span><br><span class="line">        <span class="keyword">int</span> quorum = atoi(argv[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (quorum &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="string">&quot;Quorum must be 1 or greater.&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (createSentinelRedisInstance(argv[<span class="number">1</span>],SRI_MASTER,argv[<span class="number">2</span>],</span><br><span class="line">                                        atoi(argv[<span class="number">3</span>]),quorum,<span class="literal">NULL</span>) == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">switch</span>(errno) &#123;</span><br><span class="line">            <span class="keyword">case</span> EBUSY: <span class="keyword">return</span> <span class="string">&quot;Duplicated master name.&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> ENOENT: <span class="keyword">return</span> <span class="string">&quot;Can&#x27;t resolve master instance hostname.&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> EINVAL: <span class="keyword">return</span> <span class="string">&quot;Invalid port number&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;down-after-milliseconds&quot;</span>) &amp;&amp; argc == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="comment">//指定判断下线时长 down-after-milliseconds &lt;name&gt; &lt;milliseconds&gt;</span></span><br><span class="line">        ri = sentinelGetMasterByName(argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!ri) <span class="keyword">return</span> <span class="string">&quot;No such master with specified name.&quot;</span>;</span><br><span class="line">        ri-&gt;down_after_period = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;down_after_period &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;negative or zero time parameter.&quot;</span>;</span><br><span class="line">        sentinelPropagateDownAfterPeriod(ri);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;failover-timeout&quot;</span>) &amp;&amp; argc == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="comment">//指定故障修复超时时间 failover-timeout &lt;name&gt; &lt;milliseconds&gt;</span></span><br><span class="line">        ri = sentinelGetMasterByName(argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!ri) <span class="keyword">return</span> <span class="string">&quot;No such master with specified name.&quot;</span>;</span><br><span class="line">        ri-&gt;failover_timeout = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;failover_timeout &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;negative or zero time parameter.&quot;</span>;</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;parallel-syncs&quot;</span>) &amp;&amp; argc == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="comment">//指定故障修复时，最多有多少个slave节点同时同步 parallel-syncs &lt;name&gt; &lt;milliseconds&gt;</span></span><br><span class="line">        ri = sentinelGetMasterByName(argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!ri) <span class="keyword">return</span> <span class="string">&quot;No such master with specified name.&quot;</span>;</span><br><span class="line">        ri-&gt;parallel_syncs = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;notification-script&quot;</span>) &amp;&amp; argc == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="comment">//指定通知脚本 notification-script &lt;name&gt; &lt;path&gt;</span></span><br><span class="line">        ri = sentinelGetMasterByName(argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!ri) <span class="keyword">return</span> <span class="string">&quot;No such master with specified name.&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (access(argv[<span class="number">2</span>],X_OK) == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Notification script seems non existing or non executable.&quot;</span>;</span><br><span class="line">        ri-&gt;notification_script = sdsnew(argv[<span class="number">2</span>]);</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;client-reconfig-script&quot;</span>) &amp;&amp; argc == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="comment">//指定更新配置时的脚本 client-reconfig-script &lt;name&gt; &lt;path&gt;</span></span><br><span class="line">        ri = sentinelGetMasterByName(argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!ri) <span class="keyword">return</span> <span class="string">&quot;No such master with specified name.&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (access(argv[<span class="number">2</span>],X_OK) == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Client reconfiguration script seems non existing or &quot;</span></span><br><span class="line">                   <span class="string">&quot;non executable.&quot;</span>;</span><br><span class="line">        ri-&gt;client_reconfig_script = sdsnew(argv[<span class="number">2</span>]);</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;auth-pass&quot;</span>) &amp;&amp; argc == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="comment">//指定连接时的密码 auth-pass &lt;name&gt; &lt;password&gt;</span></span><br><span class="line">        ri = sentinelGetMasterByName(argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!ri) <span class="keyword">return</span> <span class="string">&quot;No such master with specified name.&quot;</span>;</span><br><span class="line">        ri-&gt;auth_pass = sdsnew(argv[<span class="number">2</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;current-epoch&quot;</span>) &amp;&amp; argc == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">//指定纪元 current-epoch &lt;epoch&gt;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> current_epoch = strtoull(argv[<span class="number">1</span>],<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (current_epoch &gt; sentinel.current_epoch)</span><br><span class="line">            sentinel.current_epoch = current_epoch;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;myid&quot;</span>) &amp;&amp; argc == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">//指定运行id</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strlen</span>(argv[<span class="number">1</span>]) != CONFIG_RUN_ID_SIZE)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Malformed Sentinel id in myid option.&quot;</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(sentinel.myid,argv[<span class="number">1</span>],CONFIG_RUN_ID_SIZE);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;config-epoch&quot;</span>) &amp;&amp; argc == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="comment">//指定配置纪元 config-epoch &lt;name&gt; &lt;epoch&gt;</span></span><br><span class="line">        ri = sentinelGetMasterByName(argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!ri) <span class="keyword">return</span> <span class="string">&quot;No such master with specified name.&quot;</span>;</span><br><span class="line">        ri-&gt;config_epoch = strtoull(argv[<span class="number">2</span>],<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;config_epoch &gt; sentinel.current_epoch)</span><br><span class="line">            sentinel.current_epoch = ri-&gt;config_epoch;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;leader-epoch&quot;</span>) &amp;&amp; argc == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="comment">//指定leader纪元 leader-epoch &lt;name&gt; &lt;epoch&gt;</span></span><br><span class="line">        ri = sentinelGetMasterByName(argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!ri) <span class="keyword">return</span> <span class="string">&quot;No such master with specified name.&quot;</span>;</span><br><span class="line">        ri-&gt;leader_epoch = strtoull(argv[<span class="number">2</span>],<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;known-slave&quot;</span>) ||</span><br><span class="line">                !strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;known-replica&quot;</span>)) &amp;&amp; argc == <span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sentinelRedisInstance *slave;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//指定对应的slave known-replica &lt;name&gt; &lt;ip&gt; &lt;port&gt;</span></span><br><span class="line">        ri = sentinelGetMasterByName(argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!ri) <span class="keyword">return</span> <span class="string">&quot;No such master with specified name.&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> ((slave = createSentinelRedisInstance(<span class="literal">NULL</span>,SRI_SLAVE,argv[<span class="number">2</span>],</span><br><span class="line">                    atoi(argv[<span class="number">3</span>]), ri-&gt;quorum, ri)) == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Wrong hostname or port for replica.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;known-sentinel&quot;</span>) &amp;&amp;</span><br><span class="line">               (argc == <span class="number">4</span> || argc == <span class="number">5</span>)) &#123;</span><br><span class="line">        sentinelRedisInstance *si;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (argc == <span class="number">5</span>) &#123;</span><br><span class="line">            <span class="comment">//指定对应的哨兵 known-sentinel &lt;name&gt; &lt;ip&gt; &lt;port&gt; [runid]</span></span><br><span class="line">            ri = sentinelGetMasterByName(argv[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">if</span> (!ri) <span class="keyword">return</span> <span class="string">&quot;No such master with specified name.&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> ((si = createSentinelRedisInstance(argv[<span class="number">4</span>],SRI_SENTINEL,argv[<span class="number">2</span>],</span><br><span class="line">                        atoi(argv[<span class="number">3</span>]), ri-&gt;quorum, ri)) == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Wrong hostname or port for sentinel.&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            si-&gt;runid = sdsnew(argv[<span class="number">4</span>]);</span><br><span class="line">            sentinelTryConnectionSharing(si);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;rename-command&quot;</span>) &amp;&amp; argc == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="comment">//命令重命名 rename-command &lt;name&gt; &lt;command&gt; &lt;renamed-command&gt;</span></span><br><span class="line">        ri = sentinelGetMasterByName(argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!ri) <span class="keyword">return</span> <span class="string">&quot;No such master with specified name.&quot;</span>;</span><br><span class="line">        sds oldcmd = sdsnew(argv[<span class="number">2</span>]);</span><br><span class="line">        sds newcmd = sdsnew(argv[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">if</span> (dictAdd(ri-&gt;renamed_commands,oldcmd,newcmd) != DICT_OK) &#123;</span><br><span class="line">            sdsfree(oldcmd);</span><br><span class="line">            sdsfree(newcmd);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Same command renamed multiple times with rename-command.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;announce-ip&quot;</span>) &amp;&amp; argc == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">//指定ip announce-ip &lt;ip-address&gt;</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strlen</span>(argv[<span class="number">1</span>]))</span><br><span class="line">            sentinel.announce_ip = sdsnew(argv[<span class="number">1</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;announce-port&quot;</span>) &amp;&amp; argc == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">//指定端口 announce-port &lt;port&gt;</span></span><br><span class="line">        sentinel.announce_port = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">0</span>],<span class="string">&quot;deny-scripts-reconfig&quot;</span>) &amp;&amp; argc == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">//指定脚本延迟 deny-scripts-reconfig &lt;yes|no&gt;</span></span><br><span class="line">        <span class="keyword">if</span> ((sentinel.deny_scripts_reconfig = yesnotoi(argv[<span class="number">1</span>])) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Please specify yes or no for the &quot;</span></span><br><span class="line">                   <span class="string">&quot;deny-scripts-reconfig options.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Unrecognized sentinel configuration statement.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="rewriteConfigSentinelOption"><a href="#rewriteConfigSentinelOption" class="headerlink" title="rewriteConfigSentinelOption"></a>rewriteConfigSentinelOption</h5><p>重写哨兵配置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rewriteConfigSentinelOption</span><span class="params">(struct rewriteConfigState *state)</span> </span>&#123;</span><br><span class="line">    dictIterator *di, *di2;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    sds line;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//运行id</span></span><br><span class="line">    line = sdscatprintf(sdsempty(), <span class="string">&quot;sentinel myid %s&quot;</span>, sentinel.myid);</span><br><span class="line">    rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//脚本延迟</span></span><br><span class="line">    line = sdscatprintf(sdsempty(), <span class="string">&quot;sentinel deny-scripts-reconfig %s&quot;</span>,</span><br><span class="line">        sentinel.deny_scripts_reconfig ? <span class="string">&quot;yes&quot;</span> : <span class="string">&quot;no&quot;</span>);</span><br><span class="line">    rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,</span><br><span class="line">        sentinel.deny_scripts_reconfig != SENTINEL_DEFAULT_DENY_SCRIPTS_RECONFIG);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//针对每一个监听的master 创建一个 sentinel monitor</span></span><br><span class="line">    di = dictGetIterator(sentinel.masters);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *master, *ri;</span><br><span class="line">        sentinelAddr *master_addr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//master信息</span></span><br><span class="line">        master = dictGetVal(de);</span><br><span class="line">        master_addr = sentinelGetCurrentMasterAddress(master);</span><br><span class="line">        line = sdscatprintf(sdsempty(),<span class="string">&quot;sentinel monitor %s %s %d %d&quot;</span>,</span><br><span class="line">            master-&gt;name, master_addr-&gt;ip, master_addr-&gt;port,</span><br><span class="line">            master-&gt;quorum);</span><br><span class="line">        rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//下线断定时间</span></span><br><span class="line">        <span class="keyword">if</span> (master-&gt;down_after_period != SENTINEL_DEFAULT_DOWN_AFTER) &#123;</span><br><span class="line">            line = sdscatprintf(sdsempty(),</span><br><span class="line">                <span class="string">&quot;sentinel down-after-milliseconds %s %ld&quot;</span>,</span><br><span class="line">                master-&gt;name, (<span class="keyword">long</span>) master-&gt;down_after_period);</span><br><span class="line">            rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//故障修复超时</span></span><br><span class="line">        <span class="keyword">if</span> (master-&gt;failover_timeout != SENTINEL_DEFAULT_FAILOVER_TIMEOUT) &#123;</span><br><span class="line">            line = sdscatprintf(sdsempty(),</span><br><span class="line">                <span class="string">&quot;sentinel failover-timeout %s %ld&quot;</span>,</span><br><span class="line">                master-&gt;name, (<span class="keyword">long</span>) master-&gt;failover_timeout);</span><br><span class="line">            rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//slave同时同步数量</span></span><br><span class="line">        <span class="keyword">if</span> (master-&gt;parallel_syncs != SENTINEL_DEFAULT_PARALLEL_SYNCS) &#123;</span><br><span class="line">            line = sdscatprintf(sdsempty(),</span><br><span class="line">                <span class="string">&quot;sentinel parallel-syncs %s %d&quot;</span>,</span><br><span class="line">                master-&gt;name, master-&gt;parallel_syncs);</span><br><span class="line">            rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通知脚本</span></span><br><span class="line">        <span class="keyword">if</span> (master-&gt;notification_script) &#123;</span><br><span class="line">            line = sdscatprintf(sdsempty(),</span><br><span class="line">                <span class="string">&quot;sentinel notification-script %s %s&quot;</span>,</span><br><span class="line">                master-&gt;name, master-&gt;notification_script);</span><br><span class="line">            rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//重写config脚本</span></span><br><span class="line">        <span class="keyword">if</span> (master-&gt;client_reconfig_script) &#123;</span><br><span class="line">            line = sdscatprintf(sdsempty(),</span><br><span class="line">                <span class="string">&quot;sentinel client-reconfig-script %s %s&quot;</span>,</span><br><span class="line">                master-&gt;name, master-&gt;client_reconfig_script);</span><br><span class="line">            rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//密码</span></span><br><span class="line">        <span class="keyword">if</span> (master-&gt;auth_pass) &#123;</span><br><span class="line">            line = sdscatprintf(sdsempty(),</span><br><span class="line">                <span class="string">&quot;sentinel auth-pass %s %s&quot;</span>,</span><br><span class="line">                master-&gt;name, master-&gt;auth_pass);</span><br><span class="line">            rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置纪元</span></span><br><span class="line">        line = sdscatprintf(sdsempty(),</span><br><span class="line">            <span class="string">&quot;sentinel config-epoch %s %llu&quot;</span>,</span><br><span class="line">            master-&gt;name, (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) master-&gt;config_epoch);</span><br><span class="line">        rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//leader纪元</span></span><br><span class="line">        line = sdscatprintf(sdsempty(),</span><br><span class="line">            <span class="string">&quot;sentinel leader-epoch %s %llu&quot;</span>,</span><br><span class="line">            master-&gt;name, (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) master-&gt;leader_epoch);</span><br><span class="line">        rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//slave节点信息</span></span><br><span class="line">        di2 = dictGetIterator(master-&gt;slaves);</span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di2)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            sentinelAddr *slave_addr;</span><br><span class="line"></span><br><span class="line">            ri = dictGetVal(de);</span><br><span class="line">            slave_addr = ri-&gt;addr;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//处理某个slave已经选举成功的情况</span></span><br><span class="line">            <span class="keyword">if</span> (sentinelAddrIsEqual(slave_addr,master_addr))</span><br><span class="line">                slave_addr = master-&gt;addr;</span><br><span class="line">            line = sdscatprintf(sdsempty(),</span><br><span class="line">                <span class="string">&quot;sentinel known-replica %s %s %d&quot;</span>,</span><br><span class="line">                master-&gt;name, slave_addr-&gt;ip, slave_addr-&gt;port);</span><br><span class="line">            rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//其他哨兵信息</span></span><br><span class="line">        di2 = dictGetIterator(master-&gt;sentinels);</span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di2)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ri = dictGetVal(de);</span><br><span class="line">            <span class="keyword">if</span> (ri-&gt;runid == <span class="literal">NULL</span>) <span class="keyword">continue</span>;</span><br><span class="line">            line = sdscatprintf(sdsempty(),</span><br><span class="line">                <span class="string">&quot;sentinel known-sentinel %s %s %d %s&quot;</span>,</span><br><span class="line">                master-&gt;name, ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port, ri-&gt;runid);</span><br><span class="line">            rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//重命名命令</span></span><br><span class="line">        di2 = dictGetIterator(master-&gt;renamed_commands);</span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di2)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            sds oldname = dictGetKey(de);</span><br><span class="line">            sds newname = dictGetVal(de);</span><br><span class="line">            line = sdscatprintf(sdsempty(),</span><br><span class="line">                <span class="string">&quot;sentinel rename-command %s %s %s&quot;</span>,</span><br><span class="line">                master-&gt;name, oldname, newname);</span><br><span class="line">            rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//哨兵当前纪元</span></span><br><span class="line">    line = sdscatprintf(sdsempty(),</span><br><span class="line">        <span class="string">&quot;sentinel current-epoch %llu&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) sentinel.current_epoch);</span><br><span class="line">    rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//哨兵ip</span></span><br><span class="line">    <span class="keyword">if</span> (sentinel.announce_ip) &#123;</span><br><span class="line">        line = sdsnew(<span class="string">&quot;sentinel announce-ip &quot;</span>);</span><br><span class="line">        line = sdscatrepr(line, sentinel.announce_ip, sdslen(sentinel.announce_ip));</span><br><span class="line">        rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//哨兵端口</span></span><br><span class="line">    <span class="keyword">if</span> (sentinel.announce_port) &#123;</span><br><span class="line">        line = sdscatprintf(sdsempty(),<span class="string">&quot;sentinel announce-port %d&quot;</span>,</span><br><span class="line">                            sentinel.announce_port);</span><br><span class="line">        rewriteConfigRewriteLine(state,<span class="string">&quot;sentinel&quot;</span>,line,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelFlushConfig"><a href="#sentinelFlushConfig" class="headerlink" title="sentinelFlushConfig"></a>sentinelFlushConfig</h5><p>把哨兵模式下的设置参数写入到文件中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelFlushConfig</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> saved_hz = server.hz;</span><br><span class="line">    <span class="keyword">int</span> rewrite_status;</span><br><span class="line"></span><br><span class="line">    server.hz = CONFIG_DEFAULT_HZ;</span><br><span class="line">    rewrite_status = rewriteConfig(server.configfile);</span><br><span class="line">    server.hz = saved_hz;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rewrite_status == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> ((fd = open(server.configfile,O_RDONLY)) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (fsync(fd) == <span class="number">-1</span>) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">if</span> (close(fd) == EOF) <span class="keyword">goto</span> werr;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">werr:</span><br><span class="line">    <span class="keyword">if</span> (fd != <span class="number">-1</span>) close(fd);</span><br><span class="line">    serverLog(LL_WARNING,<span class="string">&quot;WARNING: Sentinel was not able to save the new configuration on disk!!!: %s&quot;</span>, strerror(errno));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="hiredis"><a href="#hiredis" class="headerlink" title="hiredis"></a>hiredis</h4><p>hiredis是一个Redis官方的开发库，封装了各种连接和遵守redis协议的操作</p>
<h5 id="sentinelSendAuthIfNeeded"><a href="#sentinelSendAuthIfNeeded" class="headerlink" title="sentinelSendAuthIfNeeded"></a>sentinelSendAuthIfNeeded</h5><p>发送密码验证，如果设置了的话，auth命令</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelSendAuthIfNeeded</span><span class="params">(sentinelRedisInstance *ri, redisAsyncContext *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *auth_pass = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_MASTER) &#123;</span><br><span class="line">        auth_pass = ri-&gt;auth_pass;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_SLAVE) &#123;</span><br><span class="line">        auth_pass = ri-&gt;master-&gt;auth_pass;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_SENTINEL) &#123;</span><br><span class="line">        <span class="keyword">if</span> (server.requirepass) auth_pass = server.requirepass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (auth_pass) &#123;</span><br><span class="line">        <span class="keyword">if</span> (redisAsyncCommand(c, sentinelDiscardReplyCallback, ri, <span class="string">&quot;%s %s&quot;</span>,</span><br><span class="line">            sentinelInstanceMapCommand(ri,<span class="string">&quot;AUTH&quot;</span>),</span><br><span class="line">            auth_pass) == C_OK) ri-&gt;link-&gt;pending_commands++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelSetClientName"><a href="#sentinelSetClientName" class="headerlink" title="sentinelSetClientName"></a>sentinelSetClientName</h5><p>设置当前连接的名字，client命令</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelSetClientName</span><span class="params">(sentinelRedisInstance *ri, redisAsyncContext *c, <span class="keyword">char</span> *type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">64</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">snprintf</span>(name,<span class="keyword">sizeof</span>(name),<span class="string">&quot;sentinel-%.8s-%s&quot;</span>,sentinel.myid,type);</span><br><span class="line">    <span class="keyword">if</span> (redisAsyncCommand(c, sentinelDiscardReplyCallback, ri,</span><br><span class="line">        <span class="string">&quot;%s SETNAME %s&quot;</span>,</span><br><span class="line">        sentinelInstanceMapCommand(ri,<span class="string">&quot;CLIENT&quot;</span>),</span><br><span class="line">        name) == C_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        ri-&gt;link-&gt;pending_commands++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelReconnectInstance"><a href="#sentinelReconnectInstance" class="headerlink" title="sentinelReconnectInstance"></a>sentinelReconnectInstance</h5><p>重新连接实例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelReconnectInstance</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;link-&gt;disconnected == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;addr-&gt;port == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    instanceLink *link = ri-&gt;link;</span><br><span class="line">    <span class="keyword">mstime_t</span> now = mstime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存活中，不需要</span></span><br><span class="line">    <span class="keyword">if</span> (now - ri-&gt;link-&gt;last_reconn_time &lt; SENTINEL_PING_PERIOD) <span class="keyword">return</span>;</span><br><span class="line">    ri-&gt;link-&gt;last_reconn_time = now;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//普通命令连接</span></span><br><span class="line">    <span class="keyword">if</span> (link-&gt;cc == <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//连接</span></span><br><span class="line">        link-&gt;cc = redisAsyncConnectBind(ri-&gt;addr-&gt;ip,ri-&gt;addr-&gt;port,NET_FIRST_BIND_ADDR);</span><br><span class="line">        <span class="keyword">if</span> (link-&gt;cc-&gt;err) &#123;</span><br><span class="line">            sentinelEvent(LL_DEBUG,<span class="string">&quot;-cmd-link-reconnection&quot;</span>,ri,<span class="string">&quot;%@ #%s&quot;</span>,</span><br><span class="line">                link-&gt;cc-&gt;errstr);</span><br><span class="line">            instanceLinkCloseConnection(link,link-&gt;cc);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            link-&gt;pending_commands = <span class="number">0</span>;</span><br><span class="line">            link-&gt;cc_conn_time = mstime();</span><br><span class="line">            link-&gt;cc-&gt;data = link;</span><br><span class="line">            redisAeAttach(server.el,link-&gt;cc);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//指定连接回调</span></span><br><span class="line">            redisAsyncSetConnectCallback(link-&gt;cc,</span><br><span class="line">                    sentinelLinkEstablishedCallback);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//指定断开连接回调</span></span><br><span class="line">            redisAsyncSetDisconnectCallback(link-&gt;cc,</span><br><span class="line">                    sentinelDisconnectCallback);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//发送密码验证</span></span><br><span class="line">            sentinelSendAuthIfNeeded(ri,link-&gt;cc);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置客户端连接名称</span></span><br><span class="line">            sentinelSetClientName(ri,link-&gt;cc,<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//发送ping命令</span></span><br><span class="line">            sentinelSendPing(ri);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//发布订阅连接</span></span><br><span class="line">    <span class="keyword">if</span> ((ri-&gt;flags &amp; (SRI_MASTER|SRI_SLAVE)) &amp;&amp; link-&gt;pc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        link-&gt;pc = redisAsyncConnectBind(ri-&gt;addr-&gt;ip,ri-&gt;addr-&gt;port,NET_FIRST_BIND_ADDR);</span><br><span class="line">        <span class="keyword">if</span> (link-&gt;pc-&gt;err) &#123;</span><br><span class="line">            sentinelEvent(LL_DEBUG,<span class="string">&quot;-pubsub-link-reconnection&quot;</span>,ri,<span class="string">&quot;%@ #%s&quot;</span>,</span><br><span class="line">                link-&gt;pc-&gt;errstr);</span><br><span class="line">            instanceLinkCloseConnection(link,link-&gt;pc);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">            link-&gt;pc_conn_time = mstime();</span><br><span class="line">            link-&gt;pc-&gt;data = link;</span><br><span class="line">            redisAeAttach(server.el,link-&gt;pc);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//指定连接成功回调</span></span><br><span class="line">            redisAsyncSetConnectCallback(link-&gt;pc,</span><br><span class="line">                    sentinelLinkEstablishedCallback);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//指定断开连接回调</span></span><br><span class="line">            redisAsyncSetDisconnectCallback(link-&gt;pc,</span><br><span class="line">                    sentinelDisconnectCallback);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//发送密码</span></span><br><span class="line">            sentinelSendAuthIfNeeded(ri,link-&gt;pc);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置对方当前连接的的名字</span></span><br><span class="line">            sentinelSetClientName(ri,link-&gt;pc,<span class="string">&quot;pubsub&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//订阅hello频道</span></span><br><span class="line">            retval = redisAsyncCommand(link-&gt;pc,</span><br><span class="line">                sentinelReceiveHelloMessages, ri, <span class="string">&quot;%s %s&quot;</span>,</span><br><span class="line">                sentinelInstanceMapCommand(ri,<span class="string">&quot;SUBSCRIBE&quot;</span>),</span><br><span class="line">                SENTINEL_HELLO_CHANNEL);</span><br><span class="line">            <span class="keyword">if</span> (retval != C_OK) &#123;</span><br><span class="line">                <span class="comment">//不能订阅的话，断开连接</span></span><br><span class="line">                instanceLinkCloseConnection(link,link-&gt;pc);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//维护连接状态，只针对哨兵而言</span></span><br><span class="line">    <span class="keyword">if</span> (link-&gt;cc &amp;&amp; (ri-&gt;flags &amp; SRI_SENTINEL || link-&gt;pc))</span><br><span class="line">        link-&gt;disconnected = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelMasterLooksSane"><a href="#sentinelMasterLooksSane" class="headerlink" title="sentinelMasterLooksSane"></a>sentinelMasterLooksSane</h5><p>判断master是否正常</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelMasterLooksSane</span><span class="params">(sentinelRedisInstance *master)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">        master-&gt;flags &amp; SRI_MASTER &amp;&amp;   <span class="comment">//配置文件标识master</span></span><br><span class="line">        master-&gt;role_reported == SRI_MASTER &amp;&amp; <span class="comment">//info标识master</span></span><br><span class="line">        (master-&gt;flags &amp; (SRI_S_DOWN|SRI_O_DOWN)) == <span class="number">0</span> &amp;&amp; <span class="comment">//没有主观下线&amp;没有客观下线</span></span><br><span class="line">        (mstime() - master-&gt;info_refresh) &lt; SENTINEL_INFO_PERIOD*<span class="number">2</span>; <span class="comment">//在两倍的info相应时间内有info回复</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelRefreshInstanceInfo"><a href="#sentinelRefreshInstanceInfo" class="headerlink" title="sentinelRefreshInstanceInfo"></a>sentinelRefreshInstanceInfo</h5><p>根据info命令返回信息，更新节点信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelRefreshInstanceInfo</span><span class="params">(sentinelRedisInstance *ri, <span class="keyword">const</span> <span class="keyword">char</span> *info)</span> </span>&#123;</span><br><span class="line">    sds *lines;</span><br><span class="line">    <span class="keyword">int</span> numlines, j;</span><br><span class="line">    <span class="keyword">int</span> role = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//缓存下来info信息</span></span><br><span class="line">    sdsfree(ri-&gt;info);</span><br><span class="line">    ri-&gt;info = sdsnew(info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//断开的时间重置成0</span></span><br><span class="line">    ri-&gt;master_link_down_time = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//按行分割信息</span></span><br><span class="line">    lines = sdssplitlen(info,<span class="built_in">strlen</span>(info),<span class="string">&quot;\r\n&quot;</span>,<span class="number">2</span>,&amp;numlines);</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; numlines; j++) &#123;</span><br><span class="line">        sentinelRedisInstance *slave;</span><br><span class="line">        sds l = lines[j];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 运行id run_id:&lt;40 hex chars&gt;  </span></span><br><span class="line">        <span class="keyword">if</span> (sdslen(l) &gt;= <span class="number">47</span> &amp;&amp; !<span class="built_in">memcmp</span>(l,<span class="string">&quot;run_id:&quot;</span>,<span class="number">7</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ri-&gt;runid == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ri-&gt;runid = sdsnewlen(l+<span class="number">7</span>,<span class="number">40</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//如果之前有存runid,这次不一样，说明这台机器重启了</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strncmp</span>(ri-&gt;runid,l+<span class="number">7</span>,<span class="number">40</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                    sentinelEvent(LL_NOTICE,<span class="string">&quot;+reboot&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">                    sdsfree(ri-&gt;runid);</span><br><span class="line">                    ri-&gt;runid = sdsnewlen(l+<span class="number">7</span>,<span class="number">40</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从节点信息</span></span><br><span class="line">        <span class="comment">//旧版本格式 slave0:&lt;ip&gt;,&lt;port&gt;,&lt;state&gt;</span></span><br><span class="line">        <span class="comment">//新版本格式 slave0:ip=127.0.0.1,port=9999,...</span></span><br><span class="line">        <span class="keyword">if</span> ((ri-&gt;flags &amp; SRI_MASTER) &amp;&amp;</span><br><span class="line">            sdslen(l) &gt;= <span class="number">7</span> &amp;&amp;</span><br><span class="line">            !<span class="built_in">memcmp</span>(l,<span class="string">&quot;slave&quot;</span>,<span class="number">5</span>) &amp;&amp; <span class="built_in">isdigit</span>(l[<span class="number">5</span>]))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> *ip, *port, *end;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//旧格式</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr</span>(l,<span class="string">&quot;ip=&quot;</span>) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ip = <span class="built_in">strchr</span>(l,<span class="string">&#x27;:&#x27;</span>); <span class="keyword">if</span> (!ip) <span class="keyword">continue</span>;</span><br><span class="line">                ip++; <span class="comment">//ip开始</span></span><br><span class="line">                port = <span class="built_in">strchr</span>(ip,<span class="string">&#x27;,&#x27;</span>); <span class="keyword">if</span> (!port) <span class="keyword">continue</span>;</span><br><span class="line">                *port = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                port++; <span class="comment">//port开始</span></span><br><span class="line">                end = <span class="built_in">strchr</span>(port,<span class="string">&#x27;,&#x27;</span>); <span class="keyword">if</span> (!end) <span class="keyword">continue</span>;</span><br><span class="line">                *end = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//新格式</span></span><br><span class="line">                ip = <span class="built_in">strstr</span>(l,<span class="string">&quot;ip=&quot;</span>); <span class="keyword">if</span> (!ip) <span class="keyword">continue</span>;</span><br><span class="line">                ip += <span class="number">3</span>; <span class="comment">//ip开始</span></span><br><span class="line">                port = <span class="built_in">strstr</span>(l,<span class="string">&quot;port=&quot;</span>); <span class="keyword">if</span> (!port) <span class="keyword">continue</span>;</span><br><span class="line">                port += <span class="number">5</span>; <span class="comment">//port开始</span></span><br><span class="line">                <span class="comment">//分割成\0</span></span><br><span class="line">                end = <span class="built_in">strchr</span>(ip,<span class="string">&#x27;,&#x27;</span>); <span class="keyword">if</span> (end) *end = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                end = <span class="built_in">strchr</span>(port,<span class="string">&#x27;,&#x27;</span>); <span class="keyword">if</span> (end) *end = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//把不存在的slave加入到master之中</span></span><br><span class="line">            <span class="keyword">if</span> (sentinelRedisInstanceLookupSlave(ri,ip,atoi(port)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((slave = createSentinelRedisInstance(<span class="literal">NULL</span>,SRI_SLAVE,ip,</span><br><span class="line">                            atoi(port), ri-&gt;quorum, ri)) != <span class="literal">NULL</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    sentinelEvent(LL_NOTICE,<span class="string">&quot;+slave&quot;</span>,slave,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">                    sentinelFlushConfig();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//和master断开的时间 master_link_down_since_seconds:&lt;seconds&gt;</span></span><br><span class="line">        <span class="keyword">if</span> (sdslen(l) &gt;= <span class="number">32</span> &amp;&amp;</span><br><span class="line">            !<span class="built_in">memcmp</span>(l,<span class="string">&quot;master_link_down_since_seconds&quot;</span>,<span class="number">30</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            ri-&gt;master_link_down_time = strtoll(l+<span class="number">31</span>,<span class="literal">NULL</span>,<span class="number">10</span>)*<span class="number">1000</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//角色</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">memcmp</span>(l,<span class="string">&quot;role:master&quot;</span>,<span class="number">11</span>)) role = SRI_MASTER;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">memcmp</span>(l,<span class="string">&quot;role:slave&quot;</span>,<span class="number">10</span>)) role = SRI_SLAVE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (role == SRI_SLAVE) &#123;</span><br><span class="line">            <span class="comment">//master_host:&lt;host&gt;</span></span><br><span class="line">            <span class="keyword">if</span> (sdslen(l) &gt;= <span class="number">12</span> &amp;&amp; !<span class="built_in">memcmp</span>(l,<span class="string">&quot;master_host:&quot;</span>,<span class="number">12</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ri-&gt;slave_master_host == <span class="literal">NULL</span> ||</span><br><span class="line">                    strcasecmp(l+<span class="number">12</span>,ri-&gt;slave_master_host))</span><br><span class="line">                &#123;</span><br><span class="line">                    sdsfree(ri-&gt;slave_master_host);</span><br><span class="line">                    ri-&gt;slave_master_host = sdsnew(l+<span class="number">12</span>);</span><br><span class="line">                    ri-&gt;slave_conf_change_time = mstime();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//master_port:&lt;port&gt;</span></span><br><span class="line">            <span class="keyword">if</span> (sdslen(l) &gt;= <span class="number">12</span> &amp;&amp; !<span class="built_in">memcmp</span>(l,<span class="string">&quot;master_port:&quot;</span>,<span class="number">12</span>)) &#123;</span><br><span class="line">                <span class="keyword">int</span> slave_master_port = atoi(l+<span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ri-&gt;slave_master_port != slave_master_port) &#123;</span><br><span class="line">                    ri-&gt;slave_master_port = slave_master_port;</span><br><span class="line">                    ri-&gt;slave_conf_change_time = mstime();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//和master的连接状态 master_link_status:&lt;status&gt;</span></span><br><span class="line">            <span class="keyword">if</span> (sdslen(l) &gt;= <span class="number">19</span> &amp;&amp; !<span class="built_in">memcmp</span>(l,<span class="string">&quot;master_link_status:&quot;</span>,<span class="number">19</span>)) &#123;</span><br><span class="line">                ri-&gt;slave_master_link_status =</span><br><span class="line">                    (strcasecmp(l+<span class="number">19</span>,<span class="string">&quot;up&quot;</span>) == <span class="number">0</span>) ?</span><br><span class="line">                    SENTINEL_MASTER_LINK_STATUS_UP :</span><br><span class="line">                    SENTINEL_MASTER_LINK_STATUS_DOWN;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//优先级 slave_priority:&lt;priority&gt;</span></span><br><span class="line">            <span class="keyword">if</span> (sdslen(l) &gt;= <span class="number">15</span> &amp;&amp; !<span class="built_in">memcmp</span>(l,<span class="string">&quot;slave_priority:&quot;</span>,<span class="number">15</span>))</span><br><span class="line">                ri-&gt;slave_priority = atoi(l+<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//同步offset slave_repl_offset:&lt;offset&gt;</span></span><br><span class="line">            <span class="keyword">if</span> (sdslen(l) &gt;= <span class="number">18</span> &amp;&amp; !<span class="built_in">memcmp</span>(l,<span class="string">&quot;slave_repl_offset:&quot;</span>,<span class="number">18</span>))</span><br><span class="line">                ri-&gt;slave_repl_offset = strtoull(l+<span class="number">18</span>,<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ri-&gt;info_refresh = mstime();</span><br><span class="line">    sdsfreesplitres(lines,numlines);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//角色不一致，一开始设定的角色和info汇报的角色</span></span><br><span class="line">    <span class="keyword">if</span> (role != ri-&gt;role_reported) &#123;</span><br><span class="line">        ri-&gt;role_reported_time = mstime();</span><br><span class="line">        ri-&gt;role_reported = role;</span><br><span class="line">        <span class="keyword">if</span> (role == SRI_SLAVE) ri-&gt;slave_conf_change_time = mstime();</span><br><span class="line">        </span><br><span class="line">        sentinelEvent(LL_VERBOSE,</span><br><span class="line">            ((ri-&gt;flags &amp; (SRI_MASTER|SRI_SLAVE)) == role) ?</span><br><span class="line">            <span class="string">&quot;+role-change&quot;</span> : <span class="string">&quot;-role-change&quot;</span>,</span><br><span class="line">            ri, <span class="string">&quot;%@ new reported role is %s&quot;</span>,</span><br><span class="line">            role == SRI_MASTER ? <span class="string">&quot;master&quot;</span> : <span class="string">&quot;slave&quot;</span>,</span><br><span class="line">            ri-&gt;flags &amp; SRI_MASTER ? <span class="string">&quot;master&quot;</span> : <span class="string">&quot;slave&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//tilt下返回</span></span><br><span class="line">    <span class="keyword">if</span> (sentinel.tilt) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从master变成slave</span></span><br><span class="line">    <span class="keyword">if</span> ((ri-&gt;flags &amp; SRI_MASTER) &amp;&amp; role == SRI_SLAVE) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从slave变成master</span></span><br><span class="line">    <span class="keyword">if</span> ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp; role == SRI_MASTER) &#123;</span><br><span class="line">        <span class="comment">//选举出来的slave成为了master</span></span><br><span class="line">        <span class="keyword">if</span> ((ri-&gt;flags &amp; SRI_PROMOTED) &amp;&amp;</span><br><span class="line">            (ri-&gt;master-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) &amp;&amp;</span><br><span class="line">            (ri-&gt;master-&gt;failover_state ==</span><br><span class="line">                SENTINEL_FAILOVER_STATE_WAIT_PROMOTION))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//此次纪元操作成功，更新纪元，后面会同步给其他哨兵</span></span><br><span class="line">            ri-&gt;master-&gt;config_epoch = ri-&gt;master-&gt;failover_epoch;</span><br><span class="line">            <span class="comment">//故障修复流转到等待其他slave更新配置</span></span><br><span class="line">            ri-&gt;master-&gt;failover_state = SENTINEL_FAILOVER_STATE_RECONF_SLAVES;</span><br><span class="line">            ri-&gt;master-&gt;failover_state_change_time = mstime();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//更新哨兵配置</span></span><br><span class="line">            sentinelFlushConfig();</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;+promoted-slave&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (sentinel.simfailure_flags &amp;</span><br><span class="line">                SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION)</span><br><span class="line">                sentinelSimFailureCrash();</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;+failover-state-reconf-slaves&quot;</span>,</span><br><span class="line">                ri-&gt;master,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">            sentinelCallClientReconfScript(ri-&gt;master,SENTINEL_LEADER,</span><br><span class="line">                <span class="string">&quot;start&quot;</span>,ri-&gt;master-&gt;addr,ri-&gt;addr);</span><br><span class="line">            sentinelForceHelloUpdateForMaster(ri-&gt;master);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//其余的情况下，认为是不正常的，需要把这个节点重新变更为slave</span></span><br><span class="line">            <span class="keyword">mstime_t</span> wait_time = SENTINEL_PUBLISH_PERIOD*<span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//节点不是被选举出来&amp;master节点状态是ok的</span></span><br><span class="line">            <span class="keyword">if</span> (!(ri-&gt;flags &amp; SRI_PROMOTED) &amp;&amp;</span><br><span class="line">                 sentinelMasterLooksSane(ri-&gt;master) &amp;&amp;</span><br><span class="line">                 sentinelRedisInstanceNoDownFor(ri,wait_time) &amp;&amp;</span><br><span class="line">                 mstime() - ri-&gt;role_reported_time &gt; wait_time)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> retval = sentinelSendSlaveOf(ri,</span><br><span class="line">                        ri-&gt;master-&gt;addr-&gt;ip,</span><br><span class="line">                        ri-&gt;master-&gt;addr-&gt;port);</span><br><span class="line">                <span class="keyword">if</span> (retval == C_OK)</span><br><span class="line">                    sentinelEvent(LL_NOTICE,<span class="string">&quot;+convert-to-slave&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对于从节点汇报的master和当前的master信息不一致的时候，设置成现在的</span></span><br><span class="line">    <span class="keyword">if</span> ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp;</span><br><span class="line">        role == SRI_SLAVE &amp;&amp;</span><br><span class="line">        (ri-&gt;slave_master_port != ri-&gt;master-&gt;addr-&gt;port ||</span><br><span class="line">         strcasecmp(ri-&gt;slave_master_host,ri-&gt;master-&gt;addr-&gt;ip)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">mstime_t</span> wait_time = ri-&gt;master-&gt;failover_timeout;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//先检查现在的master状态ok不</span></span><br><span class="line">        <span class="keyword">if</span> (sentinelMasterLooksSane(ri-&gt;master) &amp;&amp;</span><br><span class="line">            sentinelRedisInstanceNoDownFor(ri,wait_time) &amp;&amp;</span><br><span class="line">            mstime() - ri-&gt;slave_conf_change_time &gt; wait_time)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> retval = sentinelSendSlaveOf(ri,</span><br><span class="line">                    ri-&gt;master-&gt;addr-&gt;ip,</span><br><span class="line">                    ri-&gt;master-&gt;addr-&gt;port);</span><br><span class="line">            <span class="keyword">if</span> (retval == C_OK)</span><br><span class="line">                sentinelEvent(LL_NOTICE,<span class="string">&quot;+fix-slave-config&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理其余slave更新master的情况</span></span><br><span class="line">    <span class="keyword">if</span> ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp; role == SRI_SLAVE &amp;&amp;</span><br><span class="line">        (ri-&gt;flags &amp; (SRI_RECONF_SENT|SRI_RECONF_INPROG)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//发送slaveof -&gt; 等待中</span></span><br><span class="line">        <span class="keyword">if</span> ((ri-&gt;flags &amp; SRI_RECONF_SENT) &amp;&amp;</span><br><span class="line">            ri-&gt;slave_master_host &amp;&amp;</span><br><span class="line">            <span class="built_in">strcmp</span>(ri-&gt;slave_master_host,</span><br><span class="line">                    ri-&gt;master-&gt;promoted_slave-&gt;addr-&gt;ip) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">            ri-&gt;slave_master_port == ri-&gt;master-&gt;promoted_slave-&gt;addr-&gt;port)</span><br><span class="line">        &#123;</span><br><span class="line">            ri-&gt;flags &amp;= ~SRI_RECONF_SENT;</span><br><span class="line">            ri-&gt;flags |= SRI_RECONF_INPROG;</span><br><span class="line">            sentinelEvent(LL_NOTICE,<span class="string">&quot;+slave-reconf-inprog&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//等待中 -&gt; slaveof完成  </span></span><br><span class="line">        <span class="keyword">if</span> ((ri-&gt;flags &amp; SRI_RECONF_INPROG) &amp;&amp;</span><br><span class="line">            ri-&gt;slave_master_link_status == SENTINEL_MASTER_LINK_STATUS_UP)</span><br><span class="line">        &#123;</span><br><span class="line">            ri-&gt;flags &amp;= ~SRI_RECONF_INPROG;</span><br><span class="line">            ri-&gt;flags |= SRI_RECONF_DONE;</span><br><span class="line">            sentinelEvent(LL_NOTICE,<span class="string">&quot;+slave-reconf-done&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelInfoReplyCallback"><a href="#sentinelInfoReplyCallback" class="headerlink" title="sentinelInfoReplyCallback"></a>sentinelInfoReplyCallback</h5><p>info命令的回调</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelInfoReplyCallback</span><span class="params">(redisAsyncContext *c, <span class="keyword">void</span> *reply, <span class="keyword">void</span> *privdata)</span> </span>&#123;</span><br><span class="line">    sentinelRedisInstance *ri = privdata;</span><br><span class="line">    instanceLink *link = c-&gt;data;</span><br><span class="line">    redisReply *r;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!reply || !link) <span class="keyword">return</span>;</span><br><span class="line">    link-&gt;pending_commands--;</span><br><span class="line">    r = reply;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;type == REDIS_REPLY_STRING)</span><br><span class="line">        sentinelRefreshInstanceInfo(ri,r-&gt;str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelDiscardReplyCallback"><a href="#sentinelDiscardReplyCallback" class="headerlink" title="sentinelDiscardReplyCallback"></a>sentinelDiscardReplyCallback</h5><p>忽略内容的回调</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelDiscardReplyCallback</span><span class="params">(redisAsyncContext *c, <span class="keyword">void</span> *reply, <span class="keyword">void</span> *privdata)</span> </span>&#123;</span><br><span class="line">    instanceLink *link = c-&gt;data;</span><br><span class="line">    UNUSED(reply);</span><br><span class="line">    UNUSED(privdata);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (link) link-&gt;pending_commands--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelPingReplyCallback"><a href="#sentinelPingReplyCallback" class="headerlink" title="sentinelPingReplyCallback"></a>sentinelPingReplyCallback</h5><p>ping命令的回调</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelPingReplyCallback</span><span class="params">(redisAsyncContext *c, <span class="keyword">void</span> *reply, <span class="keyword">void</span> *privdata)</span> </span>&#123;</span><br><span class="line">    sentinelRedisInstance *ri = privdata;</span><br><span class="line">    instanceLink *link = c-&gt;data;</span><br><span class="line">    redisReply *r;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!reply || !link) <span class="keyword">return</span>;</span><br><span class="line">    link-&gt;pending_commands--;</span><br><span class="line">    r = reply;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;type == REDIS_REPLY_STATUS ||</span><br><span class="line">        r-&gt;type == REDIS_REPLY_ERROR) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//有效的回复包括以下三种 正常、启动中、master断开</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strncmp</span>(r-&gt;str,<span class="string">&quot;PONG&quot;</span>,<span class="number">4</span>) == <span class="number">0</span> ||</span><br><span class="line">            <span class="built_in">strncmp</span>(r-&gt;str,<span class="string">&quot;LOADING&quot;</span>,<span class="number">7</span>) == <span class="number">0</span> ||</span><br><span class="line">            <span class="built_in">strncmp</span>(r-&gt;str,<span class="string">&quot;MASTERDOWN&quot;</span>,<span class="number">10</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            link-&gt;last_avail_time = mstime();</span><br><span class="line">            link-&gt;act_ping_time = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//busy下，发送命令，终止其脚本的执行</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strncmp</span>(r-&gt;str,<span class="string">&quot;BUSY&quot;</span>,<span class="number">4</span>) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                (ri-&gt;flags &amp; SRI_S_DOWN) &amp;&amp;</span><br><span class="line">                !(ri-&gt;flags &amp; SRI_SCRIPT_KILL_SENT))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (redisAsyncCommand(ri-&gt;link-&gt;cc,</span><br><span class="line">                        sentinelDiscardReplyCallback, ri,</span><br><span class="line">                        <span class="string">&quot;%s KILL&quot;</span>,</span><br><span class="line">                        sentinelInstanceMapCommand(ri,<span class="string">&quot;SCRIPT&quot;</span>)) == C_OK)</span><br><span class="line">                &#123;</span><br><span class="line">                    ri-&gt;link-&gt;pending_commands++;</span><br><span class="line">                &#125;</span><br><span class="line">                ri-&gt;flags |= SRI_SCRIPT_KILL_SENT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    link-&gt;last_pong_time = mstime();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelPublishReplyCallback"><a href="#sentinelPublishReplyCallback" class="headerlink" title="sentinelPublishReplyCallback"></a>sentinelPublishReplyCallback</h5><p>发布消息的回调</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelPublishReplyCallback</span><span class="params">(redisAsyncContext *c, <span class="keyword">void</span> *reply, <span class="keyword">void</span> *privdata)</span> </span>&#123;</span><br><span class="line">    sentinelRedisInstance *ri = privdata;</span><br><span class="line">    instanceLink *link = c-&gt;data;</span><br><span class="line">    redisReply *r;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!reply || !link) <span class="keyword">return</span>;</span><br><span class="line">    link-&gt;pending_commands--;</span><br><span class="line">    r = reply;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//成功的话，更新时间</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;type != REDIS_REPLY_ERROR)</span><br><span class="line">        ri-&gt;last_pub_time = mstime();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelProcessHelloMessage"><a href="#sentinelProcessHelloMessage" class="headerlink" title="sentinelProcessHelloMessage"></a>sentinelProcessHelloMessage</h5><p>处理hello频道的消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelProcessHelloMessage</span><span class="params">(<span class="keyword">char</span> *hello, <span class="keyword">int</span> hello_len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 消息格式</span></span><br><span class="line">    <span class="comment">// 0=ip,1=port,2=runid,3=current_epoch,4=master_name,</span></span><br><span class="line">    <span class="comment">// 5=master_ip,6=master_port,7=master_config_epoch.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> numtokens, port, removed, master_port;</span><br><span class="line">    <span class="keyword">uint64_t</span> current_epoch, master_config_epoch;</span><br><span class="line">    <span class="keyword">char</span> **token = sdssplitlen(hello, hello_len, <span class="string">&quot;,&quot;</span>, <span class="number">1</span>, &amp;numtokens);</span><br><span class="line">    sentinelRedisInstance *si, *master;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据数量校验消息</span></span><br><span class="line">    <span class="keyword">if</span> (numtokens == <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="comment">//确定这个master，是不是自己也监听了</span></span><br><span class="line">        master = sentinelGetMasterByName(token[<span class="number">4</span>]);</span><br><span class="line">        <span class="keyword">if</span> (!master) <span class="keyword">goto</span> cleanup;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查该哨兵是不是已经在自己的拓扑结构中了</span></span><br><span class="line">        port = atoi(token[<span class="number">1</span>]);</span><br><span class="line">        master_port = atoi(token[<span class="number">6</span>]);</span><br><span class="line">        si = getSentinelRedisInstanceByAddrAndRunID(</span><br><span class="line">                        master-&gt;sentinels,token[<span class="number">0</span>],port,token[<span class="number">2</span>]);</span><br><span class="line">        current_epoch = strtoull(token[<span class="number">3</span>],<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line">        master_config_epoch = strtoull(token[<span class="number">7</span>],<span class="literal">NULL</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//不在的话</span></span><br><span class="line">        <span class="keyword">if</span> (!si) &#123;</span><br><span class="line">            <span class="comment">//删除相同runid的哨兵，处理哨兵的ip发生变化的情况</span></span><br><span class="line">            removed = removeMatchingSentinelFromMaster(master,token[<span class="number">2</span>]);</span><br><span class="line">            <span class="keyword">if</span> (removed) &#123;</span><br><span class="line">                sentinelEvent(LL_NOTICE,<span class="string">&quot;+sentinel-address-switch&quot;</span>,master,</span><br><span class="line">                    <span class="string">&quot;%@ ip %s port %d for %s&quot;</span>, token[<span class="number">0</span>],port,token[<span class="number">2</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//没有相同runid的其他哨兵，检查是否有相同ip,port的哨兵</span></span><br><span class="line">                sentinelRedisInstance *other =</span><br><span class="line">                    getSentinelRedisInstanceByAddrAndRunID(</span><br><span class="line">                        master-&gt;sentinels, token[<span class="number">0</span>],port,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//找到的话，标识其端口为无效</span></span><br><span class="line">                <span class="keyword">if</span> (other) &#123;</span><br><span class="line">                    sentinelEvent(LL_NOTICE,<span class="string">&quot;+sentinel-invalid-addr&quot;</span>,other,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">                    other-&gt;addr-&gt;port = <span class="number">0</span>; <span class="comment">/* It means: invalid address. */</span></span><br><span class="line">                    sentinelUpdateSentinelAddressInAllMasters(other);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//创建一个新的哨兵</span></span><br><span class="line">            si = createSentinelRedisInstance(token[<span class="number">2</span>],SRI_SENTINEL,</span><br><span class="line">                            token[<span class="number">0</span>],port,master-&gt;quorum,master);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (si) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!removed) sentinelEvent(LL_NOTICE,<span class="string">&quot;+sentinel&quot;</span>,si,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">                <span class="comment">//填充runid，因为哨兵不能通过info命令填充，只能在这</span></span><br><span class="line">                si-&gt;runid = sdsnew(token[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//共享这个哨兵的连接，在多个master之间</span></span><br><span class="line">                sentinelTryConnectionSharing(si);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//更新所有master的当前哨兵的地址</span></span><br><span class="line">                <span class="keyword">if</span> (removed) sentinelUpdateSentinelAddressInAllMasters(si);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//重写哨兵配置</span></span><br><span class="line">                sentinelFlushConfig();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新自己的纪元，这个哨兵的纪元更高</span></span><br><span class="line">        <span class="keyword">if</span> (current_epoch &gt; sentinel.current_epoch) &#123;</span><br><span class="line">            sentinel.current_epoch = current_epoch;</span><br><span class="line">            sentinelFlushConfig();</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;+new-epoch&quot;</span>,master,<span class="string">&quot;%llu&quot;</span>,</span><br><span class="line">                (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) sentinel.current_epoch);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新监听master的信息，包括纪元&amp;ip&amp;端口</span></span><br><span class="line">        <span class="keyword">if</span> (si &amp;&amp; master-&gt;config_epoch &lt; master_config_epoch) &#123;</span><br><span class="line">            master-&gt;config_epoch = master_config_epoch;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//master信息有变化</span></span><br><span class="line">            <span class="keyword">if</span> (master_port != master-&gt;addr-&gt;port ||</span><br><span class="line">                <span class="built_in">strcmp</span>(master-&gt;addr-&gt;ip, token[<span class="number">5</span>]))</span><br><span class="line">            &#123;</span><br><span class="line">                sentinelAddr *old_addr;</span><br><span class="line"></span><br><span class="line">                sentinelEvent(LL_WARNING,<span class="string">&quot;+config-update-from&quot;</span>,si,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">                sentinelEvent(LL_WARNING,<span class="string">&quot;+switch-master&quot;</span>,</span><br><span class="line">                    master,<span class="string">&quot;%s %s %d %s %d&quot;</span>,</span><br><span class="line">                    master-&gt;name,</span><br><span class="line">                    master-&gt;addr-&gt;ip, master-&gt;addr-&gt;port,</span><br><span class="line">                    token[<span class="number">5</span>], master_port);</span><br><span class="line"></span><br><span class="line">                old_addr = dupSentinelAddr(master-&gt;addr);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//重置master</span></span><br><span class="line">                sentinelResetMasterAndChangeAddress(master, token[<span class="number">5</span>], master_port);</span><br><span class="line">                sentinelCallClientReconfScript(master,</span><br><span class="line">                    SENTINEL_OBSERVER,<span class="string">&quot;start&quot;</span>,</span><br><span class="line">                    old_addr,master-&gt;addr);</span><br><span class="line">                releaseSentinelAddr(old_addr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (si) si-&gt;last_hello_time = mstime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line">    sdsfreesplitres(token,numtokens);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelReceiveHelloMessages"><a href="#sentinelReceiveHelloMessages" class="headerlink" title="sentinelReceiveHelloMessages"></a>sentinelReceiveHelloMessages</h5><p>收到hello频道消息的回调</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelReceiveHelloMessages</span><span class="params">(redisAsyncContext *c, <span class="keyword">void</span> *reply, <span class="keyword">void</span> *privdata)</span> </span>&#123;</span><br><span class="line">    sentinelRedisInstance *ri = privdata;</span><br><span class="line">    redisReply *r;</span><br><span class="line">    UNUSED(c);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!reply || !ri) <span class="keyword">return</span>;</span><br><span class="line">    r = reply;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新活跃时间</span></span><br><span class="line">    ri-&gt;link-&gt;pc_last_activity = mstime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验消息格式</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;type != REDIS_REPLY_ARRAY ||</span><br><span class="line">        r-&gt;elements != <span class="number">3</span> ||</span><br><span class="line">        r-&gt;element[<span class="number">0</span>]-&gt;type != REDIS_REPLY_STRING ||</span><br><span class="line">        r-&gt;element[<span class="number">1</span>]-&gt;type != REDIS_REPLY_STRING ||</span><br><span class="line">        r-&gt;element[<span class="number">2</span>]-&gt;type != REDIS_REPLY_STRING ||</span><br><span class="line">        <span class="built_in">strcmp</span>(r-&gt;element[<span class="number">0</span>]-&gt;str,<span class="string">&quot;message&quot;</span>) != <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//过滤自己发送的</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(r-&gt;element[<span class="number">2</span>]-&gt;str,sentinel.myid) != <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理hello信息</span></span><br><span class="line">    sentinelProcessHelloMessage(r-&gt;element[<span class="number">2</span>]-&gt;str, r-&gt;element[<span class="number">2</span>]-&gt;len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelSendHello"><a href="#sentinelSendHello" class="headerlink" title="sentinelSendHello"></a>sentinelSendHello</h5><p>向hello频道发送自身的状况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelSendHello</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> ip[NET_IP_STR_LEN];</span><br><span class="line">    <span class="keyword">char</span> payload[NET_IP_STR_LEN+<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">char</span> *announce_ip;</span><br><span class="line">    <span class="keyword">int</span> announce_port;</span><br><span class="line">    sentinelRedisInstance *master = (ri-&gt;flags &amp; SRI_MASTER) ? ri : ri-&gt;master;</span><br><span class="line">    sentinelAddr *master_addr = sentinelGetCurrentMasterAddress(master);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;link-&gt;disconnected) <span class="keyword">return</span> C_ERR;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//声明的ip端口，本身的ip端口优先级选择</span></span><br><span class="line">    <span class="keyword">if</span> (sentinel.announce_ip) &#123;</span><br><span class="line">        announce_ip = sentinel.announce_ip;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (anetSockName(ri-&gt;link-&gt;cc-&gt;c.fd,ip,<span class="keyword">sizeof</span>(ip),<span class="literal">NULL</span>) == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">return</span> C_ERR;</span><br><span class="line">        announce_ip = ip;</span><br><span class="line">    &#125;</span><br><span class="line">    announce_port = sentinel.announce_port ?</span><br><span class="line">                    sentinel.announce_port : server.port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拼装hello消息</span></span><br><span class="line">    <span class="built_in">snprintf</span>(payload,<span class="keyword">sizeof</span>(payload),</span><br><span class="line">        <span class="string">&quot;%s,%d,%s,%llu,&quot;</span> <span class="comment">//当前哨兵的信息</span></span><br><span class="line">        <span class="string">&quot;%s,%s,%d,%llu&quot;</span>, <span class="comment">//master的信息</span></span><br><span class="line">        announce_ip, announce_port, sentinel.myid,</span><br><span class="line">        (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) sentinel.current_epoch,</span><br><span class="line">        <span class="comment">/* --- */</span></span><br><span class="line">        master-&gt;name,master_addr-&gt;ip,master_addr-&gt;port,</span><br><span class="line">        (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) master-&gt;config_epoch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发布消息</span></span><br><span class="line">    retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span><br><span class="line">        sentinelPublishReplyCallback, ri, <span class="string">&quot;%s %s %s&quot;</span>,</span><br><span class="line">        sentinelInstanceMapCommand(ri,<span class="string">&quot;PUBLISH&quot;</span>),</span><br><span class="line">        SENTINEL_HELLO_CHANNEL,payload);</span><br><span class="line">    <span class="keyword">if</span> (retval != C_OK) <span class="keyword">return</span> C_ERR;</span><br><span class="line">    ri-&gt;link-&gt;pending_commands++;</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelForceHelloUpdateDictOfRedisInstances"><a href="#sentinelForceHelloUpdateDictOfRedisInstances" class="headerlink" title="sentinelForceHelloUpdateDictOfRedisInstances"></a>sentinelForceHelloUpdateDictOfRedisInstances</h5><p>强制更新每一个节点的上一次发布消息时间，为了下一次扫描的时候一定会发送hello消息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelForceHelloUpdateDictOfRedisInstances</span><span class="params">(dict *instances)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    di = dictGetSafeIterator(instances);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;last_pub_time &gt;= (SENTINEL_PUBLISH_PERIOD+<span class="number">1</span>))</span><br><span class="line">            ri-&gt;last_pub_time -= (SENTINEL_PUBLISH_PERIOD+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelForceHelloUpdateForMaster"><a href="#sentinelForceHelloUpdateForMaster" class="headerlink" title="sentinelForceHelloUpdateForMaster"></a>sentinelForceHelloUpdateForMaster</h5><p>强制更新master及其下面的哨兵、从节点的发布时间</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelForceHelloUpdateForMaster</span><span class="params">(sentinelRedisInstance *master)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(master-&gt;flags &amp; SRI_MASTER)) <span class="keyword">return</span> C_ERR;</span><br><span class="line">    <span class="keyword">if</span> (master-&gt;last_pub_time &gt;= (SENTINEL_PUBLISH_PERIOD+<span class="number">1</span>))</span><br><span class="line">        master-&gt;last_pub_time -= (SENTINEL_PUBLISH_PERIOD+<span class="number">1</span>);</span><br><span class="line">    sentinelForceHelloUpdateDictOfRedisInstances(master-&gt;sentinels);</span><br><span class="line">    sentinelForceHelloUpdateDictOfRedisInstances(master-&gt;slaves);</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelSendPing"><a href="#sentinelSendPing" class="headerlink" title="sentinelSendPing"></a>sentinelSendPing</h5><p>发送ping命令</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelSendPing</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span><br><span class="line">        sentinelPingReplyCallback, ri, <span class="string">&quot;%s&quot;</span>,</span><br><span class="line">        sentinelInstanceMapCommand(ri,<span class="string">&quot;PING&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (retval == C_OK) &#123;</span><br><span class="line">        ri-&gt;link-&gt;pending_commands++;</span><br><span class="line">        ri-&gt;link-&gt;last_ping_time = mstime();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//记录无效ping的开始时间，收到ping回复之后就归0了</span></span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;link-&gt;act_ping_time == <span class="number">0</span>)</span><br><span class="line">            ri-&gt;link-&gt;act_ping_time = ri-&gt;link-&gt;last_ping_time;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelSendPeriodicCommands"><a href="#sentinelSendPeriodicCommands" class="headerlink" title="sentinelSendPeriodicCommands"></a>sentinelSendPeriodicCommands</h5><p>哨兵的定时处理任务</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelSendPeriodicCommands</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">mstime_t</span> now = mstime();</span><br><span class="line">    <span class="keyword">mstime_t</span> info_period, ping_period;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//连接断开</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;link-&gt;disconnected) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前连接未回复的命令数量达到上限</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;link-&gt;pending_commands &gt;=</span><br><span class="line">        SENTINEL_MAX_PENDING_COMMANDS * ri-&gt;link-&gt;refcount) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对于从节点，如果处于主观下线或者故障修复中，发送info的频率改成1s间隔</span></span><br><span class="line">    <span class="keyword">if</span> ((ri-&gt;flags &amp; SRI_SLAVE) &amp;&amp;</span><br><span class="line">        ((ri-&gt;master-&gt;flags &amp; (SRI_O_DOWN|SRI_FAILOVER_IN_PROGRESS)) ||</span><br><span class="line">         (ri-&gt;master_link_down_time != <span class="number">0</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        info_period = <span class="number">1000</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        info_period = SENTINEL_INFO_PERIOD;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送ping的频率，正常是如果上一次收到ping回复的时间超过`down-after-milliseconds`设置，如果`down-after-milliseconds`超过1s的话，就每秒</span></span><br><span class="line">    ping_period = ri-&gt;down_after_period;</span><br><span class="line">    <span class="keyword">if</span> (ping_period &gt; SENTINEL_PING_PERIOD) ping_period = SENTINEL_PING_PERIOD;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送info命令，只针对于master,slave</span></span><br><span class="line">    <span class="keyword">if</span> ((ri-&gt;flags &amp; SRI_SENTINEL) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (ri-&gt;info_refresh == <span class="number">0</span> ||</span><br><span class="line">        (now - ri-&gt;info_refresh) &gt; info_period))</span><br><span class="line">    &#123;</span><br><span class="line">        retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span><br><span class="line">            sentinelInfoReplyCallback, ri, <span class="string">&quot;%s&quot;</span>,</span><br><span class="line">            sentinelInstanceMapCommand(ri,<span class="string">&quot;INFO&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (retval == C_OK) ri-&gt;link-&gt;pending_commands++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送ping</span></span><br><span class="line">    <span class="keyword">if</span> ((now - ri-&gt;link-&gt;last_pong_time) &gt; ping_period &amp;&amp;</span><br><span class="line">               (now - ri-&gt;link-&gt;last_ping_time) &gt; ping_period/<span class="number">2</span>) &#123;</span><br><span class="line">        sentinelSendPing(ri);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发布hello消息</span></span><br><span class="line">    <span class="keyword">if</span> ((now - ri-&gt;last_pub_time) &gt; SENTINEL_PUBLISH_PERIOD) &#123;</span><br><span class="line">        sentinelSendHello(ri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="响应命令"><a href="#响应命令" class="headerlink" title="响应命令"></a>响应命令</h4><h5 id="sentinelFailoverStateStr"><a href="#sentinelFailoverStateStr" class="headerlink" title="sentinelFailoverStateStr"></a>sentinelFailoverStateStr</h5><p>获取故障修复状态的描述</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">sentinelFailoverStateStr</span><span class="params">(<span class="keyword">int</span> state)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(state) &#123;</span><br><span class="line">    <span class="keyword">case</span> SENTINEL_FAILOVER_STATE_NONE: <span class="keyword">return</span> <span class="string">&quot;none&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> SENTINEL_FAILOVER_STATE_WAIT_START: <span class="keyword">return</span> <span class="string">&quot;wait_start&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> SENTINEL_FAILOVER_STATE_SELECT_SLAVE: <span class="keyword">return</span> <span class="string">&quot;select_slave&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE: <span class="keyword">return</span> <span class="string">&quot;send_slaveof_noone&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> SENTINEL_FAILOVER_STATE_WAIT_PROMOTION: <span class="keyword">return</span> <span class="string">&quot;wait_promotion&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> SENTINEL_FAILOVER_STATE_RECONF_SLAVES: <span class="keyword">return</span> <span class="string">&quot;reconf_slaves&quot;</span>;</span><br><span class="line">    <span class="keyword">case</span> SENTINEL_FAILOVER_STATE_UPDATE_CONFIG: <span class="keyword">return</span> <span class="string">&quot;update_config&quot;</span>;</span><br><span class="line">    <span class="keyword">default</span>: <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="addReplySentinelRedisInstance"><a href="#addReplySentinelRedisInstance" class="headerlink" title="addReplySentinelRedisInstance"></a>addReplySentinelRedisInstance</h5><p>添加单个节点的各种信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addReplySentinelRedisInstance</span><span class="params">(client *c, sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *flags = sdsempty();</span><br><span class="line">    <span class="keyword">void</span> *mbl;</span><br><span class="line">    <span class="keyword">int</span> fields = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    mbl = addDeferredMultiBulkLength(c);</span><br><span class="line"></span><br><span class="line">    addReplyBulkCString(c,<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    addReplyBulkCString(c,ri-&gt;name);</span><br><span class="line">    fields++;</span><br><span class="line"></span><br><span class="line">    addReplyBulkCString(c,<span class="string">&quot;ip&quot;</span>);</span><br><span class="line">    addReplyBulkCString(c,ri-&gt;addr-&gt;ip);</span><br><span class="line">    fields++;</span><br><span class="line"></span><br><span class="line">    addReplyBulkCString(c,<span class="string">&quot;port&quot;</span>);</span><br><span class="line">    addReplyBulkLongLong(c,ri-&gt;addr-&gt;port);</span><br><span class="line">    fields++;</span><br><span class="line"></span><br><span class="line">    addReplyBulkCString(c,<span class="string">&quot;runid&quot;</span>);</span><br><span class="line">    addReplyBulkCString(c,ri-&gt;runid ? ri-&gt;runid : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    fields++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//标志位</span></span><br><span class="line">    addReplyBulkCString(c,<span class="string">&quot;flags&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_S_DOWN) flags = sdscat(flags,<span class="string">&quot;s_down,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_O_DOWN) flags = sdscat(flags,<span class="string">&quot;o_down,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_MASTER) flags = sdscat(flags,<span class="string">&quot;master,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_SLAVE) flags = sdscat(flags,<span class="string">&quot;slave,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_SENTINEL) flags = sdscat(flags,<span class="string">&quot;sentinel,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;link-&gt;disconnected) flags = sdscat(flags,<span class="string">&quot;disconnected,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_MASTER_DOWN) flags = sdscat(flags,<span class="string">&quot;master_down,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS)</span><br><span class="line">        flags = sdscat(flags,<span class="string">&quot;failover_in_progress,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_PROMOTED) flags = sdscat(flags,<span class="string">&quot;promoted,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_RECONF_SENT) flags = sdscat(flags,<span class="string">&quot;reconf_sent,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_RECONF_INPROG) flags = sdscat(flags,<span class="string">&quot;reconf_inprog,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_RECONF_DONE) flags = sdscat(flags,<span class="string">&quot;reconf_done,&quot;</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//删除最后一个&quot;,&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (sdslen(flags) != <span class="number">0</span>) sdsrange(flags,<span class="number">0</span>,<span class="number">-2</span>);</span><br><span class="line">    addReplyBulkCString(c,flags);</span><br><span class="line">    sdsfree(flags);</span><br><span class="line">    fields++;</span><br><span class="line"></span><br><span class="line">    addReplyBulkCString(c,<span class="string">&quot;link-pending-commands&quot;</span>);</span><br><span class="line">    addReplyBulkLongLong(c,ri-&gt;link-&gt;pending_commands);</span><br><span class="line">    fields++;</span><br><span class="line"></span><br><span class="line">    addReplyBulkCString(c,<span class="string">&quot;link-refcount&quot;</span>);</span><br><span class="line">    addReplyBulkLongLong(c,ri-&gt;link-&gt;refcount);</span><br><span class="line">    fields++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) &#123;</span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;failover-state&quot;</span>);</span><br><span class="line">        addReplyBulkCString(c,(<span class="keyword">char</span>*)sentinelFailoverStateStr(ri-&gt;failover_state));</span><br><span class="line">        fields++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addReplyBulkCString(c,<span class="string">&quot;last-ping-sent&quot;</span>);</span><br><span class="line">    addReplyBulkLongLong(c,</span><br><span class="line">        ri-&gt;link-&gt;act_ping_time ? (mstime() - ri-&gt;link-&gt;act_ping_time) : <span class="number">0</span>);</span><br><span class="line">    fields++;</span><br><span class="line"></span><br><span class="line">    addReplyBulkCString(c,<span class="string">&quot;last-ok-ping-reply&quot;</span>);</span><br><span class="line">    addReplyBulkLongLong(c,mstime() - ri-&gt;link-&gt;last_avail_time);</span><br><span class="line">    fields++;</span><br><span class="line"></span><br><span class="line">    addReplyBulkCString(c,<span class="string">&quot;last-ping-reply&quot;</span>);</span><br><span class="line">    addReplyBulkLongLong(c,mstime() - ri-&gt;link-&gt;last_pong_time);</span><br><span class="line">    fields++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_S_DOWN) &#123;</span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;s-down-time&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,mstime()-ri-&gt;s_down_since_time);</span><br><span class="line">        fields++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_O_DOWN) &#123;</span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;o-down-time&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,mstime()-ri-&gt;o_down_since_time);</span><br><span class="line">        fields++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addReplyBulkCString(c,<span class="string">&quot;down-after-milliseconds&quot;</span>);</span><br><span class="line">    addReplyBulkLongLong(c,ri-&gt;down_after_period);</span><br><span class="line">    fields++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//master&amp;salve才有的信息</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; (SRI_MASTER|SRI_SLAVE)) &#123;</span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;info-refresh&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,mstime() - ri-&gt;info_refresh);</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;role-reported&quot;</span>);</span><br><span class="line">        addReplyBulkCString(c, (ri-&gt;role_reported == SRI_MASTER) ? <span class="string">&quot;master&quot;</span> :</span><br><span class="line">                                                                   <span class="string">&quot;slave&quot;</span>);</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;role-reported-time&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,mstime() - ri-&gt;role_reported_time);</span><br><span class="line">        fields++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//只有master有的信息</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_MASTER) &#123;</span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;config-epoch&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,ri-&gt;config_epoch);</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;num-slaves&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,dictSize(ri-&gt;slaves));</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;num-other-sentinels&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,dictSize(ri-&gt;sentinels));</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;quorum&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,ri-&gt;quorum);</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;failover-timeout&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,ri-&gt;failover_timeout);</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;parallel-syncs&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,ri-&gt;parallel_syncs);</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;notification_script) &#123;</span><br><span class="line">            addReplyBulkCString(c,<span class="string">&quot;notification-script&quot;</span>);</span><br><span class="line">            addReplyBulkCString(c,ri-&gt;notification_script);</span><br><span class="line">            fields++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;client_reconfig_script) &#123;</span><br><span class="line">            addReplyBulkCString(c,<span class="string">&quot;client-reconfig-script&quot;</span>);</span><br><span class="line">            addReplyBulkCString(c,ri-&gt;client_reconfig_script);</span><br><span class="line">            fields++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//只有slave才有的信息</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_SLAVE) &#123;</span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;master-link-down-time&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,ri-&gt;master_link_down_time);</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;master-link-status&quot;</span>);</span><br><span class="line">        addReplyBulkCString(c,</span><br><span class="line">            (ri-&gt;slave_master_link_status == SENTINEL_MASTER_LINK_STATUS_UP) ?</span><br><span class="line">            <span class="string">&quot;ok&quot;</span> : <span class="string">&quot;err&quot;</span>);</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;master-host&quot;</span>);</span><br><span class="line">        addReplyBulkCString(c,</span><br><span class="line">            ri-&gt;slave_master_host ? ri-&gt;slave_master_host : <span class="string">&quot;?&quot;</span>);</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;master-port&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,ri-&gt;slave_master_port);</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;slave-priority&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,ri-&gt;slave_priority);</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;slave-repl-offset&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,ri-&gt;slave_repl_offset);</span><br><span class="line">        fields++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//只有哨兵才有的信息</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_SENTINEL) &#123;</span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;last-hello-message&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,mstime() - ri-&gt;last_hello_time);</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;voted-leader&quot;</span>);</span><br><span class="line">        addReplyBulkCString(c,ri-&gt;leader ? ri-&gt;leader : <span class="string">&quot;?&quot;</span>);</span><br><span class="line">        fields++;</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,<span class="string">&quot;voted-leader-epoch&quot;</span>);</span><br><span class="line">        addReplyBulkLongLong(c,ri-&gt;leader_epoch);</span><br><span class="line">        fields++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setDeferredMultiBulkLength(c,mbl,fields*<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="addReplyDictOfRedisInstances"><a href="#addReplyDictOfRedisInstances" class="headerlink" title="addReplyDictOfRedisInstances"></a>addReplyDictOfRedisInstances</h5><p>批量添加节点的信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addReplyDictOfRedisInstances</span><span class="params">(client *c, dict *instances)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    di = dictGetIterator(instances);</span><br><span class="line">    addReplyMultiBulkLen(c,dictSize(instances));</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        addReplySentinelRedisInstance(c,ri);</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelGetMasterByNameOrReplyError"><a href="#sentinelGetMasterByNameOrReplyError" class="headerlink" title="sentinelGetMasterByNameOrReplyError"></a>sentinelGetMasterByNameOrReplyError</h5><p>根据名字获取master节点信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sentinelRedisInstance *<span class="title">sentinelGetMasterByNameOrReplyError</span><span class="params">(client *c,</span></span></span><br><span class="line"><span class="function"><span class="params">                        robj *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sentinelRedisInstance *ri;</span><br><span class="line"></span><br><span class="line">    ri = dictFetchValue(sentinel.masters,name-&gt;ptr);</span><br><span class="line">    <span class="keyword">if</span> (!ri) &#123;</span><br><span class="line">        addReplyError(c,<span class="string">&quot;No such master with that name&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelIsQuorumReachable"><a href="#sentinelIsQuorumReachable" class="headerlink" title="sentinelIsQuorumReachable"></a>sentinelIsQuorumReachable</h5><p>哨兵的数量是否支持选举，要求状态良好的哨兵数量满足两个条件：1.达到设置的最低数量 2.在总哨兵数量的比例要&gt;50%<br>usableptr 返回状态良好哨兵数量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_ISQR_OK 0 <span class="comment">//选举成功</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_ISQR_NOQUORUM (1&lt;&lt;0) <span class="comment">//可用哨兵不够规定的数量</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_ISQR_NOAUTH (1&lt;&lt;1) <span class="comment">//没有通过</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelIsQuorumReachable</span><span class="params">(sentinelRedisInstance *master, <span class="keyword">int</span> *usableptr)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">int</span> usable = <span class="number">1</span>; <span class="comment">//状态良好哨兵的数量</span></span><br><span class="line">    <span class="keyword">int</span> result = SENTINEL_ISQR_OK;</span><br><span class="line">    <span class="keyword">int</span> voters = dictSize(master-&gt;sentinels)+<span class="number">1</span>; <span class="comment">//所有参与投票选举的(已知的哨兵+自己)</span></span><br><span class="line"></span><br><span class="line">    di = dictGetIterator(master-&gt;sentinels);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//排除不可用的哨兵</span></span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;flags &amp; (SRI_S_DOWN|SRI_O_DOWN)) <span class="keyword">continue</span>;</span><br><span class="line">        usable++;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//状态良好哨兵数量 比要求的最低票数还要低</span></span><br><span class="line">    <span class="keyword">if</span> (usable &lt; (<span class="keyword">int</span>)master-&gt;quorum) result |= SENTINEL_ISQR_NOQUORUM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//状态良好哨兵数量 低于总的票数的一半+1，比例必须要&gt;总票数的50%</span></span><br><span class="line">    <span class="keyword">if</span> (usable &lt; voters/<span class="number">2</span>+<span class="number">1</span>) result |= SENTINEL_ISQR_NOAUTH;</span><br><span class="line">    <span class="keyword">if</span> (usableptr) *usableptr = usable;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelCommand"><a href="#sentinelCommand" class="headerlink" title="sentinelCommand"></a>sentinelCommand</h5><p>响应sentinel命令，运行中动态改变哨兵配置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;masters&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//获取所有master的信息 SENTINEL MASTERS</span></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc != <span class="number">2</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        addReplyDictOfRedisInstances(c,sentinel.masters);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;master&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//获取某个master的信息 SENTINEL MASTER &lt;name&gt;</span></span><br><span class="line">        sentinelRedisInstance *ri;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc != <span class="number">3</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        <span class="keyword">if</span> ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[<span class="number">2</span>]))</span><br><span class="line">            == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">        addReplySentinelRedisInstance(c,ri);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;slaves&quot;</span>) ||</span><br><span class="line">               !strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;replicas&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 获取master下所有salve的信息 SENTINEL REPLICAS &lt;master-name&gt;</span></span><br><span class="line">        sentinelRedisInstance *ri;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc != <span class="number">3</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        <span class="keyword">if</span> ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[<span class="number">2</span>])) == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        addReplyDictOfRedisInstances(c,ri-&gt;slaves);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;sentinels&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//获取监听该master的其他所有哨兵信息 SENTINEL SENTINELS &lt;master-name&gt;</span></span><br><span class="line">        sentinelRedisInstance *ri;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc != <span class="number">3</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        <span class="keyword">if</span> ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[<span class="number">2</span>])) == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        addReplyDictOfRedisInstances(c,ri-&gt;sentinels);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;is-master-down-by-addr&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//获取 ip&amp;port该master 是否已经下线</span></span><br><span class="line">        <span class="comment">//current-epoch表示发送请求哨兵的纪元</span></span><br><span class="line">        <span class="comment">//如果runid不为*，请求方希望我们为这个runid投票，为*的话则不要求</span></span><br><span class="line">        <span class="comment">// SENTINEL IS-MASTER-DOWN-BY-ADDR &lt;ip&gt; &lt;port&gt; &lt;current-epoch&gt; &lt;runid&gt;</span></span><br><span class="line">        sentinelRedisInstance *ri;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> req_epoch;</span><br><span class="line">        <span class="keyword">uint64_t</span> leader_epoch = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">char</span> *leader = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">long</span> port;</span><br><span class="line">        <span class="keyword">int</span> isdown = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//校验参数数量</span></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc != <span class="number">6</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转换端口&amp;纪元</span></span><br><span class="line">        <span class="keyword">if</span> (getLongFromObjectOrReply(c,c-&gt;argv[<span class="number">3</span>],&amp;port,<span class="literal">NULL</span>) != C_OK ||</span><br><span class="line">            getLongLongFromObjectOrReply(c,c-&gt;argv[<span class="number">4</span>],&amp;req_epoch,<span class="literal">NULL</span>)</span><br><span class="line">                                                              != C_OK)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        ri = getSentinelRedisInstanceByAddrAndRunID(sentinel.masters,</span><br><span class="line">            c-&gt;argv[<span class="number">2</span>]-&gt;ptr,port,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//是否主观下线，tilt模式下返回0</span></span><br><span class="line">        <span class="keyword">if</span> (!sentinel.tilt &amp;&amp; ri &amp;&amp; (ri-&gt;flags &amp; SRI_S_DOWN) &amp;&amp;</span><br><span class="line">                                    (ri-&gt;flags &amp; SRI_MASTER))</span><br><span class="line">            isdown = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//期望给runid投票</span></span><br><span class="line">        <span class="keyword">if</span> (ri &amp;&amp; ri-&gt;flags &amp; SRI_MASTER &amp;&amp; strcasecmp(c-&gt;argv[<span class="number">5</span>]-&gt;ptr,<span class="string">&quot;*&quot;</span>)) &#123;</span><br><span class="line">            leader = sentinelVoteLeader(ri,(<span class="keyword">uint64_t</span>)req_epoch,</span><br><span class="line">                                            c-&gt;argv[<span class="number">5</span>]-&gt;ptr,</span><br><span class="line">                                            &amp;leader_epoch);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        addReplyMultiBulkLen(c,<span class="number">3</span>);</span><br><span class="line">        addReply(c, isdown ? shared.cone : shared.czero);</span><br><span class="line">        addReplyBulkCString(c, leader ? leader : <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        addReplyLongLong(c, (<span class="keyword">long</span> <span class="keyword">long</span>)leader_epoch);</span><br><span class="line">        <span class="keyword">if</span> (leader) sdsfree(leader);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;reset&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//重置master节点，根据正则匹配master SENTINEL RESET &lt;pattern&gt;</span></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc != <span class="number">3</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        addReplyLongLong(c,sentinelResetMastersByPattern(c-&gt;argv[<span class="number">2</span>]-&gt;ptr,SENTINEL_GENERATE_EVENT));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;get-master-addr-by-name&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//根绝名称获取master的ip&amp;port信息 SENTINEL GET-MASTER-ADDR-BY-NAME &lt;master-name&gt;</span></span><br><span class="line">        sentinelRedisInstance *ri;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc != <span class="number">3</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        ri = sentinelGetMasterByName(c-&gt;argv[<span class="number">2</span>]-&gt;ptr);</span><br><span class="line">        <span class="keyword">if</span> (ri == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            addReply(c,shared.nullmultibulk);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sentinelAddr *addr = sentinelGetCurrentMasterAddress(ri);</span><br><span class="line"></span><br><span class="line">            addReplyMultiBulkLen(c,<span class="number">2</span>);</span><br><span class="line">            addReplyBulkCString(c,addr-&gt;ip);</span><br><span class="line">            addReplyBulkLongLong(c,addr-&gt;port);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;failover&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//强制开始故障修复 SENTINEL FAILOVER &lt;master-name&gt;</span></span><br><span class="line">        sentinelRedisInstance *ri;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc != <span class="number">3</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        <span class="keyword">if</span> ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[<span class="number">2</span>])) == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) &#123;</span><br><span class="line">            addReplySds(c,sdsnew(<span class="string">&quot;-INPROG Failover already in progress\r\n&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sentinelSelectSlave(ri) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            addReplySds(c,sdsnew(<span class="string">&quot;-NOGOODSLAVE No suitable replica to promote\r\n&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        serverLog(LL_WARNING,<span class="string">&quot;Executing user requested FAILOVER of &#x27;%s&#x27;&quot;</span>,</span><br><span class="line">            ri-&gt;name);</span><br><span class="line">        sentinelStartFailover(ri);</span><br><span class="line">        ri-&gt;flags |= SRI_FORCE_FAILOVER;</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;pending-scripts&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//获取脚本队列里任务信息 SENTINEL PENDING-SCRIPTS</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc != <span class="number">2</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        sentinelPendingScriptsCommand(c);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;monitor&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//监听新的master SENTINEL MONITOR &lt;name&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt;</span></span><br><span class="line">        sentinelRedisInstance *ri;</span><br><span class="line">        <span class="keyword">long</span> quorum, port;</span><br><span class="line">        <span class="keyword">char</span> ip[NET_IP_STR_LEN];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc != <span class="number">6</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        <span class="keyword">if</span> (getLongFromObjectOrReply(c,c-&gt;argv[<span class="number">5</span>],&amp;quorum,<span class="string">&quot;Invalid quorum&quot;</span>)</span><br><span class="line">            != C_OK) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (getLongFromObjectOrReply(c,c-&gt;argv[<span class="number">4</span>],&amp;port,<span class="string">&quot;Invalid port&quot;</span>)</span><br><span class="line">            != C_OK) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (quorum &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            addReplyError(c, <span class="string">&quot;Quorum must be 1 or greater.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//确保ip是对的</span></span><br><span class="line">        <span class="keyword">if</span> (anetResolveIP(<span class="literal">NULL</span>,c-&gt;argv[<span class="number">3</span>]-&gt;ptr,ip,<span class="keyword">sizeof</span>(ip)) == ANET_ERR) &#123;</span><br><span class="line">            addReplyError(c,<span class="string">&quot;Invalid IP address specified&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建master节点</span></span><br><span class="line">        ri = createSentinelRedisInstance(c-&gt;argv[<span class="number">2</span>]-&gt;ptr,SRI_MASTER,</span><br><span class="line">                c-&gt;argv[<span class="number">3</span>]-&gt;ptr,port,quorum,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (ri == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span>(errno) &#123;</span><br><span class="line">            <span class="keyword">case</span> EBUSY:</span><br><span class="line">                addReplyError(c,<span class="string">&quot;Duplicated master name&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EINVAL:</span><br><span class="line">                addReplyError(c,<span class="string">&quot;Invalid port number&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                addReplyError(c,<span class="string">&quot;Unspecified error adding the instance&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sentinelFlushConfig();</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;+monitor&quot;</span>,ri,<span class="string">&quot;%@ quorum %d&quot;</span>,ri-&gt;quorum);</span><br><span class="line">            addReply(c,shared.ok);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;flushconfig&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//重写哨兵配置</span></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc != <span class="number">2</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        sentinelFlushConfig();</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;remove&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//删除监听的master SENTINEL REMOVE &lt;name&gt;</span></span><br><span class="line">        sentinelRedisInstance *ri;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc != <span class="number">3</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        <span class="keyword">if</span> ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[<span class="number">2</span>]))</span><br><span class="line">            == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">        sentinelEvent(LL_WARNING,<span class="string">&quot;-monitor&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">        dictDelete(sentinel.masters,c-&gt;argv[<span class="number">2</span>]-&gt;ptr);</span><br><span class="line">        sentinelFlushConfig();</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;ckquorum&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//获取该master是否满足投票数量条件 SENTINEL CKQUORUM &lt;name&gt;</span></span><br><span class="line">        sentinelRedisInstance *ri;</span><br><span class="line">        <span class="keyword">int</span> usable;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc != <span class="number">3</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        <span class="keyword">if</span> ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[<span class="number">2</span>]))</span><br><span class="line">            == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">int</span> result = sentinelIsQuorumReachable(ri,&amp;usable);</span><br><span class="line">        <span class="keyword">if</span> (result == SENTINEL_ISQR_OK) &#123;</span><br><span class="line">            addReplySds(c, sdscatfmt(sdsempty(),</span><br><span class="line">                <span class="string">&quot;+OK %i usable Sentinels. Quorum and failover authorization &quot;</span></span><br><span class="line">                <span class="string">&quot;can be reached\r\n&quot;</span>,usable));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sds e = sdscatfmt(sdsempty(),</span><br><span class="line">                <span class="string">&quot;-NOQUORUM %i usable Sentinels. &quot;</span>,usable);</span><br><span class="line">            <span class="keyword">if</span> (result &amp; SENTINEL_ISQR_NOQUORUM)</span><br><span class="line">                e = sdscat(e,<span class="string">&quot;Not enough available Sentinels to reach the&quot;</span></span><br><span class="line">                             <span class="string">&quot; specified quorum for this master&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (result &amp; SENTINEL_ISQR_NOAUTH) &#123;</span><br><span class="line">                <span class="keyword">if</span> (result &amp; SENTINEL_ISQR_NOQUORUM) e = sdscat(e,<span class="string">&quot;. &quot;</span>);</span><br><span class="line">                e = sdscat(e, <span class="string">&quot;Not enough available Sentinels to reach the&quot;</span></span><br><span class="line">                              <span class="string">&quot; majority and authorize a failover&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            e = sdscat(e,<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">            addReplySds(c,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;set&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//设置监听master对应的参数信息 SENTINEL SET</span></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc &lt; <span class="number">3</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        sentinelSetCommand(c);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;info-cache&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//批量获取master节点及其salve节点缓存的info命令信息 SENTINEL INFO-CACHE &lt;name&gt; ....</span></span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc &lt; <span class="number">2</span>) <span class="keyword">goto</span> numargserr;</span><br><span class="line">        <span class="keyword">mstime_t</span> now = mstime();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据名称查找对应的master节点</span></span><br><span class="line">        dictType copy_keeper = instancesDictType;</span><br><span class="line">        copy_keeper.valDestructor = <span class="literal">NULL</span>;</span><br><span class="line">        dict *masters_local = sentinel.masters;</span><br><span class="line">        <span class="keyword">if</span> (c-&gt;argc &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            masters_local = dictCreate(&amp;copy_keeper, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; c-&gt;argc; i++) &#123;</span><br><span class="line">                sentinelRedisInstance *ri;</span><br><span class="line">                ri = sentinelGetMasterByName(c-&gt;argv[i]-&gt;ptr);</span><br><span class="line">                <span class="keyword">if</span> (!ri) <span class="keyword">continue</span>;</span><br><span class="line">                dictAdd(masters_local, ri-&gt;name, ri);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 回复格式:</span></span><br><span class="line"><span class="comment">         *   1.) master name</span></span><br><span class="line"><span class="comment">         *   2.) 1.) info from master</span></span><br><span class="line"><span class="comment">         *       2.) info from replica</span></span><br><span class="line"><span class="comment">         *       ...</span></span><br><span class="line"><span class="comment">         *   3.) other master name</span></span><br><span class="line"><span class="comment">         *   ...</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        addReplyMultiBulkLen(c,dictSize(masters_local) * <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        dictIterator  *di;</span><br><span class="line">        dictEntry *de;</span><br><span class="line">        di = dictGetIterator(masters_local);</span><br><span class="line">        <span class="comment">//master的info信息</span></span><br><span class="line">        <span class="keyword">while</span> ((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line">            addReplyBulkCBuffer(c,ri-&gt;name,<span class="built_in">strlen</span>(ri-&gt;name));</span><br><span class="line">            addReplyMultiBulkLen(c,dictSize(ri-&gt;slaves) + <span class="number">1</span>); <span class="comment">/* +1 for self */</span></span><br><span class="line">            addReplyMultiBulkLen(c,<span class="number">2</span>);</span><br><span class="line">            addReplyLongLong(c, now - ri-&gt;info_refresh);</span><br><span class="line">            <span class="keyword">if</span> (ri-&gt;info)</span><br><span class="line">                addReplyBulkCBuffer(c,ri-&gt;info,sdslen(ri-&gt;info));</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                addReply(c,shared.nullbulk);</span><br><span class="line"></span><br><span class="line">            dictIterator *sdi;</span><br><span class="line">            dictEntry *sde;</span><br><span class="line">            sdi = dictGetIterator(ri-&gt;slaves);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//slave的info信息</span></span><br><span class="line">            <span class="keyword">while</span> ((sde = dictNext(sdi)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                sentinelRedisInstance *sri = dictGetVal(sde);</span><br><span class="line">                addReplyMultiBulkLen(c,<span class="number">2</span>);</span><br><span class="line">                addReplyLongLong(c, now - sri-&gt;info_refresh);</span><br><span class="line">                <span class="keyword">if</span> (sri-&gt;info)</span><br><span class="line">                    addReplyBulkCBuffer(c,sri-&gt;info,sdslen(sri-&gt;info));</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    addReply(c,shared.nullbulk);</span><br><span class="line">            &#125;</span><br><span class="line">            dictReleaseIterator(sdi);</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di);</span><br><span class="line">        <span class="keyword">if</span> (masters_local != sentinel.masters) dictRelease(masters_local);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,<span class="string">&quot;simulate-failure&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//设置哨兵的标志 SENTINEL SIMULATE-FAILURE &lt;flag&gt; &lt;flag&gt; ... &lt;flag&gt;</span></span><br><span class="line">        <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">        sentinel.simfailure_flags = SENTINEL_SIMFAILURE_NONE;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">2</span>; j &lt; c-&gt;argc; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class="string">&quot;crash-after-election&quot;</span>)) &#123;</span><br><span class="line">                sentinel.simfailure_flags |=</span><br><span class="line">                    SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION;</span><br><span class="line">                serverLog(LL_WARNING,<span class="string">&quot;Failure simulation: this Sentinel &quot;</span></span><br><span class="line">                    <span class="string">&quot;will crash after being successfully elected as failover &quot;</span></span><br><span class="line">                    <span class="string">&quot;leader&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class="string">&quot;crash-after-promotion&quot;</span>)) &#123;</span><br><span class="line">                sentinel.simfailure_flags |=</span><br><span class="line">                    SENTINEL_SIMFAILURE_CRASH_AFTER_PROMOTION;</span><br><span class="line">                serverLog(LL_WARNING,<span class="string">&quot;Failure simulation: this Sentinel &quot;</span></span><br><span class="line">                    <span class="string">&quot;will crash after promoting the selected replica to master&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(c-&gt;argv[j]-&gt;ptr,<span class="string">&quot;help&quot;</span>)) &#123;</span><br><span class="line">                addReplyMultiBulkLen(c,<span class="number">2</span>);</span><br><span class="line">                addReplyBulkCString(c,<span class="string">&quot;crash-after-election&quot;</span>);</span><br><span class="line">                addReplyBulkCString(c,<span class="string">&quot;crash-after-promotion&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                addReplyError(c,<span class="string">&quot;Unknown failure simulation specified&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        addReply(c,shared.ok);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addReplyErrorFormat(c,<span class="string">&quot;Unknown sentinel subcommand &#x27;%s&#x27;&quot;</span>,</span><br><span class="line">                               (<span class="keyword">char</span>*)c-&gt;argv[<span class="number">1</span>]-&gt;ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">numargserr:</span><br><span class="line">    addReplyErrorFormat(c,<span class="string">&quot;Wrong number of arguments for &#x27;sentinel %s&#x27;&quot;</span>,</span><br><span class="line">                          (<span class="keyword">char</span>*)c-&gt;argv[<span class="number">1</span>]-&gt;ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelInfoCommand"><a href="#sentinelInfoCommand" class="headerlink" title="sentinelInfoCommand"></a>sentinelInfoCommand</h5><p>获取哨兵信息，包括server、client、cpu、stats等信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> info_section_from_redis(section_name) do &#123; \</span></span><br><span class="line">    <span class="keyword">if</span> (defsections || allsections || !strcasecmp(section,section_name)) &#123; \</span><br><span class="line">        sds redissection; \</span><br><span class="line">        <span class="keyword">if</span> (sections++) info = sdscat(info,<span class="string">&quot;\r\n&quot;</span>); \</span><br><span class="line">        redissection = genRedisInfoString(section_name); \</span><br><span class="line">        info = sdscatlen(info,redissection,sdslen(redissection)); \</span><br><span class="line">        sdsfree(redissection); \</span><br><span class="line">    &#125; \</span><br><span class="line">&#125; <span class="keyword">while</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SENTINEL INFO [section]  section指server、client、cpu、stats</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelInfoCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;argc &gt; <span class="number">2</span>) &#123;</span><br><span class="line">        addReply(c,shared.syntaxerr);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> defsections = <span class="number">0</span>, allsections = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *section = c-&gt;argc == <span class="number">2</span> ? c-&gt;argv[<span class="number">1</span>]-&gt;ptr : <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (section) &#123;</span><br><span class="line">        allsections = !strcasecmp(section,<span class="string">&quot;all&quot;</span>);</span><br><span class="line">        defsections = !strcasecmp(section,<span class="string">&quot;default&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        defsections = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> sections = <span class="number">0</span>;</span><br><span class="line">    sds info = sdsempty();</span><br><span class="line"></span><br><span class="line">    info_section_from_redis(<span class="string">&quot;server&quot;</span>);</span><br><span class="line">    info_section_from_redis(<span class="string">&quot;clients&quot;</span>);</span><br><span class="line">    info_section_from_redis(<span class="string">&quot;cpu&quot;</span>);</span><br><span class="line">    info_section_from_redis(<span class="string">&quot;stats&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (defsections || allsections || !strcasecmp(section,<span class="string">&quot;sentinel&quot;</span>)) &#123;</span><br><span class="line">        dictIterator *di;</span><br><span class="line">        dictEntry *de;</span><br><span class="line">        <span class="keyword">int</span> master_id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sections++) info = sdscat(info,<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        info = sdscatprintf(info,</span><br><span class="line">            <span class="string">&quot;# Sentinel\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;sentinel_masters:%lu\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;sentinel_tilt:%d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;sentinel_running_scripts:%d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;sentinel_scripts_queue_length:%ld\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;sentinel_simulate_failure_flags:%lu\r\n&quot;</span>,</span><br><span class="line">            dictSize(sentinel.masters),</span><br><span class="line">            sentinel.tilt,</span><br><span class="line">            sentinel.running_scripts,</span><br><span class="line">            listLength(sentinel.scripts_queue),</span><br><span class="line">            sentinel.simfailure_flags);</span><br><span class="line"></span><br><span class="line">        di = dictGetIterator(sentinel.masters);</span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line">            <span class="keyword">char</span> *status = <span class="string">&quot;ok&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_O_DOWN) status = <span class="string">&quot;odown&quot;</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_S_DOWN) status = <span class="string">&quot;sdown&quot;</span>;</span><br><span class="line">            info = sdscatprintf(info,</span><br><span class="line">                <span class="string">&quot;master%d:name=%s,status=%s,address=%s:%d,&quot;</span></span><br><span class="line">                <span class="string">&quot;slaves=%lu,sentinels=%lu\r\n&quot;</span>,</span><br><span class="line">                master_id++, ri-&gt;name, status,</span><br><span class="line">                ri-&gt;addr-&gt;ip, ri-&gt;addr-&gt;port,</span><br><span class="line">                dictSize(ri-&gt;slaves),</span><br><span class="line">                dictSize(ri-&gt;sentinels)+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addReplyBulkSds(c, info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelRoleCommand"><a href="#sentinelRoleCommand" class="headerlink" title="sentinelRoleCommand"></a>sentinelRoleCommand</h5><p>响应role命令，返回sentinel以及监听的所有的master名字</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelRoleCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    addReplyMultiBulkLen(c,<span class="number">2</span>);</span><br><span class="line">    addReplyBulkCBuffer(c,<span class="string">&quot;sentinel&quot;</span>,<span class="number">8</span>);</span><br><span class="line">    addReplyMultiBulkLen(c,dictSize(sentinel.masters));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//所有master名字</span></span><br><span class="line">    di = dictGetIterator(sentinel.masters);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        addReplyBulkCString(c,ri-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelSetCommand"><a href="#sentinelSetCommand" class="headerlink" title="sentinelSetCommand"></a>sentinelSetCommand</h5><p>响应<code>sentinel set</code>命令，更新监听master的哨兵配置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelSetCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    sentinelRedisInstance *ri;</span><br><span class="line">    <span class="keyword">int</span> j, changes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> badarg = <span class="number">0</span>; <span class="comment">//出问题参数索引</span></span><br><span class="line">    <span class="keyword">char</span> *option;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查找master</span></span><br><span class="line">    <span class="keyword">if</span> ((ri = sentinelGetMasterByNameOrReplyError(c,c-&gt;argv[<span class="number">2</span>]))</span><br><span class="line">        == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理选项</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">3</span>; j &lt; c-&gt;argc; j++) &#123;</span><br><span class="line">        <span class="keyword">int</span> moreargs = (c-&gt;argc<span class="number">-1</span>) - j;</span><br><span class="line">        option = c-&gt;argv[j]-&gt;ptr;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line">        <span class="keyword">int</span> old_j = j; <span class="comment">/* Used to know what to log as an event. */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//认定断线所需要时长</span></span><br><span class="line">        <span class="keyword">if</span> (!strcasecmp(option,<span class="string">&quot;down-after-milliseconds&quot;</span>) &amp;&amp; moreargs &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* down-after-millisecodns &lt;milliseconds&gt; */</span></span><br><span class="line">            robj *o = c-&gt;argv[++j];</span><br><span class="line">            <span class="keyword">if</span> (getLongLongFromObject(o,&amp;ll) == C_ERR || ll &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                badarg = j;</span><br><span class="line">                <span class="keyword">goto</span> badfmt;</span><br><span class="line">            &#125;</span><br><span class="line">            ri-&gt;down_after_period = ll;</span><br><span class="line">            sentinelPropagateDownAfterPeriod(ri);</span><br><span class="line">            changes++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(option,<span class="string">&quot;failover-timeout&quot;</span>) &amp;&amp; moreargs &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//故障修复超时时间 failover-timeout &lt;milliseconds&gt;</span></span><br><span class="line">            robj *o = c-&gt;argv[++j];</span><br><span class="line">            <span class="keyword">if</span> (getLongLongFromObject(o,&amp;ll) == C_ERR || ll &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                badarg = j;</span><br><span class="line">                <span class="keyword">goto</span> badfmt;</span><br><span class="line">            &#125;</span><br><span class="line">            ri-&gt;failover_timeout = ll;</span><br><span class="line">            changes++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(option,<span class="string">&quot;parallel-syncs&quot;</span>) &amp;&amp; moreargs &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//确定salve同步的最大并发数 parallel-syncs &lt;milliseconds&gt;</span></span><br><span class="line">            robj *o = c-&gt;argv[++j];</span><br><span class="line">            <span class="keyword">if</span> (getLongLongFromObject(o,&amp;ll) == C_ERR || ll &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                badarg = j;</span><br><span class="line">                <span class="keyword">goto</span> badfmt;</span><br><span class="line">            &#125;</span><br><span class="line">            ri-&gt;parallel_syncs = ll;</span><br><span class="line">            changes++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(option,<span class="string">&quot;notification-script&quot;</span>) &amp;&amp; moreargs &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//通知脚本 notification-script &lt;path&gt;</span></span><br><span class="line">            <span class="keyword">char</span> *value = c-&gt;argv[++j]-&gt;ptr;</span><br><span class="line">            <span class="keyword">if</span> (sentinel.deny_scripts_reconfig) &#123;</span><br><span class="line">                addReplyError(c,</span><br><span class="line">                    <span class="string">&quot;Reconfiguration of scripts path is denied for &quot;</span></span><br><span class="line">                    <span class="string">&quot;security reasons. Check the deny-scripts-reconfig &quot;</span></span><br><span class="line">                    <span class="string">&quot;configuration directive in your Sentinel configuration&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strlen</span>(value) &amp;&amp; access(value,X_OK) == <span class="number">-1</span>) &#123;</span><br><span class="line">                addReplyError(c,</span><br><span class="line">                    <span class="string">&quot;Notification script seems non existing or non executable&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (changes) sentinelFlushConfig();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            sdsfree(ri-&gt;notification_script);</span><br><span class="line">            ri-&gt;notification_script = <span class="built_in">strlen</span>(value) ? sdsnew(value) : <span class="literal">NULL</span>;</span><br><span class="line">            changes++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(option,<span class="string">&quot;client-reconfig-script&quot;</span>) &amp;&amp; moreargs &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//更改配置脚本 client-reconfig-script &lt;path&gt;</span></span><br><span class="line">            <span class="keyword">char</span> *value = c-&gt;argv[++j]-&gt;ptr;</span><br><span class="line">            <span class="keyword">if</span> (sentinel.deny_scripts_reconfig) &#123;</span><br><span class="line">                addReplyError(c,</span><br><span class="line">                    <span class="string">&quot;Reconfiguration of scripts path is denied for &quot;</span></span><br><span class="line">                    <span class="string">&quot;security reasons. Check the deny-scripts-reconfig &quot;</span></span><br><span class="line">                    <span class="string">&quot;configuration directive in your Sentinel configuration&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strlen</span>(value) &amp;&amp; access(value,X_OK) == <span class="number">-1</span>) &#123;</span><br><span class="line">                addReplyError(c,</span><br><span class="line">                    <span class="string">&quot;Client reconfiguration script seems non existing or &quot;</span></span><br><span class="line">                    <span class="string">&quot;non executable&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (changes) sentinelFlushConfig();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            sdsfree(ri-&gt;client_reconfig_script);</span><br><span class="line">            ri-&gt;client_reconfig_script = <span class="built_in">strlen</span>(value) ? sdsnew(value) : <span class="literal">NULL</span>;</span><br><span class="line">            changes++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(option,<span class="string">&quot;auth-pass&quot;</span>) &amp;&amp; moreargs &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//密码 auth-pass &lt;password&gt;</span></span><br><span class="line">            <span class="keyword">char</span> *value = c-&gt;argv[++j]-&gt;ptr;</span><br><span class="line">            sdsfree(ri-&gt;auth_pass);</span><br><span class="line">            ri-&gt;auth_pass = <span class="built_in">strlen</span>(value) ? sdsnew(value) : <span class="literal">NULL</span>;</span><br><span class="line">            changes++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(option,<span class="string">&quot;quorum&quot;</span>) &amp;&amp; moreargs &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//最小票数 quorum &lt;count&gt;</span></span><br><span class="line">            robj *o = c-&gt;argv[++j];</span><br><span class="line">            <span class="keyword">if</span> (getLongLongFromObject(o,&amp;ll) == C_ERR || ll &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                badarg = j;</span><br><span class="line">                <span class="keyword">goto</span> badfmt;</span><br><span class="line">            &#125;</span><br><span class="line">            ri-&gt;quorum = ll;</span><br><span class="line">            changes++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(option,<span class="string">&quot;rename-command&quot;</span>) &amp;&amp; moreargs &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//重命名命令 rename-command &lt;oldname&gt; &lt;newname&gt;</span></span><br><span class="line">            sds oldname = c-&gt;argv[++j]-&gt;ptr;</span><br><span class="line">            sds newname = c-&gt;argv[++j]-&gt;ptr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((sdslen(oldname) == <span class="number">0</span>) || (sdslen(newname) == <span class="number">0</span>)) &#123;</span><br><span class="line">                badarg = sdslen(newname) ? j<span class="number">-1</span> : j;</span><br><span class="line">                <span class="keyword">goto</span> badfmt;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//删除旧的</span></span><br><span class="line">            dictDelete(ri-&gt;renamed_commands,oldname);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//添加新的</span></span><br><span class="line">            <span class="keyword">if</span> (!dictSdsKeyCaseCompare(<span class="literal">NULL</span>,oldname,newname)) &#123;</span><br><span class="line">                oldname = sdsdup(oldname);</span><br><span class="line">                newname = sdsdup(newname);</span><br><span class="line">                dictAdd(ri-&gt;renamed_commands,oldname,newname);</span><br><span class="line">            &#125;</span><br><span class="line">            changes++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addReplyErrorFormat(c,<span class="string">&quot;Unknown option or number of arguments for &quot;</span></span><br><span class="line">                                  <span class="string">&quot;SENTINEL SET &#x27;%s&#x27;&quot;</span>, option);</span><br><span class="line">            <span class="keyword">if</span> (changes) sentinelFlushConfig();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//记录日志</span></span><br><span class="line">        <span class="keyword">int</span> numargs = j-old_j+<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">switch</span>(numargs) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;+set&quot;</span>,ri,<span class="string">&quot;%@ %s %s&quot;</span>,c-&gt;argv[old_j]-&gt;ptr,</span><br><span class="line">                                                          c-&gt;argv[old_j+<span class="number">1</span>]-&gt;ptr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;+set&quot;</span>,ri,<span class="string">&quot;%@ %s %s %s&quot;</span>,c-&gt;argv[old_j]-&gt;ptr,</span><br><span class="line">                                                             c-&gt;argv[old_j+<span class="number">1</span>]-&gt;ptr,</span><br><span class="line">                                                             c-&gt;argv[old_j+<span class="number">2</span>]-&gt;ptr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;+set&quot;</span>,ri,<span class="string">&quot;%@ %s&quot;</span>,c-&gt;argv[old_j]-&gt;ptr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (changes) sentinelFlushConfig();</span><br><span class="line">    addReply(c,shared.ok);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//格式错误</span></span><br><span class="line">badfmt:</span><br><span class="line">    <span class="keyword">if</span> (changes) sentinelFlushConfig();</span><br><span class="line">    addReplyErrorFormat(c,<span class="string">&quot;Invalid argument &#x27;%s&#x27; for SENTINEL SET &#x27;%s&#x27;&quot;</span>,</span><br><span class="line">        (<span class="keyword">char</span>*)c-&gt;argv[badarg]-&gt;ptr,option);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelPublishCommand"><a href="#sentinelPublishCommand" class="headerlink" title="sentinelPublishCommand"></a>sentinelPublishCommand</h5><p>响应订阅命令，只有hello频道才有用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelPublishCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(c-&gt;argv[<span class="number">1</span>]-&gt;ptr,SENTINEL_HELLO_CHANNEL)) &#123;</span><br><span class="line">        addReplyError(c, <span class="string">&quot;Only HELLO messages are accepted by Sentinel instances.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sentinelProcessHelloMessage(c-&gt;argv[<span class="number">2</span>]-&gt;ptr,sdslen(c-&gt;argv[<span class="number">2</span>]-&gt;ptr));</span><br><span class="line">    addReplyLongLong(c,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="判断校验"><a href="#判断校验" class="headerlink" title="判断校验"></a>判断校验</h4><h5 id="sentinelCheckSubjectivelyDown"><a href="#sentinelCheckSubjectivelyDown" class="headerlink" title="sentinelCheckSubjectivelyDown"></a>sentinelCheckSubjectivelyDown</h5><p>判断节点是否为主观下线</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelCheckSubjectivelyDown</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">mstime_t</span> elapsed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;link-&gt;act_ping_time)</span><br><span class="line">        elapsed = mstime() - ri-&gt;link-&gt;act_ping_time;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ri-&gt;link-&gt;disconnected)</span><br><span class="line">        elapsed = mstime() - ri-&gt;link-&gt;last_avail_time;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//建立连接后，但是在规定的时间内，没有收到ping的回复</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;link-&gt;cc &amp;&amp;</span><br><span class="line">        (mstime() - ri-&gt;link-&gt;cc_conn_time) &gt;</span><br><span class="line">        SENTINEL_MIN_LINK_RECONNECT_PERIOD &amp;&amp;</span><br><span class="line">        ri-&gt;link-&gt;act_ping_time != <span class="number">0</span> &amp;&amp; </span><br><span class="line">        (mstime() - ri-&gt;link-&gt;act_ping_time) &gt; (ri-&gt;down_after_period/<span class="number">2</span>) &amp;&amp;</span><br><span class="line">        (mstime() - ri-&gt;link-&gt;last_pong_time) &gt; (ri-&gt;down_after_period/<span class="number">2</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        instanceLinkCloseConnection(ri-&gt;link,ri-&gt;link-&gt;cc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发布订阅连接建立，在3倍的时间内没有收到有效数据</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;link-&gt;pc &amp;&amp;</span><br><span class="line">        (mstime() - ri-&gt;link-&gt;pc_conn_time) &gt;</span><br><span class="line">         SENTINEL_MIN_LINK_RECONNECT_PERIOD &amp;&amp;</span><br><span class="line">        (mstime() - ri-&gt;link-&gt;pc_last_activity) &gt; (SENTINEL_PUBLISH_PERIOD*<span class="number">3</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        instanceLinkCloseConnection(ri-&gt;link,ri-&gt;link-&gt;pc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主观下线条件2选一</span></span><br><span class="line">    <span class="comment">//1.在N久内未收到有效回复</span></span><br><span class="line">    <span class="comment">//2.节点从master变更到slave在一段时间内(下线时间+2倍的info频率)</span></span><br><span class="line">    <span class="keyword">if</span> (elapsed &gt; ri-&gt;down_after_period ||</span><br><span class="line">        (ri-&gt;flags &amp; SRI_MASTER &amp;&amp;</span><br><span class="line">         ri-&gt;role_reported == SRI_SLAVE &amp;&amp;</span><br><span class="line">         mstime() - ri-&gt;role_reported_time &gt;</span><br><span class="line">          (ri-&gt;down_after_period+SENTINEL_INFO_PERIOD*<span class="number">2</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//现在不是主观下线</span></span><br><span class="line">        <span class="keyword">if</span> ((ri-&gt;flags &amp; SRI_S_DOWN) == <span class="number">0</span>) &#123;</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;+sdown&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">            ri-&gt;s_down_since_time = mstime();</span><br><span class="line">            ri-&gt;flags |= SRI_S_DOWN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//从下线恢复正常</span></span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_S_DOWN) &#123;</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;-sdown&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">            ri-&gt;flags &amp;= ~(SRI_S_DOWN|SRI_SCRIPT_KILL_SENT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelCheckObjectivelyDown"><a href="#sentinelCheckObjectivelyDown" class="headerlink" title="sentinelCheckObjectivelyDown"></a>sentinelCheckObjectivelyDown</h5><p>检查是否客观下线，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelCheckObjectivelyDown</span><span class="params">(sentinelRedisInstance *master)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> quorum = <span class="number">0</span>, odown = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先判断主观下线</span></span><br><span class="line">    <span class="keyword">if</span> (master-&gt;flags &amp; SRI_S_DOWN) &#123;</span><br><span class="line">        quorum = <span class="number">1</span>; <span class="comment">//自己先投一票</span></span><br><span class="line">        di = dictGetIterator(master-&gt;sentinels);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查看其它哨兵的情况</span></span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_MASTER_DOWN) quorum++;</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数量够了，断定为客观下线</span></span><br><span class="line">        <span class="keyword">if</span> (quorum &gt;= master-&gt;quorum) odown = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (odown) &#123;</span><br><span class="line">        <span class="comment">//第一次客观下线</span></span><br><span class="line">        <span class="keyword">if</span> ((master-&gt;flags &amp; SRI_O_DOWN) == <span class="number">0</span>) &#123;</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;+odown&quot;</span>,master,<span class="string">&quot;%@ #quorum %d/%d&quot;</span>,</span><br><span class="line">                quorum, master-&gt;quorum);</span><br><span class="line">            master-&gt;flags |= SRI_O_DOWN;</span><br><span class="line">            master-&gt;o_down_since_time = mstime();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//把客观下线的标志拿掉</span></span><br><span class="line">        <span class="keyword">if</span> (master-&gt;flags &amp; SRI_O_DOWN) &#123;</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;-odown&quot;</span>,master,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">            master-&gt;flags &amp;= ~SRI_O_DOWN;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelReceiveIsMasterDownReply"><a href="#sentinelReceiveIsMasterDownReply" class="headerlink" title="sentinelReceiveIsMasterDownReply"></a>sentinelReceiveIsMasterDownReply</h5><p>处理询问其它哨兵master是否挂掉的回调，<code>SENTINEL is-master-down-by-addr</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelReceiveIsMasterDownReply</span><span class="params">(redisAsyncContext *c, <span class="keyword">void</span> *reply, <span class="keyword">void</span> *privdata)</span> </span>&#123;</span><br><span class="line">    sentinelRedisInstance *ri = privdata;</span><br><span class="line">    instanceLink *link = c-&gt;data;</span><br><span class="line">    redisReply *r;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!reply || !link) <span class="keyword">return</span>;</span><br><span class="line">    link-&gt;pending_commands--;</span><br><span class="line">    r = reply;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验数据格式</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;type == REDIS_REPLY_ARRAY &amp;&amp; r-&gt;elements == <span class="number">3</span> &amp;&amp;</span><br><span class="line">        r-&gt;element[<span class="number">0</span>]-&gt;type == REDIS_REPLY_INTEGER &amp;&amp;</span><br><span class="line">        r-&gt;element[<span class="number">1</span>]-&gt;type == REDIS_REPLY_STRING &amp;&amp;</span><br><span class="line">        r-&gt;element[<span class="number">2</span>]-&gt;type == REDIS_REPLY_INTEGER)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//记录回复时间</span></span><br><span class="line">        ri-&gt;last_master_down_reply_time = mstime();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;element[<span class="number">0</span>]-&gt;integer == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//该哨兵也认为下线了</span></span><br><span class="line">            ri-&gt;flags |= SRI_MASTER_DOWN;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//没有下线</span></span><br><span class="line">            ri-&gt;flags &amp;= ~SRI_MASTER_DOWN;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(r-&gt;element[<span class="number">1</span>]-&gt;str,<span class="string">&quot;*&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">//如果runid这一列不是*的话，表明该节点已经为某个哨兵投过票了，把其投票的纪元和选举的结果存下来</span></span><br><span class="line">            sdsfree(ri-&gt;leader);</span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">long</span> <span class="keyword">long</span>)ri-&gt;leader_epoch != r-&gt;element[<span class="number">2</span>]-&gt;integer)</span><br><span class="line">                serverLog(LL_WARNING,</span><br><span class="line">                    <span class="string">&quot;%s voted for %s %llu&quot;</span>, ri-&gt;name,</span><br><span class="line">                    r-&gt;element[<span class="number">1</span>]-&gt;str,</span><br><span class="line">                    (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) r-&gt;element[<span class="number">2</span>]-&gt;integer);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//投票的结果</span></span><br><span class="line">            ri-&gt;leader = sdsnew(r-&gt;element[<span class="number">1</span>]-&gt;str);</span><br><span class="line">            <span class="comment">//投票当时所在的纪元</span></span><br><span class="line">            ri-&gt;leader_epoch = r-&gt;element[<span class="number">2</span>]-&gt;integer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelAskMasterStateToOtherSentinels"><a href="#sentinelAskMasterStateToOtherSentinels" class="headerlink" title="sentinelAskMasterStateToOtherSentinels"></a>sentinelAskMasterStateToOtherSentinels</h5><p>向其他所有哨兵询问master是否挂了，为了尽快的得到回复，选举出leader然后开始故障修复</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SENTINEL_ASK_FORCED (1&lt;&lt;0) <span class="comment">//是否强制</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelAskMasterStateToOtherSentinels</span><span class="params">(sentinelRedisInstance *master, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//依次遍历监听该master的其他哨兵</span></span><br><span class="line">    di = dictGetIterator(master-&gt;sentinels);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line">        <span class="keyword">mstime_t</span> elapsed = mstime() - ri-&gt;last_master_down_reply_time; <span class="comment">//上一次该命令回复到现在的时间间隔</span></span><br><span class="line">        <span class="keyword">char</span> port[<span class="number">32</span>];</span><br><span class="line">        <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果上一次到现在太久了，认为结果不可靠，清除掉其标记和选举的leader</span></span><br><span class="line">        <span class="keyword">if</span> (elapsed &gt; SENTINEL_ASK_PERIOD*<span class="number">5</span>) &#123;</span><br><span class="line">            ri-&gt;flags &amp;= ~SRI_MASTER_DOWN;</span><br><span class="line">            sdsfree(ri-&gt;leader);</span><br><span class="line">            ri-&gt;leader = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//询问其他哨兵的时候，有一下3个条件</span></span><br><span class="line">        <span class="comment">//1.我们认为这个master已经挂了</span></span><br><span class="line">        <span class="comment">//2.和这个哨兵处于连接中</span></span><br><span class="line">        <span class="comment">//3.正常情况下，在SENTINEL_ASK_PERIOD时间内没有收到回复</span></span><br><span class="line">        <span class="keyword">if</span> ((master-&gt;flags &amp; SRI_S_DOWN) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;link-&gt;disconnected) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(flags &amp; SENTINEL_ASK_FORCED) &amp;&amp;</span><br><span class="line">            mstime() - ri-&gt;last_master_down_reply_time &lt; SENTINEL_ASK_PERIOD)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送sentinel is-master-down-by-addr</span></span><br><span class="line">        ll2string(port,<span class="keyword">sizeof</span>(port),master-&gt;addr-&gt;port);</span><br><span class="line">        retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span><br><span class="line">                    sentinelReceiveIsMasterDownReply, ri,</span><br><span class="line">                    <span class="string">&quot;%s is-master-down-by-addr %s %s %llu %s&quot;</span>,</span><br><span class="line">                    sentinelInstanceMapCommand(ri,<span class="string">&quot;SENTINEL&quot;</span>),</span><br><span class="line">                    master-&gt;addr-&gt;ip, port,</span><br><span class="line">                    sentinel.current_epoch,</span><br><span class="line">                    (master-&gt;failover_state &gt; SENTINEL_FAILOVER_STATE_NONE) ?</span><br><span class="line">                    sentinel.myid : <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (retval == C_OK) ri-&gt;link-&gt;pending_commands++;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="故障修复-1"><a href="#故障修复-1" class="headerlink" title="故障修复"></a>故障修复</h4><h5 id="sentinelSimFailureCrash"><a href="#sentinelSimFailureCrash" class="headerlink" title="sentinelSimFailureCrash"></a>sentinelSimFailureCrash</h5><p>故障修复失败模式执行时的崩溃</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelSimFailureCrash</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    serverLog(LL_WARNING,</span><br><span class="line">        <span class="string">&quot;Sentinel CRASH because of SENTINEL simulate-failure&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">99</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="sentinelVoteLeader"><a href="#sentinelVoteLeader" class="headerlink" title="sentinelVoteLeader"></a>sentinelVoteLeader</h6><p>在某个纪元下投指定的leader一票，返回现在的leader和leader所在的纪元</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">sentinelVoteLeader</span><span class="params">(sentinelRedisInstance *master, <span class="keyword">uint64_t</span> req_epoch, <span class="keyword">char</span> *req_runid, <span class="keyword">uint64_t</span> *leader_epoch)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//如果投票所在的纪元比当前哨兵的纪元大，则更新自己的纪元</span></span><br><span class="line">    <span class="keyword">if</span> (req_epoch &gt; sentinel.current_epoch) &#123;</span><br><span class="line">        sentinel.current_epoch = req_epoch;</span><br><span class="line">        sentinelFlushConfig();</span><br><span class="line">        sentinelEvent(LL_WARNING,<span class="string">&quot;+new-epoch&quot;</span>,master,<span class="string">&quot;%llu&quot;</span>,</span><br><span class="line">            (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) sentinel.current_epoch);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//master现在选举出的leader的纪元是老的，在新的纪元下，需要重新选</span></span><br><span class="line">    <span class="keyword">if</span> (master-&gt;leader_epoch &lt; req_epoch &amp;&amp; sentinel.current_epoch &lt;= req_epoch)</span><br><span class="line">    &#123;</span><br><span class="line">        sdsfree(master-&gt;leader);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置新的leader和选举出该leader所在的纪元</span></span><br><span class="line">        master-&gt;leader = sdsnew(req_runid);</span><br><span class="line">        master-&gt;leader_epoch = sentinel.current_epoch;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//持久化哨兵配置</span></span><br><span class="line">        sentinelFlushConfig();</span><br><span class="line">        sentinelEvent(LL_WARNING,<span class="string">&quot;+vote-for-leader&quot;</span>,master,<span class="string">&quot;%s %llu&quot;</span>,</span><br><span class="line">            master-&gt;leader, (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) master-&gt;leader_epoch);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//如果不是投自己的话，设置故障修复开始时间为现在+一段时间的延迟</span></span><br><span class="line">        <span class="keyword">if</span> (strcasecmp(master-&gt;leader,sentinel.myid))</span><br><span class="line">            master-&gt;failover_start_time = mstime()+rand()%SENTINEL_MAX_DESYNC;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回当前master的leader所在的纪元</span></span><br><span class="line">    *leader_epoch = master-&gt;leader_epoch;</span><br><span class="line">    <span class="keyword">return</span> master-&gt;leader ? sdsnew(master-&gt;leader) : <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelLeaderIncr"><a href="#sentinelLeaderIncr" class="headerlink" title="sentinelLeaderIncr"></a>sentinelLeaderIncr</h5><p>对某个leader+1计数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sentinelLeader</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *runid;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> votes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelLeaderIncr</span><span class="params">(dict *counters, <span class="keyword">char</span> *runid)</span> </span>&#123;</span><br><span class="line">    dictEntry *existing, *de;</span><br><span class="line">    <span class="keyword">uint64_t</span> oldval;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查找leader是否存在</span></span><br><span class="line">    de = dictAddRaw(counters,runid,&amp;existing);</span><br><span class="line">    <span class="keyword">if</span> (existing) &#123;</span><br><span class="line">        <span class="comment">//存在+1</span></span><br><span class="line">        oldval = dictGetUnsignedIntegerVal(existing);</span><br><span class="line">        dictSetUnsignedIntegerVal(existing,oldval+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> oldval+<span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//不存在的话，设置成1</span></span><br><span class="line">        serverAssert(de != <span class="literal">NULL</span>);</span><br><span class="line">        dictSetUnsignedIntegerVal(de,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelGetLeader"><a href="#sentinelGetLeader" class="headerlink" title="sentinelGetLeader"></a>sentinelGetLeader</h5><p>在某个纪元下，获取leader</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">sentinelGetLeader</span><span class="params">(sentinelRedisInstance *master, <span class="keyword">uint64_t</span> epoch)</span> </span>&#123;</span><br><span class="line">    dict *counters;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> voters = <span class="number">0</span>, voters_quorum;</span><br><span class="line">    <span class="keyword">char</span> *myvote;</span><br><span class="line">    <span class="keyword">char</span> *winner = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> leader_epoch;</span><br><span class="line">    <span class="keyword">uint64_t</span> max_votes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    serverAssert(master-&gt;flags &amp; (SRI_O_DOWN|SRI_FAILOVER_IN_PROGRESS));</span><br><span class="line">    counters = dictCreate(&amp;leaderVotesDictType,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//投票的所有人(+1表示自己)</span></span><br><span class="line">    voters = dictSize(master-&gt;sentinels)+<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//统计其他哨兵的投票结果</span></span><br><span class="line">    di = dictGetIterator(master-&gt;sentinels);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//该哨兵节点已经选出leader 并且其所在的纪元和当前哨兵纪元一样</span></span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;leader != <span class="literal">NULL</span> &amp;&amp; ri-&gt;leader_epoch == sentinel.current_epoch)</span><br><span class="line">            sentinelLeaderIncr(counters,ri-&gt;leader);</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//唱票阶段，获取票数最高的</span></span><br><span class="line">    di = dictGetIterator(counters);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> votes = dictGetUnsignedIntegerVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (votes &gt; max_votes) &#123;</span><br><span class="line">            max_votes = votes;</span><br><span class="line">            winner = dictGetKey(de);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//基于最高票数的结果，决定自己要投给谁</span></span><br><span class="line">    <span class="comment">//如果已经有其他人投票了，那么自己也投给那个人，否则投自己</span></span><br><span class="line">    <span class="keyword">if</span> (winner)</span><br><span class="line">        myvote = sentinelVoteLeader(master,epoch,winner,&amp;leader_epoch);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        myvote = sentinelVoteLeader(master,epoch,sentinel.myid,&amp;leader_epoch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果这次所在的纪元和之前(包括这次)选举的纪元一致，表明自己投成功了</span></span><br><span class="line">    <span class="keyword">if</span> (myvote &amp;&amp; leader_epoch == epoch) &#123;</span><br><span class="line">        <span class="comment">//加上自己的一票</span></span><br><span class="line">        <span class="keyword">uint64_t</span> votes = sentinelLeaderIncr(counters,myvote);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (votes &gt; max_votes) &#123;</span><br><span class="line">            max_votes = votes;</span><br><span class="line">            winner = myvote;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//确定得票最高者 是否满足成为leader的条件</span></span><br><span class="line">    <span class="comment">//1. 要大于总投票人数的一半(向下取整)+1</span></span><br><span class="line">    <span class="comment">//2. 要大于等于设置的最低票数</span></span><br><span class="line">    voters_quorum = voters/<span class="number">2</span>+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (winner &amp;&amp; (max_votes &lt; voters_quorum || max_votes &lt; master-&gt;quorum))</span><br><span class="line">        winner = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    winner = winner ? sdsnew(winner) : <span class="literal">NULL</span>;</span><br><span class="line">    sdsfree(myvote);</span><br><span class="line">    dictRelease(counters);</span><br><span class="line">    <span class="keyword">return</span> winner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelSendSlaveOf"><a href="#sentinelSendSlaveOf" class="headerlink" title="sentinelSendSlaveOf"></a>sentinelSendSlaveOf</h5><p>向节点发送slaveof命令，更改其master指向，如果host为NULL，表示执行<code>slaveof no one</code>。发送该命令，永远都会跟随一个<code>rewrite config</code>命令，让节点更新配置到磁盘上</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelSendSlaveOf</span><span class="params">(sentinelRedisInstance *ri, <span class="keyword">char</span> *host, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> portstr[<span class="number">32</span>];</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    ll2string(portstr,<span class="keyword">sizeof</span>(portstr),port);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//host为NULL的情况</span></span><br><span class="line">    <span class="keyword">if</span> (host == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        host = <span class="string">&quot;NO&quot;</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(portstr,<span class="string">&quot;ONE&quot;</span>,<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//多命令</span></span><br><span class="line">    retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span><br><span class="line">        sentinelDiscardReplyCallback, ri, <span class="string">&quot;%s&quot;</span>,</span><br><span class="line">        sentinelInstanceMapCommand(ri,<span class="string">&quot;MULTI&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (retval == C_ERR) <span class="keyword">return</span> retval;</span><br><span class="line">    ri-&gt;link-&gt;pending_commands++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//slaveof 命令</span></span><br><span class="line">    retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span><br><span class="line">        sentinelDiscardReplyCallback, ri, <span class="string">&quot;%s %s %s&quot;</span>,</span><br><span class="line">        sentinelInstanceMapCommand(ri,<span class="string">&quot;SLAVEOF&quot;</span>),</span><br><span class="line">        host, portstr);</span><br><span class="line">    <span class="keyword">if</span> (retval == C_ERR) <span class="keyword">return</span> retval;</span><br><span class="line">    ri-&gt;link-&gt;pending_commands++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//config rewrite 更新配置</span></span><br><span class="line">    retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span><br><span class="line">        sentinelDiscardReplyCallback, ri, <span class="string">&quot;%s REWRITE&quot;</span>,</span><br><span class="line">        sentinelInstanceMapCommand(ri,<span class="string">&quot;CONFIG&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (retval == C_ERR) <span class="keyword">return</span> retval;</span><br><span class="line">    ri-&gt;link-&gt;pending_commands++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//client kill type normal 断开该客户端的所有连接</span></span><br><span class="line">    retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span><br><span class="line">        sentinelDiscardReplyCallback, ri, <span class="string">&quot;%s KILL TYPE normal&quot;</span>,</span><br><span class="line">        sentinelInstanceMapCommand(ri,<span class="string">&quot;CLIENT&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (retval == C_ERR) <span class="keyword">return</span> retval;</span><br><span class="line">    ri-&gt;link-&gt;pending_commands++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//事务结束</span></span><br><span class="line">    retval = redisAsyncCommand(ri-&gt;link-&gt;cc,</span><br><span class="line">        sentinelDiscardReplyCallback, ri, <span class="string">&quot;%s&quot;</span>,</span><br><span class="line">        sentinelInstanceMapCommand(ri,<span class="string">&quot;EXEC&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (retval == C_ERR) <span class="keyword">return</span> retval;</span><br><span class="line">    ri-&gt;link-&gt;pending_commands++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelStartFailover"><a href="#sentinelStartFailover" class="headerlink" title="sentinelStartFailover"></a>sentinelStartFailover</h5><p>开始故障修复</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelStartFailover</span><span class="params">(sentinelRedisInstance *master)</span> </span>&#123;</span><br><span class="line">    serverAssert(master-&gt;flags &amp; SRI_MASTER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//故障修复状态为等待开始</span></span><br><span class="line">    master-&gt;failover_state = SENTINEL_FAILOVER_STATE_WAIT_START;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//master标记成故障修复中</span></span><br><span class="line">    master-&gt;flags |= SRI_FAILOVER_IN_PROGRESS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//纪元+1，在新的纪元下开始整个流程</span></span><br><span class="line">    master-&gt;failover_epoch = ++sentinel.current_epoch;</span><br><span class="line">    sentinelEvent(LL_WARNING,<span class="string">&quot;+new-epoch&quot;</span>,master,<span class="string">&quot;%llu&quot;</span>,</span><br><span class="line">        (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>) sentinel.current_epoch);</span><br><span class="line">    sentinelEvent(LL_WARNING,<span class="string">&quot;+try-failover&quot;</span>,master,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录时间</span></span><br><span class="line">    master-&gt;failover_start_time = mstime()+rand()%SENTINEL_MAX_DESYNC;</span><br><span class="line">    master-&gt;failover_state_change_time = mstime();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelStartFailoverIfNeeded"><a href="#sentinelStartFailoverIfNeeded" class="headerlink" title="sentinelStartFailoverIfNeeded"></a>sentinelStartFailoverIfNeeded</h5><p>如果条件满足的话，开始故障修复</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sentinelStartFailoverIfNeeded</span><span class="params">(sentinelRedisInstance *master)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//只有master为客观下线才可以</span></span><br><span class="line">    <span class="keyword">if</span> (!(master-&gt;flags &amp; SRI_O_DOWN)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//已经在故障处理中了</span></span><br><span class="line">    <span class="keyword">if</span> (master-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//距离上一次开始还没有多久(两倍的故障修复超时时间)</span></span><br><span class="line">    <span class="keyword">if</span> (mstime() - master-&gt;failover_start_time &lt;</span><br><span class="line">        master-&gt;failover_timeout*<span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (master-&gt;failover_delay_logged != master-&gt;failover_start_time) &#123;</span><br><span class="line">            <span class="keyword">time_t</span> clock = (master-&gt;failover_start_time +</span><br><span class="line">                            master-&gt;failover_timeout*<span class="number">2</span>) / <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">char</span> ctimebuf[<span class="number">26</span>];</span><br><span class="line"></span><br><span class="line">            ctime_r(&amp;clock,ctimebuf);</span><br><span class="line">            ctimebuf[<span class="number">24</span>] = <span class="string">&#x27;\0&#x27;</span>; <span class="comment">/* Remove newline. */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//记录延迟</span></span><br><span class="line">            master-&gt;failover_delay_logged = master-&gt;failover_start_time;</span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">&quot;Next failover delay: I will not start a failover before %s&quot;</span>,</span><br><span class="line">                ctimebuf);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//距离上一次过去很久了，开始一次新的</span></span><br><span class="line">    sentinelStartFailover(master);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="compareSlavesForPromotion"><a href="#compareSlavesForPromotion" class="headerlink" title="compareSlavesForPromotion"></a>compareSlavesForPromotion</h5><p>挑选成为新master的salve快排比较方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">compareSlavesForPromotion</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *a, <span class="keyword">const</span> <span class="keyword">void</span> *b)</span> </span>&#123;</span><br><span class="line">    sentinelRedisInstance **sa = (sentinelRedisInstance **)a,</span><br><span class="line">                          **sb = (sentinelRedisInstance **)b;</span><br><span class="line">    <span class="keyword">char</span> *sa_runid, *sb_runid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//优先级，优先级低的优先</span></span><br><span class="line">    <span class="keyword">if</span> ((*sa)-&gt;slave_priority != (*sb)-&gt;slave_priority)</span><br><span class="line">        <span class="keyword">return</span> (*sa)-&gt;slave_priority - (*sb)-&gt;slave_priority;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从master同步的偏移量，同步多的优先</span></span><br><span class="line">    <span class="keyword">if</span> ((*sa)-&gt;slave_repl_offset &gt; (*sb)-&gt;slave_repl_offset) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">/* a &lt; b */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((*sa)-&gt;slave_repl_offset &lt; (*sb)-&gt;slave_repl_offset) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* a &gt; b */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//比较运行id，这个只是兜底方案，无实际意义</span></span><br><span class="line">    sa_runid = (*sa)-&gt;runid;</span><br><span class="line">    sb_runid = (*sb)-&gt;runid;</span><br><span class="line">    <span class="keyword">if</span> (sa_runid == <span class="literal">NULL</span> &amp;&amp; sb_runid == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (sa_runid == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">1</span>;  <span class="comment">/* a &gt; b */</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (sb_runid == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">/* a &lt; b */</span></span><br><span class="line">    <span class="keyword">return</span> strcasecmp(sa_runid, sb_runid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelSelectSlave"><a href="#sentinelSelectSlave" class="headerlink" title="sentinelSelectSlave"></a>sentinelSelectSlave</h5><p>从一堆salve中选出新的master，能进入预选的slave需要满足以下条件</p>
<ol>
<li>情况正常，没有被判定为主观下线或者客观下线</li>
<li>连接正常</li>
<li>距离上一次有效ping的时间，要小于5倍的ping频率(1s)</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sentinelRedisInstance *<span class="title">sentinelSelectSlave</span><span class="params">(sentinelRedisInstance *master)</span> </span>&#123;</span><br><span class="line">    sentinelRedisInstance **instance =</span><br><span class="line">        zmalloc(<span class="keyword">sizeof</span>(instance[<span class="number">0</span>])*dictSize(master-&gt;slaves));</span><br><span class="line">    sentinelRedisInstance *selected = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> instances = <span class="number">0</span>;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">mstime_t</span> max_master_down_time = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//master挂掉的最大时间</span></span><br><span class="line">    <span class="keyword">if</span> (master-&gt;flags &amp; SRI_S_DOWN)</span><br><span class="line">        max_master_down_time += mstime() - master-&gt;s_down_since_time;</span><br><span class="line">    max_master_down_time += master-&gt;down_after_period * <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//遍历master下的所有slave</span></span><br><span class="line">    di = dictGetIterator(master-&gt;slaves);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *slave = dictGetVal(de);</span><br><span class="line">        <span class="keyword">mstime_t</span> info_validity_time;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//客观&amp;主观下线，忽略</span></span><br><span class="line">        <span class="keyword">if</span> (slave-&gt;flags &amp; (SRI_S_DOWN|SRI_O_DOWN)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//连接断开了，忽略</span></span><br><span class="line">        <span class="keyword">if</span> (slave-&gt;link-&gt;disconnected) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//距离上一次有效的ping时间点，大于5倍的PING频率(1s)，忽略</span></span><br><span class="line">        <span class="keyword">if</span> (mstime() - slave-&gt;link-&gt;last_avail_time &gt; SENTINEL_PING_PERIOD*<span class="number">5</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//优先级为0，忽略</span></span><br><span class="line">        <span class="keyword">if</span> (slave-&gt;slave_priority == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//master主观下线情况下，发送给salve节点的info命令是1s/次，否则是正常的频率，针对两种场景，其info命令返回结果的超时时间也需要有所不同</span></span><br><span class="line">        <span class="keyword">if</span> (master-&gt;flags &amp; SRI_S_DOWN)</span><br><span class="line">            info_validity_time = SENTINEL_PING_PERIOD*<span class="number">5</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            info_validity_time = SENTINEL_INFO_PERIOD*<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//info过期</span></span><br><span class="line">        <span class="keyword">if</span> (mstime() - slave-&gt;info_refresh &gt; info_validity_time) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//slave和master断开太久</span></span><br><span class="line">        <span class="keyword">if</span> (slave-&gt;master_link_down_time &gt; max_master_down_time) <span class="keyword">continue</span>;</span><br><span class="line">        instance[instances++] = slave;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从满足条件的salves中挑选出一个</span></span><br><span class="line">    <span class="keyword">if</span> (instances) &#123;</span><br><span class="line">        qsort(instance,instances,<span class="keyword">sizeof</span>(sentinelRedisInstance*),</span><br><span class="line">            compareSlavesForPromotion);</span><br><span class="line">        selected = instance[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    zfree(instance);</span><br><span class="line">    <span class="keyword">return</span> selected;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="故障修复各个节点处理"><a href="#故障修复各个节点处理" class="headerlink" title="故障修复各个节点处理"></a>故障修复各个节点处理</h4><h5 id="sentinelFailoverWaitStart"><a href="#sentinelFailoverWaitStart" class="headerlink" title="sentinelFailoverWaitStart"></a>sentinelFailoverWaitStart</h5><p>等待开始</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelFailoverWaitStart</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *leader;</span><br><span class="line">    <span class="keyword">int</span> isleader;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查leader是否是自己</span></span><br><span class="line">    leader = sentinelGetLeader(ri, ri-&gt;failover_epoch);</span><br><span class="line">    isleader = leader &amp;&amp; strcasecmp(leader,sentinel.myid) == <span class="number">0</span>;</span><br><span class="line">    sdsfree(leader);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//正常情况下没有选举出leader</span></span><br><span class="line">    <span class="keyword">if</span> (!isleader &amp;&amp; !(ri-&gt;flags &amp; SRI_FORCE_FAILOVER)) &#123;</span><br><span class="line">        <span class="keyword">int</span> election_timeout = SENTINEL_ELECTION_TIMEOUT;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//选举的超时时间不能大于整个流程的超时时间</span></span><br><span class="line">        <span class="keyword">if</span> (election_timeout &gt; ri-&gt;failover_timeout)</span><br><span class="line">            election_timeout = ri-&gt;failover_timeout;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//如果选举超时，在一定时间内，没有选出一个符合条件的</span></span><br><span class="line">        <span class="keyword">if</span> (mstime() - ri-&gt;failover_start_time &gt; election_timeout) &#123;</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;-failover-abort-not-elected&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">            sentinelAbortFailover(ri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//选举有结果</span></span><br><span class="line">    sentinelEvent(LL_WARNING,<span class="string">&quot;+elected-leader&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//选举成功后退出</span></span><br><span class="line">    <span class="keyword">if</span> (sentinel.simfailure_flags &amp; SENTINEL_SIMFAILURE_CRASH_AFTER_ELECTION)</span><br><span class="line">        sentinelSimFailureCrash();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//选出了leader，接下来要需要选举新的master</span></span><br><span class="line">    ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_SELECT_SLAVE;</span><br><span class="line">    ri-&gt;failover_state_change_time = mstime();</span><br><span class="line">    sentinelEvent(LL_WARNING,<span class="string">&quot;+failover-state-select-slave&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelFailoverSelectSlave"><a href="#sentinelFailoverSelectSlave" class="headerlink" title="sentinelFailoverSelectSlave"></a>sentinelFailoverSelectSlave</h5><p>从slaves中确定新的master</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelFailoverSelectSlave</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    sentinelRedisInstance *slave = sentinelSelectSlave(ri);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//没有好的slave</span></span><br><span class="line">    <span class="keyword">if</span> (slave == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelEvent(LL_WARNING,<span class="string">&quot;-failover-abort-no-good-slave&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">        sentinelAbortFailover(ri);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//成功挑出来，打上标记</span></span><br><span class="line">        sentinelEvent(LL_WARNING,<span class="string">&quot;+selected-slave&quot;</span>,slave,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">        slave-&gt;flags |= SRI_PROMOTED;</span><br><span class="line">        ri-&gt;promoted_slave = slave;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//接下来需要更新其他salve的master配置</span></span><br><span class="line">        ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE;</span><br><span class="line">        ri-&gt;failover_state_change_time = mstime();</span><br><span class="line">        sentinelEvent(LL_NOTICE,<span class="string">&quot;+failover-state-send-slaveof-noone&quot;</span>,</span><br><span class="line">            slave, <span class="string">&quot;%@&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelFailoverSendSlaveOfNoOne"><a href="#sentinelFailoverSendSlaveOfNoOne" class="headerlink" title="sentinelFailoverSendSlaveOfNoOne"></a>sentinelFailoverSendSlaveOfNoOne</h5><p>向选中的slave节点发送<code>slaveof no one</code>命令，使其成为master</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelFailoverSendSlaveOfNoOne</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果之前选举出的salve断开连接了</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;promoted_slave-&gt;link-&gt;disconnected) &#123;</span><br><span class="line">        <span class="comment">//过了好久(失败的超时时间)都没有连上，这一次整体就失败了，回归初始状态</span></span><br><span class="line">        <span class="keyword">if</span> (mstime() - ri-&gt;failover_state_change_time &gt; ri-&gt;failover_timeout) &#123;</span><br><span class="line">            sentinelEvent(LL_WARNING,<span class="string">&quot;-failover-abort-slave-timeout&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">            sentinelAbortFailover(ri);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//等待重新</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送slave no one</span></span><br><span class="line">    retval = sentinelSendSlaveOf(ri-&gt;promoted_slave,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (retval != C_OK) <span class="keyword">return</span>;</span><br><span class="line">    sentinelEvent(LL_NOTICE, <span class="string">&quot;+failover-state-wait-promotion&quot;</span>,</span><br><span class="line">        ri-&gt;promoted_slave,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接下来等待其晋升成为master</span></span><br><span class="line">    ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_WAIT_PROMOTION;</span><br><span class="line">    ri-&gt;failover_state_change_time = mstime();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelFailoverWaitPromotion"><a href="#sentinelFailoverWaitPromotion" class="headerlink" title="sentinelFailoverWaitPromotion"></a>sentinelFailoverWaitPromotion</h5><p>等待选中的salve晋升</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelFailoverWaitPromotion</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//判断在该阶段的超时，在接收到info命令的时候，如果汇报的角色是master的话，会流转到下一个状态的</span></span><br><span class="line">    <span class="keyword">if</span> (mstime() - ri-&gt;failover_state_change_time &gt; ri-&gt;failover_timeout) &#123;</span><br><span class="line">        sentinelEvent(LL_WARNING,<span class="string">&quot;-failover-abort-slave-timeout&quot;</span>,ri,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">        sentinelAbortFailover(ri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelFailoverDetectEnd"><a href="#sentinelFailoverDetectEnd" class="headerlink" title="sentinelFailoverDetectEnd"></a>sentinelFailoverDetectEnd</h5><p>故障修复的收尾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelFailoverDetectEnd</span><span class="params">(sentinelRedisInstance *master)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> not_reconfigured = <span class="number">0</span>, timeout = <span class="number">0</span>;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">mstime_t</span> elapsed = mstime() - master-&gt;failover_state_change_time;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//选举出来的slave为空或者处于主观下线中，这种情况下不能认为整个流程结束了</span></span><br><span class="line">    <span class="keyword">if</span> (master-&gt;promoted_slave == <span class="literal">NULL</span> ||</span><br><span class="line">        master-&gt;promoted_slave-&gt;flags &amp; SRI_S_DOWN) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查所有的salve是否都完成配置更新了</span></span><br><span class="line">    di = dictGetIterator(master-&gt;slaves);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *slave = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (slave-&gt;flags &amp; (SRI_PROMOTED|SRI_RECONF_DONE)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (slave-&gt;flags &amp; SRI_S_DOWN) <span class="keyword">continue</span>;</span><br><span class="line">        not_reconfigured++;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//超时</span></span><br><span class="line">    <span class="keyword">if</span> (elapsed &gt; master-&gt;failover_timeout) &#123;</span><br><span class="line">        not_reconfigured = <span class="number">0</span>;</span><br><span class="line">        timeout = <span class="number">1</span>;</span><br><span class="line">        sentinelEvent(LL_WARNING,<span class="string">&quot;+failover-end-for-timeout&quot;</span>,master,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//slave都更新完配置了</span></span><br><span class="line">    <span class="keyword">if</span> (not_reconfigured == <span class="number">0</span>) &#123;</span><br><span class="line">        sentinelEvent(LL_WARNING,<span class="string">&quot;+failover-end&quot;</span>,master,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">        master-&gt;failover_state = SENTINEL_FAILOVER_STATE_UPDATE_CONFIG;</span><br><span class="line">        master-&gt;failover_state_change_time = mstime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//超时，恢复所有slave的master为之前的</span></span><br><span class="line">    <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">        dictIterator *di;</span><br><span class="line">        dictEntry *de;</span><br><span class="line"></span><br><span class="line">        di = dictGetIterator(master-&gt;slaves);</span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            sentinelRedisInstance *slave = dictGetVal(de);</span><br><span class="line">            <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (slave-&gt;flags &amp; (SRI_RECONF_DONE|SRI_RECONF_SENT)) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (slave-&gt;link-&gt;disconnected) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            retval = sentinelSendSlaveOf(slave,</span><br><span class="line">                    master-&gt;promoted_slave-&gt;addr-&gt;ip,</span><br><span class="line">                    master-&gt;promoted_slave-&gt;addr-&gt;port);</span><br><span class="line">            <span class="keyword">if</span> (retval == C_OK) &#123;</span><br><span class="line">                sentinelEvent(LL_NOTICE,<span class="string">&quot;+slave-reconf-sent-be&quot;</span>,slave,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">                slave-&gt;flags |= SRI_RECONF_SENT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        dictReleaseIterator(di);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelFailoverReconfNextSlave"><a href="#sentinelFailoverReconfNextSlave" class="headerlink" title="sentinelFailoverReconfNextSlave"></a>sentinelFailoverReconfNextSlave</h5><p>分批更新salve的master</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelFailoverReconfNextSlave</span><span class="params">(sentinelRedisInstance *master)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="keyword">int</span> in_progress = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//统计进行中的数量</span></span><br><span class="line">    di = dictGetIterator(master-&gt;slaves);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *slave = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (slave-&gt;flags &amp; (SRI_RECONF_SENT|SRI_RECONF_INPROG))</span><br><span class="line">            in_progress++;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//还没有达到并发上限</span></span><br><span class="line">    di = dictGetIterator(master-&gt;slaves);</span><br><span class="line">    <span class="keyword">while</span>(in_progress &lt; master-&gt;parallel_syncs &amp;&amp;</span><br><span class="line">          (de = dictNext(di)) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sentinelRedisInstance *slave = dictGetVal(de);</span><br><span class="line">        <span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//跳过被选中成为maste的 以及 更新完的</span></span><br><span class="line">        <span class="keyword">if</span> (slave-&gt;flags &amp; (SRI_PROMOTED|SRI_RECONF_DONE)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新配置超时，强制改为配置ok</span></span><br><span class="line">        <span class="keyword">if</span> ((slave-&gt;flags &amp; SRI_RECONF_SENT) &amp;&amp;</span><br><span class="line">            (mstime() - slave-&gt;slave_reconf_sent_time) &gt;</span><br><span class="line">            SENTINEL_SLAVE_RECONF_TIMEOUT)</span><br><span class="line">        &#123;</span><br><span class="line">            sentinelEvent(LL_NOTICE,<span class="string">&quot;-slave-reconf-sent-timeout&quot;</span>,slave,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">            slave-&gt;flags &amp;= ~SRI_RECONF_SENT;</span><br><span class="line">            slave-&gt;flags |= SRI_RECONF_DONE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//已经发送，等待回来</span></span><br><span class="line">        <span class="keyword">if</span> (slave-&gt;flags &amp; (SRI_RECONF_SENT|SRI_RECONF_INPROG)) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (slave-&gt;link-&gt;disconnected) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送slave ip port</span></span><br><span class="line">        retval = sentinelSendSlaveOf(slave,</span><br><span class="line">                master-&gt;promoted_slave-&gt;addr-&gt;ip,</span><br><span class="line">                master-&gt;promoted_slave-&gt;addr-&gt;port);</span><br><span class="line">        <span class="keyword">if</span> (retval == C_OK) &#123;</span><br><span class="line">            slave-&gt;flags |= SRI_RECONF_SENT;</span><br><span class="line">            slave-&gt;slave_reconf_sent_time = mstime();</span><br><span class="line">            sentinelEvent(LL_NOTICE,<span class="string">&quot;+slave-reconf-sent&quot;</span>,slave,<span class="string">&quot;%@&quot;</span>);</span><br><span class="line">            in_progress++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查是否都ok了&amp;超时处理</span></span><br><span class="line">    sentinelFailoverDetectEnd(master);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelFailoverSwitchToPromotedSlave"><a href="#sentinelFailoverSwitchToPromotedSlave" class="headerlink" title="sentinelFailoverSwitchToPromotedSlave"></a>sentinelFailoverSwitchToPromotedSlave</h5><p>切换master节点信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelFailoverSwitchToPromotedSlave</span><span class="params">(sentinelRedisInstance *master)</span> </span>&#123;</span><br><span class="line">    sentinelRedisInstance *ref = master-&gt;promoted_slave ?</span><br><span class="line">                                 master-&gt;promoted_slave : master;</span><br><span class="line"></span><br><span class="line">    sentinelEvent(LL_WARNING,<span class="string">&quot;+switch-master&quot;</span>,master,<span class="string">&quot;%s %s %d %s %d&quot;</span>,</span><br><span class="line">        master-&gt;name, master-&gt;addr-&gt;ip, master-&gt;addr-&gt;port,</span><br><span class="line">        ref-&gt;addr-&gt;ip, ref-&gt;addr-&gt;port);</span><br><span class="line"></span><br><span class="line">    sentinelResetMasterAndChangeAddress(master,ref-&gt;addr-&gt;ip,ref-&gt;addr-&gt;port);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelFailoverStateMachine"><a href="#sentinelFailoverStateMachine" class="headerlink" title="sentinelFailoverStateMachine"></a>sentinelFailoverStateMachine</h5><p>根据故障修复进度执行对应的操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelFailoverStateMachine</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    serverAssert(ri-&gt;flags &amp; SRI_MASTER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//正常的</span></span><br><span class="line">    <span class="keyword">if</span> (!(ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(ri-&gt;failover_state) &#123;</span><br><span class="line">        <span class="keyword">case</span> SENTINEL_FAILOVER_STATE_WAIT_START:</span><br><span class="line">            sentinelFailoverWaitStart(ri);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SENTINEL_FAILOVER_STATE_SELECT_SLAVE:</span><br><span class="line">            sentinelFailoverSelectSlave(ri);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SENTINEL_FAILOVER_STATE_SEND_SLAVEOF_NOONE:</span><br><span class="line">            sentinelFailoverSendSlaveOfNoOne(ri);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SENTINEL_FAILOVER_STATE_WAIT_PROMOTION:</span><br><span class="line">            sentinelFailoverWaitPromotion(ri);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SENTINEL_FAILOVER_STATE_RECONF_SLAVES:</span><br><span class="line">            sentinelFailoverReconfNextSlave(ri);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelAbortFailover"><a href="#sentinelAbortFailover" class="headerlink" title="sentinelAbortFailover"></a>sentinelAbortFailover</h5><p>故障修复失败处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelAbortFailover</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    serverAssert(ri-&gt;flags &amp; SRI_FAILOVER_IN_PROGRESS);</span><br><span class="line">    serverAssert(ri-&gt;failover_state &lt;= SENTINEL_FAILOVER_STATE_WAIT_PROMOTION);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//剔除故障修复相关标记</span></span><br><span class="line">    ri-&gt;flags &amp;= ~(SRI_FAILOVER_IN_PROGRESS|SRI_FORCE_FAILOVER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//恢复故障修复状态为初始化</span></span><br><span class="line">    ri-&gt;failover_state = SENTINEL_FAILOVER_STATE_NONE;</span><br><span class="line">    ri-&gt;failover_state_change_time = mstime();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//恢复被选中的slave</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;promoted_slave) &#123;</span><br><span class="line">        ri-&gt;promoted_slave-&gt;flags &amp;= ~SRI_PROMOTED;</span><br><span class="line">        ri-&gt;promoted_slave = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h4><h5 id="sentinelHandleRedisInstance"><a href="#sentinelHandleRedisInstance" class="headerlink" title="sentinelHandleRedisInstance"></a>sentinelHandleRedisInstance</h5><p>每一个节点的处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelHandleRedisInstance</span><span class="params">(sentinelRedisInstance *ri)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//重连</span></span><br><span class="line">    sentinelReconnectInstance(ri);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//心跳检测，ping、info</span></span><br><span class="line">    sentinelSendPeriodicCommands(ri);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//结束tilt模式</span></span><br><span class="line">    <span class="keyword">if</span> (sentinel.tilt) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mstime()-sentinel.tilt_start_time &lt; SENTINEL_TILT_PERIOD) <span class="keyword">return</span>;</span><br><span class="line">        sentinel.tilt = <span class="number">0</span>;</span><br><span class="line">        sentinelEvent(LL_WARNING,<span class="string">&quot;-tilt&quot;</span>,<span class="literal">NULL</span>,<span class="string">&quot;#tilt mode exited&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查主观下线</span></span><br><span class="line">    sentinelCheckSubjectivelyDown(ri);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Masters and slaves */</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; (SRI_MASTER|SRI_SLAVE)) &#123;</span><br><span class="line">        <span class="comment">/* Nothing so far. */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//只有master才有的操作</span></span><br><span class="line">    <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_MASTER) &#123;</span><br><span class="line">        <span class="comment">//检查客观下线</span></span><br><span class="line">        sentinelCheckObjectivelyDown(ri);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//尝试开启故障修复</span></span><br><span class="line">        <span class="keyword">if</span> (sentinelStartFailoverIfNeeded(ri))</span><br><span class="line">            sentinelAskMasterStateToOtherSentinels(ri,SENTINEL_ASK_FORCED);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//故障修复各个阶段的处理</span></span><br><span class="line">        sentinelFailoverStateMachine(ri);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//正常询问其他哨兵对该master的看法</span></span><br><span class="line">        sentinelAskMasterStateToOtherSentinels(ri,SENTINEL_NO_FLAGS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelHandleDictOfRedisInstances"><a href="#sentinelHandleDictOfRedisInstances" class="headerlink" title="sentinelHandleDictOfRedisInstances"></a>sentinelHandleDictOfRedisInstances</h5><p>处理节点集合</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelHandleDictOfRedisInstances</span><span class="params">(dict *instances)</span> </span>&#123;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    sentinelRedisInstance *switch_to_promoted = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* There are a number of things we need to perform against every master. */</span></span><br><span class="line">    di = dictGetIterator(instances);</span><br><span class="line">    <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sentinelRedisInstance *ri = dictGetVal(de);</span><br><span class="line"></span><br><span class="line">        sentinelHandleRedisInstance(ri);</span><br><span class="line">        <span class="keyword">if</span> (ri-&gt;flags &amp; SRI_MASTER) &#123;</span><br><span class="line">            sentinelHandleDictOfRedisInstances(ri-&gt;slaves);</span><br><span class="line">            sentinelHandleDictOfRedisInstances(ri-&gt;sentinels);</span><br><span class="line">            <span class="keyword">if</span> (ri-&gt;failover_state == SENTINEL_FAILOVER_STATE_UPDATE_CONFIG) &#123;</span><br><span class="line">                switch_to_promoted = ri;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//替换master节点信息</span></span><br><span class="line">    <span class="keyword">if</span> (switch_to_promoted)</span><br><span class="line">        sentinelFailoverSwitchToPromotedSlave(switch_to_promoted);</span><br><span class="line">    dictReleaseIterator(di);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelCheckTiltCondition"><a href="#sentinelCheckTiltCondition" class="headerlink" title="sentinelCheckTiltCondition"></a>sentinelCheckTiltCondition</h5><p>检查tilt模式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelCheckTiltCondition</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">mstime_t</span> now = mstime();</span><br><span class="line">    <span class="keyword">mstime_t</span> delta = now - sentinel.previous_time;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (delta &lt; <span class="number">0</span> || delta &gt; SENTINEL_TILT_TRIGGER) &#123;</span><br><span class="line">        sentinel.tilt = <span class="number">1</span>;</span><br><span class="line">        sentinel.tilt_start_time = mstime();</span><br><span class="line">        sentinelEvent(LL_WARNING,<span class="string">&quot;+tilt&quot;</span>,<span class="literal">NULL</span>,<span class="string">&quot;#tilt mode entered&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sentinel.previous_time = mstime();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sentinelTimer"><a href="#sentinelTimer" class="headerlink" title="sentinelTimer"></a>sentinelTimer</h5><p>定时任务入口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sentinelTimer</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//检查tilt模式</span></span><br><span class="line">    sentinelCheckTiltCondition();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理所有的master及其相关的salve和哨兵</span></span><br><span class="line">    sentinelHandleDictOfRedisInstances(sentinel.masters);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行脚本</span></span><br><span class="line">    sentinelRunPendingScripts();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理脚本执行结束后续</span></span><br><span class="line">    sentinelCollectTerminatedScripts();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理执行超时的脚本</span></span><br><span class="line">    sentinelKillTimedoutScripts();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新server执行的频率</span></span><br><span class="line">    server.hz = CONFIG_DEFAULT_HZ + rand() % CONFIG_DEFAULT_HZ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div id="gitalk-container"></div>
<script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

		<script>
		var gitalkConfig = {"clientID":"d86b0f2f03d666a5b4d5","clientSecret":"b0a4cdac98cafbe6f866ea2b76d0800306bda397","repo":"suntw2015","owner":"suntw2015","admin":["suntw2015"],"distractionFreeMode":false};
	    gitalkConfig.id = md5(location.pathname);
		var gitalk = new Gitalk(gitalkConfig);
	    gitalk.render("gitalk-container");
	    </script>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/redis/" rel="tag"># redis</a>
              <a href="/tags/sentinel/" rel="tag"># sentinel</a>
              <a href="/tags/%E5%93%A8%E5%85%B5/" rel="tag"># 哨兵</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/11/08/redis-pubsub/" rel="prev" title="redis-发布订阅">
                  <i class="fa fa-chevron-left"></i> redis-发布订阅
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/04/07/redis-cluster/" rel="next" title="redis集群">
                  redis集群 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">孙天文</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
